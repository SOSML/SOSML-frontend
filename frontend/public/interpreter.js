var Interpreter=function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=7)}([function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=function(t){function e(n,i,r){var o=t.call(this,i)||this;return o.position=n,o.message=i,o.name=r,Object.setPrototypeOf(o,e.prototype),o}return r(e,t),e.prototype.toString=function(){return this.name+": "+this.message},e}(Error);e.InterpreterError=o;var s=function(t){function e(n,i){void 0===i&&(i="internal compiler error");var r=t.call(this,n,i,"You triggered Third Impact")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.InternalInterpreterError=s;var a=function(t){function e(n,i){var r=t.call(this,n,i,"Feature Not Implemented")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.FeatureNotImplementedError=a;var u=function(t){function e(n,i){var r=t.call(this,n,i,"Have you ever tried doing something you were not supposed to? Basically that")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.FeatureDisabledError=u;var p=function(t){function e(n,i){void 0===i&&(i="unexpected end of input");var r=t.call(this,n,i,"Input Incomplete")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.IncompleteError=p;var c=function(t){function e(n,i){var r=t.call(this,n,i,"Lexing failed")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.LexerError=c;var h=function(t){function e(n,i){var r=t.call(this,i,n,"Parsing failed")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.ParserError=h;var f=function(t){function e(n,i){var r=t.call(this,n,i,"Elaboration failed")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e.getUnguarded=function(t,n){var i="";n.length>1&&(i+="s"),i+=" ";for(var r=0;r<n.length;++r)r>0&&(i+=", "),i+='"'+n[r]+'"';return new e(t,"Unguarded type variable"+i+".")},e}(o);e.ElaborationError=f;var l=function(t){function e(n,i){var r=t.call(this,n,i,"Evaluation failed")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.EvaluationError=l;var d=function(t){function e(n,i){var r=t.call(this,n,i,"Warning")||this;return Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(o);e.Warning=d},function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=n(3),s=n(0),a=n(2);e.MAXINT=1073741823,e.MININT=-1073741824;var u=function(){return function(t){this.charactersLeft=t}}();e.PrintCounter=u;var p=function(){function t(){}return t.prototype.toString=function(t,e){return void 0===e&&(e=120),this.pcToString(t,new u(e))},t.prototype.equals=function(t){throw new s.InternalInterpreterError(-1,"Tried comparing incomparable things.")},t}();e.Value=p;var c=function(t){function e(e){var n=t.call(this)||this;return n.address=e,n}return r(e,t),e.prototype.equals=function(t){return this.address===t.address},e.prototype.pcToString=function(t,e){if(void 0===t){var n="$"+this.address;return e.charactersLeft-=n.length,n}if(void 0!==t.getCell(this.address))return e.charactersLeft-=4,"ref "+t.getCell(this.address).pcToString(t,e);throw new s.EvaluationError(-1,'Ouch, you may not de-reference "$'+this.address+'".')},e}(p);e.ReferenceValue=c;var h=function(t){function e(e){void 0===e&&(e=[]);var n=t.call(this)||this;return n.entries=e,n}return r(e,t),e.prototype.equals=function(t){if(this.entries.length!==t.entries.length)return!1;for(var e=0;e<this.entries.length;++e)if(!this.entries[e].equals(t.entries[e]))return!1;return!0},e.prototype.pcToString=function(t,e){var n="#[";e.charactersLeft-=3;for(var i=0;i<this.entries.length;++i){if(i>0&&(n+=", ",e.charactersLeft-=2),!(e.charactersLeft>0)){n+="…";break}var r=0;i<this.entries.length&&(r=Math.floor(e.charactersLeft/2)),e.charactersLeft-=r,n+=this.entries[i].pcToString(t,e),e.charactersLeft+=r}return n+"]"},e}(p);e.VectorValue=h;var f=function(t){function e(e,n){var i=t.call(this)||this;return i.address=e,i.length=n,i}return r(e,t),e.prototype.equals=function(t){return this.address===t.address},e.prototype.pcToString=function(t,e){if(void 0===t){var n="[|$"+this.address+"...$"+(this.address+this.length-1)+"|]";return e.charactersLeft-=n.length,n}var i="[|";e.charactersLeft-=4;for(var r=0;r<this.length;++r){if(r>0&&(i+=", ",e.charactersLeft-=2),!(e.charactersLeft>0)){i+="…";break}if(void 0===t.getCell(this.address+r))throw new s.EvaluationError(-1,'Ouch, you may not de-reference "$'+(this.address+r)+'".');var o=0;r<this.length&&(o=Math.floor(e.charactersLeft/2)),e.charactersLeft-=o,i+=t.getCell(this.address+r).pcToString(t,e),e.charactersLeft+=o}return i+"|]"},e}(p);e.ArrayValue=f;var l=function(t){function e(e){var n=t.call(this)||this;return n.value=e,n}return r(e,t),e.prototype.equals=function(t){return this.value===t.value},e.prototype.pcToString=function(t,e){return this.value?(e.charactersLeft-=4,"true"):(e.charactersLeft-=5,"false")},e}(p);e.BoolValue=l;var d=function(t){function e(e){var n=t.call(this)||this;return n.value=e,n}return r(e,t),e.prototype.pcToString=function(t,e){return e.charactersLeft-=1,"#"+new y(this.value).pcToString(t,e)},e.prototype.compareTo=function(t){return this.value<t.value?-1:this.value>t.value?1:0},e.prototype.equals=function(t){return this.value===t.value},e}(p);e.CharValue=d;var y=function(t){function e(e){var n=t.call(this)||this;return n.value=e,n}return r(e,t),e.implode=function(t){for(var n="";"nil"!==t.constructorName;){if("::"!==t.constructorName)throw new s.InternalInterpreterError(-1,"Is this a char list? I can't implode \""+t.constructorName+'".');var i=t.argument;if(!(i instanceof g))throw new s.InternalInterpreterError(-1,"Is this a char list? I can't implode \""+t.constructorName+'".');var r=i.getValue("1"),o=i.getValue("2");if(!(r instanceof d&&o instanceof E))throw new s.InternalInterpreterError(-1,"Is this a char list? I can't implode \""+t.constructorName+'".');n+=r.value,t=o}return new e(n)},e.prototype.pcToString=function(t,e){var n="";e.charactersLeft-=2;for(var i=0,r=this.value;i<r.length;i++){var o=r[i];if(e.charactersLeft<0){n+="…";break}switch(e.charactersLeft-=1,o){case"\n":n+="\\n";break;case"\t":n+="\\t";break;case"\r":n+="\\r";break;case"":n+="\\a";break;case"\b":n+="\\b";break;case"\v":n+="\\v";break;case"\f":n+="\\f";break;case"":n+="\\127";break;case"ÿ":n+="\\255";break;default:if(o.charCodeAt(0)<32){var s="\\^"+String.fromCharCode(o.charCodeAt(0)+64);n+=s,e.charactersLeft-=s.length-1}else n+=o}}return'"'+n+'"'},e.prototype.equals=function(t){return this.value===t.value},e.prototype.compareTo=function(t){return this.value<t.value?-1:this.value>t.value?1:0},e.prototype.concat=function(t){return new e(this.value+t.value)},e.prototype.explode=function(){for(var t=new E("nil"),e=this.value.length-1;e>=0;--e)t=new E("::",new g(new Map([["1",new d(this.value[e])],["2",t]])));return t},e}(p);e.StringValue=y;var v=function(t){function n(e){var n=t.call(this)||this;return n.value=e,n}return r(n,t),n.prototype.pcToString=function(t,e){var n=""+this.value;return e.charactersLeft-=n.length,n},n.prototype.compareTo=function(t){if(t instanceof n){var e=t.value;return this.value<e?-1:this.value>e?1:0}return 2},n.prototype.negate=function(){return new n(-this.value)},n.prototype.equals=function(t){return 0===this.compareTo(t)},n.prototype.add=function(t){return new n(this.value+t.value)},n.prototype.multiply=function(t){return new n(this.value*t.value)},n.prototype.divide=function(t){return new n(Math.floor(this.value/t.value))},n.prototype.modulo=function(t){return new n(this.value%t.value)},n.prototype.toReal=function(){return new m(this.value)},n.prototype.hasOverflow=function(){return this.value>e.MAXINT||this.value<e.MININT},n}(p);e.Word=v;var w=function(t){function n(e){var n=t.call(this)||this;return n.value=e,n}return r(n,t),n.prototype.pcToString=function(t,e){var n=""+this.value;return e.charactersLeft-=n.length,n.replace(/-/,"~")},n.prototype.compareTo=function(t){if(t instanceof n){var e=t.value;return this.value<e?-1:this.value>e?1:0}return!1},n.prototype.equals=function(t){return 0===this.compareTo(t)},n.prototype.negate=function(){return new n(-this.value)},n.prototype.add=function(t){return new n(this.value+t.value)},n.prototype.multiply=function(t){return new n(this.value*t.value)},n.prototype.divide=function(t){return new n(Math.floor(this.value/t.value))},n.prototype.modulo=function(t){return new n(this.value-Math.floor(this.value/t.value)*t.value)},n.prototype.toReal=function(){return new m(this.value)},n.prototype.hasOverflow=function(){return this.value>e.MAXINT||this.value<e.MININT},n}(p);e.Integer=w;var m=function(t){function e(e){var n=t.call(this)||this;return n.value=e,n}return r(e,t),e.prototype.pcToString=function(t,e){var n=""+this.value;return-1===n.search(/\./)&&(n+=".0"),e.charactersLeft-=n.length,n.replace(/-/,"~")},e.prototype.compareTo=function(t){if(t instanceof e){var n=t.value;return this.value<n?-1:this.value>n?1:0}return!1},e.prototype.equals=function(t){return 0===this.compareTo(t)},e.prototype.negate=function(){return new e(-this.value)},e.prototype.add=function(t){return new e(this.value+t.value)},e.prototype.multiply=function(t){return new e(this.value*t.value)},e.prototype.divide=function(t){return new e(this.value/t.value)},e.prototype.toInteger=function(){return new w(Math.floor(this.value))},e.prototype.hasOverflow=function(){return!1},e}(p);e.Real=m;var g=function(t){function e(e){void 0===e&&(e=new Map);var n=t.call(this)||this;return n.entries=e,n}return r(e,t),e.prototype.pcToString=function(t,e){for(var n=this,i=1!==this.entries.size,r=1;r<=this.entries.size;++r)this.entries.has(""+r)||(i=!1);if(i){var o="(";e.charactersLeft-=2;for(r=1;r<=this.entries.size;++r){r>1&&(o+=", ",e.charactersLeft-=2);var a=this.entries.get(""+r);if(void 0===a)throw new s.InternalInterpreterError(-1,"How did we loose this value? It was there before. I promise…");if(!(e.charactersLeft>0)){o+="…";break}var u=0;r<this.entries.size&&(u=Math.floor(e.charactersLeft/2)),e.charactersLeft-=u,o+=a.pcToString(t,e),e.charactersLeft+=u}return o+")"}var p="{";e.charactersLeft-=2;var c=!0,h=!1,f=0;return this.entries.forEach(function(i,r){if(!h){if(c?c=!1:(p+=", ",e.charactersLeft-=2),e.charactersLeft>0){var o=0;f<n.entries.size&&(o=Math.floor(e.charactersLeft/2)),e.charactersLeft-=o,p+=r+" = "+i.pcToString(t,e),e.charactersLeft+=o}else p+="…",h=!0;++f}}),p+"}"},e.prototype.getValue=function(t){if(!this.entries.has(t))throw new s.EvaluationError(0,"Tried accessing non-existing record part.");return this.entries.get(t)},e.prototype.hasValue=function(t){return this.entries.has(t)},e.prototype.equals=function(t){var n=this;if(!(t instanceof e))return!1;var i=!1;return this.entries.forEach(function(e,n){t.entries.has(n)||(i=!0),e.equals(t.entries.get(n))||(i=!0)}),!i&&(t.entries.forEach(function(e,r){n.entries.has(r)||(i=!0),e.equals(t.entries.get(r))||(i=!0)}),!i)},e}(p);e.RecordValue=g;var T=function(t){function e(e,n,i){var r=t.call(this)||this;return r.state=e,r.recursives=n,r.body=i,r}return r(e,t),e.prototype.pcToString=function(t,e){return e.charactersLeft-=2,"fn"},e.prototype.compute=function(t,n,i){for(var r=this.state.getNestedState(this.state.id),s=0;s<this.recursives.length;++s)this.recursives[s][1]instanceof e?r.setDynamicValue(this.recursives[s][0],new e(this.state,this.recursives,this.recursives[s][1].body),o.IdentifierStatus.VALUE_VARIABLE):r.setDynamicValue(this.recursives[s][0],this.recursives[s][1],o.IdentifierStatus.VALUE_VARIABLE);t.push({next:this.body,params:{state:r,recResult:void 0,modifiable:i,value:n}})},e.prototype.equals=function(t){throw new s.InternalInterpreterError(-1,'You simply cannot compare "'+this.pcToString(void 0,new u(20))+'" and "'+t.pcToString(void 0,new u(20))+'".')},e}(p);e.FunctionValue=T;var E=function(t){function e(e,n,i){void 0===n&&(n=void 0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.argument=n,r.id=i,r}return r(e,t),e.prototype.pcToString=function(t,n){if("::"===this.constructorName){var i="[";n.charactersLeft-=2;for(var r=this;"nil"!==r.constructorName;){if("::"!==r.constructorName)throw new s.InternalInterpreterError(-1,'Is this even a list? 1 "'+r.constructorName+'".');var o=r.argument;if(!(o instanceof g&&2===o.entries.size))throw new s.InternalInterpreterError(-1,'Is this even a list? 3 "'+r.constructorName+'".');var u=o.getValue("1"),c=o.getValue("2");if(!(u instanceof p&&c instanceof e))throw new s.InternalInterpreterError(-1,'Is this even a list? 2 "'+r.constructorName+'".');if(r!==this&&(i+=", ",n.charactersLeft-=2),!(n.charactersLeft>0)){i+="…";break}var h=0;"nil"!==c.constructorName&&(h=Math.floor(n.charactersLeft/2)),n.charactersLeft-=h,i+=u.pcToString(t,n),n.charactersLeft+=h,r=c}return i+"]"}if("nil"===this.constructorName)return n.charactersLeft-=2,"[]";if(void 0!==t){var f=t.getInfixStatus(new a.IdentifierToken(this.constructorName,-1));if(void 0!==f&&f.infix&&this.argument instanceof g&&2===this.argument.entries.size){var l=this.argument.getValue("1"),d=this.argument.getValue("2");if(l instanceof p&&d instanceof p){n.charactersLeft-=4+this.constructorName.length;h=Math.floor(n.charactersLeft/2);n.charactersLeft-=h;i="(";if(n.charactersLeft>0?i+=l.pcToString(t,n):i+="…",n.charactersLeft+=h,i+=" "+this.constructorName,this.id>0)i+=y="/"+this.id,n.charactersLeft-=y.length;return n.charactersLeft>0?i+=" "+d.pcToString(t,n):i+=" …",i+")"}}}var y,v="";(v+=this.constructorName,n.charactersLeft-=this.constructorName.length+1,this.id>0)&&(v+=y="/"+this.id,n.charactersLeft-=y.length);return this.argument&&(n.charactersLeft>0?(v+=" ",this.argument instanceof e&&this.argument.argument?v+="(":this.argument instanceof x&&this.argument.argument&&(v+="("),v+=this.argument.pcToString(t,n),this.argument instanceof e&&this.argument.argument?v+=")":this.argument instanceof x&&this.argument.argument&&(v+=")")):v+=" …"),v},e.prototype.equals=function(t){return t instanceof I&&(t=t.construct()),t instanceof e&&(this.constructorName===t.constructorName&&this.id===t.id&&(void 0!==this.argument?void 0===t.argument||this.argument.equals(t.argument):void 0===t.argument))},e}(p);e.ConstructedValue=E;var x=function(t){function e(e,n,i,r){void 0===n&&(n=void 0),void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.constructorName=e,o.argument=n,o.id=i,o.evalId=r,o}return r(e,t),e.prototype.pcToString=function(t,e){var n=this.constructorName;if(e.charactersLeft-=this.constructorName.length+1,this.id>0){var i="/"+this.id;n+=i,e.charactersLeft-=i.length}return this.argument&&(e.charactersLeft>0?n+=" "+this.argument.pcToString(t,e):n+=" …"),n},e.prototype.equals=function(t){return t instanceof k&&(t=t.construct()),t instanceof e&&(this.constructorName===t.constructorName&&this.id===t.id&&this.evalId===t.evalId&&(void 0!==this.argument?void 0===t.argument||this.argument.equals(t.argument):void 0===t.argument))},e}(p);e.ExceptionValue=x;var S=function(t){function e(e,n){var i=t.call(this)||this;return i.name=e,i.apply=n,i}return r(e,t),e.prototype.pcToString=function(t,e){return e.charactersLeft-=2,"fn"},e.prototype.equals=function(t){return t instanceof e&&this.name===t.name},e}(p);e.PredefinedFunction=S;var I=function(t){function e(e,n,i){void 0===n&&(n=0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.numArgs=n,r.id=i,r}return r(e,t),e.prototype.equals=function(t){return t instanceof e&&(this.constructorName===t.constructorName&&this.id===t.id)},e.prototype.construct=function(t){return void 0===t&&(t=void 0),new E(this.constructorName,t,this.id)},e.prototype.pcToString=function(t,e){var n=this.constructorName;if(e.charactersLeft-=this.constructorName.length,this.id>0){var i="/"+this.id;n+=i,e.charactersLeft-=i.length}return n},e}(p);e.ValueConstructor=I;var k=function(t){function e(e,n,i,r){void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.exceptionName=e,o.numArgs=n,o.id=i,o.evalId=r,o}return r(e,t),e.prototype.equals=function(t){return t instanceof e&&(this.exceptionName===t.exceptionName&&this.id===t.id&&this.evalId===t.evalId)},e.prototype.construct=function(t){return void 0===t&&(t=void 0),new x(this.exceptionName,t,this.id,this.evalId)},e.prototype.pcToString=function(t,e){var n=this.exceptionName;if(e.charactersLeft-=this.exceptionName.length,this.id>0){var i="/"+this.id;n+=i,e.charactersLeft-=i.length}return n},e}(p);e.ExceptionConstructor=k},function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){this.text=t,this.position=e}return t.prototype.getText=function(){return this.text},t.prototype.isValidRecordLabel=function(){return!1},t.prototype.isVid=function(){return!1},t}();e.KeywordToken=o;var s=function(){function t(){}return t.prototype.isVid=function(){return!1},t}();e.ConstantToken=s;var a=function(t){function e(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return r(e,t),e.prototype.getText=function(){return""+this.value},e.prototype.isValidRecordLabel=function(){return!1},e}(s);e.IntegerConstantToken=a;var u=function(t){function e(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return r(e,t),e.prototype.getText=function(){return this.text},e.prototype.isValidRecordLabel=function(){return!1},e}(s);e.RealConstantToken=u;var p=function(t){function e(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return r(e,t),e.prototype.getText=function(){return""+this.value},e.prototype.isValidRecordLabel=function(){return!1},e}(s);e.WordConstantToken=p;var c=function(t){function e(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return r(e,t),e.prototype.getText=function(){return""+this.text},e.prototype.isValidRecordLabel=function(){return!1},e}(s);e.CharacterConstantToken=c;var h=function(t){function e(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return r(e,t),e.prototype.getText=function(){return""+this.text},e.prototype.isValidRecordLabel=function(){return!1},e}(s);e.StringConstantToken=h;var f=function(){function t(t,e){this.text=t,this.position=e,this.opPrefixed=!1}return t.prototype.getText=function(){return this.text},t.prototype.isValidRecordLabel=function(){return!0},t.prototype.isVid=function(){return!0},t}();e.IdentifierToken=f;var l=function(t){function e(e,n){return t.call(this,e,n)||this}return r(e,t),e.prototype.getText=function(){return this.text},e.prototype.isValidRecordLabel=function(){return!0},e}(f);e.AlphanumericIdentifierToken=l;var d=function(){function t(t,e){this.text=t,this.position=e}return t.prototype.getText=function(){return this.text},t.prototype.isValidRecordLabel=function(){return!1},t.prototype.isVid=function(){return!1},t}();e.TypeVariableToken=d;var y=function(t){function e(e,n){return t.call(this,e,n)||this}return r(e,t),e.prototype.getText=function(){return this.text},e.prototype.isValidRecordLabel=function(){return!1},e.prototype.isVid=function(){return!1},e}(d);e.EqualityTypeVariableToken=y;var v=function(t){function e(e){var n=t.call(this,"*",e)||this;return n.position=e,n.opPrefixed=!1,n}return r(e,t),e.prototype.getText=function(){return this.text},e.prototype.isValidRecordLabel=function(){return!0},e.prototype.isVid=function(){return!0},e}(o);e.StarToken=v;var w=function(t){function e(e){var n=t.call(this,"=",e)||this;return n.position=e,n}return r(e,t),e.prototype.getText=function(){return this.text},e.prototype.isValidRecordLabel=function(){return!1},e.prototype.isVid=function(){return!0},e}(o);e.EqualsToken=w;var m=function(t){function e(e,n,i){return t.call(this,e,n,i)||this}return r(e,t),e.prototype.getText=function(){return this.text},e.prototype.isValidRecordLabel=function(){return!0},e.prototype.isVid=function(){return!1},e}(a);e.NumericToken=m;var g=function(){function t(t,e,n,i){this.text=t,this.position=e,this.qualifiers=n,this.id=i,this.opPrefixed=!1}return t.prototype.getText=function(){for(var t="",e=0;e<this.qualifiers.length;++e)e>0&&(t+="."),t+=this.qualifiers[e].getText();return t+"."+this.id.getText()},t.prototype.isValidRecordLabel=function(){return!1},t.prototype.isVid=function(){return!1},t}();e.LongIdentifierToken=g},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),r=n(2),o=n(0);!function(t){t[t.VALUE_VARIABLE=0]="VALUE_VARIABLE",t[t.VALUE_CONSTRUCTOR=1]="VALUE_CONSTRUCTOR",t[t.EXCEPTION_CONSTRUCTOR=2]="EXCEPTION_CONSTRUCTOR"}(e.IdentifierStatus||(e.IdentifierStatus={}));var s=function(){function t(t,e,n,i){void 0===i&&(i=!0),this.type=t,this.constructors=e,this.arity=n,this.allowsEquality=i}return t.prototype.toString=function(){return"TypeInformation("+this.type+", ["+this.constructors+"], arity = "+this.arity+", allowsEquality = "+this.allowsEquality+")"},t}();e.TypeInformation=s;var a=function(){return function(t,e,n,i){this.paramName=t,this.param=e,this.body=n,this.state=i}}();e.DynamicFunctorInformation=a;var u=function(){function t(t,e,n){this.typeInterface=t,this.valueInterface=e,this.structureInterface=n}return t.prototype.extend=function(t){for(var e in t.typeInterface)t.typeInterface.hasOwnProperty(e)&&(this.typeInterface[e]=t.typeInterface[e]);for(var e in t.valueInterface)t.valueInterface.hasOwnProperty(e)&&(this.valueInterface[e]=t.valueInterface[e]);for(var e in t.structureInterface)t.structureInterface.hasOwnProperty(e)&&(this.structureInterface[e]=t.structureInterface[e]);return this},t}();e.DynamicInterface=u;var p=function(){return function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=!1),this.infix=t,this.precedence=e,this.rightAssociative=n}}();e.InfixStatus=p;var c=function(){function t(t,e,n,i,r){this.typeEnvironment=t,this.valueEnvironment=e,this.structureEnvironment=n,this.signatureEnvironment=i,this.functorEnvironment=r}return t.prototype.getValue=function(t){if(this.valueEnvironment.hasOwnProperty(t))return this.valueEnvironment[t]},t.prototype.getType=function(t){if(this.typeEnvironment.hasOwnProperty(t))return this.typeEnvironment[t]},t.prototype.getStructure=function(t){if(this.structureEnvironment.hasOwnProperty(t))return this.structureEnvironment[t]},t.prototype.getSignature=function(t){if(this.signatureEnvironment.hasOwnProperty(t))return this.signatureEnvironment[t]},t.prototype.getFunctor=function(t){if(this.functorEnvironment.hasOwnProperty(t))return this.functorEnvironment[t]},t.prototype.setValue=function(t,e,n){this.valueEnvironment[t]=[e,n]},t.prototype.setType=function(t,e){this.typeEnvironment[t]=e},t.prototype.setStructure=function(t,e){this.structureEnvironment[t]=e},t.prototype.setSignature=function(t,e){this.signatureEnvironment[t]=e},t.prototype.setFunctor=function(t,e){this.functorEnvironment[t]=e},t.prototype.extend=function(t){for(var e in t.typeEnvironment)t.typeEnvironment.hasOwnProperty(e)&&(this.typeEnvironment[e]=t.typeEnvironment[e]);for(var e in t.valueEnvironment)t.valueEnvironment.hasOwnProperty(e)&&(this.valueEnvironment[e]=t.valueEnvironment[e]);for(var e in t.structureEnvironment)t.structureEnvironment.hasOwnProperty(e)&&(this.structureEnvironment[e]=t.structureEnvironment[e]);for(var e in t.signatureEnvironment)t.signatureEnvironment.hasOwnProperty(e)&&(this.signatureEnvironment[e]=t.signatureEnvironment[e]);for(var e in t.functorEnvironment)t.functorEnvironment.hasOwnProperty(e)&&(this.functorEnvironment[e]=t.functorEnvironment[e]);return this},t.prototype.restrict=function(e){var n=new t({},{},{},this.signatureEnvironment,this.functorEnvironment);for(var i in e.typeInterface)if(e.typeInterface.hasOwnProperty(i)&&this.typeEnvironment.hasOwnProperty(i)){for(var r=new Set,o=[],s=0;s<this.typeEnvironment[i].length;++s)r=r.add(this.typeEnvironment[i][s]);for(s=0;s<e.typeInterface[i].length;++s)r.has(e.typeInterface[i][s])&&o.push(e.typeInterface[i][s]);n.typeEnvironment[i]=o}for(var i in e.valueInterface)e.valueInterface.hasOwnProperty(i)&&this.valueEnvironment.hasOwnProperty(i)&&(n.valueEnvironment[i]=[this.valueEnvironment[i][0],e.valueInterface[i]]);for(var i in e.structureInterface)e.structureInterface.hasOwnProperty(i)&&this.structureEnvironment.hasOwnProperty(i)&&(n.structureEnvironment[i]=this.structureEnvironment[i].restrict(e.structureInterface[i]));return n},t}();e.DynamicBasis=c;var h=function(){function t(t,e,n,i,r){this.typeEnvironment=t,this.valueEnvironment=e,this.structureEnvironment=n,this.signatureEnvironment=i,this.functorEnvironment=r}return t.prototype.getValue=function(t){if(this.valueEnvironment.hasOwnProperty(t))return this.valueEnvironment[t]},t.prototype.getType=function(t){if(this.typeEnvironment.hasOwnProperty(t))return this.typeEnvironment[t]},t.prototype.getStructure=function(t){if(this.structureEnvironment.hasOwnProperty(t))return this.structureEnvironment[t]},t.prototype.getSignature=function(t){if(this.signatureEnvironment.hasOwnProperty(t))return this.signatureEnvironment[t]},t.prototype.getFunctor=function(t){if(this.functorEnvironment.hasOwnProperty(t))return this.functorEnvironment[t]},t.prototype.setValue=function(t,e,n){this.valueEnvironment[t]=[e,n]},t.prototype.deleteValue=function(t){this.valueEnvironment[t]=void 0},t.prototype.setType=function(t,e,n,i,r){this.typeEnvironment[t]=new s(e,n,i,r)},t.prototype.setStructure=function(t,e){this.structureEnvironment[t]=e},t.prototype.setSignature=function(t,e){this.signatureEnvironment[t]=e},t.prototype.setFunctor=function(t,e){this.functorEnvironment[t]=e},t.prototype.extend=function(t){for(var e in t.typeEnvironment)t.typeEnvironment.hasOwnProperty(e)&&(this.typeEnvironment[e]=t.typeEnvironment[e]);for(var e in t.valueEnvironment)t.valueEnvironment.hasOwnProperty(e)&&(this.valueEnvironment[e]=t.valueEnvironment[e]);for(var e in t.structureEnvironment)t.structureEnvironment.hasOwnProperty(e)&&(this.structureEnvironment[e]=t.structureEnvironment[e]);for(var e in t.signatureEnvironment)t.signatureEnvironment.hasOwnProperty(e)&&(this.signatureEnvironment[e]=t.signatureEnvironment[e]);for(var e in t.functorEnvironment)t.functorEnvironment.hasOwnProperty(e)&&(this.functorEnvironment[e]=t.functorEnvironment[e]);return this},t}();e.StaticBasis=h;var f=function(){function t(t,e,n,i,r,o,s,a,u,p,c,h,f){void 0===s&&(s=[0,new Map]),void 0===a&&(a={}),void 0===u&&(u={}),void 0===p&&(p=[]),void 0===c&&(c=!1),void 0===h&&(h=!1),void 0===f&&(f=[]),this.id=t,this.parent=e,this.staticBasis=n,this.dynamicBasis=i,this.memory=r,this.exceptionEvalId=o,this.freeTypeVariables=s,this.infixEnvironment=a,this.valueIdentifierId=u,this.warns=p,this.insideLocalDeclBody=c,this.localDeclStart=h,this.loadedModules=f}return t.allowsRebind=function(t){return void 0==={true:!1,false:!1,nil:!1,"::":!1,"=":!1,ref:!1,":=":!1,"!":!1}[t]},t.prototype.getNestedState=function(e){void 0===e&&(e=void 0),void 0===e&&(e=this.id+1);var n=new t(e,this,new h({},{},{},{},{}),new c({},{},{},{},{}),[this.memory[0],{}],this.exceptionEvalId,[this.freeTypeVariables[0],new Map]);n.insideLocalDeclBody=this.insideLocalDeclBody;for(var i=0,r=this.loadedModules;i<r.length;i++){var o=r[i];n.loadedModules.push(o)}return n},t.prototype.hasModule=function(t){for(var e=0,n=this.loadedModules;e<n.length;e++){if(n[e]===t)return!0}return!1},t.prototype.registerModule=function(t){this.loadedModules.push(t)},t.prototype.getIdChanges=function(t){if(this.id<=t)return{};var e={};for(var n in void 0!==this.parent&&(e=this.parent.getIdChanges(t)),this.valueIdentifierId)this.valueIdentifierId.hasOwnProperty(n)&&(e[n]=this.valueIdentifierId[n]);return e},t.prototype.getMemoryChanges=function(t){if(this.id<=t)return[];var e=[];for(var n in void 0!==this.parent&&(e=this.parent.getMemoryChanges(t)),this.memory[1])this.memory[1].hasOwnProperty(n)&&e.push([+n,this.memory[1][n]]);return e},t.prototype.getDynamicChanges=function(t){if(this.id<=t)return new c({},{},{},{},{});var e=new c({},{},{},{},{});return void 0!==this.parent&&(e=this.parent.getDynamicChanges(t)),e=e.extend(this.dynamicBasis)},t.prototype.getDynamicLocalDeclChanges=function(t){if(this.id<=t||this.localDeclStart)return new c({},{},{},{},{});var e=new c({},{},{},{},{});return void 0!==this.parent&&(e=this.parent.getDynamicLocalDeclChanges(t)),e=e.extend(this.dynamicBasis)},t.prototype.getStaticChanges=function(t){if(this.id<=t)return new h({},{},{},{},{});var e=new h({},{},{},{},{});return void 0!==this.parent&&(e=this.parent.getStaticChanges(t)),e=e.extend(this.staticBasis)},t.prototype.getCell=function(t){return void 0!==this.memory[1][t]?this.memory[1][t]:void 0===this.parent?void 0:this.parent.getCell(t)},t.prototype.getTypeVariableBinds=function(t){void 0===t&&(t=0);var e=this.freeTypeVariables;if(void 0===this.parent||this.parent.id<t){var n=new Map;return e[1].forEach(function(t,e){n.set(e,t)}),[e[0],n]}var i=this.parent.getTypeVariableBinds(t);return e[1].forEach(function(t,e){i[1].set(e,t)}),[Math.max(e[0],i[0]),i[1]]},t.prototype.getStaticValue=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getValue(t);return void 0!==n||void 0===this.parent||this.parent.id<e?void 0!==n?[n[0],n[1]]:n:this.parent.getStaticValue(t,e)},t.prototype.getStaticType=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getType(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticType(t,e)},t.prototype.getStaticStructure=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getStructure(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticStructure(t,e)},t.prototype.getAndResolveStaticStructure=function(t,e){void 0===e&&(e=0);var n=void 0;if(0===t.qualifiers.length)throw new o.EvaluationError(t.position,"Unqualified LongIdentifierToken are too unqualified to be useful here.");n=this.getStaticStructure(t.qualifiers[0].getText(),e);for(var i=1;i<t.qualifiers.length;++i){if(void 0===n)return n;n=n.getStructure(t.qualifiers[i].getText())}return n},t.prototype.getStaticSignature=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getSignature(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticSignature(t,e)},t.prototype.getStaticFunctor=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getFunctor(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticFunctor(t,e)},t.prototype.getDynamicValue=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getValue(t);return void 0!==n||void 0===this.parent||this.parent.id<e?void 0!==n?[n[0],n[1]]:n:this.parent.getDynamicValue(t,e)},t.prototype.getDynamicType=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getType(t);return void 0!==n||void 0===this.parent||this.parent.id<e?void 0!==n?[n[0],n[1]]:n:this.parent.getDynamicType(t,e)},t.prototype.getDynamicStructure=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getStructure(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicStructure(t,e)},t.prototype.getAndResolveDynamicStructure=function(t,e){void 0===e&&(e=0);var n=void 0;if(0===t.qualifiers.length)throw new o.EvaluationError(t.position,"Unqualified LongIdentifierToken are too unqualified to be useful here.");n=this.getDynamicStructure(t.qualifiers[0].getText(),e);for(var i=1;i<t.qualifiers.length;++i){if(void 0===n)return n;n=n.getStructure(t.qualifiers[i].getText())}return n},t.prototype.getDynamicSignature=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getSignature(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicSignature(t,e)},t.prototype.getDynamicFunctor=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getFunctor(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicFunctor(t,e)},t.prototype.getInfixStatus=function(t,e){if(void 0===e&&(e=0),t.isVid()||t instanceof r.LongIdentifierToken)return this.infixEnvironment.hasOwnProperty(t.getText())||!this.parent||this.parent.id<e?this.infixEnvironment[t.getText()]:this.parent.getInfixStatus(t,e);throw new o.InternalInterpreterError(t.position,'You gave me some "'+t.getText()+'" ('+t.constructor.name+") but I only want (Long)IdentifierToken.")},t.prototype.getValueIdentifierId=function(t,e){return void 0===e&&(e=0),this.valueIdentifierId.hasOwnProperty(t)?this.valueIdentifierId[t]:!this.parent||this.parent.id<e?0:this.parent.getValueIdentifierId(t,e)},t.prototype.getWarnings=function(){return this.warns},t.prototype.incrementValueIdentifierId=function(t,e){if(void 0===e&&(e=void 0),void 0===e||this.id===e)this.valueIdentifierId[t]=this.getValueIdentifierId(t,e)+1;else{if(e>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+e+'" does not exist.');this.parent.incrementValueIdentifierId(t,e)}},t.prototype.setCell=function(t,e){t>=this.memory[0]&&(this.memory[0]=t+1),this.memory[1][t]=e},t.prototype.setNewCell=function(t){return this.memory[1][this.memory[0]]=t,new i.ReferenceValue(this.memory[0]++)},t.prototype.getNextExceptionEvalId=function(){return this.exceptionEvalId++},t.prototype.deleteStaticValue=function(t){this.staticBasis.deleteValue(t),void 0!==this.parent&&this.parent.deleteStaticValue(t)},t.prototype.setStaticValue=function(t,e,n,i){if(void 0===i&&(i=void 0),void 0===i||i===this.id)this.staticBasis.setValue(t,e,n);else{if(i>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+i+'" does not exist.');this.parent.setStaticValue(t,e,n,i)}},t.prototype.setStaticType=function(t,e,n,i,r,s){if(void 0===s&&(s=void 0),void 0===s||s===this.id)this.staticBasis.setType(t,e,n,i,r);else{if(s>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+s+'" does not exist.');this.parent.setStaticType(t,e,n,i,r,s)}},t.prototype.setStaticStructure=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.staticBasis.setStructure(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setStaticStructure(t,e,n)}},t.prototype.setStaticSignature=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.staticBasis.setSignature(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setStaticSignature(t,e,n)}},t.prototype.setStaticFunctor=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.staticBasis.setFunctor(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setStaticFunctor(t,e,n)}},t.prototype.setDynamicValue=function(t,e,n,i){if(void 0===i&&(i=void 0),void 0===i||i===this.id)this.dynamicBasis.setValue(t,e,n);else{if(i>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+i+'" does not exist.');this.parent.setDynamicValue(t,e,n,i)}},t.prototype.setDynamicType=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setType(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setDynamicType(t,e,n)}},t.prototype.setDynamicStructure=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setStructure(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setDynamicStructure(t,e,n)}},t.prototype.setDynamicSignature=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setSignature(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setDynamicSignature(t,e,n)}},t.prototype.setDynamicFunctor=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setFunctor(t,e);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setDynamicFunctor(t,e,n)}},t.prototype.setInfixStatus=function(t,e,n,i,s){if(void 0===s&&(s=void 0),void 0===s||s===this.id)(t.isVid()||t instanceof r.LongIdentifierToken)&&(this.infixEnvironment[t.getText()]=new p(i,e,n));else{if(s>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+s+'" does not exist.');this.parent.setInfixStatus(t,e,n,i,s)}},t.prototype.setValueIdentifierId=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.valueIdentifierId[t]=e;else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setValueIdentifierId(t,e,n)}},t.prototype.addWarning=function(t,e){if(void 0===e&&(e=void 0),void 0===e||e===this.id)this.warns.push(t);else{if(e>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+e+'" does not exist.');this.parent.addWarning(t,e)}},t.prototype.setWarnings=function(t,e){if(void 0===e&&(e=void 0),void 0===e||e===this.id)this.warns=t;else{if(e>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+e+'" does not exist.');this.parent.setWarnings(t,e)}},t}();e.State=f},function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),s=function(){function t(){}return t.prototype.instantiate=function(t,e,n){throw void 0===n&&(n=new Set),new o.ElaborationError(-1,"I mustn't run away. I mustn't run away. I mustn't run away.")},t.prototype.merge=function(t,e,n){throw new o.ElaborationError(-1,"I don't know anything. But you know everything.")},t.prototype.makeEqType=function(t,e){throw new o.ElaborationError(-1,"I don't know everything. I just know what I know.")},t.prototype.getTypeVariables=function(t){throw void 0===t&&(t=!1),new o.ElaborationError(-1,"This is wrong.\nI said with a posed look.")},t.prototype.getOrderedTypeVariables=function(){throw new o.ElaborationError(-1,"You seem well today.\nDid something nice happen?")},t.prototype.replaceTypeVariables=function(t,e){throw void 0===e&&(e=new Set),new o.ElaborationError(-1,"あんたバカ?")},t.prototype.qualify=function(t,e){return this},t.prototype.propagate=function(t){return void 0===t&&(t=new Map),this},t.prototype.makeFree=function(){return this},t.prototype.simplify=function(){return this},t.prototype.isOpaque=function(){return!1},t.prototype.getOpaqueName=function(){return"undefined"},t.prototype.isResolved=function(){return!1},t.prototype.admitsEquality=function(t){return!1},t.prototype.flatten=function(t){return void 0===t&&(t=new Map),this},t.prototype.replace=function(t,e){return t.equals(this)?e:this},t.prototype.normalize=function(t,e){void 0===t&&(t=0),void 0===e&&(e={});for(var n=this.getOrderedTypeVariables(),i=this.getTypeVariables(!0),r=new Map,o=0,s=0,a=n;s<a.length;s++){var u=a[s];if(!r.has(u)){var p="",c=++o;if(i.has(u)&&(c=++t),c<=26)p=String.fromCharCode("a".charCodeAt(0)+c-1);else for(;c>0;){var h=--c%26;p=String.fromCharCode("a".charCodeAt(0)+h)+p,c=Math.floor(c/26)}var f="'";u.length>2&&"'"===u.charAt(1)&&(f+="'"),i.has(u)&&(f+="~"),f+=p,i.has(u)&&(f=f.toUpperCase()),r.set(u,f)}}var l=this.replaceTypeVariables(r);return!1!==e.strictMode&&(l=l.flatten(new Map)),[l,t]},t}();e.Type=s;var a=function(t){function e(){return t.call(this)||this}return r(e,t),e.prototype.isResolved=function(){return!0},e.prototype.toString=function(){return"any"},e.prototype.equals=function(t){return!0},e.prototype.instantiate=function(t,e,n){return void 0===n&&(n=new Set),this},e.prototype.merge=function(t,e,n){return[n,e]},e.prototype.makeEqType=function(t,e){return[this,e]},e.prototype.getTypeVariables=function(t){return void 0===t&&(t=!1),new Map},e.prototype.getOrderedTypeVariables=function(){return[]},e.prototype.replaceTypeVariables=function(t,e){return void 0===e&&(e=new Set),this},e}(s);e.AnyType=a;var u=function(t){function e(e,n,i){void 0===i&&(i=[]);var r=t.call(this)||this;return r.name=e,r.type=n,r.domain=i,r.isFree=!1,r}return r(e,t),e.prototype.isResolved=function(){return this.type.isResolved()},e.prototype.simplify=function(){var t=new e(this.name,this.type.simplify(),this.domain);return t.isFree=this.isFree,t},e.prototype.makeFree=function(){var t=new e(this.name,this.type.makeFree(),this.domain);return t.isFree=!0,t},e.prototype.flatten=function(t){if(this.domain.length>0)return t=t.set(this.name,this.domain[0]),this.type.flatten(t);var n=new e(this.name,this.type.flatten(t),this.domain);return n.isFree=this.isFree,n},e.prototype.qualify=function(t,n){var i=new e(this.name,this.type.qualify(t,n),this.domain);return i.isFree=this.isFree,i},e.prototype.propagate=function(t){void 0===t&&(t=new Map),this.domain.length>0&&(t=t.set(this.name,this.domain));var n=new e(this.name,this.type.propagate(t),this.domain);return n.isFree=this.isFree,n},e.prototype.isOpaque=function(){return this.type.isOpaque()},e.prototype.getOpaqueName=function(){return this.type.getOpaqueName()},e.prototype.instantiate=function(t,n){var i=new e(this.name,this.type.instantiate(t,n),this.domain);return i.isFree=this.isFree,i},e.prototype.toString=function(){for(var t=new Set,n=new Set,i=this;i instanceof e;)i.isFree?t=t.add([i.name,i.domain]):n=n.add([i.name,i.domain]),i=i.type;var r="";return n.size>0&&(r+="∀",n.forEach(function(t){if(r+=" "+t[0],t[1].length>0){r+=" ∈ {";for(var e=0;e<t[1].length;++e)e>0&&(r+=", "),r+=t[1][e];r+="}"}}),r+=" . "),r+=i,t.size>0&&(r+=",",t.forEach(function(t){if(r+=" "+t[0],t[1].length>0){r+=" ∈ {";for(var e=0;e<t[1].length;++e)e>0&&(r+=", "),r+=t[1][e];r+="}"}}),r+=" free"),r},e.prototype.getTypeVariables=function(t){var e=this;void 0===t&&(t=!1);var n=this.type.getTypeVariables(t),i=new Map;return n.forEach(function(n,r){r===e.name&&t!==e.isFree||(i=i.has(r)?i.set(r,p.mergeDomain(n,i.get(r))):i.set(r,n))}),t&&this.isFree&&!i.has(this.name)&&(i=i.set(this.name,this.domain)),i},e.prototype.getOrderedTypeVariables=function(){return[this.name].concat(this.type.getOrderedTypeVariables())},e.prototype.replaceTypeVariables=function(t,n){if(void 0===n&&(n=new Set),t.has(this.name)){var i=new e(t.get(this.name),this.type.replaceTypeVariables(t,n),this.domain);return n.has(this.name)?i.isFree=!0:i.isFree=this.isFree,i}return(i=new e(this.name,this.type.replaceTypeVariables(t,n),this.domain)).isFree=this.isFree,i},e.prototype.equals=function(t){return t instanceof e&&t.name===this.name&&t.type.equals(this.type)},e}(s);e.TypeVariableBind=u;var p=function(t){function e(e,n,i){void 0===n&&(n=0),void 0===i&&(i=[]);var r=t.call(this)||this;return r.name=e,r.position=n,r.domain=i,r.isFree=!1,r}return r(e,t),e.mergeDomain=function(t,e){if(0===t.length)return e;if(0===e.length)return t;for(var n=[],i=0,r=t;i<r.length;i++)for(var o=r[i],s=0,a=e;s<a.length;s++){var u=a[s];o.equals(u)&&n.push(o)}return n},e.prototype.isResolved=function(){return!0},e.prototype.makeFree=function(){var t=new e(this.name,this.position,this.domain);return t.isFree=!0,t},e.prototype.flatten=function(t){return this.domain.length>0?(t=t.set(this.name,this.domain[0]),this.domain[0]):t.has(this.name)?t.get(this.name):this},e.prototype.propagate=function(t){void 0===t&&(t=new Map);var n=[];t.has(this.name)&&(n=t.get(this.name));var i=new e(this.name,this.position,n);return i.isFree=this.isFree,i},e.prototype.toString=function(){return this.name},e.prototype.instantiate=function(t,e,n){if(void 0===n&&(n=new Set),!e.has(this.name))return this;if(n.has(this.name))throw new o.ElaborationError(-1,'Type clash. An expression of type "'+this.normalize()[0]+'" cannot have type "'+e.get(this.name)[0].normalize()[0]+'" because of circularity.');var i=new Set;return n.forEach(function(t){i.add(t)}),i.add(this.name),e.get(this.name)[0].instantiate(t,e,i)},e.prototype.merge=function(t,n,i){if(i instanceof a)return[this,n];var r=this.instantiate(t,n);if(r instanceof e){var s=i.instantiate(t,n);if(s instanceof e){if(r.name===s.name){var u=e.mergeDomain(r.domain,s.domain);if(0===u.length&&r.domain.length+s.domain.length>0)throw['Cannot merge domains of "'+r.normalize(0,{strictMode:!1})[0]+'" and "'+i.normalize(0,{strictMode:!1})[0]+'" ({'+r.domain+"} and {"+s.domain+"})"];var p=new e(r.name,r.position,u);return p.isFree=r.isFree&&s.isFree,[p,n]}var c=new Map,h=r;if(r.name<s.name?(r.domain=e.mergeDomain(r.domain,s.domain),c.set(s.name,r.name)):(s.domain=e.mergeDomain(r.domain,s.domain),c.set(r.name,s.name),h=s),0===h.domain.length&&r.domain.length+s.domain.length>0)throw['Cannot merge domains of "'+this.normalize(0,{strictMode:!1})[0]+'" and "'+i.normalize(0,{strictMode:!1})[0]+'". ({'+r.domain+"} and {"+s.domain+"})"];var f=new Map;n.forEach(function(t,e){f=f.set(e,[t[0].replaceTypeVariables(c),t[1]])}),h.isFree=r.isFree&&s.isFree,r.name<s.name?f.set(s.name,[r,h.isFree]):f.set(r.name,[s,h.isFree]);var l=h.domain;return f.has("$"+r.name)&&(l=e.mergeDomain(l,f.get("$"+r.name)[0].domain)),f.has("$"+s.name)&&(l=e.mergeDomain(l,f.get("$"+s.name)[0].domain)),f.set("$"+r.name,[new e(r.name,-1,l),h.isFree]),f.set("$"+s.name,[new e(s.name,-1,l),h.isFree]),[h,f]}if(s.getTypeVariables().has(r.name))throw new o.ElaborationError(-1,'Type clash. An expression of type "'+r.normalize()[0]+'" cannot have type "'+s.normalize()[0]+'" because of circularity.');if(r.isFree&&(s=s.makeFree()),r.admitsEquality(t)&&!s.admitsEquality(t)){var d=s.makeEqType(t,n);if(!d[0].admitsEquality(t))throw['Type "'+s.normalize()[0]+'" does not admit equality.',r,s];s=d[0],n=d[1]}if(r.domain.length>0&&0===e.mergeDomain(r.domain,[s]).length)throw['Type "'+s.normalize(0,{strictMode:!1})[0]+'" is not part of the domain of "'+r.normalize(0,{strictMode:!1})[0]+'" ({'+r.domain+"})."];return[s,n.set(r.name,[s,r.isFree])]}return r.merge(t,n,i)},e.prototype.makeEqType=function(t,n){if(this.admitsEquality(t))return[this,n];if(n.has(this.name)){var i=n.get(this.name)[0].makeEqType(t,n);n=i[1];var r=new e("'"+this.name,this.position,this.domain);r.isFree=this.isFree,n=n.set(r.name,[i[0],r.isFree])}var o=new e("'"+this.name,this.position,this.domain);return[o,n.set(this.name,[o,this.isFree])]},e.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;return t&&!this.isFree||(e=e.set(this.name,this.domain)),e},e.prototype.getOrderedTypeVariables=function(){return[this.name]},e.prototype.replaceTypeVariables=function(t,n){if(void 0===n&&(n=new Set),t.has(this.name)){var i=new e(t.get(this.name),0,this.domain);return n.has(this.name)?i.isFree=!0:i.isFree=this.isFree,i}return this},e.prototype.admitsEquality=function(t){return"'"===this.name[1]},e.prototype.equals=function(t){return t instanceof a||t instanceof e&&this.name===t.name},e}(s);e.TypeVariable=p;var c=function(t){function e(e,n,i){void 0===n&&(n=!0),void 0===i&&(i=0);var r=t.call(this)||this;return r.elements=e,r.complete=n,r.position=i,r}return r(e,t),e.prototype.isResolved=function(){if(!this.complete)return!1;var t=!0;return this.elements.forEach(function(e,n){t=t&&e.isResolved()}),t},e.prototype.makeFree=function(){var t=new Map;return this.elements.forEach(function(e,n){t.set(n,e.makeFree())}),new e(t,this.complete,this.position)},e.prototype.replace=function(t,n){if(t.equals(this))return n;var i=new Map;return this.elements.forEach(function(e,r){i.set(r,e.replace(t,n))}),new e(i,this.complete,this.position)},e.prototype.flatten=function(t){var n=new Map;return this.elements.forEach(function(e,i){n.set(i,e.flatten(t))}),new e(n,this.complete,this.position)},e.prototype.instantiate=function(t,n,i){void 0===i&&(i=new Set);var r=new Map;return this.elements.forEach(function(e,o){r.set(o,e.instantiate(t,n,i))}),new e(r,this.complete,this.position)},e.prototype.qualify=function(t,n){var i=new Map;return this.elements.forEach(function(e,r){i.set(r,e.qualify(t,n))}),new e(i,this.complete,this.position)},e.prototype.propagate=function(t){void 0===t&&(t=new Map);var n=new Map;return this.elements.forEach(function(e,i){n.set(i,e.propagate(t))}),new e(n,this.complete,this.position)},e.prototype.merge=function(t,n,i){var r=this;if(i instanceof p||i instanceof a)return i.merge(t,n,this);if((i=i.instantiate(t,n))instanceof e){if(!this.complete&&i.complete)return i.merge(t,n,this);var o=new Map,s=n;return i.elements.forEach(function(e,n){if(r.complete&&!r.elements.has(n))throw["Records don't agree on members (\""+n+'" occurs only once.)',r.instantiate(t,s),i.instantiate(t,s)];if(r.elements.has(n)){var a=e.merge(t,s,r.elements.get(n));o=o.set(n,a[0]),s=a[1]}else o=o.set(n,e.instantiate(t,s))}),i.complete?this.elements.forEach(function(e,n){if(!i.elements.has(n))throw["Records don't agree on members (\""+n+'" occurs only once.)',r.instantiate(t,s),i.instantiate(t,s)]}):this.elements.forEach(function(e,n){o=o.set(n,e.instantiate(t,s))}),[new e(o,this.complete||i.complete,this.position),s]}throw['Cannot merge "'+this.instantiate(t,n).normalize()[0]+'" and "'+i.instantiate(t,n).normalize()[0]+'".',this.constructor.name,i.constructor.name]},e.prototype.makeEqType=function(t,n){var i=new Map;return this.elements.forEach(function(e,r){var o=e.makeEqType(t,n);i.set(r,o[0]),n=o[1]}),[new e(i,this.complete,this.position),n]},e.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;return this.elements.forEach(function(n){n.getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,p.mergeDomain(t,e.get(n))):e.set(n,t)})}),e},e.prototype.getOrderedTypeVariables=function(){var t=[];return this.elements.forEach(function(e){t=t.concat(e.getOrderedTypeVariables())}),t},e.prototype.replaceTypeVariables=function(t,n){void 0===n&&(n=new Set);var i=new Map;return this.elements.forEach(function(e,r){i=i.set(r,e.replaceTypeVariables(t,n))}),new e(i,this.complete,0)},e.prototype.getType=function(t){if(!this.elements.has(t))throw new o.ElaborationError(0,"Tried accessing non-existing record part.");return this.elements.get(t)},e.prototype.hasType=function(t){return this.elements.has(t)},e.prototype.admitsEquality=function(t){var e=!0;return this.elements.forEach(function(n,i){n.admitsEquality(t)||(e=!1)}),e},e.prototype.toString=function(){for(var t=1!==this.elements.size,n=1;n<=this.elements.size;++n)this.elements.has(""+n)||(t=!1);if(t){if(0===this.elements.size)return"unit";var i="";for(n=1;n<=this.elements.size;++n){n>1&&(i+=" * ");var r=this.elements.get(""+n);r instanceof h||r instanceof e&&0!==r.elements.size?i+="("+r+")":i+=r}return i+""}var o="{",s=!0;return this.elements.forEach(function(t,e){s?s=!1:o+=", ",o+=e+": "+t}),this.complete||(s||(o+=", "),o+="..."),o+"}"},e.prototype.simplify=function(){var t=new Map;return this.elements.forEach(function(e,n){t.set(n,e.simplify())}),new e(t,this.complete,this.position)},e.prototype.equals=function(t){var n=this;if(t instanceof a)return!0;if(!(t instanceof e)||this.complete!==t.complete)return!1;var i=!0;return this.elements.forEach(function(e,n){e.equals(t.elements.get(n))||(i=!1)}),t.elements.forEach(function(t,e){t.equals(n.elements.get(e))||(i=!1)}),i},e}(s);e.RecordType=c;var h=function(t){function e(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.parameterType=e,r.returnType=n,r.position=i,r}return r(e,t),e.prototype.isResolved=function(){return this.parameterType.isResolved()&&this.returnType.isResolved()},e.prototype.makeFree=function(){return new e(this.parameterType.makeFree(),this.returnType.makeFree(),this.position)},e.prototype.flatten=function(t){return new e(this.parameterType.flatten(t),this.returnType.flatten(t),this.position)},e.prototype.replace=function(t,n){return this.equals(t)?n:new e(this.parameterType.replace(t,n),this.returnType.replace(t,n),this.position)},e.prototype.instantiate=function(t,n,i){return void 0===i&&(i=new Set),new e(this.parameterType.instantiate(t,n,i),this.returnType.instantiate(t,n,i),this.position)},e.prototype.qualify=function(t,n){return new e(this.parameterType.qualify(t,n),this.returnType.qualify(t,n),this.position)},e.prototype.propagate=function(t){return void 0===t&&(t=new Map),new e(this.parameterType.propagate(t),this.returnType.propagate(t),this.position)},e.prototype.merge=function(t,n,i){if(i instanceof p||i instanceof a)return i.merge(t,n,this);var r=i.instantiate(t,n);if(r instanceof e){var o=this.parameterType.merge(t,n,r.parameterType),s=this.returnType.merge(t,o[1],r.returnType);return[new e(o[0],s[0],this.position),s[1]]}throw['Cannot merge "'+this.instantiate(t,n).normalize()[0]+'" and "'+i.instantiate(t,n).normalize()[0]+'".',this.constructor.name,i.constructor.name]},e.prototype.makeEqType=function(t,e){return[this,e]},e.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;return this.parameterType.getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,p.mergeDomain(t,e.get(n))):e.set(n,t)}),this.returnType.getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,p.mergeDomain(t,e.get(n))):e.set(n,t)}),e},e.prototype.getOrderedTypeVariables=function(){var t=[];return t=(t=t.concat(this.parameterType.getOrderedTypeVariables())).concat(this.returnType.getOrderedTypeVariables())},e.prototype.replaceTypeVariables=function(t,n){return void 0===n&&(n=new Set),new e(this.parameterType.replaceTypeVariables(t,n),this.returnType.replaceTypeVariables(t,n),0)},e.prototype.admitsEquality=function(t){return!1},e.prototype.toString=function(){return this.parameterType instanceof e?"("+this.parameterType+") → "+this.returnType:this.parameterType+" → "+this.returnType},e.prototype.simplify=function(){return new e(this.parameterType.simplify(),this.returnType.simplify(),this.position)},e.prototype.equals=function(t){return t instanceof a||t instanceof e&&this.parameterType.equals(t.parameterType)&&this.returnType.equals(t.returnType)},e}(s);e.FunctionType=h;var f=function(t){function e(e,n,i,r,o,s){void 0===n&&(n=[]),void 0===i&&(i=0),void 0===r&&(r=void 0),void 0===o&&(o=!1),void 0===s&&(s=0);var a=t.call(this)||this;return a.name=e,a.typeArguments=n,a.position=i,a.qualifiedName=r,a.opaque=o,a.id=s,a}return r(e,t),e.prototype.isResolved=function(){for(var t=0;t<this.typeArguments.length;++t)if(!this.typeArguments[t].isResolved())return!1;return!0},e.prototype.isOpaque=function(){return this.opaque},e.prototype.getOpaqueName=function(){return this.isOpaque?this.name:"undefined"},e.prototype.makeFree=function(){for(var t=[],n=0;n<this.typeArguments.length;++n)t.push(this.typeArguments[n].makeFree());return new e(this.name,t,this.position,this.qualifiedName,this.opaque,this.id)},e.prototype.replace=function(t,n){if(this.equals(t))return n;for(var i=[],r=0;r<this.typeArguments.length;++r)i.push(this.typeArguments[r].replace(t,n));return new e(this.name,i,this.position,this.qualifiedName,this.opaque,this.id)},e.prototype.flatten=function(t){for(var n=[],i=0;i<this.typeArguments.length;++i)n.push(this.typeArguments[i].flatten(t));return new e(this.name,n,this.position,this.qualifiedName,this.opaque,this.id)},e.prototype.qualify=function(t,n){for(var i=[],r=0;r<this.typeArguments.length;++r)i.push(this.typeArguments[r].qualify(t,n));var o=new e(this.name,i,this.position,this.qualifiedName,this.opaque,this.id);return void 0!==t.getStaticType(this.name)&&(o.qualifiedName=n),o},e.prototype.propagate=function(t){void 0===t&&(t=new Map);for(var n=[],i=0;i<this.typeArguments.length;++i)n.push(this.typeArguments[i].propagate(t));return new e(this.name,n,this.position,this.qualifiedName,this.opaque,this.id)},e.prototype.instantiate=function(t,n,i){void 0===i&&(i=new Set);var r=t.getStaticType(this.name);if(void 0!==this.qualifiedName){var s=t.getAndResolveStaticStructure(this.qualifiedName);r=void 0!==s?s.getType(this.name):void 0}if(void 0!==r&&r.type instanceof h)try{var a=r.type.getTypeVariables(),u=1,p=new Map;a.forEach(function(t,e){p=p.set(e,"'*q"+u),++u});var c=r.type.replaceTypeVariables(p),f=this.merge(t,n,c.parameterType,!0),l=t.getNestedState(t.id);return l.setStaticType(this.name,c.returnType,[],-1,r.allowsEquality),c.returnType.instantiate(l,f[1])}catch(t){if(!(t instanceof Array))throw t;throw new o.ElaborationError(-1,'Instantiating "'+this.normalize()[0]+'" failed: '+t[0])}else{if(void 0===r){if(this.id>0)throw new o.ElaborationError(-1,'Unbound type "'+this.name+"/"+this.id+'".');throw new o.ElaborationError(-1,'Unbound type "'+this.name+'".')}if(void 0!==r&&r.type.isOpaque())this.opaque=!0;else{if(!(void 0===r||r.type instanceof e&&this.typeArguments.length===r.type.typeArguments.length))throw new o.ElaborationError(this.position,"Arity mismatch: "+this.normalize()[0]+" vs "+r.type.normalize()[0]+".");if(void 0!==r&&(!(r.type instanceof e)||this.id>r.type.id)){if(this.id>0)throw new o.ElaborationError(-1,'Unbound type "'+this.name+"/"+this.id+'".');throw new o.ElaborationError(-1,'Unbound type "'+this.name+'".')}}}for(var d=[],y=0;y<this.typeArguments.length;++y)d.push(this.typeArguments[y].instantiate(t,n,i));return new e(this.name,d,this.position,this.qualifiedName,this.opaque,this.id)},e.prototype.merge=function(t,n,i,r){if(void 0===r&&(r=!1),i instanceof p||i instanceof a)return i.merge(t,n,this);var o=this,s=i;if(!r){if(!((o=this.instantiate(t,n))instanceof e))return o.merge(t,n,i);s=i.instantiate(t,n)}var u=o;if(s instanceof e&&u.name===s.name&&u.id===s.id){for(var c=[],h=n,f=0;f<o.typeArguments.length;++f){var l=o.typeArguments[f].merge(t,h,s.typeArguments[f]);c.push(l[0]),h=l[1]}return[new e(u.name,c,u.position,u.qualifiedName,u.opaque,u.id),h]}throw['Cannot merge "'+this.instantiate(t,n).normalize()[0]+'" and "'+i.instantiate(t,n).normalize()[0]+'".',this.constructor.name,i.constructor.name]},e.prototype.makeEqType=function(t,n){var i=t.getStaticType(this.name);if(void 0!==this.qualifiedName){var r=t.getAndResolveStaticStructure(this.qualifiedName);i=void 0!==r?r.getType(this.name):void 0}if(void 0!==i&&!i.allowsEquality)return[this,n];for(var o=[],s=0;s<this.typeArguments.length;++s){var a=this.typeArguments[s].makeEqType(t,n);o.push(a[0]),n=a[1]}return[new e(this.name,o,this.position,this.qualifiedName,this.opaque,this.id),n]},e.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;if(this.typeArguments.length>0)for(var n=0;n<this.typeArguments.length;++n)this.typeArguments[n].getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,p.mergeDomain(t,e.get(n))):e.set(n,t)});return e},e.prototype.getOrderedTypeVariables=function(){for(var t=[],e=0;e<this.typeArguments.length;++e)t=t.concat(this.typeArguments[e].getOrderedTypeVariables());return t},e.prototype.replaceTypeVariables=function(t,n){for(var i=[],r=0;r<this.typeArguments.length;++r)i.push(this.typeArguments[r].replaceTypeVariables(t,n));return new e(this.name,i,0,this.qualifiedName,this.opaque,this.id)},e.prototype.admitsEquality=function(t){var n=t.getStaticType(this.name);if(void 0!==this.qualifiedName){var i=t.getAndResolveStaticStructure(this.qualifiedName);n=void 0!==i?i.getType(this.name):void 0}if(void 0===n)return!0;var r=t.getNestedState(t.id);r.setStaticType(this.name,this,[],this.typeArguments.length,!0);for(var o=0;o<this.typeArguments.length;++o)if(!this.typeArguments[o].admitsEquality(r))return!1;var s=function(i){var o=t.getStaticValue(n.constructors[i]);if(void 0===o)return"continue";for(var s=o[0];s instanceof u;)s=s.type;if(s instanceof e)return"continue";var a=s.parameterType,p=a.getTypeVariables(),c=new Map;return p.forEach(function(t,e){e.startsWith("''")||(c=c.set(e,"'"+e))}),(a=a.replaceTypeVariables(c)).admitsEquality(r)?void 0:{value:!1}};for(o=0;o<n.constructors.length;++o){var a=s(o);if("object"==typeof a)return a.value}return n.allowsEquality},e.prototype.toString=function(){var t="";(this.typeArguments.length>1||1===this.typeArguments.length&&(this.typeArguments[0]instanceof h||this.typeArguments[0]instanceof c&&"unit"!==this.typeArguments[0].toString()))&&(t+="(");for(var e=0;e<this.typeArguments.length;++e)e>0&&(t+=", "),t+=this.typeArguments[e];if((this.typeArguments.length>1||1===this.typeArguments.length&&(this.typeArguments[0]instanceof h||this.typeArguments[0]instanceof c&&"unit"!==this.typeArguments[0].toString()))&&(t+=")"),this.typeArguments.length>0&&(t+=" "),void 0!==this.qualifiedName)for(e=0;e<this.qualifiedName.qualifiers.length;++e)t+=this.qualifiedName.qualifiers[e].getText()+".";return t+=this.name,this.id>0&&(t+="/"+this.id),t},e.prototype.simplify=function(){for(var t=[],n=0;n<this.typeArguments.length;++n)t.push(this.typeArguments[n].simplify());return new e(this.name,t,this.position,this.qualifiedName,this.opaque,this.id)},e.prototype.equals=function(t){if(t instanceof a)return!0;if(!(t instanceof e)||this.name!==t.name||this.id!==t.id)return!1;for(var n=0;n<this.typeArguments.length;++n)if(!this.typeArguments[n].equals(t.typeArguments[n]))return!1;return!0},e}(s);e.CustomType=f;var l=function(t){function e(e,n){void 0===n&&(n=0);var i=t.call(this)||this;return i.elements=e,i.position=n,i}return r(e,t),e.prototype.toString=function(){for(var t="(",e=0;e<this.elements.length;++e)e>0&&(t+=" * "),t+=this.elements[e];return t+")"},e.prototype.simplify=function(){for(var t=new Map,e=0;e<this.elements.length;++e)t.set(""+(e+1),this.elements[e].simplify());return new c(t,!0,this.position)},e.prototype.equals=function(t){return this.simplify().equals(t)},e}(s);e.TupleType=l},function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=n(6),s=n(2),a=n(4),u=n(3),p=n(0),c=n(1),h=function(){function t(){}return t.prototype.elaborate=function(t,e,n,i,r){throw void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=!1),void 0===r&&(r={}),new p.InternalInterpreterError(-1,"Not yet implemented.")},t.prototype.evaluate=function(t,e){throw new p.InternalInterpreterError(-1,"Not yet implemented.")},t.prototype.toString=function(){throw new p.InternalInterpreterError(-1,"Not yet implemented.")},t.prototype.simplify=function(){throw new p.InternalInterpreterError(-1,"Not yet implemented.")},t.prototype.assertUniqueBinding=function(t,e){return new Set},t}();e.Declaration=h;var f=function(t){function e(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.typeVariableSequence=n,o.valueBinding=i,o.id=r,o}return r(e,t),e.prototype.assertUniqueBinding=function(t,e){for(var n=0;n<this.valueBinding.length;++n)this.valueBinding[n].pattern.assertUniqueBinding(t,e),this.valueBinding[n].expression.assertUniqueBinding(t,e);return new Set},e.prototype.simplify=function(){for(var t=[],n=0;n<this.valueBinding.length;++n)t.push(new b(this.valueBinding[n].position,this.valueBinding[n].isRecursive,this.valueBinding[n].pattern.simplify(),this.valueBinding[n].expression.simplify()));return new e(this.position,this.typeVariableSequence,t,this.id)},e.prototype.elaborate=function(t,e,n,i,r){for(var s=[],c=[],h=[],f=e,l=0;l<this.valueBinding.length;++l){if(this.valueBinding[l].isRecursive){for(var d=l;d<this.valueBinding.length;++d){for(var y=this.valueBinding[d].pattern;y instanceof o.TypedExpression;)y=y.expression;var v=y.name.getText();s.push([v,new a.TypeVariableBind("'a",new a.TypeVariableBind("'b",new a.FunctionType(new a.TypeVariable("'a"),new a.TypeVariable("'b"))))])}break}var w=this.valueBinding[l].getType(this.typeVariableSequence,t,f,n,i);h=h.concat(w[1]),f=w[2],n=w[3],t.valueIdentifierId=w[4];for(d=0;d<w[0].length;++d)c.push(w[0][d])}var m=t.getNestedState(t.id);for(d=0;d<s.length;++d){if(!(r&&!0===r.allowSuccessorML||s[d][1].isResolved()))throw new p.ElaborationError(this.position,"Unresolved record type. (Is that a goblin?)");m.setStaticValue(s[d][0],s[d][1],u.IdentifierStatus.VALUE_VARIABLE)}var g=h,T=new Map;f.forEach(function(t,e){T=T.set(e,t)});for(var E=n,x=m.valueIdentifierId,S=this.valueBinding.length-l+1,I=0;I<S*S+1;++I){h=g,f=new Map,T.forEach(function(t,e){f=f.set(e,t)}),n=E,m.valueIdentifierId=x;var k=!1;for(d=l;d<this.valueBinding.length;++d){w=this.valueBinding[d].getType(this.typeVariableSequence,m,f,n,i);h=h.concat(w[1]),f=w[2],n=w[3],m.valueIdentifierId=w[4];for(var V=0;V<w[0].length;++V){var b=m.getStaticValue(w[0][V][0]);if(void 0!==b&&b[0].normalize()[0].equals(w[0][V][1].normalize()[0])||(k=!0),!(r&&!0===r.allowSuccessorML||w[0][V][1].isResolved()))throw new p.ElaborationError(this.position,"Unresolved record type. (Is that a goblin?)");m.setStaticValue(w[0][V][0],w[0][V][1],u.IdentifierStatus.VALUE_VARIABLE)}}if(!k)break;if(I===S*S)throw new p.ElaborationError(this.position,"My brain trembles; too much circularity.")}for(d=0;d<c.length;++d){if(!(r&&!0===r.allowSuccessorML||c[d][1].isResolved()))throw new p.ElaborationError(this.position,"Unresolved record type. (Is that a goblin?)");m.setStaticValue(c[d][0],c[d][1],u.IdentifierStatus.VALUE_VARIABLE)}return[m,h,f,n]},e.prototype.evaluate=function(t,e){var n=t.state;void 0===t.step&&(t.result=[],t.recursives=[],t.isRec=!1,t.step=-1);var i=t.result,r=t.recursives,o=t.isRec,s=t.step;if(s>=0){var a=t.recResult;if(void 0===a)throw new p.InternalInterpreterError(-1,"How is this undefined? "+JSON.stringify(a));if(this.valueBinding[s].isRecursive&&(o=!0),a.hasThrown)return{newState:n,value:a.value,hasThrown:!0};var h=this.valueBinding[s].pattern.matches(n,a.value);if(void 0===h)return{newState:n,value:new c.ExceptionValue("Bind",void 0,0,1),hasThrown:!0};for(var f=0;f<h.length;++f)o?r.push(h[f]):i.push(h[f])}if(++s<this.valueBinding.length)return t.step=s,t.isRec=o,e.push({next:this,params:t}),void e.push({next:this.valueBinding[s].expression,params:{state:n,modifiable:t.modifiable,recResult:void 0}});var l=n.getNestedState(n.id);for(f=0;f<r.length;++f)r[f][1]instanceof c.FunctionValue?l.setDynamicValue(r[f][0],new c.FunctionValue(r[f][1].state,r,r[f][1].body),u.IdentifierStatus.VALUE_VARIABLE):l.setDynamicValue(r[f][0],r[f][1],u.IdentifierStatus.VALUE_VARIABLE);for(f=0;f<i.length;++f)l.setDynamicValue(i[f][0],i[f][1],u.IdentifierStatus.VALUE_VARIABLE);return{newState:l,value:void 0,hasThrown:!1}},e.prototype.toString=function(){for(var t="val <stuff>",e=0;e<this.valueBinding.length;++e)e>0&&(t+=" and"),t+=" "+this.valueBinding[e];return t+";"},e}(h);e.ValueDeclaration=f;var l=function(t){function e(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.typeBinding=n,r.id=i,r}return r(e,t),e.prototype.simplify=function(){for(var t=[],n=0;n<this.typeBinding.length;++n)t.push(new L(this.typeBinding[n].position,this.typeBinding[n].typeVariableSequence,this.typeBinding[n].name,this.typeBinding[n].type.simplify()));return new e(this.position,t,this.id)},e.prototype.elaborate=function(t,e,n,i,r){for(var o=0;o<this.typeBinding.length;++o){var s=t.getStaticType(this.typeBinding[o].name.getText());if(void 0!==s&&s.type instanceof a.CustomType)throw new p.ElaborationError(this.position,"Nnaaa~ Redefining types as aliases is not yet implemented.");t.setStaticType(this.typeBinding[o].name.getText(),new a.FunctionType(new a.CustomType(this.typeBinding[o].name.getText(),this.typeBinding[o].typeVariableSequence),this.typeBinding[o].type.instantiate(t,e)),[],this.typeBinding[o].typeVariableSequence.length,!0)}return[t,[],e,n]},e.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.typeBinding.length;++i)n.setDynamicType(this.typeBinding[i].name.getText(),[]);return{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){for(var t="type",e=0;e<this.typeBinding.length;++e)e>0&&(t+=" and"),t+=" <stuff> "+this.typeBinding[e].name.getText(),t+=" = "+this.typeBinding[e].type;return t+";"},e}(h);e.TypeDeclaration=l;var d=function(t){function e(e,n,i,r,o){void 0===r&&(r=0),void 0===o&&(o={});var s=t.call(this)||this;if(s.position=e,s.datatypeBinding=n,s.typeBinding=i,s.id=r,s.givenIds=o,void 0!==s.typeBinding)throw new p.FeatureDisabledError(s.position,'Who is "withtype"?');return s}return r(e,t),e.prototype.simplify=function(){for(var t=[],n=0;n<this.datatypeBinding.length;++n){for(var i=[],r=0;r<this.datatypeBinding[n].type.length;++r)void 0!==this.datatypeBinding[n].type[r][1]?i.push([this.datatypeBinding[n].type[r][0],this.datatypeBinding[n].type[r][1].simplify()]):i.push(this.datatypeBinding[n].type[r]);t.push(new B(this.datatypeBinding[n].position,this.datatypeBinding[n].typeVariableSequence,this.datatypeBinding[n].name,i))}return new e(this.position,t,void 0,this.id)},e.prototype.elaborate=function(t,e,n,i,r){for(var o=[],s=0;s<this.datatypeBinding.length;++s){for(var a=this.datatypeBinding[s].getType(t,i),c=0;c<a[0].length;++c){if(!u.State.allowsRebind(a[0][c][0]))throw new p.ElaborationError(this.position,'You simply cannot rebind "'+a[0][c][0]+'".');t.setStaticValue(a[0][c][0],a[0][c][1],u.IdentifierStatus.VALUE_CONSTRUCTOR),o.push(a[0][c][1])}t.setStaticType(a[2][0],a[1],a[2][1],this.datatypeBinding[s].typeVariableSequence.length,!0),t.incrementValueIdentifierId(a[2][0])}for(s=0;s<o.length;++s)o[s].instantiate(t,new Map);return[t,[],e,n]},e.prototype.evaluate=function(t,e){for(var n=t.state,i=t.modifiable,r=0;r<this.datatypeBinding.length;++r){for(var o=this.datatypeBinding[r].compute(n,i),s=0;s<o[0].length;++s){if(!u.State.allowsRebind(o[0][s][0]))throw new p.EvaluationError(this.position,'You simply cannot rebind "'+o[0][s][0]+'".');n.setDynamicValue(o[0][s][0],o[0][s][1],u.IdentifierStatus.VALUE_CONSTRUCTOR)}n.setDynamicType(o[1][0],o[1][1]),void 0===this.givenIds[o[1][0]]&&(i.incrementValueIdentifierId(o[1][0]),this.givenIds[o[1][0]]=n.getValueIdentifierId(o[1][0]))}return{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){for(var t="datatype",e=0;e<this.datatypeBinding.length;++e){e>0&&(t+=" and"),t+=" "+this.datatypeBinding[e].name.getText()+" =";for(var n=0;n<this.datatypeBinding[e].type.length;++n)n>0&&(t+=" |"),t+=" "+this.datatypeBinding[e].type[n][0].getText(),void 0!==this.datatypeBinding[e].type[n][1]&&(t+=" of "+this.datatypeBinding[e].type[n][1])}return t+";"},e}(h);e.DatatypeDeclaration=d;var y=function(t){function e(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.name=n,o.oldname=i,o.id=r,o}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n,i,r){var o=void 0;if(this.oldname instanceof s.LongIdentifierToken){var u=t.getAndResolveStaticStructure(this.oldname);void 0!==u&&(o=u.getType(this.oldname.id.getText()))}else o=t.getStaticType(this.oldname.getText());if(void 0===o)throw new p.ElaborationError(this.position,'The datatype "'+this.oldname.getText()+"\" doesn't exist.");var c=o.type.instantiate(t,e);return t.setStaticType(this.name.getText(),new a.FunctionType(new a.CustomType(this.name.getText(),c.typeArguments,0,this.oldname instanceof s.LongIdentifierToken?this.oldname:void 0),c),[],o.arity,o.allowsEquality),[t,[],e,n]},e.prototype.evaluate=function(t,e){var n=t.state,i=[];if(this.oldname instanceof s.LongIdentifierToken){var r=n.getAndResolveDynamicStructure(this.oldname);void 0!==r&&(i=r.getType(this.oldname.id.getText()))}else i=n.getDynamicType(this.oldname.getText());if(void 0===i)throw new p.EvaluationError(this.position,'The datatype "'+this.oldname.getText()+'" does not exist.');return n.setDynamicType(this.name.getText(),i),{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){return"datatype "+this.name.getText()+" = datatype "+this.oldname.getText()+";"},e}(h);e.DatatypeReplication=y;var v=function(t){function e(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.bindings=n,r.id=i,r}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.toString=function(){return"exception <stuff>;"},e.prototype.elaborate=function(t,e,n,i,r){var o=new Set;e.forEach(function(t,e){e.includes("!")&&(o=o.add(e.substring(1)))});for(var s=0;s<this.bindings.length;++s)t=this.bindings[s].elaborate(t,i,o,r);return[t,[],e,n]},e.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.bindings.length;++i)this.bindings[i].evaluate(n,t.modifiable);return{newState:n,value:void 0,hasThrown:!1}},e}(h);e.ExceptionDeclaration=v;var w=function(t){function e(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.declaration=n,o.body=i,o.id=r,o}return r(e,t),e.prototype.assertUniqueBinding=function(t,e){return this.declaration.assertUniqueBinding(t,e),this.body.assertUniqueBinding(t,e),new Set},e.prototype.simplify=function(){return new e(this.position,this.declaration.simplify(),this.body.simplify(),this.id)},e.prototype.elaborate=function(t,e,n,i,r){var o=[t.getNestedState(0).getNestedState(t.id),[],e,n],s=this.declaration.elaborate(o[0],e,n,!1,r);t.valueIdentifierId=s[0].getIdChanges(0);var a=s[0].getNestedState(t.id);return o=this.body.elaborate(a,s[2],s[3],i,r),a.parent=t,[o[0],s[1].concat(o[1]),o[2],o[3]]},e.prototype.evaluate=function(t,e){var n=t.state,i=t.modifiable;void 0===t.step&&(t.step=-1);var r=t.step;if(-1===r){var o=n.getNestedState(0),s=o.getNestedState(n.id);return o.insideLocalDeclBody||(o.localDeclStart=!0),t.nstate=s,t.step=r+1,e.push({next:this,params:t}),void e.push({next:this.declaration,params:{state:s,modifiable:i,recResult:void 0}})}if(0===r){if(void 0===(c=t.recResult)||void 0===c.newState)throw new p.InternalInterpreterError(-1,"How is this undefined?");var a=c.newState;return c.hasThrown?{newState:n,value:c.value,hasThrown:!0}:((s=a.getNestedState(n.id)).insideLocalDeclBody=!0,t.nstate=s,t.res=c,t.step=r+1,e.push({next:this,params:t}),void e.push({next:this.body,params:{state:s,modifiable:i,recResult:void 0}}))}var u=t.recResult,c=(s=t.nstate,t.res);if(void 0===u||void 0===c)throw new p.InternalInterpreterError(-1,"How is this undefined?");return s.parent=n,void 0!==u.newState&&(u.newState.insideLocalDeclBody=n.insideLocalDeclBody),u},e.prototype.toString=function(){var t="local "+this.declaration;return t+=" in "+this.body,t+=" end;"},e}(h);e.LocalDeclaration=w;var m=function(t){function e(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.names=n,r.id=i,r}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n,i,r){for(var o=0;o<this.names.length;++o){var a=void 0;if(this.names[o]instanceof s.LongIdentifierToken?void 0!==(a=t.getAndResolveStaticStructure(this.names[o]))&&(a=a.getStructure(this.names[o].id.getText())):a=t.getStaticStructure(this.names[o].getText()),void 0===a)throw new p.EvaluationError(this.position,'Undefined module "'+this.names[o].getText()+'".');t.staticBasis.extend(a)}return[t,[],e,n]},e.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.names.length;++i){var r=void 0;if(this.names[i]instanceof s.LongIdentifierToken?void 0!==(r=n.getAndResolveDynamicStructure(this.names[i]))&&(r=r.getStructure(this.names[i].id.getText())):r=n.getDynamicStructure(this.names[i].getText()),void 0===r)throw new p.EvaluationError(this.position,'Undefined module "'+this.names[i].getText()+'".');n.dynamicBasis.extend(r)}return{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){for(var t="open",e=0;e<this.names.length;++e)t+=" "+this.names[e].getText();return t+";"},e}(h);e.OpenDeclaration=m;var g=function(t){function e(e){void 0===e&&(e=0);var n=t.call(this)||this;return n.id=e,n}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n,i,r){return[t,[],e,n]},e.prototype.evaluate=function(t,e){return{newState:t.state,value:void 0,hasThrown:!1}},e.prototype.toString=function(){return" ;"},e}(h);e.EmptyDeclaration=g;var T=function(t){function e(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.declarations=n,r.id=i,r}return r(e,t),e.prototype.assertUniqueBinding=function(t,e){for(var n=0;n<this.declarations.length;++n)this.declarations[n].assertUniqueBinding(t,e);return new Set},e.prototype.simplify=function(){for(var t=[],n=0;n<this.declarations.length;++n)t.push(this.declarations[n].simplify());return new e(this.position,t,this.id)},e.prototype.elaborate=function(t,e,n,i,r){for(var o=this,s=[],a=e,u=n,c=function(n){i&&(a=new Map,t.getTypeVariableBinds()[1].forEach(function(t,e){a=a.set(e,t)}));var c=h.declarations[n].elaborate(t.getNestedState(h.declarations[n].id),a,u,i,r);t=c[0],s=s.concat(c[1]),a=c[2];var f=new Map;if(i&&(f=e),c[2].forEach(function(e,n){if(e[1]&&"~"===n[1]){var a=e[0].instantiate(t,c[2]).normalize(t.freeTypeVariables[0],r);t.parent.getTypeVariableBinds()[1].has(n)||s.push(new p.Warning(o.position,'The free type variable "'+n+'" has been instantiated to "'+a[0]+'".\n')),f=f.set(n,[a[0],!0])}else i||(f=f.set(n,[e[0].instantiate(t,c[2]),!1]))}),a=f,i)for(var l in t.freeTypeVariables[1]=f,t.staticBasis.valueEnvironment)if(t.staticBasis.valueEnvironment.hasOwnProperty(l)){var d=t.staticBasis.valueEnvironment[l],y=d[0].normalize(t.freeTypeVariables[0],r);t.freeTypeVariables[0]=y[1],t.setStaticValue(l,y[0],d[1])}u=c[3]},h=this,f=0;f<this.declarations.length;++f)c(f);return[t,s,a,u]},e.prototype.evaluate=function(t,e){var n=t.state;void 0===t.step&&(t.step=-1);var i=t.step;if(i>=0){var r=t.recResult;if(void 0===r||void 0===r.newState)throw new p.InternalInterpreterError(-1,"How is this undefined?");if(r.hasThrown)return{newState:r.newState,value:r.value,hasThrown:!0};n=r.newState}if(++i<this.declarations.length){var o=n.getNestedState(this.declarations[i].id);return t.step=i,t.state=n,e.push({next:this,params:t}),void e.push({next:this.declarations[i],params:{state:o,modifiable:t.modifiable,recResult:void 0}})}return{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){for(var t="",e=0;e<this.declarations.length;++e)e>0&&(t+=" "),t+=this.declarations[e];return t},e}(h);e.SequentialDeclaration=T;var E=function(t){function e(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.typeVariableSequence=n,o.functionValueBinding=i,o.id=r,o}return r(e,t),e.prototype.simplify=function(){for(var t=[],e=0;e<this.functionValueBinding.length;++e)t.push(this.functionValueBinding[e].simplify());return new f(this.position,this.typeVariableSequence,t,this.id)},e}(h);e.FunctionDeclaration=E;var x=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return r(e,t),e.prototype.simplify=function(){return new f(this.position,[],[new b(this.position,!1,new o.Tuple(-1,[]),this.expression)]).simplify()},e}(h);e.Evaluation=x;var S=function(t){function e(e,n,i,r,o){void 0===o&&(o=0);var s=t.call(this)||this;if(s.position=e,s.datatypeBinding=n,s.typeBinding=i,s.declaration=r,s.id=o,void 0!==s.typeBinding)throw new p.FeatureDisabledError(s.position,'Who is "withtype"?');return s}return r(e,t),e.prototype.simplify=function(){for(var t=new d(this.position,this.datatypeBinding,void 0,this.id),e=[],n=0;n<this.datatypeBinding.length;++n)e.push(new L(this.datatypeBinding[n].position,this.datatypeBinding[n].typeVariableSequence,this.datatypeBinding[n].name,new a.CustomType(this.datatypeBinding[n].name.getText(),this.datatypeBinding[n].typeVariableSequence)));var i=new l(this.position,e,this.id);return new w(this.position,t,new T(this.position,[i,this.declaration],this.id),this.id).simplify()},e}(h);e.AbstypeDeclaration=S;var I=function(t){function e(e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.operators=n,o.precedence=i,o.id=r,o}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n){return[t,[],e,n]},e.prototype.setInfixStatus=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],this.precedence,!1,!0)},e.prototype.evaluate=function(t,e){var n=t.state;return this.setInfixStatus(n),{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){var t="infix";t+=" "+this.precedence;for(var e=0;e<this.operators.length;++e)t+=" "+this.operators[e].getText();return t+";"},e}(h);e.InfixDeclaration=I;var k=function(t){function e(e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.operators=n,o.precedence=i,o.id=r,o}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n){return[t,[],e,n]},e.prototype.setInfixStatus=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],this.precedence,!0,!0)},e.prototype.evaluate=function(t,e){var n=t.state;return this.setInfixStatus(n),{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){var t="infixr";t+=" "+this.precedence;for(var e=0;e<this.operators.length;++e)t+=" "+this.operators[e].getText();return t+";"},e}(h);e.InfixRDeclaration=k;var V=function(t){function e(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.operators=n,r.id=i,r}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n){return[t,[],e,n]},e.prototype.setInfixStatus=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],0,!1,!1)},e.prototype.evaluate=function(t,e){var n=t.state;return this.setInfixStatus(n),{newState:n,value:void 0,hasThrown:!1}},e.prototype.toString=function(){for(var t="nonfix",e=0;e<this.operators.length;++e)t+=" "+this.operators[e].getText();return t+";"},e}(h);e.NonfixDeclaration=V;var b=function(){function t(t,e,n,i){this.position=t,this.isRecursive=e,this.pattern=n,this.expression=i}return t.prototype.toString=function(){var t="";return this.isRecursive&&(t+="rec "),t+=this.pattern,(t+=" = ")+this.expression},t.prototype.getType=function(t,e,n,i,r){var o=this,s=e.getNestedState(e.id),u=new Map;n.forEach(function(t,e){u=u.set(e,t)});var c=this.expression.getType(s,u,i),h=this.pattern.matchType(s,c[4],c[0]),f=new Set;if(void 0===h)throw new p.ElaborationError(this.position,'Type clash. An expression of type "'+c[0]+'" cannot be assigned to "'+h[1]+'".');for(var l=[],d=new Set,y=0;y<t.length;++y){if(d.has(t[y].name))throw new p.ElaborationError(t[y].position,'I will not let a duplicate type variable name "'+t[y].name+'" disturb my Happy Sugar Life.');d=d.add(t[y].name);var v=t[y].instantiate(e,h[2]);if(!(v instanceof a.TypeVariable)||v.domain.length>0||t[y].admitsEquality(e)!==v.admitsEquality(e))throw new p.ElaborationError(this.position,'Type clash. An expression of explicit type "'+t[y]+'" cannot have type "'+v.normalize()[0]+'".');l.push(v)}this.expression.getExplicitTypeVariables().forEach(function(t){var n=t.instantiate(e,h[2]);if(!(n instanceof a.TypeVariable)||n.domain.length>0||t.admitsEquality(e)!==n.admitsEquality(e))throw new p.ElaborationError(o.position,'Type clash. An expression of explicit type "'+t+'" cannot have type "'+n.normalize()[0]+'".')});var w=!this.isRecursive&&!this.expression.isSafe(e),m=!1,g=function(t){h[0][t][1]=h[0][t][1].instantiate(e,h[2]),r||(h[2]=h[2].set("'**"+h[0][t][0],[h[0][t][1],!1]));for(var n=h[0][t][1].getTypeVariables(),i=h[0][t][1].getTypeVariables(!0),o=new Set,s=l.length-1;s>=0;--s)if(n.has(l[s].name)){var u=n.get(l[s].name);h[2].has("$"+l[s].name)&&(u=a.TypeVariable.mergeDomain(u,h[2].get("$"+l[s].name)[0].domain)),h[0][t][1]=new a.TypeVariableBind(l[s].name,h[0][t][1],u),h[0][t][1].isFree=0===h[0][t][1].domain.length&&(w||i.has(l[s].name)),m=m||h[0][t][1].isFree,o.add(l[s].name)}l=[],h[0][t][1].getTypeVariables().forEach(function(t,e){if((r||!f.has(e))&&!o.has(e)){var n=t;h[2].has("$"+e)&&(n=a.TypeVariable.mergeDomain(n,h[2].get("$"+e)[0].domain)),l.push(new a.TypeVariable(e,0,n))}});for(s=l.length-1;s>=0;--s)h[0][t][1]=new a.TypeVariableBind(l[s].name,h[0][t][1],l[s].domain),h[0][t][1].isFree=0===h[0][t][1].domain.length&&(w||i.has(l[s].name)),m=m||h[0][t][1].isFree};for(y=0;y<h[0].length;++y)g(y);return m&&r&&c[1].push(new p.Warning(this.position,"Free type variables at top level.\n")),[h[0],c[1],h[2],c[2],c[5]]},t}();e.ValueBinding=b;var A=function(){function t(t,e,n){this.position=t,this.parameters=e,this.name=n}return t.prototype.simplify=function(){if(void 0===this.name)throw new p.InternalInterpreterError(this.position,"This function isn't ready to be simplified yet.");for(var t,e=[],n=[],i=0;i<this.parameters[0][0].length;++i)e.push(new o.ValueIdentifier(-1,new s.IdentifierToken("__arg"+i,-1)));for(i=0;i<this.parameters.length;++i){var r=void 0;r=1===this.parameters[i][0].length?this.parameters[i][0][0]:new o.Tuple(-1,this.parameters[i][0]),void 0===this.parameters[i][1]?n.push([r,this.parameters[i][2]]):n.push([r,new o.TypedExpression(-1,this.parameters[i][2],this.parameters[i][1])])}t=1!==e.length?new o.Tuple(-1,e).simplify():e[0];var a,u=new o.Match(-1,n);a=new o.CaseAnalysis(-1,t,u);for(i=this.parameters[0][0].length-1;i>=0;--i)a=new o.Lambda(-1,new o.Match(-1,[[new o.ValueIdentifier(-1,new s.IdentifierToken("__arg"+i,-1)),a]]));return new b(this.position,!0,this.name,a.simplify())},t.prototype.toString=function(){for(var t="",e=0;e<this.parameters.length;++e){e>0&&(t+=" | "),t+=this.name.name.getText();for(var n=0;n<this.parameters[e][0].length;++n)t+=" "+this.parameters[e][0][n];void 0!==this.parameters[e][1]&&(t+=": "+this.parameters[e][1]),t+=" = "+this.parameters[e][2]}return t},t}();e.FunctionValueBinding=A;var L=function(){return function(t,e,n,i){this.position=t,this.typeVariableSequence=e,this.name=n,this.type=i}}();e.TypeBinding=L;var B=function(){function t(t,e,n,i,r){void 0===r&&(r={}),this.position=t,this.typeVariableSequence=e,this.name=n,this.type=i,this.givenIds=r}return t.prototype.getType=function(t,e){var n=[],i=[],r=t.getNestedState(t.id),o=t.getValueIdentifierId(this.name.getText());r.incrementValueIdentifierId(this.name.getText());var s=new a.CustomType(this.name.getText(),this.typeVariableSequence,-1,void 0,!1,0),u=new a.CustomType(this.name.getText(),this.typeVariableSequence,-1,void 0,!1,o);r.setStaticType(this.name.getText(),u,[],this.typeVariableSequence.length,!0);for(var c=function(t){var e=u;if(void 0!==h.type[t][1]){var r=h.type[t][1].replace(s,u);e=new a.FunctionType(r,e)}for(var o=new Set,c=0;c<h.typeVariableSequence.length;++c){if(o.has(h.typeVariableSequence[c].name))throw new p.ElaborationError(h.typeVariableSequence[c].position,"I'm not interested in duplicate type variable names such as \""+h.typeVariableSequence[c]+'".');o=o.add(h.typeVariableSequence[c].name)}var f=[];if(e.getTypeVariables().forEach(function(t,n){o.has(n)?e=new a.TypeVariableBind(n,e,t):f.push(n)}),f.length>0)throw p.ElaborationError.getUnguarded(h.position,f);i.push([h.type[t][0].getText(),e]),n.push(h.type[t][0].getText())},h=this,f=0;f<this.type.length;++f)c(f);return[i,u,[this.name.getText(),n]]},t.prototype.compute=function(t,e){for(var n=[],i=[],r=0;r<this.type.length;++r){var o=0;void 0!==this.type[r][1]&&(o=1);var s=-1;void 0===this.givenIds[this.type[r][0].getText()]?(s=e.getValueIdentifierId(this.type[r][0].getText()),e.incrementValueIdentifierId(this.type[r][0].getText()),this.givenIds[this.type[r][0].getText()]=s):s=this.givenIds[this.type[r][0].getText()],i.push([this.type[r][0].getText(),new c.ValueConstructor(this.type[r][0].getText(),o,s)]),n.push(this.type[r][0].getText())}return[i,[this.name.getText(),n]]},t}();e.DatatypeBinding=B;var R=function(){function t(t,e,n){this.position=t,this.name=e,this.type=n}return t.prototype.elaborate=function(t,e,n,i){if(void 0!==this.type){var r=this.type.simplify().instantiate(t,new Map),o=[];if(r.getTypeVariables().forEach(function(t,e){o.push(e)}),e&&o.length>0)throw p.ElaborationError.getUnguarded(this.position,o);t.setStaticValue(this.name.getText(),new a.FunctionType(r.makeFree(),new a.CustomType("exn")),u.IdentifierStatus.EXCEPTION_CONSTRUCTOR)}else t.setStaticValue(this.name.getText(),new a.CustomType("exn"),u.IdentifierStatus.EXCEPTION_CONSTRUCTOR);return t},t.prototype.evaluate=function(t,e){var n=0;void 0!==this.type&&(n=1);var i=t.getValueIdentifierId(this.name.getText());t.incrementValueIdentifierId(this.name.getText());var r=e.getNextExceptionEvalId();if(!u.State.allowsRebind(this.name.getText()))throw new p.EvaluationError(this.position,'You simply cannot rebind "'+this.name.getText()+'".');t.setDynamicValue(this.name.getText(),new c.ExceptionConstructor(this.name.getText(),n,i,r),u.IdentifierStatus.EXCEPTION_CONSTRUCTOR)},t}();e.DirectExceptionBinding=R;var C=function(){function t(t,e,n){this.position=t,this.name=e,this.oldname=n}return t.prototype.elaborate=function(t,e,n){var i=void 0;if(this.oldname instanceof s.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.oldname);void 0!==r&&(i=r.getValue(this.oldname.id.getText()))}else i=t.getStaticValue(this.oldname.getText());if(void 0===i)throw new p.ElaborationError(this.position,'Unbound value identifier "'+this.oldname.getText()+'".');if(i[1]!==u.IdentifierStatus.EXCEPTION_CONSTRUCTOR)throw new p.ElaborationError(this.position,'You cannot transform "'+i[0]+'" into an exception.');return t.setStaticValue(this.name.getText(),i[0].normalize()[0],u.IdentifierStatus.EXCEPTION_CONSTRUCTOR),t},t.prototype.evaluate=function(t,e){var n=void 0;if(this.oldname instanceof s.LongIdentifierToken){var i=t.getAndResolveDynamicStructure(this.oldname);void 0!==i&&(n=i.getValue(this.oldname.id.getText()))}else n=t.getDynamicValue(this.oldname.getText());if(void 0===n)throw new p.EvaluationError(this.position,'Unbound value identifier "'+this.oldname.getText()+'".');if(n[1]!==u.IdentifierStatus.EXCEPTION_CONSTRUCTOR)throw new p.EvaluationError(this.position,'You cannot transform "'+n[0].toString(t,40)+'" into an exception.');t.setDynamicValue(this.name.getText(),n[0],u.IdentifierStatus.EXCEPTION_CONSTRUCTOR)},t}();e.ExceptionAlias=C},function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=n(4),s=n(5),a=n(2),u=n(3),p=n(0),c=n(1),h=function(){function t(){}return t.prototype.getType=function(t,e,n,i,r){throw void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),new p.InternalInterpreterError(this.position,'Called "getType" on a derived form.')},t.prototype.compute=function(t,e){throw new p.InternalInterpreterError(this.position,'Called "getValue" on a derived form.')},t.prototype.isSafe=function(t){return!0},t.prototype.getExplicitTypeVariables=function(){return new Set},t.prototype.toString=function(){throw new p.InternalInterpreterError(this.position,"You humans can't seem to write bug-free code. What an inferior species.")},t.prototype.assertUniqueBinding=function(t,e){return new Set},t}();e.Expression=h;var f=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.token=n,i}return r(e,t),e.prototype.matchType=function(t,e,n){return[[],this.getType(t,e)[0],e]},e.prototype.matches=function(t,e){var n=this.compute({state:t,modifiable:t,recResult:void 0},[]);if(void 0===n||void 0===n.value)throw new p.InternalInterpreterError(this.token.position,"How is this undefined?");return n.value.equals(e)?[]:void 0},e.prototype.getType=function(t,e,n,i,r){if(void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),this.token instanceof a.IntegerConstantToken||this.token instanceof a.NumericToken)return[new o.CustomType("int"),[],n,i,e,t.valueIdentifierId];if(this.token instanceof a.RealConstantToken)return[new o.CustomType("real"),[],n,i,e,t.valueIdentifierId];if(this.token instanceof a.WordConstantToken)return[new o.CustomType("word"),[],n,i,e,t.valueIdentifierId];if(this.token instanceof a.CharacterConstantToken)return[new o.CustomType("char"),[],n,i,e,t.valueIdentifierId];if(this.token instanceof a.StringConstantToken)return[new o.CustomType("string"),[],n,i,e,t.valueIdentifierId];throw new p.InternalInterpreterError(this.token.position,'"'+this+'" does not seem to be a valid constant.')},e.prototype.simplify=function(){return this},e.prototype.toString=function(){return this.token.getText()},e.prototype.compute=function(t,e){var n=void 0;if(this.token instanceof a.IntegerConstantToken||this.token instanceof a.NumericToken?n=new c.Integer(this.token.value):this.token instanceof a.RealConstantToken?n=new c.Real(this.token.value):this.token instanceof a.WordConstantToken?n=new c.Word(this.token.value):this.token instanceof a.CharacterConstantToken?n=new c.CharValue(this.token.value):this.token instanceof a.StringConstantToken&&(n=new c.StringValue(this.token.value)),void 0===n)throw new p.EvaluationError(this.token.position,"You sure that this is a constant?");return{newState:void 0,value:n,hasThrown:!1}},e}(h);e.Constant=f;var l=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.name=n,i}return r(e,t),e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var s=void 0;if(this.name instanceof a.LongIdentifierToken){var c=t.getAndResolveStaticStructure(this.name);if(void 0!==c&&void 0!==(s=c.getValue(this.name.id.getText()))){var h=new u.State(0,void 0,c,t.dynamicBasis,[0,{}],4);s=[s[0].qualify(h,this.name),s[1]]}}else s=t.getStaticValue(this.name.getText());var f=e,l=!1;if(void 0===s||s[1]===u.IdentifierStatus.VALUE_VARIABLE){var d=new o.TypeVariable("'**"+this.name.getText());if(r)s=[new o.TypeVariableBind("'**"+this.name.getText(),d),0],l=!0;else{if(e.has(d.name))return[e.get(d.name)[0].instantiate(t,f),[],n,i,f,t.valueIdentifierId];if(void 0===s)throw new p.ElaborationError(this.position,'Unbound value identifier "'+this.name.getText()+'".')}}for(var y=new Set,v=new Set,w=new Map;s[0]instanceof o.TypeVariableBind;)s[0].isFree?(v=v.add(s[0].name),w=w.set(s[0].name,s[0].name)):y=y.add(s[0].name),s[0]=s[0].type;y=y.add("*");var m=[];y.forEach(function(r){for(var o=+n.substring(3)+1,s="";;++o)if(n="'"+n[1]+n[2]+o,!y.has(n)&&!i.has(n)&&!e.has(n)&&void 0===t.getStaticValue(n)){s="'"===r[1]?"'"+n:n,m.push(s),w=w.set(r,s);break}});for(var g=0;g<m.length;++g)i=i.add(m[g]);var T=s[0].replaceTypeVariables(w,v).instantiate(t,f);return l&&(f=f.set("'**"+this.name.getText(),[T,!1])),[T,[],n,i,f,t.valueIdentifierId]},e.prototype.matchType=function(t,e,n){if(this.name instanceof a.LongIdentifierToken)throw new p.ElaborationError(this.position,"Variable names in patterns cannot be qualified.");var i=t.getStaticValue(this.name.getText());if(void 0===i||i[1]===u.IdentifierStatus.VALUE_VARIABLE)return[[[this.name.getText(),n.instantiate(t,e)]],n.instantiate(t,e),e];var r=this.getType(t,e,"'*g0");r[3].forEach(function(t){var e="'*p"+t.substring(3);"'"===t[1]&&(e="''*p"+t.substring(4)),r[4]=r[4].set(t,[new o.TypeVariable(e),!1])}),i[0]=r[0],e=r[4];try{var s=n.merge(t,e,i[0]);return[[],s[0],s[1]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,'Type clash: "'+n.normalize()[0]+'" vs. "'+i[0].normalize()[0]+'": '+t[0])}},e.prototype.matches=function(t,e){if(this.name instanceof a.LongIdentifierToken)throw new p.EvaluationError(this.position,"Variable names in patterns cannot be qualified.");var n=t.getDynamicValue(this.name.getText());if(void 0===n||n[1]===u.IdentifierStatus.VALUE_VARIABLE)return[[this.name.getText(),e]];try{if(e.equals(n[0]))return[]}catch(t){return[[this.name.getText(),e]]}},e.prototype.simplify=function(){return this},e.prototype.toString=function(){return this.name.getText()},e.prototype.compute=function(t,e){var n=t.state,i=void 0;if(this.name instanceof a.LongIdentifierToken){var r=n.getAndResolveDynamicStructure(this.name);void 0!==r&&(i=r.getValue(this.name.id.getText()))}else i=n.getDynamicValue(this.name.getText());if(void 0===i)throw new p.EvaluationError(this.position,'Unbound value identifier "'+this.name.getText()+'".');return i[1]===u.IdentifierStatus.VALUE_CONSTRUCTOR&&0===i[0].numArgs?{newState:void 0,value:i[0].construct(),hasThrown:!1}:i[1]===u.IdentifierStatus.EXCEPTION_CONSTRUCTOR&&0===i[0].numArgs?{newState:void 0,value:i[0].construct(),hasThrown:!1}:{newState:void 0,value:i[0],hasThrown:!1}},e.prototype.assertUniqueBinding=function(t,e){if(e.has(this.name.getText()))return new Set;var n=t.getStaticValue(this.name.getText());if(void 0!==n&&n[1]!==u.IdentifierStatus.VALUE_VARIABLE)return new Set;var i=t.getDynamicValue(this.name.getText());return void 0!==i&&i[1]!==u.IdentifierStatus.VALUE_VARIABLE?new Set:(new Set).add(this.name.getText())},e}(h);e.ValueIdentifier=l;var d=function(t){function e(e,n,i){var r=t.call(this)||this;r.position=e,r.complete=n,r.entries=i,r.entries.sort();for(var o=1;o<r.entries.length;++o)if(r.entries[o][0]===r.entries[o-1][0])throw new p.ElaborationError(r.position,'Label "'+r.entries[o][0]+'" occurs more than once in the same record.');return r}return r(e,t),e.prototype.getExplicitTypeVariables=function(){for(var t=new Set,e=0;e<this.entries.length;++e)this.entries[e][1].getExplicitTypeVariables().forEach(function(e){t=t.add(e)});return t},e.prototype.getEntry=function(t){for(var e=0;e<this.entries.length;++e)if(this.entries[e][0]===t)return this.entries[e][1];throw new p.InternalInterpreterError(this.position,'Yeah, "'+t+'" would be nice to have.')},e.prototype.isSafe=function(t){for(var e=0;e<this.entries.length;++e)if(!this.entries[e][1].isSafe(t))return!1;return!0},e.prototype.matchType=function(t,e,n){if(n instanceof o.RecordType||(n=n.instantiate(t,e)),n instanceof o.TypeVariable){for(var i=new Map,r=0;r<this.entries.length;++r){var s=new o.TypeVariable(n.name+"*"+r);s.isFree=n.isFree,i=i.set(this.entries[r][0],s)}var a=new o.RecordType(i,this.complete);e=e.set(n.name,[a,n.isFree]),n=a}if(!(n instanceof o.RecordType))throw new p.ElaborationError(this.position,'Expected pattern of a record type, got "'+n.constructor.name+'".');if(this.complete&&this.entries.length!==n.elements.size)throw new p.ElaborationError(this.position,"Expected a record type with "+this.entries.length+" entries, but the given one has "+n.elements.size+".");var u=[],c=new Map,h=e;for(r=0;r<this.entries.length;++r){if(!n.hasType(this.entries[r][0]))throw new p.ElaborationError(this.position,"I am mad scientist. Sunovabitch!");var f=this.entries[r][1].matchType(t,h,n.getType(this.entries[r][0]));u=u.concat(f[0]),c=c.set(this.entries[r][0],f[1]),h=f[2]}return[u,new o.RecordType(c),h]},e.prototype.matches=function(t,e){if(e instanceof c.RecordValue&&(!this.complete||this.entries.length===e.entries.size)){for(var n=[],i=0;i<this.entries.length;++i){if(!e.hasValue(this.entries[i][0]))return;var r=this.entries[i][1].matches(t,e.getValue(this.entries[i][0]));if(void 0===r)return r;for(var o=0;o<r.length;++o)n.push(r[o])}return n}},e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);for(var s=new Map,a=[],c=e,h=0;h<this.entries.length;++h){var f=this.entries[h][0],d=this.entries[h][1];if(s.has(f))throw new p.ElaborationError(this.position,'Label "'+f+'" occurs more than once in the same record.');if(d instanceof l&&r){var y=t.getStaticValue(d.name.getText());if(void 0!==y&&y[1]!==u.IdentifierStatus.VALUE_VARIABLE&&y[0]instanceof o.FunctionType)throw new p.ElaborationError(d.position,"Unary constructor in the pattern needs an argument.")}var v=d.getType(t,c,n,i,r);a=a.concat(v[1]),n=v[2],i=v[3],v[4].forEach(function(t,e){c=c.set(e,t)}),t.valueIdentifierId=v[5],s=s.set(f,v[0])}return[new o.RecordType(s,this.complete),a,n,i,c,t.valueIdentifierId]},e.prototype.simplify=function(){for(var t=[],n=0;n<this.entries.length;++n){var i=this.entries[n];t.push([i[0],i[1].simplify()])}return new e(this.position,this.complete,t)},e.prototype.toString=function(){for(var t="{",e=!0,n=0;n<this.entries.length;++n)e||(t+=", "),e=!1,t+=this.entries[n][0]+" = "+this.entries[n][1];return this.complete||(e||(t+=", "),t+="..."),t+"}"},e.prototype.compute=function(t,e){var n=t.state;void 0===t.step&&(t.step=-1,t.nentr=new Map);var i=t.nentr,r=t.step;if(r>=0){var o=t.recResult;if(void 0===o)throw new p.InternalInterpreterError(-1,"How is this undefined?");if(o.hasThrown)return{newState:void 0,value:o.value,hasThrown:!0};i=i.set(this.entries[r][0],o.value)}return++r<this.entries.length?(t.step=r,t.nentr=i,e.push({next:this,params:t}),void e.push({next:this.entries[r][1],params:{state:n,modifiable:t.modifiable,recResult:void 0}})):{newState:void 0,value:new c.RecordValue(i),hasThrown:!1}},e.prototype.assertUniqueBinding=function(t,e){for(var n=this,i=new Set,r=0;r<this.entries.length;++r){this.entries[r][1].assertUniqueBinding(t,e).forEach(function(t){if(i.has(t))throw new p.ParserError("Don't try to rebind \""+t+'" "'+t+'" in the same pattern... Sorry, I stuttered.',n.position);i=i.add(t)})}return i},e}(h);e.Record=d;var y=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.declaration=n,r.expression=i,r}return r(e,t),e.prototype.simplify=function(){return new e(this.position,this.declaration.simplify(),this.expression.simplify())},e.prototype.toString=function(){var t="let "+this.declaration;return t+=" in "+this.expression+" end"},e.prototype.isSafe=function(t){return!1},e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=t.getNestedState(t.id),s=new Map;e.forEach(function(n,i){if("*"===i[1]&&"*"===i[2]){var r=i.substring(3),a=n[0].instantiate(t,e);o.setStaticValue(r,a,u.IdentifierStatus.VALUE_VARIABLE)}s=s.set(i,n)});var a=this.declaration.elaborate(o,s,n),p=new Map;a[2].forEach(function(t,e){p=p.set(e,t)});var c=this.expression.getType(a[0],p,a[3],i,r);return[c[0],a[1].concat(c[1]),c[2],c[3],c[4],c[5]]},e.prototype.compute=function(t,e){var n=t.state;void 0===t.step&&(t.step=-1);var i=t.step;if(-1===i){var r=n.getNestedState(0).getNestedState(n.id);return t.step=i+1,t.state=n,e.push({next:this,params:t}),void e.push({next:this.declaration,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}if(0===i){var o=t.recResult;if(void 0===o||void 0===o.newState)throw new p.InternalInterpreterError(-1,"How is this undefined?");r=o.newState;return o.hasThrown?{newState:void 0,value:o.value,hasThrown:!0}:void e.push({next:this.expression,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}var s=t.recResult;if(void 0===s)throw new p.InternalInterpreterError(-1,"How is this undefined?");return{newState:void 0,value:s.value,hasThrown:s.hasThrown}},e.prototype.assertUniqueBinding=function(t,e){return this.declaration.assertUniqueBinding(t,e),this.expression.assertUniqueBinding(t,e),new Set},e}(h);e.LocalDeclarationExpression=y;var v=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.typeAnnotation=i,r}return r(e,t),e.prototype.getExplicitTypeVariables=function(){var t=new Set;return this.typeAnnotation.getTypeVariables().forEach(function(e,n){t=t.add(new o.TypeVariable(n,0,e))}),t},e.prototype.isSafe=function(t){return this.expression.isSafe(t)},e.prototype.matchType=function(t,e,n){var i=this.expression.matchType(t,e,n);try{for(var r=i[1].merge(t,i[2],this.typeAnnotation.instantiate(t,i[2])),o=0;o<i[0].length;++o)i[0][o][1]=i[0][o][1].instantiate(t,r[1]);return[i[0],r[0],r[1]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,'The annotated type "'+this.typeAnnotation+'" does not match the expression\'s type "'+i[1].normalize()[0]+'": '+t[0])}},e.prototype.matches=function(t,e){return this.expression.matches(t,e)},e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=this.expression.getType(t,e,n,i,r);try{var s=this.typeAnnotation.instantiate(t,o[4]),a=o[0].merge(t,o[4],s);return[a[0],o[1],o[2],o[3],a[1],o[5]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,'The specified type "'+this.typeAnnotation+'" does not match the annotated expression\'s type "'+o[0].normalize()[0]+'": '+t[0])}},e.prototype.simplify=function(){return new e(this.position,this.expression.simplify(),this.typeAnnotation.simplify())},e.prototype.toString=function(){var t="( "+this.expression;return(t+=": "+this.typeAnnotation)+" )"},e.prototype.compute=function(t,e){return this.expression.compute(t,e)},e.prototype.assertUniqueBinding=function(t,e){return this.expression.assertUniqueBinding(t,e)},e}(h);e.TypedExpression=v;var w=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.func=n,r.argument=i,r}return r(e,t),e.prototype.getExplicitTypeVariables=function(){var t=new Set;return this.func.getExplicitTypeVariables().forEach(function(e){t=t.add(e)}),this.argument.getExplicitTypeVariables().forEach(function(e){t=t.add(e)}),t},e.prototype.isSafe=function(t){if(!(this.func instanceof l))return!1;var e=t.getStaticValue(this.func.name.getText());return void 0!==e&&"ref"!==this.func.name.getText()&&e[1]!==u.IdentifierStatus.VALUE_VARIABLE},e.prototype.matchType=function(t,e,n){if(!(this.func instanceof l))throw new p.ElaborationError(this.position,"Non-identifier applied to a pattern.");var i=t.getStaticValue(this.func.name.getText());if(void 0===i||i[1]===u.IdentifierStatus.VALUE_VARIABLE)throw new p.ElaborationError(this.position,'Expected a constructor, "'+this.func.name.getText()+"\" isn't.");var r=this.func.getType(t,e,"'g0");if(r[3].forEach(function(t){var e="'p"+t.substring(2);"'"===t[1]&&(e="''p"+t.substring(3)),r[4]=r[4].set(t,[new o.TypeVariable(e),!1])}),i[0]=r[0],e=r[4],!(i[0]instanceof o.FunctionType))throw new p.ElaborationError(this.position,"This is truly more...slothful.");try{var s=i[0],a=s.returnType.merge(t,e,n),c=this.argument.matchType(t,a[1],s.parameterType.instantiate(t,a[1]));return[c[0],a[0],c[2]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Merge failed: "+t[0])}},e.prototype.matches=function(t,e){if(e instanceof c.FunctionValue)throw new p.EvaluationError(this.position,"You simply cannot match function values.");if(e instanceof c.ConstructedValue)return this.func instanceof l&&this.func.name.getText()===e.constructorName&&"ref"!==this.func.name.getText()?void 0!==e.argument?this.argument.matches(t,e.argument):[]:void 0;if(e instanceof c.ExceptionValue){var n=t.getDynamicValue(this.func.name.getText());if(void 0===n)throw new p.InternalInterpreterError(this.position,"How did you match something that does not exist?");var i=n[0];return this.func instanceof l&&i instanceof c.ExceptionConstructor&&this.func.name.getText()===e.constructorName&&i.id===e.id&&i.evalId===e.evalId?void 0!==e.argument?this.argument.matches(t,e.argument):[]:void 0}if(e instanceof c.PredefinedFunction)throw new p.EvaluationError(this.position,"You simply cannot match predefined functions.");if(e instanceof c.ReferenceValue)return this.func instanceof l&&"ref"===this.func.name.getText()?this.argument.matches(t,t.getCell(e.address)):void 0;throw new p.EvaluationError(this.position,"Help me, I'm broken. ("+e.constructor.name+").")},e.prototype.getType=function(t,e,n,i,r){if(void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),r&&this.func instanceof l)if(this.func.name instanceof a.LongIdentifierToken){var s=t.getAndResolveStaticStructure(this.func.name);if(void 0===s||void 0===s.getValue(this.func.name.id.getText()))throw new p.ElaborationError(this.position,'"'+this.func.name.getText()+'" is not a constructor.')}else{var c=t.getStaticValue(this.func.name.getText());if(void 0===c||c[1]===u.IdentifierStatus.VALUE_VARIABLE)throw new p.ElaborationError(this.position,'"'+this.func.name.getText()+'" is not a constructor.')}var h=this.func.getType(t,e,n,i,r);t.valueIdentifierId=h[5];var f=new Map;h[4].forEach(function(t,e){f=f.set(e,t)});var d=this.argument.getType(t,f,h[2],h[3],r);if(d[4].forEach(function(t,e){h[4]=h[4].set(e,t)}),h[0]=h[0].instantiate(t,h[4]),h[0]instanceof o.TypeVariable){var y=new o.TypeVariable(h[0].name+"*a"),v=new o.TypeVariable(h[0].name+"*b");y.isFree=h[0].isFree,v.isFree=h[0].isFree;var w=new o.FunctionType(y,v);h[4]=h[4].set(h[0].name,[w,h[0].isFree]),h[0]=w}if(h[0]instanceof o.AnyType&&(h[0]=new o.FunctionType(new o.AnyType,new o.AnyType)),!(h[0]instanceof o.FunctionType))throw new p.ElaborationError(this.func.position,'"'+this.func+'" of type "'+h[0].normalize()[0]+'" is not a function.');try{var m=h[0].parameterType.merge(t,h[4],d[0]),g=h[0].returnType;return h[0].parameterType instanceof o.RecordType&&!h[0].parameterType.complete&&(g=g.replace(h[0].parameterType,m[0])),[g.instantiate(t,m[1]),h[1].concat(d[1]),d[2],d[3],m[1],d[5]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,'Type clash. Functions of type "'+h[0].normalize()[0]+'" cannot take an argument of type "'+d[0].normalize()[0]+'": '+t[0])}},e.prototype.simplify=function(){return new e(this.position,this.func.simplify(),this.argument.simplify())},e.prototype.toString=function(){var t="( "+this.func;return(t+=" "+this.argument)+" )"},e.prototype.compute=function(t,e){var n=t.state,i=t.modifiable;void 0===t.step&&(t.step=-1);var r=t.step;if(-1===r)return t.step=r+1,t.state=n,e.push({next:this,params:t}),void e.push({next:this.func,params:{state:n,modifiable:i,recResult:void 0}});if(0===r){if(void 0===(o=t.recResult))throw new p.InternalInterpreterError(-1,"How is this undefined?");return o.hasThrown?o:(t.step=r+1,t.state=n,t.funcVal=o,e.push({next:this,params:t}),void e.push({next:this.argument,params:{state:n,modifiable:i,recResult:void 0}}))}if(1===r){var o=t.funcVal,s=t.recResult;if(void 0===o||void 0===o.value)throw new p.InternalInterpreterError(-1,"How is this undefined?");if(void 0===s||void 0===s.value)throw new p.InternalInterpreterError(-1,"How is this undefined?");if(s.hasThrown)return{newState:void 0,value:s.value,hasThrown:!0};if(o.value instanceof c.FunctionValue)return void o.value.compute(e,s.value,i);if(o.value instanceof c.ValueConstructor)return{newState:void 0,value:o.value.construct(s.value),hasThrown:!1};if(o.value instanceof c.ExceptionConstructor)return{newState:void 0,value:o.value.construct(s.value),hasThrown:!1};if(o.value instanceof c.PredefinedFunction){for(var a,u=0,h=(a=o.value.apply(s.value,t))[2];u<h.length;u++){var f=h[u];i.addWarning(f)}return{newState:void 0,value:a[0],hasThrown:a[1]}}throw new p.EvaluationError(this.position,'Cannot evaluate the function "'+this.func+'" ('+o[0].constructor.name+").")}if(void 0===(a=t.recResult))throw new p.InternalInterpreterError(-1,"How is this undefined?");return{newState:void 0,value:a.value,hasThrown:a.hasThrown}},e.prototype.assertUniqueBinding=function(t,e){var n=this.func.assertUniqueBinding(t,e),i=this.argument.assertUniqueBinding(t,e);return this.func instanceof l&&0===n.size?i:new Set},e}(h);e.FunctionApplication=w;var m=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.match=i,r}return r(e,t),e.prototype.getExplicitTypeVariables=function(){return this.expression.getExplicitTypeVariables()},e.prototype.isSafe=function(t){return this.expression.isSafe(t)},e.prototype.simplify=function(){return new e(this.position,this.expression.simplify(),this.match.simplify())},e.prototype.toString=function(){var t="( "+this.expression+" )";return t+=" handle "+this.match},e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var s=this.match.getType(t,e,n,i,r,!1);if(!(s[0]instanceof o.FunctionType))throw new p.ElaborationError(this.match.position,'You can only handle things of type "exn" and not "'+s[0].parameterType.normalize()[0]+'".');try{s[0].parameterType.merge(t,s[4],new o.CustomType("exn"))}catch(t){throw new p.ElaborationError(this.match.position,'You can only handle things of type "exn" and not "'+s[0].parameterType.normalize()[0]+'".')}var a=s[0].returnType;t.valueIdentifierId=s[5];var u=this.expression.getType(t,s[4],s[2],s[3],r);try{var c=a.merge(t,u[4],u[0]);return[c[0],s[1].concat(u[1]),u[2],u[3],c[1],u[5]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.expression.position,'The "handle" cannot change the type of the expression from "'+u[0].normalize()[0]+'" to "'+a.normalize()[0]+'": '+t[0])}},e.prototype.compute=function(t,e){var n=t.state;if(void 0===t.recResult)return e.push({next:this,params:t}),void e.push({next:this.expression,params:{state:n,modifiable:t.modifiable,recResult:void 0}});var i=t.recResult;if(void 0===i||void 0===i.value)throw new p.InternalInterpreterError(-1,"How is this undefined?");if(void 0===t.exprResult)return i.hasThrown?(t.exprResult=i,e.push({next:this,params:t}),void e.push({next:this.match,params:{state:n,modifiable:t.modifiable,recResult:void 0,value:i.value}})):i;i=t.exprResult;var r=t.recResult;if(void 0===i||void 0===i.value||void 0===r||void 0===r.value)throw new p.InternalInterpreterError(-1,"How is this undefined?");return r.hasThrown&&r.value.equals(new c.ExceptionValue("Match",void 0,0,0))?{newState:void 0,value:i.value,hasThrown:i.hasThrown}:{newState:void 0,value:r.value,hasThrown:r.hasThrown}},e.prototype.assertUniqueBinding=function(t,e){return this.expression.assertUniqueBinding(t,e),this.match.assertUniqueBinding(t,e),new Set},e}(h);e.HandleException=m;var g=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return r(e,t),e.prototype.getExplicitTypeVariables=function(){return this.expression.getExplicitTypeVariables()},e.prototype.simplify=function(){return new e(this.position,this.expression.simplify())},e.prototype.isSafe=function(t){return!1},e.prototype.toString=function(){return"raise "+this.expression},e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var s=this.expression.getType(t,e,n,i,r);try{var a=s[0].merge(t,e,new o.CustomType("exn"));return[new o.TypeVariable(s[2]),s[1],s[2]+"0",s[3],a[1],s[5]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.expression.position,"Raising anything but exceptions will only raise exceptions: "+t[0])}},e.prototype.compute=function(t,e){var n=t.state;if(void 0===t.recResult)return e.push({next:this,params:t}),void e.push({next:this.expression,params:{state:n,modifiable:t.modifiable,recResult:void 0}});var i=t.recResult;if(void 0===i||void 0===i.value)throw new p.InternalInterpreterError(-1,"How is this undefined?");if(!(i.value instanceof c.ExceptionValue))throw new p.EvaluationError(this.position,'Cannot "raise" value of type "'+i.value.constructor.name+'" (type must be "exn").');return{newState:n,value:i.value,hasThrown:!0}},e.prototype.assertUniqueBinding=function(t,e){return this.expression.assertUniqueBinding(t,e),new Set},e}(h);e.RaiseException=g;var T=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.match=n,i}return r(e,t),e.prototype.getExplicitTypeVariables=function(){return this.match.getExplicitTypeVariables()},e.prototype.simplify=function(){return new e(this.position,this.match.simplify())},e.prototype.toString=function(){return"( fn "+this.match+" )"},e.prototype.getType=function(t,e,n,i,r){return void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),this.match.getType(t,e,n,i,r)},e.prototype.compute=function(t,e){var n=t.state,i=n.getNestedState(n.id);return i.insideLocalDeclBody&&(i.dynamicBasis=n.getDynamicLocalDeclChanges(-1),i.insideLocalDeclBody=!1),{newState:void 0,value:new c.FunctionValue(i,[],this.match),hasThrown:!1}},e.prototype.assertUniqueBinding=function(t,e){return this.match.assertUniqueBinding(t,e),new Set},e}(h);e.Lambda=T;var E=function(){function t(t,e){this.position=t,this.matches=e}return t.prototype.getExplicitTypeVariables=function(){for(var t=new Set,e=0;e<this.matches.length;++e)this.matches[e][0].getExplicitTypeVariables().forEach(function(e){t=t.add(e)}),this.matches[e][1].getExplicitTypeVariables().forEach(function(e){t=t.add(e)});return t},t.prototype.toString=function(){for(var t="",e=0;e<this.matches.length;++e)e>0&&(t+=" | "),t+=this.matches[e][0],t+=" => "+this.matches[e][1];return t},t.prototype.compute=function(t,e){var n=t.state,i=t.value;if(void 0===i)throw new p.InternalInterpreterError(-1,"How is this undefined?");for(var r=0;r<this.matches.length;++r){var o=n.getNestedState(n.id),s=this.matches[r][0].matches(o,i);if(void 0!==s){for(var a=0;a<s.length;++a)o.setDynamicValue(s[a][0],s[a][1],u.IdentifierStatus.VALUE_VARIABLE);return void e.push({next:this.matches[r][1],params:{state:o,modifiable:t.modifiable,recResult:void 0}})}}return{newState:void 0,value:new c.ExceptionValue("Match",void 0,0,0),hasThrown:!0}},t.prototype.getType=function(t,e,n,i,r,s){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),void 0===s&&(s=!1);for(var a=new o.FunctionType(new o.AnyType,new o.AnyType),c=[],h=e,f=new Map,d=function(e){var s;if(y.matches[e][0]instanceof l){var d=t.getStaticValue(y.matches[e][0].name.getText());if(void 0!==d&&d[1]!==u.IdentifierStatus.VALUE_VARIABLE&&d[0]instanceof o.FunctionType)throw new p.ElaborationError(y.matches[e][0].position,"Unary constructor in the pattern needs an argument.")}var v=new Map;h.forEach(function(t,e){v=v.set(e,t)});var w=y.matches[e][0].getType(t,h,n,i,!0);t.valueIdentifierId=w[5],c=c.concat(w[1]);var m=y.matches[e][1].getType(t,w[4],w[2],w[3],r);c=c.concat(m[1]),t.valueIdentifierId=m[5],n=m[2],i=m[3];var g=new o.FunctionType(w[0],m[0]);try{s=a.merge(t,m[4],g),a=s[0],h=s[1],a=a.instantiate(t,h)}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(y.position,"Match rules disagree on type: "+t[0])}a=a.instantiate(t,h),h.forEach(function(t,e){"*"!==e[1]||"*"!==e[2]?v=v.set(e,t):f=f.set(e,t)}),h=v},y=this,v=0;v<this.matches.length;++v)d(v);var w=new Map;return h.forEach(function(t,e){w=w.set(e,t)}),f.forEach(function(t,e){w=w.set(e,t)}),s&&c.push(new p.Warning(this.position,"How should I know whether this pattern matching is exhaustive? Do I look like friggin' WIKIP***A to you?!\n")),[a,c,n,i,h,t.valueIdentifierId]},t.prototype.simplify=function(){for(var e=[],n=0;n<this.matches.length;++n){var i=this.matches[n];e.push([i[0].simplify(),i[1].simplify()])}return new t(this.position,e)},t.prototype.assertUniqueBinding=function(t,e){for(var n=0;n<this.matches.length;++n)this.matches[n][0].assertUniqueBinding(t,e),this.matches[n][1].assertUniqueBinding(t,e);return new Set},t}();e.Match=E;var x=function(t){function e(e){var n=t.call(this)||this;return n.position=e,n}return r(e,t),e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);for(var s=+n.substring(3)+1,a="";;++s)if(n="'"+n[1]+n[2]+s,!i.has(n)&&!e.has(n)&&void 0===t.getStaticValue(n))return a=n,[new o.TypeVariable(a),[],a,i.add(a),e,t.valueIdentifierId]},e.prototype.compute=function(t,e){throw new p.InternalInterpreterError(this.position,"Wildcards are far too wild to have a value.")},e.prototype.matchType=function(t,e,n){return[[],n,e]},e.prototype.matches=function(t,e){return[]},e.prototype.simplify=function(){return this},e.prototype.toString=function(){return"_"},e.prototype.assertUniqueBinding=function(t,e){return new Set},e}(h);e.Wildcard=x;var S=function(t){function e(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.identifier=n,o.typeAnnotation=i,o.pattern=r,o}return r(e,t),e.prototype.getType=function(t,e,n,i,r){if(void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),!r)throw new p.InternalInterpreterError(this.position,"Layered patterns are far too layered to have a type.");var o=new l(-1,this.identifier).getType(t,e,n,i,!0),s=o[0];if(void 0!==this.typeAnnotation)try{e=(u=s.merge(t,o[4],this.typeAnnotation))[1],s=u[0]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Wrong type annotation: "+t[0])}var a=this.pattern.getType(t,e,o[2],o[3],!0);try{var u;e=(u=s.merge(t,a[4],a[0]))[1],s=u[0]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Wrong type annotation: "+t[0])}return[s,o[1].concat(a[1]),a[2],a[3],e,t.valueIdentifierId]},e.prototype.compute=function(t,e){throw new p.InternalInterpreterError(this.position,"Layered patterns are far too layered to have a value.")},e.prototype.matchType=function(t,e,n){var i=n;if(void 0!==this.typeAnnotation)try{var r=n.merge(t,e,this.typeAnnotation);e=r[1],i=r[0]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Wrong type annotation: "+t[0])}var o=this.pattern.matchType(t,e,i);return[[[this.identifier.getText(),i]].concat(o[0]),n,o[2]]},e.prototype.matches=function(t,e){var n=this.pattern.matches(t,e);return void 0===n?n:[[this.identifier.getText(),e]].concat(n)},e.prototype.simplify=function(){return this.typeAnnotation?new e(this.position,this.identifier,this.typeAnnotation.simplify(),this.pattern.simplify()):new e(this.position,this.identifier,void 0,this.pattern.simplify())},e.prototype.toString=function(){return this.identifier.getText()+" as "+this.pattern},e.prototype.assertUniqueBinding=function(t,e){var n=this.pattern.assertUniqueBinding(t,e),i=t.getStaticValue(this.identifier.getText());if(void 0!==i&&i[1]!==u.IdentifierStatus.VALUE_VARIABLE)return n;var r=t.getDynamicValue(this.identifier.getText());if(void 0!==r&&r[1]!==u.IdentifierStatus.VALUE_VARIABLE)return n;if(n.has(this.identifier.getText()))throw new p.ParserError('No matter from which end you start eating this pattern,rebinding "'+this.identifier.getText()+'" is still a bad idea.',this.position);return n.add(this.identifier.getText())},e}(h);e.LayeredPattern=S;var I=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return r(e,t),e.prototype.getType=function(t,e,n,i,r){if(void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),0===this.expressions.length)return[new o.CustomType("vector",[new o.AnyType],this.position),[],n,i,e,t.valueIdentifierId];for(var s=this.expressions[0].getType(t,e,n,i,r),a=s[0],u=0;u<this.expressions.length;++u){s=this.expressions[u].getType(t,s[4],s[2],s[3],r);try{var c=a.merge(t,s[4],s[0]);s[4]=c[1],a=c[0]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Type clash in vector entries: "+t[0])}}return[new o.CustomType("vector",[a],this.position),s[1],s[2],s[3],s[4],s[5]]},e.prototype.compute=function(t,e){for(var n=[],i=0;i<this.expressions.length;++i){var r=this.expressions[i].compute(t,e);if(void 0===r||void 0===r.value)throw new p.InternalInterpreterError(this.position,"NG");n.push(r.value)}return{newState:void 0,value:new c.VectorValue(n),hasThrown:!1}},e.prototype.getExplicitTypeVariables=function(){return new Set},e.prototype.matchType=function(t,e,n){if(!(n instanceof o.CustomType)||"vector"!==n.name)throw new p.ElaborationError(this.position,'Vectors like only vectors, not "'+n+'". Stay cool.');for(var i=n.typeArguments[0],r=[],s=0;s<this.expressions.length;++s){var a=this.expressions[s].matchType(t,e,i);i=a[1],r=r.concat(a[0]),e=a[2]}return[r,new o.CustomType("vector",[i],this.position),e]},e.prototype.matches=function(t,e){if(!(e instanceof c.VectorValue))throw new p.ElaborationError(this.position,'Vectors like only vectors, not "'+e+'". Stay cool.');for(var n=[],i=0;i<this.expressions.length;++i){var r=this.expressions[i].matches(t,e.entries[i]);void 0!==r&&(n=n.concat(r))}return n},e.prototype.simplify=function(){for(var t=[],n=0;n<this.expressions.length;++n)t.push(this.expressions[n].simplify());return new e(this.position,t)},e.prototype.toString=function(){for(var t="#[ ",e=0;e<this.expressions.length;++e)e>0&&(t+=", "),t+=this.expressions[e];return t+" ]"},e}(h);e.Vector=I;var k=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.left=n,r.right=i,r}return r(e,t),e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=this.left.getType(t,e,n,i,r),s=this.right.getType(t,o[4],o[2],o[3],r);try{var a=o[0].merge(t,s[4],s[0]);return[a[0],o[1].concat(s[1]),s[2],s[3],a[1],s[5]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Both patterns of a conjunctive pattern must have the same type.")}},e.prototype.simplify=function(){return new e(this.position,this.left.simplify(),this.right.simplify())},e.prototype.matchType=function(t,e,n){throw new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e.prototype.matches=function(t,e){var n=this.left.matches(t,e);if(void 0!==n){for(var i=t.getNestedState(t.id),r=0,o=n;r<o.length;r++){var s=o[r];i.setDynamicValue(s[0],s[1],u.IdentifierStatus.VALUE_VARIABLE)}var a=this.right.matches(i,e);if(void 0!==a)return n.concat(a)}},e.prototype.assertUniqueBinding=function(t,e){return new Set},e}(h);e.ConjunctivePattern=k;var V=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.left=n,r.right=i,r}return r(e,t),e.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=this.left.getType(t,e,n,i,r),s=this.right.getType(t,o[4],o[2],o[3],r);try{var a=o[0].merge(t,s[4],s[0]);return[a[0],o[1].concat(s[1]),s[2],s[3],a[1],s[5]]}catch(t){if(!(t instanceof Array))throw t;throw new p.ElaborationError(this.position,"Both patterns of a disjunctive pattern must have the same type.")}},e.prototype.simplify=function(){return new e(this.position,this.left.simplify(),this.right.simplify())},e.prototype.matchType=function(t,e,n){throw new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e.prototype.matches=function(t,e){var n=this.left.matches(t,e);return void 0!==n?n:this.right.matches(t,e)},e.prototype.assertUniqueBinding=function(t,e){return new Set},e}(h);e.DisjunctivePattern=V;var b=function(t){function e(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.pattern=n,o.nested=i,o.expression=r,o}return r(e,t),e.prototype.getType=function(t,e,n,i,r){throw void 0===e&&(e=new Map),void 0===n&&(n="'*t0"),void 0===i&&(i=new Set),void 0===r&&(r=!1),new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e.prototype.simplify=function(){return new e(this.position,this.pattern.simplify(),this.nested.simplify(),this.expression.simplify())},e.prototype.matchType=function(t,e,n){throw new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e.prototype.matches=function(t,e){if(void 0!==this.pattern.matches(t,e))throw new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e.prototype.assertUniqueBinding=function(t,e){return new Set},e}(h);e.NestedMatch=b;var A=function(t){function e(e,n){var i=t.call(this)||this;return i.expressions=e,i.operators=n,i}return r(e,t),e.prototype.matchType=function(t,e,n){return this.reParse(t).matchType(t,e,n)},e.prototype.matches=function(t,e){return this.reParse(t).matches(t,e)},e.prototype.simplify=function(){throw new p.InternalInterpreterError(this.position,"Ouch, I'm not fully parsed.")},e.prototype.reParse=function(t){for(var e=this.operators,n=this.expressions,i=[],r=0;r<n.length;++r)i.push([r]);e.sort(function(e,n){var i=e[0],r=e[1],o=n[0],s=n[1],a=t.getInfixStatus(i),u=t.getInfixStatus(o);if(a.precedence>u.precedence)return-1;if(a.precedence<u.precedence)return 1;if(a.rightAssociative){if(r>s)return-1;if(r<s)return 1}else{if(r>s)return 1;if(r<s)return-1}return 0});for(r=0;r<e.length;++r){if(r>0){var o=t.getInfixStatus(e[r][0]),s=t.getInfixStatus(e[r-1][0]);if(o.precedence===s.precedence&&o.rightAssociative!==s.rightAssociative&&(i[e[r-1][1]+1]===i[e[r][1]]||i[e[r-1][1]]===i[e[r][1]+1]))throw new p.ParserError("Could you ever imagine left associatives and right associatives living together in peace?",e[r][0].position)}for(var a=n[e[r][1]],u=n[e[r][1]+1],c=new w(e[r][0].position,new l(e[r][0].position,e[r][0]),new N(e[r][0].position,[a,u])),h=i[e[r][1]],f=0,d=i[e[r][1]+1];f<d.length;f++){var y=d[f];h.push(y)}for(var v=0,m=h;v<m.length;v++){i[y=m[v]]=h,n[y]=c}}return n[0]},e}(h);e.InfixExpression=A;var L=new l(0,new a.IdentifierToken("false",0)),B=new l(0,new a.IdentifierToken("true",0)),R=new l(0,new a.IdentifierToken("nil",0)),C=new l(0,new a.IdentifierToken("::",0)),O=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.leftOperand=n,r.rightOperand=i,r}return r(e,t),e.prototype.simplify=function(){return new F(this.position,this.leftOperand,this.rightOperand,L).simplify()},e.prototype.toString=function(){return"( "+this.leftOperand+" andalso "+this.rightOperand+" )"},e}(h);e.Conjunction=O;var _=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.leftOperand=n,r.rightOperand=i,r}return r(e,t),e.prototype.simplify=function(){return new F(this.position,this.leftOperand,B,this.rightOperand).simplify()},e.prototype.toString=function(){return"( "+this.leftOperand+" orelse "+this.rightOperand+" )"},e}(h);e.Disjunction=_;var N=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return r(e,t),e.prototype.matchType=function(t,e,n){return this.simplify().matchType(t,e,n)},e.prototype.matches=function(t,e){return this.simplify().matches(t,e)},e.prototype.simplify=function(){for(var t=[],e=0;e<this.expressions.length;++e)t.push([""+(e+1),this.expressions[e].simplify()]);return new d(this.position,!0,t)},e.prototype.toString=function(){for(var t="( ",e=0;e<this.expressions.length;++e)e>0&&(t+=", "),t+=this.expressions[e];return t+" )"},e}(h);e.Tuple=N;var q=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return r(e,t),e.prototype.matchType=function(t,e,n){return this.simplify().matchType(t,e,n)},e.prototype.matches=function(t,e){return this.simplify().matches(t,e)},e.prototype.simplify=function(){for(var t=R,e=this.expressions.length-1;e>=0;--e){var n=new N(-1,[this.expressions[e],t]).simplify();t=new w(-1,C,n)}return t},e.prototype.toString=function(){for(var t="[ ",e=0;e<this.expressions.length;++e)e>0&&(t+=", "),t+=this.expressions[e];return t+" ]"},e}(h);e.List=q;var U=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return r(e,t),e.prototype.simplify=function(){for(var t=this.expressions.length-1,e=new E(-1,[[new x(0),this.expressions[t]]]),n=new D(-1,this.expressions[t-1],e),i=t-2;i>=0;--i)e=new E(-1,[[new x(0),n]]),n=new D(-1,this.expressions[i],e);return n.simplify()},e.prototype.toString=function(){for(var t="( ",e=0;e<this.expressions.length;++e)e>0&&(t+="; "),t+=this.expressions[e];return t+" )"},e}(h);e.Sequence=U;var P=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.label=n,i}return r(e,t),e.prototype.simplify=function(){return new T(this.position,new E(-1,[[new d(-1,!1,[[this.label.text,new l(-1,new a.IdentifierToken("__rs",-1))]]),new l(-1,new a.IdentifierToken("__rs",-1))]]))},e.prototype.toString=function(){return"#"+this.label.getText()},e}(h);e.RecordSelector=P;var D=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.match=i,r}return r(e,t),e.prototype.simplify=function(){return new w(this.position,new T(this.position,this.match.simplify()),this.expression.simplify())},e.prototype.toString=function(){return"case "+this.expression+" of "+this.match},e}(h);e.CaseAnalysis=D;var F=function(t){function e(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.condition=n,o.consequence=i,o.alternative=r,o}return r(e,t),e.prototype.simplify=function(){var t=new E(this.position,[[B,this.consequence],[L,this.alternative]]);return new D(this.position,this.condition,t).simplify()},e.prototype.toString=function(){return"if "+this.condition+" then "+this.consequence+" else "+this.alternative},e}(h);e.Conditional=F;var M=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.condition=n,r.body=i,r}return r(e,t),e.prototype.simplify=function(){var t=new l(this.position,new a.IdentifierToken("__whl",this.position)),e=new w(this.position,t,new N(this.position,[])),n=new F(this.position,this.condition,new U(this.position,[this.body,e]),new N(this.position,[])),i=new s.ValueBinding(this.position,!0,t,new T(this.position,new E(this.position,[[new N(this.position,[]),n]]))),r=new s.ValueDeclaration(this.position,[],[i]);return new y(this.position,r,e).simplify()},e.prototype.toString=function(){return"( while "+this.condition+" do "+this.body+" )"},e}(h);e.While=M;var K=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.pattern=n,r.condition=i,r}return r(e,t),e.prototype.simplify=function(){return new b(this.position,this.pattern.simplify(),B,this.condition.simplify())},e.prototype.matchType=function(t,e,n){throw new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e.prototype.matches=function(t,e){throw new p.InternalInterpreterError(this.position,"「ニャ－、ニャ－」")},e}(h);e.PatternGuard=K},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(8),r=n(11),o=n(0),s=n(9),a=n(10),u=n(14);function p(){var t=[];for(var e in r.STDLIB)Object.prototype.hasOwnProperty.call(r.STDLIB,e)&&"_"!==e[0]&&t.push(e);return t}e.interpret=function(t,e,n){void 0===e&&(e=i.getInitialState()),void 0===n&&(n={allowUnicodeInStrings:!1,allowSuccessorML:!1,disableElaboration:!1,allowVector:!0,strictMode:!0});var r=e.getNestedState(),p=s.lex(t,n),c=a.parse(p,r,n);if(c=c.simplify(),r=e.getNestedState(),!0===n.disableElaboration){var h=u.evaluate(e.getNestedState(),c);if(void 0===h)throw new o.InternalInterpreterError(-1,"How is this undefined?");return{state:h.newState,evaluationErrored:h.hasThrown,error:h.value,warnings:h.newState.getWarnings()}}var f=c.elaborate(r,new Map,"'*t0",!0,n);if(r=f[0],!0===n.disableEvaluation)return{state:r,evaluationErrored:!1,error:void 0,warnings:r.getWarnings()};var l=u.evaluate(e.getNestedState(),c);if(void 0===l)throw new o.InternalInterpreterError(-1,"How is this undefined?");for(var d=0;d<f[1].length;++d)l.newState.addWarning(f[1][d]);if(l.hasThrown)return{state:l.newState,evaluationErrored:!0,error:l.value,warnings:l.newState.getWarnings()};for(var y=l.newState;y.id>e.id;){if(void 0!==y.dynamicBasis){for(var d in y.freeTypeVariables=r.getTypeVariableBinds(y.id),y.dynamicBasis.valueEnvironment)Object.prototype.hasOwnProperty.call(y.dynamicBasis.valueEnvironment,d)&&void 0!==(v=r.getStaticValue(d,y.id))&&y.setStaticValue(d,v[0],v[1]);for(var d in y.dynamicBasis.typeEnvironment)Object.prototype.hasOwnProperty.call(y.dynamicBasis.typeEnvironment,d)&&void 0!==(v=r.getStaticType(d,y.id))&&y.setStaticType(d,v.type,v.constructors,v.arity,v.allowsEquality);for(var d in y.dynamicBasis.structureEnvironment)Object.prototype.hasOwnProperty.call(y.dynamicBasis.structureEnvironment,d)&&void 0!==(v=r.getStaticStructure(d,y.id))&&y.setStaticStructure(d,v);for(var d in y.dynamicBasis.signatureEnvironment)Object.prototype.hasOwnProperty.call(y.dynamicBasis.signatureEnvironment,d)&&void 0!==(v=r.getStaticSignature(d,y.id))&&y.setStaticSignature(d,v);for(var d in y.dynamicBasis.functorEnvironment){var v;Object.prototype.hasOwnProperty.call(y.dynamicBasis.functorEnvironment,d)&&void 0!==(v=r.getStaticFunctor(d,y.id))&&y.setStaticFunctor(d,v)}}if(void 0===r.parent)break;for(y=y.parent;r.id>y.id&&void 0!==r.parent;)r=r.parent}return{state:l.newState,evaluationErrored:!1,error:l.value,warnings:l.newState.getWarnings()}},e.getAvailableModules=p,e.getFirstState=function(t,e){void 0===t&&(t=p()),void 0===e&&(e={});for(var n=r.loadModule(i.getInitialState(),"__Base",e),o=0,s=t;o<s.length;o++){var a=s[o];n=r.loadModule(n,a,e)}return n}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(3),r=n(4),o=n(1),s=n(0),a=new r.CustomType("real"),u=new r.CustomType("bool"),p=new r.CustomType("string"),c=new r.CustomType("char");function h(t){return new r.FunctionType(new r.TupleType([t,t]),t).simplify()}function f(t){return new r.FunctionType(new r.TupleType([t,t]),u).simplify()}var l=new r.TypeVariable("'a"),d=new r.TypeVariable("''b"),y=new r.TypeVariable("'iw"),v=new r.TypeVariable("'ir"),w=new r.TypeVariable("'iwr"),m=new r.TypeVariable("'any"),g=new o.ExceptionConstructor("Match",0,0,0),T=new o.ExceptionConstructor("Bind",0,0,1),E=new o.ExceptionConstructor("Div",0,0,2),x=new o.ExceptionConstructor("Overflow",0,0,3);function S(t){return new r.TypeVariableBind("'iw",t,[new r.CustomType("int"),new r.CustomType("word")]).propagate()}function I(t){return new r.TypeVariableBind("'ir",t,[new r.CustomType("int"),a]).propagate()}function k(t){return new r.TypeVariableBind("'iwr",t,[new r.CustomType("int"),new r.CustomType("word"),a]).propagate()}function V(t){return new r.TypeVariableBind("'any",t,[new r.CustomType("int"),new r.CustomType("word"),a,new r.CustomType("string"),new r.CustomType("char")]).propagate()}var b=new i.State(0,void 0,new i.StaticBasis({unit:new i.TypeInformation(new r.FunctionType(new r.CustomType("unit"),new r.TupleType([])).simplify(),[],0,!0),bool:new i.TypeInformation(new r.CustomType("bool"),["true","false"],0,!0),int:new i.TypeInformation(new r.CustomType("int"),[],0,!0),word:new i.TypeInformation(new r.CustomType("word"),[],0,!0),real:new i.TypeInformation(a,[],0,!1),string:new i.TypeInformation(new r.CustomType("string"),[],0,!0),char:new i.TypeInformation(new r.CustomType("char"),[],0,!0),list:new i.TypeInformation(new r.CustomType("list",[l]),["nil","::"],1,!0),array:new i.TypeInformation(new r.CustomType("array",[l]),[],1,!0),vector:new i.TypeInformation(new r.CustomType("vector",[l]),[],1,!0),ref:new i.TypeInformation(new r.CustomType("ref",[l]),["ref"],1,!0),exn:new i.TypeInformation(new r.CustomType("exn"),[],0,!1)},{div:[S(h(y)),i.IdentifierStatus.VALUE_VARIABLE],mod:[S(h(y)),i.IdentifierStatus.VALUE_VARIABLE],"*":[k(h(w)),i.IdentifierStatus.VALUE_VARIABLE],"/":[h(a),i.IdentifierStatus.VALUE_VARIABLE],"+":[k(h(w)),i.IdentifierStatus.VALUE_VARIABLE],"-":[k(h(w)),i.IdentifierStatus.VALUE_VARIABLE],"<":[V(f(m)),i.IdentifierStatus.VALUE_VARIABLE],"<=":[V(f(m)),i.IdentifierStatus.VALUE_VARIABLE],">":[V(f(m)),i.IdentifierStatus.VALUE_VARIABLE],">=":[V(f(m)),i.IdentifierStatus.VALUE_VARIABLE],"=":[new r.TypeVariableBind("''b",new r.FunctionType(new r.TupleType([d,d]),u)).simplify(),i.IdentifierStatus.VALUE_VARIABLE],"<>":[new r.TypeVariableBind("''b",new r.FunctionType(new r.TupleType([d,d]),u)).simplify(),i.IdentifierStatus.VALUE_VARIABLE],true:[new r.CustomType("bool"),i.IdentifierStatus.VALUE_CONSTRUCTOR],false:[new r.CustomType("bool"),i.IdentifierStatus.VALUE_CONSTRUCTOR],nil:[new r.TypeVariableBind("'a",new r.CustomType("list",[l])),i.IdentifierStatus.VALUE_CONSTRUCTOR],"::":[new r.TypeVariableBind("'a",new r.FunctionType(new r.TupleType([l,new r.CustomType("list",[l])]),new r.CustomType("list",[l]))).simplify(),i.IdentifierStatus.VALUE_CONSTRUCTOR],Match:[new r.CustomType("exn"),i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Bind:[new r.CustomType("exn"),i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Div:[new r.CustomType("exn"),i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Overflow:[new r.CustomType("exn"),i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],"^":[h(p),i.IdentifierStatus.VALUE_VARIABLE],explode:[new r.FunctionType(p,new r.CustomType("list",[c])).simplify(),i.IdentifierStatus.VALUE_VARIABLE],implode:[new r.FunctionType(new r.CustomType("list",[c]),p).simplify(),i.IdentifierStatus.VALUE_VARIABLE],"~":[I(new r.FunctionType(v,v)),i.IdentifierStatus.VALUE_VARIABLE],abs:[I(new r.FunctionType(v,v)),i.IdentifierStatus.VALUE_VARIABLE],print:[new r.TypeVariableBind("'a",new r.FunctionType(l,new r.TupleType([]))).simplify(),i.IdentifierStatus.VALUE_VARIABLE],printLn:[new r.TypeVariableBind("'a",new r.FunctionType(l,new r.TupleType([]))).simplify(),i.IdentifierStatus.VALUE_VARIABLE],":=":[new r.TypeVariableBind("'a",new r.FunctionType(new r.TupleType([new r.CustomType("ref",[l]),l]),new r.TupleType([]))).simplify(),i.IdentifierStatus.VALUE_VARIABLE],ref:[new r.TypeVariableBind("'a",new r.FunctionType(l,new r.CustomType("ref",[l]))),i.IdentifierStatus.VALUE_CONSTRUCTOR],"!":[new r.TypeVariableBind("'a",new r.FunctionType(new r.CustomType("ref",[l]),l)),i.IdentifierStatus.VALUE_VARIABLE]},{},{},{}),new i.DynamicBasis({unit:[],bool:["true","false"],int:[],word:[],real:[],string:[],char:[],list:["nil","::"],array:[],vector:[],ref:["ref"],exn:[]},{div:[new o.PredefinedFunction("div",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer&&i instanceof o.Integer)return 0===i.value?[E.construct(),!0,[]]:[n.divide(i),!1,[]];if(n instanceof o.Word&&i instanceof o.Word)return 0===i.value?[E.construct(),!0,[]]:[n.divide(i),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "div" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],mod:[new o.PredefinedFunction("mod",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer&&i instanceof o.Integer)return 0===i.value?[E.construct(),!0,[]]:[n.modulo(i),!1,[]];if(n instanceof o.Word&&i instanceof o.Word)return 0===i.value?[E.construct(),!0,[]]:[n.modulo(i),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "mod" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"*":[new o.PredefinedFunction("*",function(t,e){if(t instanceof o.RecordValue){var n,i=t.getValue("1"),r=t.getValue("2");if(i instanceof o.Integer&&r instanceof o.Integer)return(n=i.multiply(r)).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(i instanceof o.Word&&r instanceof o.Word)return(n=i.multiply(r)).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(i instanceof o.Real&&r instanceof o.Real)return(n=i.multiply(r)).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]]}throw new s.InternalInterpreterError(-1,'Called "*" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"/":[new o.PredefinedFunction("/",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Real&&i instanceof o.Real)return 0===i.value?[E.construct(),!0,[]]:[n.divide(i),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "/" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"+":[new o.PredefinedFunction("+",function(t,e){if(t instanceof o.RecordValue){var n,i=t.getValue("1"),r=t.getValue("2");if(i instanceof o.Integer&&r instanceof o.Integer)return(n=i.add(r)).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(i instanceof o.Word&&r instanceof o.Word)return(n=i.add(r)).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(i instanceof o.Real&&r instanceof o.Real)return(n=i.add(r)).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]]}throw new s.InternalInterpreterError(-1,'Called "+" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"-":[new o.PredefinedFunction("-",function(t,e){if(t instanceof o.RecordValue){var n,i=t.getValue("1"),r=t.getValue("2");if(i instanceof o.Integer&&r instanceof o.Integer)return(n=i.add(r.negate())).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(i instanceof o.Word&&r instanceof o.Word)return(n=i.add(r.negate())).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(i instanceof o.Real&&r instanceof o.Real)return(n=i.add(r.negate())).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]]}throw new s.InternalInterpreterError(-1,'Called "-" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"<":[new o.PredefinedFunction("<",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer&&i instanceof o.Integer)return[new o.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof o.Word&&i instanceof o.Word)return[new o.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof o.Real&&i instanceof o.Real)return[new o.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof o.StringValue&&i instanceof o.StringValue)return[new o.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof o.CharValue&&i instanceof o.CharValue)return[new o.BoolValue(n.compareTo(i)<0),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "<" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],">":[new o.PredefinedFunction("<",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer&&i instanceof o.Integer)return[new o.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof o.Word&&i instanceof o.Word)return[new o.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof o.Real&&i instanceof o.Real)return[new o.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof o.StringValue&&i instanceof o.StringValue)return[new o.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof o.CharValue&&i instanceof o.CharValue)return[new o.BoolValue(n.compareTo(i)>0),!1,[]]}throw new s.InternalInterpreterError(-1,'Called ">" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"<=":[new o.PredefinedFunction("<",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer&&i instanceof o.Integer)return[new o.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof o.Word&&i instanceof o.Word)return[new o.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof o.Real&&i instanceof o.Real)return[new o.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof o.StringValue&&i instanceof o.StringValue)return[new o.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof o.CharValue&&i instanceof o.CharValue)return[new o.BoolValue(n.compareTo(i)<=0),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "<=" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],">=":[new o.PredefinedFunction("<",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer&&i instanceof o.Integer)return[new o.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof o.Word&&i instanceof o.Word)return[new o.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof o.Real&&i instanceof o.Real)return[new o.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof o.StringValue&&i instanceof o.StringValue)return[new o.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof o.CharValue&&i instanceof o.CharValue)return[new o.BoolValue(n.compareTo(i)>=0),!1,[]]}throw new s.InternalInterpreterError(-1,'Called ">=" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"=":[new o.PredefinedFunction("=",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");return[new o.BoolValue(n.equals(i)),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "=" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"<>":[new o.PredefinedFunction("=",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");return[new o.BoolValue(!n.equals(i)),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "<>" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],true:[new o.BoolValue(!0),i.IdentifierStatus.VALUE_CONSTRUCTOR],false:[new o.BoolValue(!1),i.IdentifierStatus.VALUE_CONSTRUCTOR],nil:[new o.ValueConstructor("nil"),i.IdentifierStatus.VALUE_CONSTRUCTOR],"::":[new o.ValueConstructor("::",1),i.IdentifierStatus.VALUE_CONSTRUCTOR],Match:[g,i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Bind:[T,i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Div:[E,i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Overflow:[x,i.IdentifierStatus.EXCEPTION_CONSTRUCTOR],"^":[new o.PredefinedFunction("^",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.StringValue&&i instanceof o.StringValue)return[n.concat(i),!1,[]]}throw new s.InternalInterpreterError(-1,'Called "^" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],explode:[new o.PredefinedFunction("explode",function(t,e){if(t instanceof o.StringValue)return[t.explode(),!1,[]];throw new s.InternalInterpreterError(-1,'Called "explode" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],implode:[new o.PredefinedFunction("implode",function(t,e){if(t instanceof o.ConstructedValue)return[o.StringValue.implode(t),!1,[]];throw new s.InternalInterpreterError(-1,'Called "implode" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],"~":[new o.PredefinedFunction("~",function(t,e){var n;if(t instanceof o.Integer)return(n=t.negate()).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(t instanceof o.Real)return(n=t.negate()).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];throw new s.InternalInterpreterError(-1,'Called "~" on something weird.')}),i.IdentifierStatus.VALUE_VARIABLE],abs:[new o.PredefinedFunction("~",function(t,e){var n;if(t instanceof o.Integer)return t.value>=0?[t,!1,[]]:(n=t.negate()).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];if(t instanceof o.Real)return t.value>=0?[t,!1,[]]:(n=t.negate()).hasOverflow()?[x.construct(),!0,[]]:[n,!1,[]];throw new s.InternalInterpreterError(-1,'Called "~" on something weird.')}),i.IdentifierStatus.VALUE_VARIABLE],print:[new o.PredefinedFunction("print",function(t,e){var n=[];return t instanceof o.StringValue?n.push(new s.Warning(-2,t.value)):n.push(new s.Warning(-2,t.toString(void 0,1e18))),[new o.RecordValue,!1,n]}),i.IdentifierStatus.VALUE_VARIABLE],printLn:[new o.PredefinedFunction("printLn",function(t,e){var n=[];return t instanceof o.StringValue?n.push(new s.Warning(-2,t.value+"\n")):n.push(new s.Warning(-2,t.toString(void 0,1e18)+"\n")),[new o.RecordValue,!1,n]}),i.IdentifierStatus.VALUE_VARIABLE],":=":[new o.PredefinedFunction(":=",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.ReferenceValue)return e.modifiable.setCell(n.address,i),[new o.RecordValue,!1,[]]}throw new s.InternalInterpreterError(-1,'Called ":=" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE],ref:[new o.PredefinedFunction("ref",function(t,e){return[e.modifiable.setNewCell(t),!1,[]]}),i.IdentifierStatus.VALUE_VARIABLE],"!":[new o.PredefinedFunction("!",function(t,e){if(t instanceof o.ReferenceValue){var n=e.modifiable.getCell(t.address);if(void 0===n)throw new s.InternalInterpreterError(-1,"Neko-sempai, I think that I crashed. What shall I do now?");return[n,!1,[]]}throw new s.InternalInterpreterError(-1,'Called "!" on value of the wrong type ('+t.constructor.name+").")}),i.IdentifierStatus.VALUE_VARIABLE]},{},{},{}),[0,{}],4,[0,new Map],{div:new i.InfixStatus(!0,7,!1),mod:new i.InfixStatus(!0,7,!1),"*":new i.InfixStatus(!0,7,!1),"/":new i.InfixStatus(!0,7,!1),"+":new i.InfixStatus(!0,6,!1),"-":new i.InfixStatus(!0,6,!1),"<":new i.InfixStatus(!0,4,!1),">":new i.InfixStatus(!0,4,!1),"<=":new i.InfixStatus(!0,4,!1),">=":new i.InfixStatus(!0,4,!1),"::":new i.InfixStatus(!0,5,!0),"=":new i.InfixStatus(!0,4,!1),"<>":new i.InfixStatus(!0,4,!1),":=":new i.InfixStatus(!0,3,!1),"^":new i.InfixStatus(!0,6,!1)},{Match:1,Bind:1,Div:1,Overflow:1,int:1,real:1,string:1,char:1,unit:1,word:1,list:1,bool:1});e.getInitialState=function(){return b.getNestedState()}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),r=n(2),o=n(1),s=new Set(["abstype","and","andalso","as","case","datatype","do","else","end","exception","fn","fun","handle","if","in","infix","infixr","let","local","nonfix","of","op","open","orelse","raise","rec","then","type","val","with","withtype","while","(",")","[","]","{","}",",",":",";","...","_","|","=","=>","->","#","eqtype","functor","signature","struct","include","sharing","structure","where","sig",":>"]),a=new Set(["!","%","&","$","#","+","-","/",":","<","=",">","?","@","\\","~","`","^","|","*"]),u=function(){function t(t,e){this.input=t,this.options=e,this.position=0,this.skipWhitespaceAndComments()}return t.isAlphanumeric=function(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||"'"===t||"_"===t},t.isSymbolic=function(t){return a.has(t)},t.isWhitespace=function(t){return" "===t||"\t"===t||"\n"===t||"\f"===t},t.isNumber=function(t,e){return t>="0"&&t<="9"||e&&(t>="a"&&t<="f"||t>="A"&&t<="F")},t.prototype.consumeChar=function(t,e){if(void 0===t&&(t=""),void 0===e&&(e=this.input.length-1),this.position>=this.input.length)throw""===t?new i.IncompleteError(e):new i.IncompleteError(e,t);return++this.position,this.input.charAt(this.position-1)},t.prototype.getChar=function(t){return void 0===t&&(t=0),this.position+t>=this.input.length?"":this.input.charAt(this.position+t)},t.prototype.skipWhitespace=function(){for(;t.isWhitespace(this.getChar());)++this.position},t.prototype.skipWhitespaceAndComments=function(){var t;do{for(t=this.position,this.skipWhitespace();this.position+1<this.input.length&&"(*"===this.input.substr(this.position,2);){var e=this.position;this.position+=2;for(var n=1;n>0;){if(this.position>this.input.length-2)throw new i.IncompleteError(e,"unclosed comment");var r=this.input.substr(this.position,2);"(*"===r?(++n,++this.position):"*)"===r&&(--n,++this.position),++this.position}}}while(this.position!==t);this.tokenStart=this.position},t.prototype.readNumeric=function(e,n){void 0===n&&(n=-1);for(var i="";t.isNumber(this.getChar(),e)&&i.length!==n;)i+=this.consumeChar();return i},t.prototype.makeNumberToken=function(e,n,s,a){if(void 0===n&&(n=!1),void 0===s&&(s=!1),void 0===a&&(a=!1),n&&s)throw new i.InternalInterpreterError(this.position);var u=this.input.substring(this.tokenStart,this.position);if(n)return new r.RealConstantToken(u,this.tokenStart,parseFloat(e));var p=parseInt(e,a?16:10);if(p>o.MAXINT)throw new i.LexerError(this.position,'"'+p+'", whoa, it\'s over "'+o.MAXINT+'".');if(p<o.MININT)throw new i.LexerError(this.position,'"'+p+'", whoa, it\'s ounder "'+o.MININT+'".');if(s)return new r.WordConstantToken(u,this.tokenStart,p);var c=u.charAt(0);return t.isNumber(c,!1)&&"0"!==c?new r.NumericToken(u,this.tokenStart,p):new r.IntegerConstantToken(u,this.tokenStart,p)},t.prototype.lexNumber=function(){var e="",n=!1,i=!1,r=!1,o=!1;if("~"===this.getChar()&&(++this.position,o=!0,e+="-"),"0"===this.getChar()&&("w"===this.getChar(1)||"x"===this.getChar(1))){++this.position,"w"===this.getChar()&&(i=!0),"x"===this.getChar(i?1:0)&&(n=!0);var s=i&&n?2:1;if(o&&i||!t.isNumber(this.getChar(s),n))return e+="0",this.makeNumberToken(e,!1,!1,!1);this.position+=s}if(e+=this.readNumeric(n),n||i)return this.makeNumberToken(e,!1,i,n);if("."===this.getChar()){if(!t.isNumber(this.getChar(1),!1))return this.makeNumberToken(e);e+=this.consumeChar(),e+=this.readNumeric(!1),r=!0}if("e"===this.getChar()||"E"===this.getChar()){if(t.isNumber(this.getChar(1),!1))e+="e",++this.position,e+=this.readNumeric(!1);else{if("~"!==this.getChar(1)||!t.isNumber(this.getChar(2),!1))return this.makeNumberToken(e,r);e+="e-",this.position+=2,e+=this.readNumeric(!1)}r=!0}return this.makeNumberToken(e,r)},t.prototype.lexString=function(){var e=this.position;if('"'!==this.consumeChar())throw new i.InternalInterpreterError(this.position);for(var n="";'"'!==this.getChar();)if("\\"===this.getChar()){if(++this.position,t.isWhitespace(this.getChar())){if(this.skipWhitespace(),"\\"!==this.consumeChar("unterminated whitespace escape sequence"))throw new i.LexerError(this.position-1,"Found non-whitespace character in whitespace escape sequence.")}else switch(u=this.consumeChar()){case"a":n+="";break;case"b":n+="\b";break;case"t":n+="\t";break;case"n":n+="\n";break;case"v":n+="\v";break;case"f":n+="\f";break;case"r":n+="\r";break;case'"':n+='"';break;case"\\":n+="\\";break;case"^":var o=this.consumeChar().charCodeAt(0);if(o<64||o>95)throw new i.LexerError(this.position-1,'"'+String.fromCharCode(o)+'" does not represent a valid control character.');n+=String.fromCharCode(o-64);break;case"u":if(4!==(s=this.readNumeric(!0,4)).length)throw new i.LexerError(this.position-s.length-1,"A Unicode escape sequence must consist of four digits.");if((a=parseInt(s,16))>=256&&!this.options.allowUnicodeInStrings)throw new i.LexerError(this.position-s.length-1,'The character code "'+s+'" is too large, only values between 00 and ff are allowed.');n+=String.fromCharCode(a);break;default:if(!t.isNumber(u,!1))throw new i.LexerError(this.position-1,"Invalid escape sequence.");var s,a;if(--this.position,3!==(s=this.readNumeric(!1,3)).length)throw new i.LexerError(this.position-s.length-1,"A numeric escape sequence must consist of three digits.");if((a=parseInt(s,10))>=256&&!this.options.allowUnicodeInStrings)throw new i.LexerError(this.position-s.length-1,'The character code "'+s+'" is too large, only values between 000 and 255 are allowed.');n+=String.fromCharCode(a)}}else{var u;if(((u=this.consumeChar("unterminated string",this.tokenStart).charCodeAt(0))<33||u>126)&&32!==u&&u<128){var p="";throw 9===u&&(p=" (tab)"),10===u&&(p=" (newline)"),13===u&&(p=" (carriage return)"),new i.LexerError(this.position-1,"A string may not contain the character <"+u+">"+p+".")}n+=String.fromCharCode(u)}if('"'!==this.consumeChar())throw new i.InternalInterpreterError(this.position);return new r.StringConstantToken(this.input.substring(e,this.position),this.tokenStart,n)},t.prototype.lexCharacter=function(){if("#"!==this.consumeChar())throw new i.InternalInterpreterError(this.position);var t=this.lexString();if(1!==t.value.length)throw new i.LexerError(this.tokenStart,"A character constant must have length 1, not "+t.value.length+".");return new r.CharacterConstantToken("#"+t.text,this.tokenStart,t.value)},t.prototype.lexIdentifierOrKeyword=function(){var e,n="",o=this.getChar();if(t.isSymbolic(o))e=t.isSymbolic;else{if(!t.isAlphanumeric(o)||t.isNumber(o,!1)||"_"===o){if(s.has(o))return new r.KeywordToken(this.consumeChar(),this.tokenStart);if("."===o&&"."===this.getChar(1)&&"."===this.getChar(2))return this.position+=3,new r.KeywordToken("...",this.tokenStart);throw o.charCodeAt(0)<32?new i.LexerError(this.position,"Invalid character <"+o.charCodeAt(0)+">."):new i.LexerError(this.position,'Invalid token "'+o+'".')}e=t.isAlphanumeric}do{n+=this.consumeChar()}while(e(this.getChar()));return"*"===n?new r.StarToken(this.tokenStart):"="===n?new r.EqualsToken(this.tokenStart):s.has(n)?new r.KeywordToken(n,this.tokenStart):"'"===o?"'"===n.charAt(1)?new r.EqualityTypeVariableToken(n,this.tokenStart):new r.TypeVariableToken(n,this.tokenStart):t.isAlphanumeric(o)?new r.AlphanumericIdentifierToken(n,this.tokenStart):new r.IdentifierToken(n,this.tokenStart)},t.prototype.lexLongIdentifierOrKeyword=function(){var t=this.tokenStart,e=this.lexIdentifierOrKeyword();if("."!==this.getChar())return e;var n=[];do{if(this.consumeChar(),!(e instanceof r.AlphanumericIdentifierToken))throw new i.LexerError(e.position,'Expected structure name before ".".');n.push(e),this.tokenStart=this.position,e=this.lexIdentifierOrKeyword()}while("."===this.getChar());if(!(e instanceof r.IdentifierToken||e instanceof r.StarToken)||e instanceof r.TypeVariableToken)throw new i.LexerError(e.position,'"'+e.text+'" is not allowed in a long identifier.');return new r.LongIdentifierToken(this.input.substring(t,this.position),t,n,e)},t.prototype.nextToken=function(){var e;return this.tokenStart=this.position,e=t.isNumber(this.getChar(),!1)||"~"===this.getChar()&&t.isNumber(this.getChar(1),!1)?this.lexNumber():'"'===this.getChar()?this.lexString():"#"===this.getChar()&&'"'===this.getChar(1)?this.lexCharacter():this.lexLongIdentifierOrKeyword(),this.skipWhitespaceAndComments(),e},t.prototype.finished=function(){return this.position>=this.input.length},t}();e.lex=function(t,e){for(var n=new u(t,e),i=[];!n.finished();)i.push(n.nextToken());return i}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(6),r=n(4),o=n(0),s=n(2),a=n(5),u=n(13),p=function(){function t(t,e,n,i){if(this.tokens=t,this.state=e,this.currentId=n,this.options=i,this.position=0,this.newcons=new Set,void 0===this.state)throw new o.InternalInterpreterError(-1,"What are you, stupid? Hurry up and give me a state already!")}return t.prototype.assertFinished=function(){if(this.position<=this.tokens.length-1)throw new o.ParserError('Junk after declaration: "'+this.currentToken().getText()+'".',this.position)},t.prototype.assertKeywordToken=function(t,e){if(void 0===e&&(e=void 0),!(t instanceof s.KeywordToken))throw new o.ParserError('Expected a reserved word, got "'+t.getText()+'" ('+t.constructor.name+").",t.position);if(void 0!==e&&t.text!==e)throw new o.ParserError('Expected "'+e+'" but got "'+t.text+'".',t.position)},t.prototype.assertVidToken=function(t){if(!t.isVid())throw new o.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},t.prototype.assertIdentifierToken=function(t){if(!(t instanceof s.IdentifierToken))throw new o.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},t.prototype.assertVidOrLongToken=function(t){if(!(t.isVid()||t instanceof s.LongIdentifierToken))throw new o.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},t.prototype.assertIdentifierOrLongToken=function(t){if(!(t instanceof s.IdentifierToken||t instanceof s.LongIdentifierToken))throw new o.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},t.prototype.assertRecordLabelToken=function(t){if(!t.isValidRecordLabel())throw new o.ParserError('Expected a record label "'+t.getText()+'" ('+t.constructor.name+").",t.position)},t.prototype.checkVidOrLongToken=function(t){return t.isVid()||t instanceof s.LongIdentifierToken},t.prototype.checkIdentifierOrLongToken=function(t){return t instanceof s.IdentifierToken||t instanceof s.LongIdentifierToken},t.prototype.checkKeywordToken=function(t,e){return void 0===e&&(e=void 0),t instanceof s.KeywordToken&&(void 0===e||t.text===e)},t.prototype.parseOpIdentifierToken=function(t){void 0===t&&(t=!1);var e=this.currentToken(),n=this.checkKeywordToken(e,"op");n&&++this.position,t?this.assertIdentifierOrLongToken(this.currentToken()):this.assertIdentifierToken(this.currentToken());var i=this.currentToken();return i.opPrefixed=n,++this.position,i},t.prototype.parseAtomicExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"op")){++this.position;var e=this.currentToken();return this.assertVidOrLongToken(e),e.opPrefixed=!0,++this.position,new i.ValueIdentifier(t.position,e)}if(this.checkKeywordToken(t,"{"))return++this.position,this.parseExpressionRow();if(this.checkKeywordToken(t,"(")){if(++this.position,this.checkKeywordToken(this.currentToken(),")"))return++this.position,new i.Tuple(t.position,[]);for(var n=[this.parseExpression()],r=!1,a=!1;;){e=this.currentToken();if(!this.checkKeywordToken(e,",")||r){if(this.checkKeywordToken(e,";")&&!a){if(++this.position,r=!0,!this.options.allowSuccessorML||!this.checkKeywordToken(this.currentToken(),")")){n.push(this.parseExpression());continue}e=this.currentToken()}if(!this.checkKeywordToken(e,")"))throw new o.ParserError('Expected ",", ";" or ")" but got "'+e.getText()+'".',e.position);if(++this.position,1===n.length)return n[0];if(a)return new i.Tuple(t.position,n);if(r)return new i.Sequence(t.position,n);n.push(this.parseExpression())}else++this.position,a=!0,n.push(this.parseExpression())}}if(this.checkKeywordToken(t,"[")){if(++this.position,this.checkKeywordToken(this.currentToken(),"]"))return++this.position,new i.List(t.position,[]);for(n=[this.parseExpression()];;){e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,"]"))return++this.position,new i.List(t.position,n);throw new o.ParserError('Expected "," or "]" but found "'+e.getText()+'".',e.position)}++this.position,n.push(this.parseExpression())}}if(this.checkKeywordToken(t,"#")){++this.position;var u=this.currentToken();if(this.options.allowVector&&this.checkKeywordToken(u,"[")){if(++this.position,this.checkKeywordToken(this.currentToken(),"]"))return++this.position,new i.Vector(t.position,[]);for(n=[this.parseExpression()];;){e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,"]"))return++this.position,new i.Vector(t.position,n);throw new o.ParserError('Expected "," or "]" but found "'+e.getText()+'".',e.position)}++this.position,n.push(this.parseExpression())}}return this.assertRecordLabelToken(u),++this.position,new i.RecordSelector(t.position,u)}if(this.checkKeywordToken(t,"let")){++this.position;var p=this.state;this.state=this.state.getNestedState(this.state.id);var c=new Set;this.newcons.forEach(function(t){c=c.add(t)});var h=this.parseDeclaration();this.assertKeywordToken(this.currentToken(),"in"),++this.position;for(var f=[this.parseExpression()],l=this.currentToken(),d=l.position;this.checkKeywordToken(l,";");){if(++this.position,this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),"end")){l=this.currentToken();break}f.push(this.parseExpression()),l=this.currentToken()}return this.assertKeywordToken(l,"end"),++this.position,this.state=p,this.newcons=c,f.length>=2?new i.LocalDeclarationExpression(t.position,h,new i.Sequence(d,f)):new i.LocalDeclarationExpression(t.position,h,f[0])}if(t instanceof s.ConstantToken)return++this.position,new i.Constant(t.position,t);if(t.isVid()||t instanceof s.LongIdentifierToken){if(++this.position,void 0!==this.state.getInfixStatus(t)&&this.state.getInfixStatus(t).infix)throw new o.ParserError('Infix operator "'+t.getText()+'" appeared in non-infix context without "op".',t.position);return new i.ValueIdentifier(t.position,t)}throw new o.ParserError('Expected atomic expression, "'+t.getText()+'" found.',t.position)},t.prototype.parseExpressionRow=function(){for(var t=this.currentToken(),e=[],n=!0;;){var r=this.currentToken();if(this.checkKeywordToken(r,"}"))return++this.position,new i.Record(t.position,!0,e);if(n||!this.checkKeywordToken(r,",")){if(n=!1,!r.isValidRecordLabel())throw new o.ParserError('Expected "}", or identifier, got "'+r.getText()+'".',r.position);++this.position;var s=this.currentToken();this.assertKeywordToken(s,"="),++this.position,e.push([r.getText(),this.parseExpression()])}else++this.position}},t.prototype.parseApplicationExpression=function(){for(var t=this.currentToken(),e=this.parseAtomicExpression();;){var n=this.position,r=this.currentToken();if(this.checkVidOrLongToken(r)&&void 0!==this.state.getInfixStatus(r)&&this.state.getInfixStatus(r).infix)break;try{var s=this.parseAtomicExpression();e=new i.FunctionApplication(t.position,e,s)}catch(t){if(t instanceof o.IncompleteError)throw t;this.position=n;break}}return e},t.prototype.parseInfixExpression=function(){for(var t=[],e=[],n=0;;){t.push(this.parseApplicationExpression());var r=this.currentToken();if(!this.checkVidOrLongToken(r)||void 0===this.state.getInfixStatus(r)||!this.state.getInfixStatus(r).infix)break;++this.position,e.push([r,n++])}return 0===n?t[0]:new i.InfixExpression(t,e).reParse(this.state)},t.prototype.parseAppendedExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"raise"))return++this.position,new i.RaiseException(t.position,this.parseExpression());if(this.checkKeywordToken(t,"if")){++this.position;var e=this.parseExpression();this.assertKeywordToken(this.currentToken(),"then"),++this.position;var n=this.parseExpression();return this.options.allowSuccessorML&&!this.checkKeywordToken(this.currentToken(),"else")?new i.Conditional(t.position,e,n,new i.Tuple(-1,[])):(this.assertKeywordToken(this.currentToken(),"else"),++this.position,new i.Conditional(t.position,e,n,this.parseExpression()))}if(this.checkKeywordToken(t,"case")){++this.position;e=this.parseExpression();return this.assertKeywordToken(this.currentToken(),"of"),++this.position,new i.CaseAnalysis(t.position,e,this.parseMatch())}if(this.checkKeywordToken(t,"while")){++this.position;e=this.parseExpression();return this.assertKeywordToken(this.currentToken(),"do"),++this.position,new i.While(t.position,e,this.parseExpression())}if(this.checkKeywordToken(t,"fn"))return++this.position,new i.Lambda(t.position,this.parseMatch());for(var r=this.parseInfixExpression(),o=this.currentToken();this.checkKeywordToken(o,":");)++this.position,r=new i.TypedExpression(t.position,r,this.parseType()),o=this.currentToken();return r},t.prototype.parseExpression=function(){var t=this.parseAppendedExpression(),e=this.currentToken(),n=e;if(this.checkKeywordToken(e,"andalso")||this.checkKeywordToken(e,"orelse")){for(var r=[[t,[0]]],o=[],s=0;;){if(this.checkKeywordToken(e,"orelse"))o.push([1,s++]),++this.position;else{if(!this.checkKeywordToken(e,"andalso"))break;o.push([0,s++]),++this.position}r.push([this.parseAppendedExpression(),[s]]),e=this.currentToken()}o.sort();for(var a=0;a<o.length;++a){var u=r[o[a][1]][0],p=r[o[a][1]+1][0],c=void 0;c=0===o[a][0]?new i.Conjunction(u.position,u,p):new i.Disjunction(u.position,u,p);for(var h=r[o[a][1]][1],f=0,l=r[o[a][1]+1][1];f<l.length;f++){var d=l[f];h.push(d)}for(var y=0,v=h;y<v.length;y++){r[d=v[y]]=[c,h]}}t=r[0][0]}for(e=this.currentToken();this.checkKeywordToken(e,"handle");)++this.position,t=new i.HandleException(n.position,t,this.parseMatch()),e=this.currentToken();return t},t.prototype.parseSimpleStructureExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"struct")){++this.position;var e=this.parseDeclaration(!1,!0);return this.assertKeywordToken(this.currentToken(),"end"),++this.position,new u.StructureExpression(t.position,e)}if(this.checkKeywordToken(t,"let")){++this.position;e=this.parseDeclaration(!1,!0);this.assertKeywordToken(this.currentToken(),"in"),++this.position;var n=this.parseStructureExpression();return this.assertKeywordToken(this.currentToken(),"end"),++this.position,new u.LocalDeclarationStructureExpression(t.position,e,n)}if(t instanceof s.IdentifierToken)if(++this.position,this.checkKeywordToken(this.currentToken(),"(")){++this.position;var i=this.position;try{n=this.parseStructureExpression();return this.assertKeywordToken(this.currentToken(),")"),++this.position,new u.FunctorApplication(t.position,t,n)}catch(n){this.position=i;e=this.parseDeclaration(!1,!0);return this.assertKeywordToken(this.currentToken(),")"),++this.position,new u.FunctorApplication(t.position,t,new u.StructureExpression(t.position,e))}}else--this.position;if(this.checkIdentifierOrLongToken(t))return++this.position,new u.StructureIdentifier(t.position,t);throw new o.ParserError("Expected a simple structure expression.",t.position)},t.prototype.parseStructureExpression=function(){for(var t=this.currentToken(),e=this.parseSimpleStructureExpression();;)if(this.checkKeywordToken(this.currentToken(),":"))++this.position,e=new u.TransparentConstraint(t.position,e,this.parseSignatureExpression());else{if(!this.checkKeywordToken(this.currentToken(),":>"))break;++this.position,e=new u.OpaqueConstraint(t.position,e,this.parseSignatureExpression())}return e},t.prototype.parseSimpleSignatureExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"sig")){++this.position;var e=this.parseSpecification();return this.assertKeywordToken(this.currentToken(),"end"),++this.position,new u.SignatureExpression(t.position,e)}if(t instanceof s.IdentifierToken)return++this.position,new u.SignatureIdentifier(t.position,t);throw new o.ParserError("Expected a simple signature expression.",t.position)},t.prototype.parseSignatureExpression=function(){for(var t=this.currentToken(),e=this.parseSimpleSignatureExpression(),n=!0;this.checkKeywordToken(this.currentToken(),"where")||!n&&this.checkKeywordToken(this.currentToken(),"and");){n=!1,++this.position,this.assertKeywordToken(this.currentToken(),"type"),++this.position;var i=this.parseTypeVarSequence();this.assertIdentifierOrLongToken(this.currentToken());var r=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,e=new u.TypeRealisation(t.position,e,i,r,this.parseType())}return e},t.prototype.parseSimpleSpecification=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"val")){++this.position;for(var e=[];;){this.assertIdentifierOrLongToken(this.currentToken());var n=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),":"),++this.position,e.push([n,this.parseType()]),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.ValueSpecification(t.position,e)}if(this.checkKeywordToken(t,"type")){++this.position;e=[];for(var i=this.position;;){var r=this.parseTypeVarSequence();if(this.assertIdentifierToken(this.currentToken()),e.push([r,this.currentToken()]),++this.position,this.checkKeywordToken(this.currentToken(),"=")){var o=[];for(this.position=i;;){r=this.parseTypeVarSequence(),this.assertIdentifierToken(this.currentToken());n=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,o.push([r,n,this.parseType()]),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.TypeAliasSpecification(t.position,o)}if(!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.TypeSpecification(t.position,e)}if(this.checkKeywordToken(t,"eqtype")){++this.position;for(e=[];;){r=this.parseTypeVarSequence();if(this.assertIdentifierToken(this.currentToken()),e.push([r,this.currentToken()]),++this.position,!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.EqualityTypeSpecification(t.position,e)}if(this.checkKeywordToken(t,"datatype")){if(++this.position,this.position+2<this.tokens.length&&this.checkKeywordToken(this.tokens[this.position+2],"datatype")){this.assertIdentifierToken(this.currentToken());var s=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,this.assertKeywordToken(this.currentToken(),"datatype"),++this.position,this.assertIdentifierOrLongToken(this.currentToken());var a=this.currentToken();return++this.position,new u.DatatypeReplicationSpecification(t.position,s,a)}for(e=[];;){r=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());s=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,!0===this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),"|")&&++this.position;for(var p=[];;){this.assertIdentifierToken(this.currentToken());var c=this.currentToken();++this.position;var h=void 0;if(this.checkKeywordToken(this.currentToken(),"of")&&(++this.position,h=this.parseType()),p.push([c,h]),!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}if(e.push([r,s,p]),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.DatatypeSpecification(t.position,e)}if(this.checkKeywordToken(t,"exception")){++this.position;for(e=[];;){this.assertIdentifierToken(this.currentToken());s=this.currentToken();++this.position;h=void 0;if(this.checkKeywordToken(this.currentToken(),"of")&&(++this.position,h=this.parseType()),e.push([s,h]),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.ExceptionSpecification(t.position,e)}if(this.checkKeywordToken(t,"structure")){++this.position;for(e=[];;){this.assertIdentifierToken(this.currentToken());s=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),":"),++this.position,e.push([s,this.parseSignatureExpression()]),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new u.StructureSpecification(t.position,e)}if(this.checkKeywordToken(t,"include")){++this.position;var f=[],l=this.position;try{for(;;)f.push(this.parseSignatureExpression()),l=this.position}catch(t){this.position=l}return new u.IncludeSpecification(t.position,f)}return new u.EmptySpecification(t.position)},t.prototype.parseSequentialSpecification=function(){for(var t=this.currentToken(),e=[];;){var n=this.parseSimpleSpecification();if(n instanceof u.EmptySpecification)break;e.push(n),this.checkKeywordToken(this.currentToken(),";")&&++this.position}return new u.SequentialSpecification(t.position,e)},t.prototype.parseSpecification=function(){for(var t=this.currentToken(),e=this.parseSequentialSpecification();this.checkKeywordToken(this.currentToken(),"sharing");){++this.position,this.assertKeywordToken(this.currentToken(),"type"),++this.position,this.assertIdentifierOrLongToken(this.currentToken());var n=[this.currentToken()];for(++this.position;this.checkKeywordToken(this.currentToken(),"=");)++this.position,this.assertIdentifierOrLongToken(this.currentToken()),n.push(this.currentToken()),++this.position;if(n.length<2)throw new o.ParserError('A "sharing" expression requires at least 2 type names.',t.position);e=new u.SharingSpecification(t.position,e,n)}return e},t.prototype.parseMatch=function(){var t=this.currentToken();this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),"|")&&++this.position;for(var e=[];;){var n=this.parsePattern();n.simplify().assertUniqueBinding(this.state,this.newcons),this.assertKeywordToken(this.currentToken(),"=>"),++this.position;var r=this.parseExpression();if(e.push([n,r]),!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}return new i.Match(t.position,e)},t.prototype.parsePatternRow=function(){for(var t=this.currentToken(),e=[],n=!0,r=!0;;){var a=this.currentToken();if(this.checkKeywordToken(a,"}"))return++this.position,new i.Record(t.position,r,e);if(!r)throw new o.ParserError("Record wildcard must appear as last element of the record.",a.position);if(n||!this.checkKeywordToken(a,","))if(n=!1,this.checkKeywordToken(a,"..."))r=!1,++this.position;else{if(!a.isValidRecordLabel())throw new o.ParserError('Expected "}", "...", or identifier.',a.position);++this.position;var u=this.currentToken();if(!(u instanceof s.KeywordToken))throw new o.ParserError('Expected ":", "as", ",", or "=", got '+u.getText()+'".',u.position);if("="===u.text){++this.position,e.push([a.getText(),this.parsePattern()]);continue}var p=void 0;if(a instanceof s.NumericToken)throw new o.ParserError('You cannot assign to "'+a.getText()+'".',a.position);var c=new i.ValueIdentifier(a.position,a);":"===u.text&&(++this.position,p=this.parseType(),u=this.currentToken()),"as"!==u.text||this.options.allowSuccessorML?void 0!==p&&(c=new i.TypedExpression(c.position,c,p)):(++this.position,c=new i.LayeredPattern(c.position,c.name,p,this.parsePattern()),u=this.currentToken()),e.push([a.getText(),c])}else++this.position}},t.prototype.parseAtomicPattern=function(){if(this.position>=this.tokens.length)throw new o.ParserError("Unexpected end of token stream",-1);var t=this.currentToken();if(this.checkKeywordToken(t,"op")){++this.position;var e=this.currentToken();this.assertVidOrLongToken(e),e.opPrefixed=!0,++this.position;var n=this.position;try{if(!(e instanceof s.LongIdentifierToken)){var r=this.currentToken(),a=void 0;return this.checkKeywordToken(r,":")&&(++this.position,a=this.parseType(),r=this.currentToken()),this.assertKeywordToken(r,"as"),++this.position,new i.LayeredPattern(t.position,e,a,this.parsePattern())}}catch(t){this.position=n}return new i.ValueIdentifier(t.position,e)}if(this.checkKeywordToken(t,"_"))return++this.position,new i.Wildcard(t.position);if(this.checkKeywordToken(t,"{"))return++this.position,this.parsePatternRow();if(this.checkKeywordToken(t,"(")){if(++this.position,this.checkKeywordToken(this.currentToken(),")"))return++this.position,new i.Tuple(t.position,[]);for(var u=[this.parsePattern()];;){e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,")"))return++this.position,1===u.length?u[0]:new i.Tuple(t.position,u);throw new o.ParserError('Expected "," or ")", but got "'+e.getText()+'".',e.position)}++this.position,u.push(this.parsePattern())}}if(this.options.allowVector&&this.checkKeywordToken(t,"#")&&this.checkKeywordToken(this.nextToken(),"[")){if(++this.position,++this.position,this.checkKeywordToken(this.currentToken(),"]"))return++this.position,new i.Vector(t.position,[]);for(u=[this.parsePattern()];;){e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,"]"))return++this.position,new i.Vector(t.position,u);throw new o.ParserError('Expected "," or "]" but found "'+e.getText()+'".',e.position)}++this.position,u.push(this.parsePattern())}}if(this.checkKeywordToken(t,"[")){if(++this.position,this.checkKeywordToken(this.currentToken(),"]"))return++this.position,new i.List(t.position,[]);for(u=[this.parsePattern()];;){e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,"]"))return++this.position,new i.List(t.position,u);throw new o.ParserError('Expected "," or "]" but found "'+e.getText()+'".',e.position)}++this.position,u.push(this.parsePattern())}}else{if(t instanceof s.ConstantToken){if(t instanceof s.RealConstantToken)throw new o.ParserError('I am not interested in real constants such as "'+t.getText()+'" appearing in patterns.',t.position);return++this.position,new i.Constant(t.position,t)}if(t.isVid()&&"="!==t.getText()||t instanceof s.LongIdentifierToken){++this.position;n=this.position;try{if(!(t instanceof s.LongIdentifierToken)){r=this.currentToken(),a=void 0;return this.checkKeywordToken(r,":")&&(++this.position,a=this.parseType(),r=this.currentToken()),this.assertKeywordToken(r,"as"),++this.position,t instanceof s.KeywordToken&&(t=new s.IdentifierToken(t.getText(),t.position)),new i.LayeredPattern(t.position,t,a,this.parsePattern())}}catch(t){this.position=n}return new i.ValueIdentifier(t.position,t)}}throw new o.ParserError('Expected atomic pattern but got "'+t.getText()+'".',t.position)},t.prototype.parseApplicationPattern=function(){var t=this.position,e=this.currentToken(),n=this.parseAtomicPattern();if(n instanceof i.ValueIdentifier&&void 0!==this.state.getInfixStatus(n.name)&&this.state.getInfixStatus(n.name).infix&&!(t>0&&this.checkKeywordToken(this.tokens[t-1],"op")||this.checkKeywordToken(e,"op")))throw new o.ParserError('Infix operator "'+n+'" appeared in non-infix context without "op".',e.position);for(;;){var r=this.position,s=this.currentToken();if(this.checkVidOrLongToken(s)&&void 0!==this.state.getInfixStatus(s)&&this.state.getInfixStatus(s).infix)break;var a=!1;try{var u=this.parseAtomicPattern();if(n instanceof i.Wildcard)throw a=!0,new o.ParserError("You cannot apply a pattern to a wildcard.",e.position);n=new i.FunctionApplication(e.position,n,u)}catch(t){if(a)throw t;this.position=r;break}}return n},t.prototype.parseInfixPattern=function(){for(var t=[],e=[],n=0;;){t.push(this.parseApplicationPattern());var r=this.currentToken();if(!this.checkIdentifierOrLongToken(r)||void 0===this.state.getInfixStatus(r)||!this.state.getInfixStatus(r).infix)break;++this.position,e.push([r,n++])}return 0===n?t[0]:new i.InfixExpression(t,e).reParse(this.state)},t.prototype.parsePattern=function(){for(var t=this.currentToken(),e=this.parseInfixPattern();;){if(!this.checkKeywordToken(this.currentToken(),":")){if(!0===this.options.allowSuccessorML){if(this.checkKeywordToken(this.currentToken(),"as")){++this.position,e=new i.ConjunctivePattern(t.position,e,this.parsePattern());continue}if(this.checkKeywordToken(this.currentToken(),"|")){++this.position,e=new i.DisjunctivePattern(t.position,e,this.parseInfixPattern());continue}if(this.checkKeywordToken(this.currentToken(),"with")){++this.position;var n=this.parsePattern();this.assertKeywordToken(this.currentToken(),"="),++this.position,e=new i.NestedMatch(t.position,e,n,this.parseExpression());continue}if(this.checkKeywordToken(this.currentToken(),"if")){++this.position,e=new i.PatternGuard(t.position,e,this.parseExpression());continue}}break}++this.position,e=new i.TypedExpression(t.position,e,this.parseType())}return e},t.prototype.parseTypeRow=function(){for(var t=this.currentToken(),e=new Map,n=!0;;){var i=this.currentToken();if(this.checkKeywordToken(i,"}"))return++this.position,new r.RecordType(e,!0,t.position);if(n||!this.checkKeywordToken(i,",")){if(n=!1,i.isValidRecordLabel()){++this.position;var a=this.currentToken();if(!(a instanceof s.KeywordToken))throw new o.ParserError('Expected ":".',a.position);if(":"===a.text){if(++this.position,e.has(i.getText()))throw new o.ParserError('Duplicate record label "'+i.getText()+'".',i.position);e.set(i.getText(),this.parseType());continue}throw new o.ParserError('Expected ":".',a.position)}throw new o.ParserError('Expected "}", or an identifier, got "'+i.getText()+'".',i.position)}++this.position}},t.prototype.parseSimpleType=function(){var t=this.currentToken();if(t instanceof s.TypeVariableToken)return++this.position,new r.TypeVariable(t.getText(),t.position);if(this.checkIdentifierOrLongToken(t))return++this.position,t instanceof s.LongIdentifierToken?new r.CustomType(t.id.getText(),[],t.position,t):new r.CustomType(t.getText(),[],t.position);if(this.checkKeywordToken(t,"{"))return++this.position,this.parseTypeRow();if(this.checkKeywordToken(t,"(")){if(++this.position,this.checkKeywordToken(this.currentToken(),")"))throw new o.ParserError('Use "{}" or "unit" to denote the unit type.',this.currentToken().position);for(var e=[this.parseType()];;){var n=this.currentToken();if(!this.checkKeywordToken(n,",")){if(this.checkKeywordToken(n,")")){if(++this.position,1===e.length)return e[0];this.assertIdentifierOrLongToken(this.currentToken());var i=this.currentToken();return++this.position,new r.CustomType(i.getText(),e,t.position)}throw new o.ParserError('Expected "," or ")", got "'+n.getText()+'".',n.position)}++this.position,e.push(this.parseType())}}throw new o.ParserError('Expected either "(" or "{" got "'+t.getText()+'".',t.position)},t.prototype.parseType=function(){var t=this.parseTupleType(),e=this.currentToken();if(!this.checkKeywordToken(e,"->"))return t;++this.position;var n=this.parseType();return new r.FunctionType(t,n,e.position)},t.prototype.parseTupleType=function(){for(var t=[this.parseCustomType()],e=this.currentToken().position;this.checkKeywordToken(this.currentToken(),"*");)++this.position,t.push(this.parseCustomType());return 1===t.length?t[0]:new r.TupleType(t,e)},t.prototype.parseCustomType=function(){for(var t=this.currentToken(),e=this.parseSimpleType();this.position<this.tokens.length;){var n=this.currentToken();if(!this.checkIdentifierOrLongToken(n))return e;++this.position,e=n instanceof s.LongIdentifierToken?new r.CustomType(n.id.getText(),[e],t.position,n):new r.CustomType(n.getText(),[e],t.position)}return e},t.prototype.parseValueBinding=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"rec")){++this.position;var e=this.parseValueBinding();return e.position=t.position,e.isRecursive=!0,e}var n=this.parsePattern();return n.simplify().assertUniqueBinding(this.state,this.newcons),this.assertKeywordToken(this.currentToken(),"="),++this.position,new a.ValueBinding(t.position,!1,n,this.parseExpression())},t.prototype.parseFunctionValueBinding=function(){var t=this.currentToken(),e=[],n=-1,r=void 0;for(!0===this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),"|")&&++this.position;;){var s=[],u=void 0,p=void 0;if(this.checkKeywordToken(this.currentToken(),"(")){var c=this.position;try{var h=this.parsePattern(),f=!1,l=[];for(h instanceof i.FunctionApplication||(f=!0);!f&&h instanceof i.FunctionApplication;)l.push(h.argument),h=h.func;if(h instanceof i.ValueIdentifier||(f=!0),f)throw new o.ParserError("Nyaboron is sad. Did you forget a function name?",h.position);p=h;for(var d=l.length-1;d>=0;--d)s.push(l[d])}catch(t){var y=!1;try{this.position=c,++this.position;var v=this.parseAtomicPattern();if(this.assertVidOrLongToken(this.currentToken()),p=new i.ValueIdentifier(this.currentToken().position,this.currentToken()),void 0===this.state.getInfixStatus(this.currentToken())||!this.state.getInfixStatus(this.currentToken()).infix)throw new o.ParserError('"'+this.currentToken().getText()+'" does not have infix status.',this.currentToken().position);if(!0!==this.options.allowSuccessorML&&"="===this.currentToken().getText())throw y=!0,new o.FeatureDisabledError(this.currentToken().position,'Why would you try to rebind "="?');++this.position;var w=this.parseAtomicPattern();for(this.assertKeywordToken(this.currentToken(),")"),++this.position,s.push(new i.Tuple(-1,[v,w]));!this.checkKeywordToken(this.currentToken(),"=")&&!this.checkKeywordToken(this.currentToken(),":");){if((h=this.parseAtomicPattern())instanceof i.ValueIdentifier&&void 0!==this.state.getInfixStatus(h.name)&&this.state.getInfixStatus(h.name).infix)throw new o.ParserError('Cute little infix identifiers such as "'+h+'" sure should play somewhere else.',h.position);s.push(h)}}catch(e){if(!y)throw t;throw e}}}else{var m=this.position,g=!1,T=!1;try{var E=this.parseOpIdentifierToken();if(p=new i.ValueIdentifier(E.position,E),void 0!==this.state.getInfixStatus(p.name)&&this.state.getInfixStatus(p.name).infix&&!p.name.opPrefixed)throw g=!0,new o.ParserError('Missing "op".',p.name.position);for(;!this.checkKeywordToken(this.currentToken(),"=")&&!this.checkKeywordToken(this.currentToken(),":");){if((h=this.parseAtomicPattern())instanceof i.ValueIdentifier&&void 0!==this.state.getInfixStatus(h.name)&&this.state.getInfixStatus(h.name).infix)throw T=!0,new o.ParserError('Cute little infix identifiers such as "'+h+'" sure should play somewhere else.',h.position);s.push(h)}}catch(t){if(g)throw t;g=!1;try{this.position=m;v=this.parseAtomicPattern();if(this.assertVidOrLongToken(this.currentToken()),p=new i.ValueIdentifier(this.currentToken().position,this.currentToken()),void 0===this.state.getInfixStatus(this.currentToken())||!this.state.getInfixStatus(this.currentToken()).infix){if(T)throw g=!0,t;throw new o.ParserError('"'+this.currentToken().getText()+'" does not have infix status.',this.currentToken().position)}++this.position;w=this.parseAtomicPattern();s.push(new i.Tuple(-1,[v,w]))}catch(e){throw console.log(e),t}}}if(this.checkKeywordToken(this.currentToken(),":")&&(++this.position,u=this.parseType()),this.assertKeywordToken(this.currentToken(),"="),++this.position,-1===n)n=s.length;else if(2!==n&&3!==n&&n!==s.length)throw new o.ParserError("Different number of arguments.",t.position);if(0===n)throw new o.ParserError('Functions need arguments to survive. Rely on "val" instead.',t.position);if(void 0===r)r=p;else if(p.name.getText()!==r.name.getText())throw new o.ParserError('Different function names in different cases ("'+p.name.getText()+'" vs. "'+r.name.getText()+'")',t.position);if(new i.Tuple(-1,s).simplify().assertUniqueBinding(this.state,this.newcons),e.push([s,u,this.parseExpression()]),!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}return new a.FunctionValueBinding(t.position,e,r)},t.prototype.parseTypeBinding=function(){var t=this.currentToken(),e=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var n=this.currentToken();return++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,new a.TypeBinding(t.position,e,n,this.parseType())},t.prototype.parseTypeBindingSeq=function(){for(var t=[];t.push(this.parseTypeBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return t},t.prototype.parseExceptionBinding=function(){var t=this.currentToken(),e=this.parseOpIdentifierToken();if(this.checkKeywordToken(this.currentToken(),"of")){++this.position;var n=this.parseType();return new a.DirectExceptionBinding(t.position,e,n)}if(this.checkKeywordToken(this.currentToken(),"=")){++this.position;var i=this.parseOpIdentifierToken(!0);return new a.ExceptionAlias(t.position,e,i)}return new a.DirectExceptionBinding(t.position,e,void 0)},t.prototype.parseDatatypeBinding=function(){var t=this.currentToken(),e=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var n=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position;var i=[];for(!0===this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),"|")&&++this.position;;){var r=this.parseOpIdentifierToken();if(this.newcons=this.newcons.add(r.getText()),this.checkKeywordToken(this.currentToken(),"of")){++this.position;var o=this.parseType();i.push([r,o])}else i.push([r,void 0]);if(!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}return new a.DatatypeBinding(t.position,e,n,i)},t.prototype.parseDatatypeBindingSeq=function(){for(var t=[];t.push(this.parseDatatypeBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return t},t.prototype.parseStructureBinding=function(){var t=this.currentToken();this.assertIdentifierToken(this.currentToken());var e=this.currentToken();if(++this.position,this.checkKeywordToken(this.currentToken(),":")){++this.position;var n=this.parseSignatureExpression();this.assertKeywordToken(this.currentToken(),"="),++this.position;var i=this.parseStructureExpression();return new u.StructureBinding(t.position,e,new u.TransparentConstraint(t.position,i,n))}if(this.checkKeywordToken(this.currentToken(),":>")){++this.position;n=this.parseSignatureExpression();this.assertKeywordToken(this.currentToken(),"="),++this.position;i=this.parseStructureExpression();return new u.StructureBinding(t.position,e,new u.OpaqueConstraint(t.position,i,n))}return this.assertKeywordToken(this.currentToken(),"="),++this.position,new u.StructureBinding(t.position,e,this.parseStructureExpression())},t.prototype.parseStructureBindingSeq=function(){for(var t=[];t.push(this.parseStructureBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return t},t.prototype.parseSignatureBinding=function(){var t=this.currentToken();this.assertIdentifierToken(this.currentToken());var e=this.currentToken();return++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,new u.SignatureBinding(t.position,e,this.parseSignatureExpression())},t.prototype.parseSignatureBindingSeq=function(){for(var t=[];t.push(this.parseSignatureBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return t},t.prototype.parseFunctorBinding=function(){var t=this.currentToken();this.assertIdentifierToken(this.currentToken());var e=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),"("),++this.position,this.currentToken()instanceof s.IdentifierToken){var n=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),":"),++this.position;var i=this.parseSignatureExpression();if(this.assertKeywordToken(this.currentToken(),")"),++this.position,this.checkKeywordToken(this.currentToken(),":")){++this.position;var r=this.parseSignatureExpression();return this.assertKeywordToken(this.currentToken(),"="),++this.position,new u.FunctorBinding(t.position,e,n,i,new u.TransparentConstraint(t.position,this.parseStructureExpression(),r))}if(this.checkKeywordToken(this.currentToken(),":>")){++this.position;r=this.parseSignatureExpression();return this.assertKeywordToken(this.currentToken(),"="),++this.position,new u.FunctorBinding(t.position,e,n,i,new u.OpaqueConstraint(t.position,this.parseStructureExpression(),r))}return this.assertKeywordToken(this.currentToken(),"="),++this.position,new u.FunctorBinding(t.position,e,n,i,this.parseStructureExpression())}var o=this.parseSpecification(),p=new u.SignatureExpression(-1,o);this.assertKeywordToken(this.currentToken(),")"),++this.position;var c=!1,h=void 0;this.checkKeywordToken(this.currentToken(),":")?(++this.position,h=this.parseSignatureExpression()):this.checkKeywordToken(this.currentToken(),":>")&&(c=!0,++this.position,h=this.parseSignatureExpression()),this.assertKeywordToken(this.currentToken(),"="),++this.position;var f=this.parseStructureExpression(),l=new s.AlphanumericIdentifierToken("__farg",-1);return void 0!==h&&(f=c?new u.OpaqueConstraint(-1,f,h):new u.TransparentConstraint(-1,f,h)),f=new u.LocalDeclarationStructureExpression(-1,new a.OpenDeclaration(-1,[l]),f),new u.FunctorBinding(t.position,e,l,p,f)},t.prototype.parseFunctorBindingSeq=function(){for(var t=[];t.push(this.parseFunctorBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return t},t.prototype.parseTypeVarSequence=function(t){void 0===t&&(t=!1);var e=this.currentToken(),n=[];if(e instanceof s.TypeVariableToken)return n.push(new r.TypeVariable(e.text,e.position)),++this.position,n;if(this.checkKeywordToken(e,"("))for(++this.position;;){if(!((e=this.currentToken())instanceof s.TypeVariableToken)){if(t)return;throw new o.ParserError("Expected a type varible.",e.position)}if(n.push(new r.TypeVariable(e.text,e.position)),++this.position,e=this.currentToken(),!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,")")){++this.position;break}throw new o.ParserError('Expected "," or ")" but got "'+e.getText()+'".',e.position)}++this.position}return n},t.prototype.parseDeclaration=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1);for(var n=[],i=this.currentToken(),r=this.currentId++;this.position<this.tokens.length;){var o=this.parseSimpleDeclaration(t,e);if(o instanceof a.EmptyDeclaration){if(this.position>=this.tokens.length||this.checkKeywordToken(this.currentToken(),"in")||this.checkKeywordToken(this.currentToken(),"end")||this.checkKeywordToken(this.currentToken(),")"))break}else n.push(o),this.checkKeywordToken(this.currentToken(),";")&&++this.position}return new a.SequentialDeclaration(i.position,n,r)},t.prototype.parseSimpleDeclaration=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1);var n=this.currentToken(),r=this.currentId++;if(this.checkKeywordToken(n,"val")){++this.position,void 0===(l=this.parseTypeVarSequence(!0))&&(--this.position,l=[]);for(var p=[],c=!1;;){var h=this.parseValueBinding();if(h.isRecursive){c=!0;for(var f=h.pattern;f instanceof i.TypedExpression;)f=f.expression;if(!(h.expression instanceof i.Lambda))throw new o.ParserError('Using "rec" requires binding a lambda.',h.position);if(!(f instanceof i.ValueIdentifier||f instanceof i.Wildcard))throw new o.ParserError('Using "rec" requires binding to a single identifier and not "'+f.toString(0,!0)+'".',h.position)}if(h.isRecursive=c,p.push(h),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new a.ValueDeclaration(n.position,l,p,r)}if(this.checkKeywordToken(n,"fun")){var l;++this.position,void 0===(l=this.parseTypeVarSequence(!0))&&(--this.position,l=[]);for(var d=[];d.push(this.parseFunctionValueBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return new a.FunctionDeclaration(n.position,l,d,r)}if(this.checkKeywordToken(n,"type"))return++this.position,new a.TypeDeclaration(n.position,this.parseTypeBindingSeq(),r);if(this.checkKeywordToken(n,"datatype")){if(this.position+3<this.tokens.length&&this.checkKeywordToken(this.tokens[this.position+3],"datatype")){++this.position;var y=this.currentToken();this.assertIdentifierToken(y),++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,this.assertKeywordToken(this.currentToken(),"datatype"),++this.position;var v=this.currentToken();return this.assertIdentifierOrLongToken(v),++this.position,new a.DatatypeReplication(n.position,y,v,r)}++this.position;var w=this.parseDatatypeBindingSeq();if(this.checkKeywordToken(this.currentToken(),"withtype")){++this.position;var m=this.parseTypeBindingSeq();return new a.DatatypeDeclaration(n.position,w,m,r)}return new a.DatatypeDeclaration(n.position,w,void 0,r)}if(this.checkKeywordToken(n,"abstype")){++this.position;var g=this.state;this.state=this.state.getNestedState(this.state.id);var T=new Set;this.newcons.forEach(function(t){T=T.add(t)});w=this.parseDatatypeBindingSeq();var E=void 0;this.checkKeywordToken(this.currentToken(),"withtype")&&(++this.position,E=this.parseTypeBindingSeq()),this.assertKeywordToken(this.currentToken(),"with"),++this.position;var x=this.parseDeclaration();return this.assertKeywordToken(this.currentToken(),"end"),++this.position,this.state=g,this.newcons=T,new a.AbstypeDeclaration(n.position,w,E,x,r)}if(this.checkKeywordToken(n,"exception")){++this.position;for(var S=[];S.push(this.parseExceptionBinding()),this.checkKeywordToken(this.currentToken(),"and");)++this.position;return new a.ExceptionDeclaration(n.position,S,r)}if(this.checkKeywordToken(n,"local")){++this.position;g=this.state;this.state=this.state.getNestedState(this.state.id);var I=new Set;this.newcons.forEach(function(t){I=I.add(t)});x=this.parseDeclaration(!1,e);this.assertKeywordToken(this.currentToken(),"in"),++this.position;var k=this.parseDeclaration(!1,e);return this.assertKeywordToken(this.currentToken(),"end"),++this.position,this.state=g,this.newcons=I,new a.LocalDeclaration(n.position,x,k,r)}if(this.checkKeywordToken(n,"open")){++this.position;for(var V=[];this.checkIdentifierOrLongToken(this.currentToken());)V.push(this.currentToken()),++this.position;if(0===V.length)throw new o.ParserError('Empty "open" declaration.',this.currentToken().position);return new a.OpenDeclaration(n.position,V,r)}if(this.checkKeywordToken(n,"infix")){++this.position;var b=0;if(this.currentToken()instanceof s.IntegerConstantToken){if(1!==this.currentToken().text.length)throw new o.ParserError("Precedences may only be single digits.",this.currentToken().position);b=this.currentToken().value,++this.position}for(V=[];this.currentToken().isVid();)V.push(this.currentToken()),++this.position;if(0===V.length)throw new o.ParserError('Empty "infix" declaration.',this.currentToken().position);return(A=new a.InfixDeclaration(n.position,V,b,r)).setInfixStatus(this.state),A}if(this.checkKeywordToken(n,"infixr")){++this.position;b=0;if(this.currentToken()instanceof s.IntegerConstantToken){if(1!==this.currentToken().text.length)throw new o.ParserError("Precedences may only be single digits.",this.currentToken().position);b=this.currentToken().value,++this.position}for(V=[];this.currentToken().isVid();)V.push(this.currentToken()),++this.position;if(0===V.length)throw new o.ParserError('Empty "infixr" declaration.',this.currentToken().position);return(A=new a.InfixRDeclaration(n.position,V,b,r)).setInfixStatus(this.state),A}if(this.checkKeywordToken(n,"nonfix")){++this.position;for(V=[];this.currentToken().isVid();)V.push(this.currentToken()),++this.position;if(0===V.length)throw new o.ParserError('Empty "nonfix" declaration.',this.currentToken().position);var A;return(A=new a.NonfixDeclaration(n.position,V,r)).setInfixStatus(this.state),A}if(this.options.allowSuccessorML&&this.checkKeywordToken(n,"do"))return++this.position,new a.Evaluation(n.position,this.parseExpression());if((!0===this.options.allowStructuresAnywhere||e)&&this.checkKeywordToken(n,"structure"))return++this.position,new u.StructureDeclaration(n.position,this.parseStructureBindingSeq());if((!0===this.options.allowSignaturesAnywhere||t)&&this.checkKeywordToken(n,"signature"))return++this.position,new u.SignatureDeclaration(n.position,this.parseSignatureBindingSeq());if((!0===this.options.allowFunctorsAnywhere||t)&&this.checkKeywordToken(n,"functor"))return++this.position,new u.FunctorDeclaration(n.position,this.parseFunctorBindingSeq());if(this.checkKeywordToken(n,";"))return++this.position,new a.EmptyDeclaration(r);if(this.checkKeywordToken(n,"in")||this.checkKeywordToken(n,"end")||this.checkKeywordToken(n,")"))return new a.EmptyDeclaration(r);if(t){if(this.position>0&&!this.checkKeywordToken(this.tokens[this.position-1],";"))throw new o.ParserError('A single top-level expression must be separated from preceeding declarations by a ";".',this.position);var L=this.parseExpression(),B=new a.ValueBinding(n.position,!1,new i.ValueIdentifier(-1,new s.AlphanumericIdentifierToken("it",-1)),L);return this.assertKeywordToken(this.currentToken(),";"),new a.ValueDeclaration(n.position,[],[B],r)}throw new o.ParserError('Expected a declaration, found "'+n.getText()+'".',n.position)},t.prototype.currentToken=function(){if(this.position>=this.tokens.length)throw new o.IncompleteError(-1,"More input, I'm starving. ~nyan.");return this.tokens[this.position]},t.prototype.nextToken=function(){if(this.position+1>=this.tokens.length)throw new o.IncompleteError(-1,"More input, I'm starving. ~nyan.");return this.tokens[this.position+1]},t}();e.Parser=p,e.parse=function(t,e,n){void 0===n&&(n={});var i=new p(t,e,e.id,n),r=i.parseDeclaration(!0,!0);return i.assertFinished(),r}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(3),r=n(4),o=n(1),s=n(0),a=n(7),u=n(12),p=n(9),c=n(10),h=n(5),f=n(6),l=new r.CustomType("int"),d=new r.CustomType("real"),y=new r.CustomType("string"),v=new r.CustomType("char"),w=new o.ExceptionConstructor("Overflow",0,0,3),m=new o.ExceptionConstructor("Domain",0,0,4),g=new o.ExceptionConstructor("Size",0,0,5),T=new o.ExceptionConstructor("Chr",0,0,6),E=new o.ExceptionConstructor("Subscript",0,0,7);e.STDLIB={__Base:{native:void 0,code:"fun o (f,g) x = f (g x);\n            infix 3 o;\n            datatype order = LESS | EQUAL | GREATER;\n\n            exception Domain;\n            exception Size;\n            exception Chr;\n            exception Subscript;\n\n            fun not true = false | not false = true;\n\n            (* fun ! (a : 'A ref): 'A = ! a;\n            fun op := ((a, b) : ('A ref * 'A)): unit = a := b;\n            fun ref (a : 'A): 'A ref = ref a; *)\n            \n            fun ignore a = ();\n            infix 0 before;\n            fun a before (b: unit) = a;",requires:void 0},Array:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{}),a=new r.CustomType("array",[new r.TypeVariable("'a")]),u=new r.CustomType("list",[new r.TypeVariable("'a")]);return n.setType("array",a,[],1,!0),e.setType("array",[]),e.setValue("array",new o.PredefinedFunction("array",function(t,e){if(t instanceof o.RecordValue&&2===t.entries.size){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Integer){var r=n.value;if(r<0)return[g.construct(),!0,[]];var a=new o.ArrayValue(e.modifiable.memory[0]+1,r);e.modifiable.setNewCell(a);for(var u=0;u<r;++u)e.modifiable.setNewCell(i);return[a,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("array",new r.FunctionType(new r.TupleType([l,new r.TypeVariable("'a")]).simplify(),a),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("fromList",new o.PredefinedFunction("fromList",function(t,e){var n=new o.ArrayValue(e.modifiable.memory[0]+1,0);if(e.modifiable.setNewCell(n),t instanceof o.ConstructedValue){for(var i=t;"nil"!==i.constructorName;){if("::"!==i.constructorName)throw new s.InternalInterpreterError(-1,"std type mismatch");var r=i.argument;if(!(r instanceof o.RecordValue&&2===r.entries.size))throw new s.InternalInterpreterError(-1,"std type mismatch");var a=r.getValue("1"),u=r.getValue("2");if(!(a instanceof o.Value&&u instanceof o.ConstructedValue))throw new s.InternalInterpreterError(-1,"std type mismatch");e.modifiable.setNewCell(a),n.length++,i=u}return[n,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("fromList",new r.FunctionType(u,a),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("sub",new o.PredefinedFunction("sub",function(t,e){if(t instanceof o.RecordValue&&2===t.entries.size){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.ArrayValue&&i instanceof o.Integer){var r=i.value;return r<0||r>=n.length?[E.construct(),!0,[]]:[e.modifiable.getCell(n.address+r),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("sub",new r.FunctionType(new r.TupleType([a,l]).simplify(),new r.TypeVariable("'a")),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("update",new o.PredefinedFunction("update",function(t,e){if(t instanceof o.RecordValue&&3===t.entries.size){var n=t.getValue("1"),i=t.getValue("2"),r=t.getValue("3");if(n instanceof o.ArrayValue&&i instanceof o.Integer){var a=i.value;return a<0||a>=n.length?[E.construct(),!0,[]]:(e.modifiable.setCell(n.address+a,r),[new o.RecordValue,!1,[]])}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("update",new r.FunctionType(new r.TupleType([a,l,new r.TypeVariable("'a")]),new r.TupleType([])).simplify(),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("length",new o.PredefinedFunction("length",function(t,e){if(t instanceof o.ArrayValue)return[new o.Integer(t.length),!1,[]];throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("length",new r.FunctionType(a,l),i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure("Array",e),t.setStaticStructure("Array",n),t},code:"structure Array :> sig\n            (* eqtype 'a array = 'a array *)\n            (* type 'a vector = 'a Vector.vector *)\n            (* val maxLen : int *)\n            val array : int * 'a -> 'a array\n            val fromList : 'a list -> 'a array\n            val tabulate : int * (int -> 'a) -> 'a array\n            val length : 'a array -> int\n            val sub : 'a array * int -> 'a\n            val update : 'a array * int * 'a -> unit\n            val vector : 'a array -> 'a vector\n            val copy    : {src : 'a array, dst : 'a array, di : int} -> unit\n            val copyVec : {src : 'a vector, dst : 'a array, di : int} -> unit\n            val appi : (int * 'a -> unit) -> 'a array -> unit\n            val app  : ('a -> unit) -> 'a array -> unit\n            val modifyi : (int * 'a -> 'a) -> 'a array -> unit\n            val modify  : ('a -> 'a) -> 'a array -> unit\n            val foldli : (int * 'a * 'b -> 'b) -> 'b -> 'a array -> 'b\n            val foldri : (int * 'a * 'b -> 'b) -> 'b -> 'a array -> 'b\n            val foldl  : ('a * 'b -> 'b) -> 'b -> 'a array -> 'b\n            val foldr  : ('a * 'b -> 'b) -> 'b -> 'a array -> 'b\n            val findi : (int * 'a -> bool) -> 'a array -> (int * 'a) option\n            val find  : ('a -> bool) -> 'a array -> 'a option\n            val exists : ('a -> bool) -> 'a array -> bool\n            val all : ('a -> bool) -> 'a array -> bool\n            val collate : ('a * 'a -> order) -> 'a array * 'a array -> order\n        end = struct\n            open Array;\n            fun tabulate (n, f) = fromList (List.tabulate (n, f));\n\n            fun vector arr = Vector.tabulate (length arr, fn i => sub (arr, i));\n            \n            fun copy {src, dst, di} = if di < 0 orelse length dst < di + length src then raise Subscript \n                else let\n                    val len = length src\n                    fun loop index = if index = len then ()\n                        else ( update(dst, index + di, sub(src, index)); loop (index + 1))\n                    in \n                        loop 0\n                    end;\n            fun copyVec {src, dst, di} = if di < 0 orelse length dst < di + Vector.length src then raise Subscript \n                else let\n                    val len = Vector.length src\n                    fun loop index = if index = len then ()\n                        else ( update(dst, index + di, Vector.sub(src, index)); loop (index + 1))\n                    in \n                        loop 0\n                    end;\n            \n            fun appi p arr = let\n                val len = length arr\n                fun loop index = if index = len then ()\n                    else (p(index, sub(arr, index)); loop (index +1))\n                in \n                    loop 0\n                end;\n            fun app p = appi (fn (_, v) => p v);\n            \n                        fun modifyi p arr = let\n                val len = length arr\n                fun loop index = if index = len then ()\n                    else ( update(arr, index, p(index, sub(arr, index))); loop (index +1))\n                in \n                    loop 0\n                end;\n                \n            fun modifyi p arr = let\n                val len = length arr\n                fun loop index = if index = len then ()\n                    else ( update(arr, index, p(index, sub(arr, index))); loop (index +1))\n                in \n                    loop 0\n                end; \n            fun modify p = modifyi (fn (_, v) => p v);\n\n            fun foldli f init arr = let\n                val len = length arr\n                fun loop (i, b) =\n                    if i = len then b\n                    else loop (i + 1, f (i, sub (arr, i), b))\n                in\n                    loop (0, init)\n                end;\n            fun foldri f init arr = let\n                val len = length arr\n                fun loop (i, b) =\n                    if i = ~1 then b\n                    else loop (i - 1, f (i, sub (arr, i), b))\n                in\n                    loop (len - 1, init)\n                end;\n            fun foldl f init arr = foldli (fn (_, a, x) => f(a, x)) init arr;\n            fun foldr f init arr = foldri (fn (_, a, x) => f(a, x)) init arr;\n            \n            fun findi f arr = let\n                val len = length arr\n                fun loop index = \n                    if index = Array.length arr then NONE\n                    else let\n                        val el = sub(arr, index) \n                    in if f (index, el) then SOME (index, el) else loop (index+1) \n                    end\n                in \n                    loop 0\n                end;\n            fun find f arr = case findi (fn (_, v) => f v) arr of NONE => NONE \n                                                                | SOME (_, v) => SOME v;\n            fun exists p arr = case find p arr of NONE => false \n                                                | SOME _ => true;\n            \n            fun all p = foldl (fn (v, acc) => p v andalso acc) true;\n            fun collate p (a1, a2) = let\n                val length1 = length a1\n                val length2 = length a2\n                fun loop index = \n                    if index = length1 andalso index = length2 then EQUAL\n                    else if index = length1 then LESS\n                    else if index = length2 then GREATER\n                    else case p (sub (a1, index), sub (a2, index)) of\n                        EQUAL => loop (index + 1)\n                      | l => l\n                in loop 0\n                end;\n\n        end;",requires:["Option","List","Vector"]},Char:{native:function(t){return t.setDynamicValue("ord",new o.PredefinedFunction("ord",function(t,e){if(t instanceof o.CharValue){var n=t.value;return[new o.Integer(n.charCodeAt(0)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("ord",new r.FunctionType(v,l),i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("chr",new o.PredefinedFunction("chr",function(t,e){if(t instanceof o.Integer){var n=t.value;return n<0||n>255?[T.construct(),!0,[]]:[new o.CharValue(String.fromCharCode(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("chr",new r.FunctionType(l,v),i.IdentifierStatus.VALUE_VARIABLE),t},code:'structure Char = struct\n                fun isLower c  = #"a" <= c andalso c <= #"z"\n                fun isUpper c  = #"A" <= c andalso c <= #"Z"\n                fun isDigit c  = #"0" <= c andalso c <= #"9"\n                fun isAlpha c  = isLower c orelse isUpper c\n                fun isHexDigit c = #"0" <= c andalso c <= #"9"\n                               orelse #"a" <= c andalso c <= #"f"\n                               orelse #"A" <= c andalso c <= #"F"\n                fun isAlphaNum c = isAlpha c orelse isDigit c\n                fun isPrint c  = c >= #" " andalso c < #"\\127"\n                fun isSpace c  = c = #" " orelse #"\\009" <= c andalso c <= #"\\013"\n                fun isGraph c  = isPrint c andalso not (isSpace c)\n                fun isPunct c  = isGraph c andalso not (isAlphaNum c)\n                fun isAscii c  = c <= #"\\127"\n                fun isCntrl c  = c < #" " orelse c >= #"\\127"\n\n                fun toLower c =\n                    if #"A" <= c andalso c <= #"Z" then chr (ord c + 32)\n                    else c;\n                fun toUpper c =\n                    if #"a" <= c andalso c <= #"z" then chr (ord c - 32)\n                    else c;\n\n                fun compare (a, b) = Int.compare(ord a, ord b);\n                fun op< (a, b) = Int.compare(ord a, ord b) = LESS;\n                fun op> (a, b) = Int.compare(ord a, ord b) = GREATER;\n                fun op<= (a, b) = Int.compare(ord a, ord b) <> GREATER;\n                fun op>= (a, b) = Int.compare(ord a, ord b) <> LESS;\n\n                val ord = ord;\n                val chr = chr;\n                val maxOrd = 255;\n                val maxChar = chr maxOrd;\n                val minChar = chr 0;\n                \n                fun succ c = if c = maxChar then raise Chr else chr(ord c + 1)\n                fun pred c = if c = minChar then raise Chr else chr(ord c - 1)\n                \n                fun contains s = let\n                    val table = Array.array(maxOrd + 1, false)\n                    val l = explode s\n                    in \n                        (List.app (fn x => Array.update(table, ord x, true)) l; fn c => Array.sub(table, ord c))\n                    end;\n                fun notContains s = let\n                    val table = Array.array(maxOrd + 1, false)\n                    val l = explode s\n                    in \n                        (List.app (fn x => Array.update(table, ord x, true)) l; fn c => not (Array.sub(table, ord c)))\n                    end;\n            end;',requires:["Int","Array","List"]},Eval:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{});return e.setValue("evalExp",new o.PredefinedFunction("symbolic_eval",function(t,e){if(!(t instanceof o.StringValue))throw new s.InternalInterpreterError(-1,"This std type mismatch reigns supreme!");var n=t.value;try{var i=p.lex(n+";",{}),r=new c.Parser(i,e.state,e.state.id,{}).parseExpression();r=r.simplify();var a=[];a.push({next:r,params:{state:e.state.getNestedState(),modifiable:e.state.getNestedState(),recResult:void 0}});for(var u=void 0,l="",d=new Map,y=function(){var t=a.pop();if(void 0===t)throw new s.InternalInterpreterError(-1,"バトル、バトルしたい！");var e=t.next,n=t.params;n.recResult=u,u=e instanceof h.Declaration?e.evaluate(n,a):e.compute(n,a);var i=t.next.toString();if(1===n.step&&!i.includes("__arg"))if(u&&u.value)l+=i+" → "+u.value.toString(n.state)+"\n";else{var r=new Map;d.forEach(function(t,e){i.includes(e)?i=i.replace(e,t):r.set(e,t)}),d=r,l+=i+"\n"}u&&u.value&&"fn"!==u.value.toString(n.state)&&(t.next instanceof f.ValueIdentifier||t.next instanceof f.Record||d.set(t.next.toString(),u.value.toString(n.state)))};a.length>0;)y();return void 0!==u&&void 0!==u.value&&(l+=u.value.toString(void 0)+"\n"),[new o.RecordValue,!1,[new s.Warning(-2,l)]]}catch(t){return[new o.RecordValue,!1,[new s.Warning(t.position,t.message)]]}}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("evalExp",new r.FunctionType(y,new r.TupleType([])).simplify(),i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure("Eval",e),t.setStaticStructure("Eval",n),t},code:void 0,requires:void 0},Int:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{});return e.setValue("toString",new o.PredefinedFunction("toString",function(t,e){if(t instanceof o.Integer)return[new o.StringValue(t.toString(void 0)),!1,[]];throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("toString",new r.FunctionType(l,y),i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure("Int",e),t.setStaticStructure("Int",n),t},code:"structure Int = struct\n                open Int;\n                fun compare (x, y: int) = if x < y then LESS else if x > y then GREATER else EQUAL;\n\n                val minInt = SOME ~"+-o.MININT+";\n                val maxInt = SOME "+o.MAXINT+";\n                fun max (x, y) = if x < y then y else x : int;\n                fun min (x, y) = if x > y then y else x : int;\n            end;",requires:["Option"]},List:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{});return n.setType("list",new r.CustomType("list",[new r.TypeVariable("'a")]),["nil","::"],1,!0),n.setValue("nil",new r.TypeVariableBind("'a",new r.CustomType("list",[new r.TypeVariable("'a")])),i.IdentifierStatus.VALUE_CONSTRUCTOR),n.setValue("::",new r.TypeVariableBind("'a",new r.FunctionType(new r.TupleType([new r.TypeVariable("'a"),new r.CustomType("list",[new r.TypeVariable("'a")])]),new r.CustomType("list",[new r.TypeVariable("'a")]))).simplify(),i.IdentifierStatus.VALUE_CONSTRUCTOR),e.setType("list",["nil","::"]),e.setValue("nil",new o.ValueConstructor("nil"),i.IdentifierStatus.VALUE_CONSTRUCTOR),e.setValue("::",new o.ValueConstructor("::",1),i.IdentifierStatus.VALUE_CONSTRUCTOR),t.setDynamicStructure("List",e),t.setStaticStructure("List",n),t},code:"structure List : sig\n                datatype 'a list = nil | :: of 'a * 'a list;\n                val rev: 'a list -> 'a list;\n            end  = struct\n                open List;\n                fun rev' nil ys     = ys\n                  | rev' (x::xs) ys = rev' xs (x::ys)\n                fun rev xs = rev' xs nil;\n            end;\n\n            structure List = struct\n                exception Empty;\n                open List;\n\n                fun hd nil = raise Empty\n                  | hd (x::xr) = x;\n\n                fun tl nil = raise Empty\n                  | tl (x::xr) = xr;\n\n                fun null nil = true\n                  | null (x::xr) = false;\n\n                fun map f nil = nil\n                  | map f (x::xr) = (f x) :: (map f xr);\n\n                infixr 5 @;\n                fun [] @ ys = ys\n                  | (x::xr) @ ys = x :: (xr @ ys);\n\n                fun length nil = 0\n                  | length (x::xr) = 1 + length xr;\n\n                fun foldr f e []      = e\n                  | foldr f e (x::xr) = f(x, foldr f e xr);\n\n                fun foldl f e []      = e\n                  | foldl f e (x::xr) = foldl f (f(x, e)) xr;\n            end;\n            open List;\n            infixr 5 @;\n\n            structure List = struct\n                open List;\n\n                fun concat nil = nil\n                  | concat (x::xr) = x @ concat xr;\n\n                fun tabulate (n, f) = let\n                    fun h i = if i < n then f i :: h (i + 1) else []\n                in\n                    if n < 0 then raise Size else h 0\n                end;\n\n                fun exists p []      = false\n                  | exists p (x::xr) = p x orelse exists p xr;\n\n                fun all p []      = true\n                  | all p (x::xr) = p x andalso all p xr;\n\n                fun filter p []      = []\n                  | filter p (x::xr) = if p x then x :: filter p xr else filter p xr;\n\n                fun collate (compare : 'a * 'a -> order) p = case p of\n                    (nil, _::_)     => LESS\n                  | (nil, nil)      => EQUAL\n                  | (_::_, nil)     => GREATER\n                  | (x::xr, y::yr)  => case compare (x, y) of\n                         EQUAL  => collate compare (xr, yr)\n                       | s      => s;\n\n                fun nth ([], _)    = raise Subscript\n                  | nth (x::xs, 0) = x\n                  | nth (x::xs, n) = nth (xs, n - 1);\n\n                fun last [x] = x\n                  | last (x::xs) = last xs\n                  | last [] = raise Empty;\n\n                fun getItem [] = NONE\n                  | getItem x = SOME (hd x, tl x);\n\n                fun take (x, 0) = []\n                  | take ([], _) = raise Subscript\n                  | take (x::xs, n) = x :: take (xs, n - 1);\n\n                fun drop (x, 0) = x\n                  | drop ([], _) = raise Subscript\n                  | drop (x::xs, n) = drop (xs, n - 1);\n\n                fun revAppend (l1, l2) = (rev l1) @ l2;\n\n                fun app (f: 'a -> unit) [] = ()\n                  | app (f: 'a -> unit) (x::xs) = (f x; app f xs);\n\n                fun mapPartial f l\n                    = ((map valOf) o (filter isSome) o (map f)) l;\n\n                fun find f [] = NONE\n                  | find f (x::xs) = if f x then SOME x else find f xs;\n\n                fun partition f [] = ([], [])\n                  | partition f (x::xs) = let\n                    val tmp = partition f xs\n                in\n                    if f x then (x :: #1 tmp, #2 tmp)\n                    else (#1 tmp, x :: #2 tmp)\n                end;\n            end;",requires:["Option"]},Listsort:{native:void 0,code:"structure Listsort : sig\n                val sort: ('a * 'a -> order) -> 'a list -> 'a list;\n                val sorted: ('a * 'a -> order) -> 'a list -> bool;\n                val mergeUniq: ('a * 'a -> order) -> 'a list * 'a list -> 'a list;\n                val merge: ('a * 'a -> order) -> 'a list * 'a list -> 'a list;\n                val eqclasses: ('a * 'a -> order) -> 'a list -> 'a list list;\n            end = struct\n              fun take ordr x1 xr []       = x1 :: xr\n                | take ordr x1 xr (y1::yr) = (case ordr(x1, y1) of\n                    LESS    => x1 :: take ordr y1 yr xr\n                  | _       => y1 :: take ordr x1 xr yr);\n\n              fun takeUniq ordr x1 xr []       = x1 :: xr\n                | takeUniq ordr x1 xr (y1::yr) = (case ordr(x1, y1) of\n                    LESS    => x1 :: takeUniq ordr y1 yr xr\n                  | GREATER => y1 :: takeUniq ordr x1 xr yr\n                  | EQUAL   => takeUniq ordr x1 xr yr);\n\n              fun merge ordr ([],     ys) = ys\n                | merge ordr (x1::xr, ys) = take ordr x1 xr ys;\n\n              fun mergeUniq ordr ([],     ys) = ys\n                | mergeUniq ordr (x1::xr, ys) = takeUniq ordr x1 xr ys;\n\n              fun mergepairs ordr l1  [] k              = [l1]\n                | mergepairs ordr l1 (ls as (l2::lr)) k =\n                  if k mod 2 = 1 then l1::ls\n                  else mergepairs ordr (merge ordr (l1, l2)) lr (k div 2);\n\n              fun nextrun ordr run []      = (run, [])\n                | nextrun ordr run (xs as (x::xr)) =\n                  if ordr(x, List.hd run) = LESS then (run, xs)\n                  else nextrun ordr (x::run) xr;\n\n              fun sorting ordr []      ls r = List.hd(mergepairs ordr [] ls 0)\n                | sorting ordr (x::xs) ls r = let\n                    val (revrun, tail) = nextrun ordr [x] xs\n                  in\n                    sorting ordr tail (mergepairs ordr (List.rev revrun) ls (r+1)) (r+1)\n                  end;\n\n              fun group ordr last rest cs1 css = case rest of\n                  []     => cs1 :: css\n                | r1::rr => if ordr(r1, last) = EQUAL then group ordr r1 rr (r1 :: cs1) css\n                            else group ordr r1 rr [r1] (cs1 :: css);\n\n              fun sort ordr []               = []\n                | sort ordr (xs as [_])      = xs\n                | sort ordr (xs as [x1, x2]) = (case ordr(x1, x2) of\n                    GREATER => [x2, x1]\n                  | _       => xs)\n                | sort ordr xs = sorting ordr xs [] 0;\n\n              fun sorted ordr []           = true\n                | sorted ordr [x]          = true\n                | sorted ordr (x1::x2::xr) =\n                  ordr(x1, x2) <> GREATER andalso sorted ordr (x2::xr);\n\n\n              fun eqclasses ordr xs = let\n                  val xs = List.rev (sort ordr xs)\n                in\n                  case xs of\n                      []     => []\n                    | x1::xr => group ordr x1 xr [x1] []\n                  end;\n            end;\n            structure List = struct\n                open List;\n                open Listsort;\n            end;",requires:["List"]},Math:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{});return e.setValue("sqrt",new o.PredefinedFunction("sqrt",function(t,e){if(t instanceof o.Real){var n=t.value;return n<0?[m.construct(),!0,[]]:[new o.Real(Math.sqrt(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("sqrt",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("sin",new o.PredefinedFunction("sin",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.sin(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("sin",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("cos",new o.PredefinedFunction("cos",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.cos(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("cos",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("tan",new o.PredefinedFunction("tan",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.tan(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("tan",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("asin",new o.PredefinedFunction("asin",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.asin(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("asin",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("acos",new o.PredefinedFunction("acos",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.acos(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("acos",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("atan",new o.PredefinedFunction("atan",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.atan(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("atan",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("atan2",new o.PredefinedFunction("atan2",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Real&&i instanceof o.Real){var r=n.value,a=i.value;return[new o.Real(Math.atan2(r,a)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("atan2",new r.FunctionType(new r.TupleType([d,d]),d).simplify(),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("exp",new o.PredefinedFunction("exp",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.exp(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("exp",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("pow",new o.PredefinedFunction("pow",function(t,e){if(t instanceof o.RecordValue){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.Real&&i instanceof o.Real){var r=n.value,a=i.value;return[new o.Real(Math.pow(r,a)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("pow",new r.FunctionType(new r.TupleType([d,d]),d).simplify(),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("ln",new o.PredefinedFunction("ln",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.log(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("ln",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("log10",new o.PredefinedFunction("log10",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.log10(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("log10",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("sinh",new o.PredefinedFunction("sinh",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.sinh(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("sinh",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("cosh",new o.PredefinedFunction("cosh",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.cosh(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("cosh",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("tanh",new o.PredefinedFunction("tanh",function(t,e){if(t instanceof o.Real){var n=t.value;return[new o.Real(Math.tanh(n)),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("tanh",new r.FunctionType(d,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("pi",new o.Real(3.14159265359),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("pi",d,i.IdentifierStatus.VALUE_VARIABLE),e.setValue("e",new o.Real(2.71828182846),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("e",d,i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure("Math",e),t.setStaticStructure("Math",n),t},code:void 0,requires:void 0},Option:{native:void 0,code:"structure Option = struct\n                exception Option;\n\n                datatype 'a option = NONE | SOME of 'a;\n\n                fun getOpt (NONE, a) = a\n                  | getOpt (SOME x, a) = x;\n\n                fun isSome NONE = false\n                  | isSome (SOME _) = true;\n\n                fun valOf (SOME x) = x\n                  | valOf NONE = raise Option;\n\n                fun filter f x = if f x then SOME x else NONE;\n\n                fun join NONE = NONE\n                  | join (SOME (SOME x)) = SOME x;\n\n                fun app f (SOME v) = f v\n                  | app f NONE = ();\n\n                fun map f NONE = NONE\n                  | map f (SOME v) = SOME(f v);\n\n                fun mapPartial f NONE = NONE\n                  | mapPartial f (SOME v) = f v;\n\n                fun compose (f, g) a = case g a of\n                      NONE => NONE\n                    | SOME v => SOME (f v);\n\n                fun composePartial (f, g) a = case g a of\n                      NONE => NONE\n                    | SOME v => (f v);\n            end;\n            open Option;",requires:void 0},Real:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{});return e.setValue("fromInt",new o.PredefinedFunction("fromInt",function(t,e){if(t instanceof o.Integer){var n=t.value;return[new o.Real(n),!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("fromInt",new r.FunctionType(l,d),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("round",new o.PredefinedFunction("round",function(t,e){if(t instanceof o.Real){var n=t.value,i=new o.Integer(Math.round(n));return i.hasOverflow()?[w.construct(),!0,[]]:[i,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("round",new r.FunctionType(d,l),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("floor",new o.PredefinedFunction("floor",function(t,e){if(t instanceof o.Real){var n=t.value,i=new o.Integer(Math.floor(n));return i.hasOverflow()?[w.construct(),!0,[]]:[i,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("floor",new r.FunctionType(d,l),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("ceil",new o.PredefinedFunction("ceil",function(t,e){if(t instanceof o.Real){var n=t.value,i=new o.Integer(Math.ceil(n));return i.hasOverflow()?[w.construct(),!0,[]]:[i,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("ceil",new r.FunctionType(d,l),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("toString",new o.PredefinedFunction("toString",function(t,e){if(t instanceof o.Real)return[new o.StringValue(t.toString(void 0)),!1,[]];throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("toString",new r.FunctionType(d,y),i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure("Real",e),t.setStaticStructure("Real",n),t},code:"structure Real = struct\n                open Real;\n                fun compare (x, y: real) = if x < y then LESS else if x > y then GREATER else EQUAL;\n            end;",requires:void 0},String:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{});return n.setType("string",new r.CustomType("string",[]),[],0,!0),e.setType("string",[]),n.setType("char",new r.CustomType("char",[]),[],0,!0),e.setType("char",[]),t.setDynamicStructure("String",e),t.setStaticStructure("String",n),t},code:'structure String : sig\n                eqtype string\n                eqtype char\n                val size : string -> int\n                val sub : string * int -> char\n                val extract   : string * int * int option -> string\n                val substring : string * int * int -> string\n                val ^ : string * string -> string\n                val concat : string list -> string\n                val concatWith : string -> string list -> string\n                val str : char -> string\n                val implode : char list -> string\n                val explode : string -> char list\n                val map : (char -> char) -> string -> string\n                val translate : (char -> string) -> string -> string\n                val tokens : (char -> bool) -> string -> string list\n                val fields : (char -> bool) -> string -> string list\n                val isPrefix    : string -> string -> bool\n                val isSubstring : string -> string -> bool\n                val isSuffix    : string -> string -> bool\n                val compare : string * string -> order\n                val collate : (char * char -> order)\n                                -> string * string -> order\n                val <  : string * string -> bool\n                val <= : string * string -> bool\n                val >  : string * string -> bool\n                val >= : string * string -> bool\n            end = struct\n                open String;\n\n                fun size s = List.length (explode s);\n                fun sub (s,i) = List.nth (explode s, i);\n                fun extract (s, i, NONE) = implode (List.drop (explode s, i))\n                  | extract (s, i, SOME j) = implode (List.take (List.drop (explode s, i), j));\n                fun substring (s, i, j) = extract (s, i, SOME j);\n                val op^ = op^;\n\n                fun cc2 b ([], y) = y\n                  | cc2 b (x::xs, y) = cc2 b (xs, y^b^x);\n                fun concat a = cc2 "" (a, "");\n                fun concatWith b [] = ""\n                  | concatWith b (a::c) = a ^ (cc2 b (c, ""));\n\n                fun str c = implode [c];\n                val implode = implode;\n                val explode = explode;\n                fun map f s = implode(List.map f (explode s));\n                fun translate f s = concat(List.map f (explode s));\n\n\n                fun cmp f ([], []) = EQUAL\n                  | cmp f ([], _) = LESS\n                  | cmp f (_, []) = GREATER\n                  | cmp f (x::xs, y::ys) = let\n                        val tmp = f (x, y);\n                    in\n                        if tmp <> EQUAL then tmp else cmp f (xs, ys)\n                    end;\n\n                fun matchPrefix ([], _) = true\n                  | matchPrefix (_, []) = false\n                  | matchPrefix (x::xs, y::ys) = if x <> y then false else matchPrefix (xs, ys);\n\n                fun matchSubstring ([], _) = true\n                  | matchSubstring (_, []) = false\n                  | matchSubstring (x, y as _::ys) = if matchPrefix (x, y) then true\n                    else matchSubstring (x, ys);\n\n                fun getFields (f, [], tmp, x) = (implode tmp) :: x\n                  | getFields (f, (r::rs), tmp, x) = if f r then\n                        getFields (f, rs, [], (implode tmp)::x)\n                    else\n                        getFields (f, rs, r::tmp, x);\n\n                fun tokens f s = List.filter (fn t => t <> "") (getFields (f, rev (explode s), [], []));\n                fun fields f s = getFields (f, rev (explode s), [], []);\n\n                fun isPrefix a b = matchPrefix (explode a, explode b);\n                fun isSubstring a b = matchSubstring (explode a, explode b);\n                fun isSuffix a b = matchPrefix (rev (explode a), rev (explode b));\n\n                fun compare (a, b) = cmp Char.compare (explode a, explode b);\n                fun collate f (a, b) = cmp f (explode a, explode b);\n\n                fun op< (a, b) = compare (a, b) = LESS;\n                fun op> (a, b) = compare (a, b) = GREATER;\n                fun op<= (a, b) = compare (a, b) <> GREATER;\n                fun op>= (a, b) = compare (a, b) <> LESS;\n            end;',requires:["Char","List"]},Vector:{native:function(t){var e=new i.DynamicBasis({},{},{},{},{}),n=new i.StaticBasis({},{},{},{},{}),a=new r.CustomType("vector",[new r.TypeVariable("'a")]),u=new r.CustomType("list",[new r.TypeVariable("'a")]);return n.setType("vector",a,[],1,!0),e.setType("vector",[]),e.setValue("fromList",new o.PredefinedFunction("fromList",function(t,e){var n=new o.VectorValue([]);if(t instanceof o.ConstructedValue){for(var i=t;"nil"!==i.constructorName;){if("::"!==i.constructorName)throw new s.InternalInterpreterError(-1,"std type mismatch");var r=i.argument;if(!(r instanceof o.RecordValue&&2===r.entries.size))throw new s.InternalInterpreterError(-1,"std type mismatch");var a=r.getValue("1"),u=r.getValue("2");if(!(a instanceof o.Value&&u instanceof o.ConstructedValue))throw new s.InternalInterpreterError(-1,"std type mismatch");n.entries.push(a),i=u}return[n,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("fromList",new r.FunctionType(u,a),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("sub",new o.PredefinedFunction("sub",function(t,e){if(t instanceof o.RecordValue&&2===t.entries.size){var n=t.getValue("1"),i=t.getValue("2");if(n instanceof o.VectorValue&&i instanceof o.Integer){var r=i.value;return r<0||r>=n.entries.length?[E.construct(),!0,[]]:[n.entries[r],!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("sub",new r.FunctionType(new r.TupleType([a,l]).simplify(),new r.TypeVariable("'a")),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("update",new o.PredefinedFunction("update",function(t,e){if(t instanceof o.RecordValue&&3===t.entries.size){var n=t.getValue("1"),i=t.getValue("2"),r=t.getValue("3");if(n instanceof o.VectorValue&&i instanceof o.Integer){var a=i.value;if(a<0||a>=n.entries.length)return[E.construct(),!0,[]];var u=new o.VectorValue(n.entries.slice());return u.entries[a]=r,[u,!1,[]]}throw new s.InternalInterpreterError(-1,"std type mismatch")}throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("update",new r.FunctionType(new r.TupleType([a,l,new r.TypeVariable("'a")]).simplify(),a),i.IdentifierStatus.VALUE_VARIABLE),e.setValue("length",new o.PredefinedFunction("length",function(t,e){if(t instanceof o.VectorValue)return[new o.Integer(t.entries.length),!1,[]];throw new s.InternalInterpreterError(-1,"std type mismatch")}),i.IdentifierStatus.VALUE_VARIABLE),n.setValue("length",new r.FunctionType(a,l),i.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure("Vector",e),t.setStaticStructure("Vector",n),t},code:"structure Vector :> sig\n            (* eqtype 'a vector = 'a vector *)\n            (* val maxLen : int *)\n            val fromList : 'a list -> 'a vector\n            val tabulate : int * (int -> 'a) -> 'a vector\n            val length : 'a vector -> int\n            val sub : 'a vector * int -> 'a\n            val update : 'a vector * int * 'a -> 'a vector\n            val concat : 'a vector list -> 'a vector\n            val appi : (int * 'a -> unit) -> 'a vector -> unit\n            val app  : ('a -> unit) -> 'a vector -> unit\n            val mapi : (int * 'a -> 'b) -> 'a vector -> 'b vector\n            val map  : ('a -> 'b) -> 'a vector -> 'b vector\n            val foldli : (int * 'a * 'b -> 'b) -> 'b -> 'a vector -> 'b\n            val foldri : (int * 'a * 'b -> 'b) -> 'b -> 'a vector -> 'b\n            val foldl  : ('a * 'b -> 'b) -> 'b -> 'a vector -> 'b\n            val foldr  : ('a * 'b -> 'b) -> 'b -> 'a vector -> 'b\n            val findi : (int * 'a -> bool) -> 'a vector -> (int * 'a) option \n            val find  : ('a -> bool) -> 'a vector -> 'a option \n            val exists : ('a -> bool) -> 'a vector -> bool\n            val all : ('a -> bool) -> 'a vector -> bool\n            val collate : ('a * 'a -> order) -> 'a vector * 'a vector -> order\n        end = struct\n            open Vector;\n            fun tabulate (n, f) = fromList (List.tabulate (n, f));\n\n            fun foldli f init vec = let\n                val len = length vec\n                fun loop (i, b) =\n                    if i = len then b\n                    else loop (i + 1, f (i, sub (vec, i), b))\n                in\n                    loop (0, init)\n                end;\n            fun foldri f init vec = let\n                val len = length vec\n                fun loop (i, b) =\n                    if i = ~1 then b\n                    else loop (i - 1, f (i, sub (vec, i), b))\n                in\n                    loop (len - 1, init)\n                end;\n            fun foldl f init vec = foldli (fn (_, a, x) => f(a, x)) init vec;\n            fun foldr f init vec = foldri (fn (_, a, x) => f(a, x)) init vec;\n\n            fun concat l = fromList (List.concat (List.map (foldr (fn (a, b) => (a::b)) []) l));\n\n            fun appi f vec = List.app f (foldri (fn (i,a,l) => (i,a)::l) [] vec);\n            fun app  f vec = List.app f (foldr (fn (a,l) => a::l) [] vec);\n            fun mapi f vec = fromList (List.map f (foldri (fn (i,a,l) => (i,a)::l) [] vec));\n            fun map  f vec = fromList (List.map f (foldr (fn (a,l) => a::l) [] vec));\n\n            fun findi f vec = let\n                val len = length vec\n                fun loop index = \n                    if index = Vector.length vec then NONE\n                    else let\n                        val el = sub(vec, index) \n                    in if f (index, el) then SOME (index, el) else loop (index+1) \n                    end\n                in \n                    loop 0\n                end;\n            fun find f vec = case findi (fn (_, v) => f v) vec of NONE => NONE \n                                                                 | SOME (_, v) => SOME v;\n            fun exists p vec = case find p vec of NONE => false \n                                                | SOME _ => true;\n            \n            fun all p vec = foldl (fn (v, acc) => p v andalso acc) true vec;\n            fun collate p (v1, v2) = let\n                val length1 = length v1\n                val length2 = length v2\n                fun loop index = \n                    if index = length1 andalso index = length2 then EQUAL\n                    else if index = length1 then LESS\n                    else if index = length2 then GREATER\n                    else case p (sub (v1, index), sub (v2, index)) of\n                        EQUAL => loop (index + 1)\n                      | l => l\n                in loop 0\n                end;\n        end;\n        val vector = Vector.fromList;",requires:["Option","List"]},Version:{native:void 0,code:'structure Version = struct\n            val version     = "'+u.VERSION+'";\n            val branch      = "'+u.BRANCH_NAME+'";\n            val commit      = "'+u.COMMIT_HASH+'";\n            val buildDate   = "'+u.BUILD_DATE+'";\n            val message     = "'+u.COMMIT_MESSAGE+'";\n        end;',requires:void 0}},e.loadModule=function t(n,i,r){if(!e.STDLIB.hasOwnProperty(i))throw new s.InternalInterpreterError(-1,'The module "'+i+'" does not exist. Auuuu~');if(n.hasModule(i))return n;var o=e.STDLIB[i];if(void 0!==o.requires)for(var u=0,p=o.requires;u<p.length;u++){var c=p[u];n.hasModule(c)||(n=t(n,c,r))}return void 0!==o.native&&(n=o.native(n)),void 0!==o.code&&(n=a.interpret(o.code,n,r).state),n.registerModule(i),n}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VERSION="1.1.0",e.BRANCH_NAME="master",e.COMMIT_HASH="e94afc3",e.BUILD_DATE="Sat 12 Oct 2019 03:23:45 PM UTC",e.COMMIT_MESSAGE="fix tests"},function(t,e,n){"use strict";var i,r=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var o=n(6),s=n(5),a=n(2),u=n(4),p=n(3),c=n(0),h=n(1),f=n(8),l=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.structureDeclaration=n,i}return r(e,t),e.prototype.simplify=function(){return new e(this.position,this.structureDeclaration.simplify())},e.prototype.elaborate=function(t,e,n){var i=t.getNestedState(0).getNestedState(t.id),r=this.structureDeclaration.elaborate(i,e,n,!0);return t.valueIdentifierId=r[0].valueIdentifierId,[r[0].getStaticChanges(0),r[1],r[2],r[3]]},e.prototype.computeStructure=function(t,e,n){if(void 0===t.recResult){var i=t.state,r=i.getNestedState(0).getNestedState(i.id);return e.push({next:n,params:t}),void e.push({next:this.structureDeclaration,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}var o=t.recResult;if(void 0===o||void 0===o.newState)throw new c.InternalInterpreterError(-1,"RAINBOW!");r=o.newState;return o.hasThrown?o.value:r.getDynamicChanges(0)},e.prototype.toString=function(){return"struct "+this.structureDeclaration+" end"},e}(o.Expression);e.StructureExpression=l;var d=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.identifier=n,i}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n){var i=void 0;if(this.identifier instanceof a.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.identifier);void 0!==r&&(i=r.getStructure(this.identifier.id.getText()))}else i=t.getStaticStructure(this.identifier.getText());if(void 0===i)throw new c.ElaborationError(this.position,'Undefined module "'+this.identifier.getText()+'".');return[i,[],e,n]},e.prototype.computeStructure=function(t,e,n){var i=t.state,r=void 0;if(this.identifier instanceof a.LongIdentifierToken){var o=i.getAndResolveDynamicStructure(this.identifier);void 0!==o&&(r=o.getStructure(this.identifier.id.getText()))}else r=i.getDynamicStructure(this.identifier.getText());if(void 0===r)throw new c.EvaluationError(this.position,'Undefined module "'+this.identifier.getText()+'".');return r},e.prototype.toString=function(){return this.identifier.getText()},e}(o.Expression);e.StructureIdentifier=d;var y=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.structureExpression=n,r.signatureExpression=i,r}return r(e,t),e.restrict=function(t,n,i,r,o,s){var a=new p.StaticBasis({},{},{},{},{}),h=i.getNestedState(i.id);h.staticBasis=n;var f=i.getNestedState(i.id);for(var l in f.staticBasis=t,t.typeEnvironment)if(t.typeEnvironment.hasOwnProperty(l)){if(!n.typeEnvironment.hasOwnProperty(l))throw new c.ElaborationError(s,'Signature mismatch: Unimplemented type "'+l+'".');var d=t.typeEnvironment[l],y=n.typeEnvironment[l];if(d.arity!==y.arity)throw new c.ElaborationError(s,'Signature mismatch: Implementation of type "'+l+'" has the wrong arity.');try{var v=d.type,w=y.type;!(d.type instanceof u.FunctionType)&&y.type instanceof u.FunctionType&&(w=y.type.parameterType);var m=v.merge(h,r,w);a.setType(l,y.type.instantiate(f,m[1]),d.constructors,d.arity,d.allowsEquality),r=m[1]}catch(t){if(!(t instanceof Array))throw t;throw new c.ElaborationError(s,'Signature mismatch: Wrong implementation of type "'+l+'": '+t[0])}}for(var l in t.valueEnvironment)if(t.valueEnvironment.hasOwnProperty(l)){if(!n.valueEnvironment.hasOwnProperty(l))throw new c.ElaborationError(s,'Signature mismatch: Unimplemented value "'+l+'".');d=t.valueEnvironment[l],y=n.valueEnvironment[l];for(var g=new Map,T=d[0].getTypeVariables(),E=y[0].getTypeVariables();y[0]instanceof u.TypeVariableBind;){for(;;){var x=+o.substring(3);if(o=I="'"+o[1]+o[2]+(x+1),!r.has(I)&&!T.has(I)&&!E.has(I)){"'"===y[0].name[1]&&(I="'"+I),g=g.set(y[0].name,I);break}}y[0]=y[0].type}y[0]=y[0].replaceTypeVariables(g);for(var S=d[0];S instanceof u.TypeVariableBind;){for(;;){var I;x=+o.substring(3);if(o=I="'"+o[1]+o[2]+(x+1),!r.has(I)&&!T.has(I)&&!E.has(I)){"'"===S.name[1]&&(I="'"+I),g=g.set(S.name,I);break}}S=S.type}S=S.replaceTypeVariables(g);try{var k=S.merge(h,r,y[0]);a.setValue(l,d[0].instantiate(h,k[1]),d[1])}catch(t){if(!(t instanceof Array))throw t;throw new c.ElaborationError(s,'Signature mismatch: Wrong implementation of type "'+l+'": '+t[0])}}for(var l in t.structureEnvironment)if(t.structureEnvironment.hasOwnProperty(l)){if(!n.structureEnvironment.hasOwnProperty(l))throw new c.ElaborationError(s,'Unimplemented structure "'+l+'".');try{var V=e.restrict(t.getStructure(l),n.getStructure(l),h,r,o,s);a.setStructure(l,V[0]),r=V[2],o=V[3]}catch(t){throw new c.ElaborationError(s,'Signature Mismatch: Wrong implementation of structure "'+l+'": '+t.message)}}return[a,[],r,o]},e.prototype.simplify=function(){return new e(this.position,this.structureExpression.simplify(),this.signatureExpression.simplify())},e.prototype.elaborate=function(t,n,i){var r=this.structureExpression.elaborate(t,n,i),o=this.signatureExpression.elaborate(t,r[2],r[3]);return e.restrict(o[0],r[0],t,o[2],o[3],this.position)},e.prototype.computeStructure=function(t,e,n){var i=this.structureExpression.computeStructure(t,e,n);if(void 0!==i){if(i instanceof h.Value)return i;var r=this.signatureExpression.computeInterface(t.state);return i.restrict(r)}},e.prototype.toString=function(){return this.structureExpression+" : "+this.signatureExpression},e}(o.Expression);e.TransparentConstraint=y;var v=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.structureExpression=n,r.signatureExpression=i,r}return r(e,t),e.restrict=function(t,n,i,r,o,s){var a=new p.StaticBasis({},{},{},{},{}),h=i.getNestedState(i.id);h.staticBasis=n;var f=i.getNestedState(i.id);for(var l in f.staticBasis=t,f=f.getNestedState(i.id),t.typeEnvironment)if(t.typeEnvironment.hasOwnProperty(l)){if(!n.typeEnvironment.hasOwnProperty(l))throw new c.ElaborationError(s,'Signature mismatch: Unimplemented type "'+l+'".');var d=t.typeEnvironment[l],y=n.typeEnvironment[l];if(d.arity!==y.arity)throw new c.ElaborationError(s,'Signature mismatch: Implementation of type "'+l+'" has the wrong arity.');try{var v=d.type,w=y.type;!(d.type instanceof u.FunctionType)&&y.type instanceof u.FunctionType&&(w=y.type.parameterType);var m=v.merge(h,r,w);v=new u.CustomType(v.name,v.typeArguments,v.position,v.qualifiedName,!0),a.setType(l,v,[],d.arity,d.allowsEquality),f.staticBasis.setType(l,v,d.constructors,d.arity,d.allowsEquality),r=m[1]}catch(t){if(!(t instanceof Array))throw t;throw new c.ElaborationError(s,'Signature mismatch: Wrong implementation of type "'+l+'": '+t[0])}}for(var l in t.valueEnvironment)if(t.valueEnvironment.hasOwnProperty(l)){if(!n.valueEnvironment.hasOwnProperty(l))throw new c.ElaborationError(s,'Signature mismatch: Unimplemented value "'+l+'".');d=t.valueEnvironment[l],y=n.valueEnvironment[l];for(var g=new Map,T=d[0].getTypeVariables(),E=y[0].getTypeVariables(),x=y[0];x instanceof u.TypeVariableBind;){for(;;){var S=+o.substring(3);if(o=k="'"+o[1]+o[2]+(S+1),!r.has(k)&&!T.has(k)&&!E.has(k)){"'"===x.name[1]&&(k="'"+k),g=g.set(x.name,k);break}}x=x.type}x=x.replaceTypeVariables(g);for(var I=d[0];I instanceof u.TypeVariableBind;){for(;;){var k;S=+o.substring(3);if(o=k="'"+o[1]+o[2]+(S+1),!r.has(k)&&!T.has(k)&&!E.has(k)){"'"===I.name[1]&&(k="'"+k),g=g.set(I.name,k);break}}I=I.type}I=I.replaceTypeVariables(g);try{I.merge(h,r,x),a.setValue(l,d[0].instantiate(f,r),d[1])}catch(t){if(!(t instanceof Array))throw t;throw new c.ElaborationError(s,'Signature mismatch: Wrong implementation of type "'+l+'": '+t[0])}}for(var l in t.structureEnvironment)if(t.structureEnvironment.hasOwnProperty(l)){if(!n.structureEnvironment.hasOwnProperty(l))throw new c.ElaborationError(s,'Unimplemented structure "'+l+'".');try{var V=e.restrict(t.getStructure(l),n.getStructure(l),h,r,o,s);a.setStructure(l,V[0]),r=V[2],o=V[3]}catch(t){throw new c.ElaborationError(s,'Signature Mismatch: Wrong implementation of structure "'+l+'": '+t.message)}}return[a,[],r,o]},e.prototype.simplify=function(){return new e(this.position,this.structureExpression.simplify(),this.signatureExpression.simplify())},e.prototype.elaborate=function(t,n,i){var r=this.structureExpression.elaborate(t,n,i),o=this.signatureExpression.elaborate(t,r[2],r[3]);return e.restrict(o[0],r[0],t,o[2],o[3],this.position)},e.prototype.computeStructure=function(t,e,n){var i=this.structureExpression.computeStructure(t,e,n);if(void 0!==i){if(i instanceof h.Value)return i;var r=this.signatureExpression.computeInterface(t.state);return i.restrict(r)}},e.prototype.toString=function(){return this.structureExpression+" :> "+this.signatureExpression},e}(o.Expression);e.OpaqueConstraint=v;var w=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.functorId=n,r.structureExpression=i,r}return r(e,t),e.prototype.simplify=function(){return new e(this.position,this.functorId,this.structureExpression.simplify())},e.prototype.elaborate=function(t,e,n){var i=this.structureExpression.elaborate(t,e,n),r=t.getStaticFunctor(this.functorId.getText());if(void 0===r)throw new c.EvaluationError(this.position,'Undefined functor "'+this.functorId.getText()+'".');var o=new p.StaticBasis({},{},{},{},{});o.extend(r[1]);var s=o.extend(y.restrict(r[0],i[0],t,e,n,this.position)[0]);for(var a in s.valueEnvironment)if(s.valueEnvironment.hasOwnProperty(a)){var u=s.valueEnvironment[a];if(void 0!==u&&void 0!==u[0]){var h=t.getNestedState(t.id);h.staticBasis=s,s.valueEnvironment[a]=[u[0].instantiate(h,i[2]),u[1]]}}return[s,i[1],i[2],i[3]]},e.prototype.computeStructure=function(t,e,n){var i=t.state,r=i.getDynamicFunctor(this.functorId.getText());if(void 0===r)throw new c.EvaluationError(this.position,'Undefined functor "'+this.functorId.getText()+'".');if(void 0===t.funappres){if(void 0===(o=this.structureExpression.computeStructure(t,e,n)))return;if(o instanceof h.Value)return o;t.funappres=o}var o=t.funappres;if(void 0===t.nstate){var s=r.state.getNestedState(r.state.id);s.setDynamicStructure(r.paramName.getText(),o.restrict(r.param)),t.nstate=s}t.state=t.nstate;var a=r.body.computeStructure(t,e,n);return t.state=i,a},e.prototype.toString=function(){return this.functorId.getText()+"( "+this.structureExpression+" )"},e}(o.Expression);e.FunctorApplication=w;var m=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.declaration=n,r.expression=i,r}return r(e,t),e.prototype.simplify=function(){return new e(this.position,this.declaration.simplify(),this.expression.simplify())},e.prototype.elaborate=function(t,e,n){var i=t.getNestedState(t.id);e.forEach(function(n,r){"*"===r[1]&&"*"===r[2]&&i.setStaticValue(r.substring(3),n[0].instantiate(t,e),p.IdentifierStatus.VALUE_VARIABLE)});var r=this.declaration.elaborate(i,e,n);n=r[3];var o=new Map;e.forEach(function(t,e){o=o.set(e,[t[0].instantiate(r[0],r[2]),t[1]])});var s=this.expression.elaborate(r[0],r[2],n);return[s[0],r[1].concat(s[1]),s[2],s[3]]},e.prototype.toString=function(){return"let "+this.declaration+" in "+this.expression+" end"},e.prototype.computeStructure=function(t,e,n){var i=t.state;if(void 0===t.ldseRes){if(void 0===t.recResult){var r=i.getNestedState(0).getNestedState(i.id);return e.push({next:n,params:t}),void e.push({next:this.declaration,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}t.ldseRes=t.recResult,t.recResult=void 0}var o=t.ldseRes;if(void 0===o||void 0===o.newState)throw new c.InternalInterpreterError(-1,"Anpan.");r=o.newState;if(o.hasThrown)return o.value;t.state=r;var s=this.expression.computeStructure(t,e,n);return t.state=i,s},e}(o.Expression);e.LocalDeclarationStructureExpression=m;var g=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.specification=n,i}return r(e,t),e.prototype.simplify=function(){return new e(this.position,this.specification.simplify())},e.prototype.elaborate=function(t,e,n){return this.specification.elaborate(t,e,n)},e.prototype.computeInterface=function(t){return this.specification.computeInterface(t)},e.prototype.toString=function(){return"sig "+this.specification+" end"},e}(o.Expression);e.SignatureExpression=g;var T=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.identifier=n,i}return r(e,t),e.prototype.simplify=function(){return this},e.prototype.elaborate=function(t,e,n){var i=void 0;if(this.identifier instanceof a.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.identifier);void 0!==r&&(i=r.getSignature(this.identifier.id.getText()))}else i=t.getStaticSignature(this.identifier.getText());if(void 0===i)throw new c.EvaluationError(this.position,'Undefined signature "'+this.identifier.getText()+'".');return[i,[],e,n]},e.prototype.computeInterface=function(t){var e=void 0;if(this.identifier instanceof a.LongIdentifierToken){var n=t.getAndResolveDynamicStructure(this.identifier);void 0!==n&&(e=n.getSignature(this.identifier.id.getText()))}else e=t.getDynamicSignature(this.identifier.getText());if(void 0===e)throw new c.EvaluationError(this.position,'Undefined signature "'+this.identifier.getText()+'".');return e},e.prototype.toString=function(){return this.identifier.getText()},e}(o.Expression);e.SignatureIdentifier=T;var E=function(t){function e(e,n,i,r,o){var s=t.call(this)||this;return s.position=e,s.signatureExpression=n,s.tyvarseq=i,s.name=r,s.type=o,s}return r(e,t),e.prototype.simplify=function(){return new e(this.position,this.signatureExpression.simplify(),this.tyvarseq,this.name,this.type.simplify())},e.prototype.elaborate=function(t,e,n){var i=this.signatureExpression.elaborate(t,e,n),r=t.getNestedState(0);r.staticBasis=i[0];var o=void 0,s=i[0],p=this.name.getText();if(this.name instanceof a.LongIdentifierToken?void 0!==(s=r.getAndResolveStaticStructure(this.name))&&(o=s.getType(this.name.id.getText()),p=this.name.id.getText()):o=r.getStaticType(this.name.getText()),void 0===o||void 0===s)throw new c.ElaborationError(this.position,'Undefined type "'+this.name.getText()+'".');return s.setType(p,new u.FunctionType(o.type,this.type),[],this.tyvarseq.length,o.allowsEquality),i},e.prototype.computeInterface=function(t){return this.signatureExpression.computeInterface(t)},e.prototype.toString=function(){return this.signatureExpression+" where type <stuff> "+this.name.getText()+" = "+this.type},e}(o.Expression);e.TypeRealisation=E;var x=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.structureBinding=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n,i){for(var r=[],o=0;o<this.structureBinding.length;++o){var s=this.structureBinding[o].elaborate(t,e,n);t=s[0],r=r.concat(s[1]),e=s[2],n=s[3]}return[t,r,e,n]},e.prototype.evaluate=function(t,e){void 0===t.whichBind&&(t.whichBind=0);var n=t.whichBind,i=this.structureBinding[n].evaluate(t,e,this);if(void 0!==i){if(i.hasThrown)return i;if(t.state=i.newState,t.whichBind=t.whichBind+1,t.recResult=void 0,t.whichBind===this.structureBinding.length)return{newState:t.state,value:void 0,hasThrown:!1};e.push({next:this,params:t})}},e.prototype.simplify=function(){for(var t=[],n=0;n<this.structureBinding.length;++n)t.push(this.structureBinding[n].simplify());return new e(this.position,t)},e.prototype.toString=function(){for(var t="structure",e=0;e<this.structureBinding.length;++e)t+=" "+this.structureBinding[e];return t+";"},e}(s.Declaration);e.StructureDeclaration=x;var S=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.signatureBinding=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){void 0===e&&(e=new Map),void 0===n&&(n="'*t0");for(var i=[],r=0;r<this.signatureBinding.length;++r){var o=this.signatureBinding[r].elaborate(t,e,n);t=o[0],i=i.concat(o[1]),e=o[2],n=o[3]}return[t,i,e,n]},e.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.signatureBinding.length;++i)n=this.signatureBinding[i].evaluate(n);return{newState:n,value:void 0,hasThrown:!1}},e.prototype.simplify=function(){for(var t=[],n=0;n<this.signatureBinding.length;++n)t.push(this.signatureBinding[n].simplify());return new e(this.position,t)},e.prototype.toString=function(){for(var t="structure",e=0;e<this.signatureBinding.length;++e)t+=" "+this.signatureBinding[e];return t+";"},e}(s.Declaration);e.SignatureDeclaration=S;var I=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.functorBinding=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){var i;void 0===e&&(e=new Map),void 0===n&&(n="'*t0");for(var r=[],o=0;o<this.functorBinding.length;++o){var s;t=(i=this.functorBinding[o].elaborate(t,e,n))[0],s=i[1],e=i[2],n=i[3],r=r.concat(s)}return[t,r,e,n]},e.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.functorBinding.length;++i)n=this.functorBinding[i].evaluate(n);return{newState:n,value:void 0,hasThrown:!1}},e.prototype.simplify=function(){for(var t=[],n=0;n<this.functorBinding.length;++n)t.push(this.functorBinding[n].simplify());return new e(this.position,t)},e.prototype.toString=function(){for(var t="functor",e=0;e<this.functorBinding.length;++e)t+=" "+this.functorBinding[e];return t+";"},e}(s.Declaration);e.FunctorDeclaration=I;var k=function(){function t(t,e,n){this.position=t,this.name=e,this.binding=n}return t.prototype.simplify=function(){return new t(this.position,this.name,this.binding.simplify())},t.prototype.elaborate=function(t,e,n){var i=this.binding.elaborate(t,e,n);return t.setStaticStructure(this.name.getText(),i[0]),[t,i[1],i[2],i[3]]},t.prototype.evaluate=function(t,e,n){var i=this.binding.computeStructure(t,e,n);if(void 0!==i){var r=t.state;return i instanceof h.Value?{newState:r,value:i,hasThrown:!0}:(r.setDynamicStructure(this.name.getText(),i),{newState:r,value:void 0,hasThrown:!1})}},t.prototype.toString=function(){return this.name.getText()+" = "+this.binding},t}();e.StructureBinding=k;var V=function(){function t(t,e,n){this.position=t,this.name=e,this.binding=n}return t.prototype.simplify=function(){return new t(this.position,this.name,this.binding.simplify())},t.prototype.elaborate=function(t,e,n){var i=this.binding.elaborate(t,e,n);return t.setStaticSignature(this.name.getText(),i[0]),[t,i[1],i[2],i[3]]},t.prototype.evaluate=function(t){return t.setDynamicSignature(this.name.getText(),this.binding.computeInterface(t)),t},t.prototype.toString=function(){return this.name.getText()+" = "+this.binding},t}();e.SignatureBinding=V;var b=function(){function t(t,e,n,i,r){this.position=t,this.name=e,this.signatureName=n,this.signatureBinding=i,this.binding=r}return t.prototype.simplify=function(){return new t(this.position,this.name,this.signatureName,this.signatureBinding.simplify(),this.binding.simplify())},t.prototype.elaborate=function(t,e,n){void 0===e&&(e=new Map),void 0===n&&(n="'*t0");var i=this.signatureBinding.elaborate(t,e,n),r=t.getNestedState(t.id);r.setStaticStructure(this.signatureName.getText(),i[0]);var o=this.binding.elaborate(r,i[2],i[3]);return t.setStaticFunctor(this.name.getText(),[i[0],o[0]]),[t,i[1].concat(o[1]),o[2],o[3]]},t.prototype.evaluate=function(t){var e=this.signatureBinding.computeInterface(t),n=f.getInitialState().getNestedState(t.id);return n.dynamicBasis=t.getDynamicChanges(-1),t.setDynamicFunctor(this.name.getText(),new p.DynamicFunctorInformation(this.signatureName,e,this.binding,n)),t},t.prototype.toString=function(){return this.name.getText()+"( "+this.signatureName+" : "+this.signatureBinding+" ) = "+this.binding},t}();e.FunctorBinding=b;var A=function(){function t(){}return t.prototype.simplify=function(){return this},t}();e.Specification=A;var L=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.valueDescription=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=function(n){var r=o.valueDescription[n][1].simplify().instantiate(t,e);r.getTypeVariables().forEach(function(t,e){r=new u.TypeVariableBind(e,r,t)}),i.setValue(o.valueDescription[n][0].getText(),r,p.IdentifierStatus.VALUE_VARIABLE)},o=this,s=0;s<this.valueDescription.length;++s)r(s);return[i,[],e,n]},e.prototype.computeInterface=function(t){for(var e={},n=0;n<this.valueDescription.length;++n)e[this.valueDescription[n][0].getText()]=p.IdentifierStatus.VALUE_VARIABLE;return new p.DynamicInterface({},e,{})},e}(A);e.ValueSpecification=L;var B=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.typeDescription=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=0;r<this.typeDescription.length;++r)i.setType(this.typeDescription[r][1].getText(),new u.CustomType(this.typeDescription[r][1].getText(),this.typeDescription[r][0]),[],this.typeDescription[r][0].length,!1);return[i,[],e,n]},e.prototype.computeInterface=function(t){for(var e={},n=0;n<this.typeDescription.length;++n)e[this.typeDescription[n][1].getText()]=[];return new p.DynamicInterface(e,{},{})},e}(A);e.TypeSpecification=B;var R=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.typeDescription=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=0;r<this.typeDescription.length;++r)i.setType(this.typeDescription[r][1].getText(),new u.CustomType(this.typeDescription[r][1].getText(),this.typeDescription[r][0]),[],this.typeDescription[r][0].length,!0);return[i,[],e,n]},e.prototype.computeInterface=function(t){for(var e={},n=0;n<this.typeDescription.length;++n)e[this.typeDescription[n][1].getText()]=[];return new p.DynamicInterface(e,{},{})},e}(A);e.EqualityTypeSpecification=R;var C=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.datatypeDescription=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=0;r<this.datatypeDescription.length;++r){for(var o=[],s=new u.CustomType(this.datatypeDescription[r][1].getText(),this.datatypeDescription[r][0]),a=function(t){if(o.push(c.datatypeDescription[r][2][t][0].getText()),void 0===c.datatypeDescription[r][2][t][1]){var e=s;e.getTypeVariables().forEach(function(t,n){e=new u.TypeVariableBind(n,e,t)}),i.setValue(c.datatypeDescription[r][2][t][0].getText(),e,p.IdentifierStatus.VALUE_CONSTRUCTOR)}else{var n=new u.FunctionType(c.datatypeDescription[r][2][t][1],s);n.getTypeVariables().forEach(function(t,e){n=new u.TypeVariableBind(e,n,t)}),i.setValue(c.datatypeDescription[r][2][t][0].getText(),n,p.IdentifierStatus.VALUE_CONSTRUCTOR)}},c=this,h=0;h<this.datatypeDescription[r][2].length;++h)a(h);i.setType(this.datatypeDescription[r][1].getText(),s,o,this.datatypeDescription[r][0].length,!0)}return[i,[],e,n]},e.prototype.computeInterface=function(t){for(var e={},n={},i=0;i<this.datatypeDescription.length;++i){for(var r=[],o=0;o<this.datatypeDescription[i][2].length;++o)e[this.datatypeDescription[i][2][o][0].getText()]=p.IdentifierStatus.VALUE_CONSTRUCTOR,r.push(this.datatypeDescription[i][2][o][0].getText());n[this.datatypeDescription[i][1].getText()]=r}return new p.DynamicInterface(n,e,{})},e.prototype.simplify=function(){for(var t=[],n=0;n<this.datatypeDescription.length;++n){for(var i=[],r=0;r<this.datatypeDescription[n][2].length;++r)void 0===this.datatypeDescription[n][2][r][1]?i.push(this.datatypeDescription[n][2][r]):i.push([this.datatypeDescription[n][2][r][0],this.datatypeDescription[n][2][r][1].simplify()]);t.push([this.datatypeDescription[n][0],this.datatypeDescription[n][1],i])}return new e(this.position,t)},e}(A);e.DatatypeSpecification=C;var O=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.name=n,r.oldname=i,r}return r(e,t),e.prototype.elaborate=function(t,e,n){var i=void 0;if(this.oldname instanceof a.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.oldname);void 0!==r&&(i=r.getType(this.oldname.id.getText()))}else i=t.getStaticType(this.oldname.getText());if(void 0===i)throw new c.ElaborationError(this.position,'The datatype "'+this.oldname.getText()+"\" doesn't exist.");var o=i.type.instantiate(t,e),s=new p.StaticBasis({},{},{},{},{});return s.setType(this.name.getText(),new u.FunctionType(new u.CustomType(this.name.getText(),o.typeArguments,0,this.oldname instanceof a.LongIdentifierToken?this.oldname:void 0),o),[],i.arity,i.allowsEquality),[s,[],e,n]},e.prototype.computeInterface=function(t){var e=void 0;if(this.oldname instanceof a.LongIdentifierToken){var n=t.getAndResolveDynamicStructure(this.oldname);void 0!==n&&(e=n.getType(this.oldname.id.getText()))}else e=t.getDynamicType(this.oldname.getText());if(void 0===e)throw new c.EvaluationError(this.position,'The datatype "'+this.oldname.getText()+'" does not exist.');for(var i={},r=0;r<e.length;++r)i[e[r]]=p.IdentifierStatus.VALUE_CONSTRUCTOR;var o={};return o[this.name.getText()]=e,new p.DynamicInterface(o,i,{})},e}(A);e.DatatypeReplicationSpecification=O;var _=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.exceptionDescription=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=function(e){if(void 0!==o.exceptionDescription[e][1]){var n=o.exceptionDescription[e][1].simplify().instantiate(t,new Map),r=[];if(n.getTypeVariables().forEach(function(t,e){r.push(e)}),r.length>0)throw c.ElaborationError.getUnguarded(o.position,r);i.setValue(o.exceptionDescription[e][0].getText(),new u.FunctionType(n,new u.CustomType("exn")).normalize()[0],p.IdentifierStatus.EXCEPTION_CONSTRUCTOR)}else i.setValue(o.exceptionDescription[e][0].getText(),new u.CustomType("exn").normalize()[0],p.IdentifierStatus.EXCEPTION_CONSTRUCTOR)},o=this,s=0;s<this.exceptionDescription.length;++s)r(s);return[i,[],e,n]},e.prototype.computeInterface=function(t){for(var e={},n=0;n<this.exceptionDescription.length;++n)e[this.exceptionDescription[n][0].getText()]=p.IdentifierStatus.EXCEPTION_CONSTRUCTOR;return new p.DynamicInterface({},e,{})},e.prototype.simplify=function(){for(var t=[],n=0;n<this.exceptionDescription.length;++n)void 0===this.exceptionDescription[n][1]?t.push(this.exceptionDescription[n]):t.push([this.exceptionDescription[n][0],this.exceptionDescription[n][1].simplify()]);return new e(this.position,t)},e}(A);e.ExceptionSpecification=_;var N=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.structureDescription=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=[],o=e,s=n,a=0;a<this.structureDescription.length;++a){var u=this.structureDescription[a][1].elaborate(t,o,s);r.concat(u[1]),o=u[2],s=u[3],i.setStructure(this.structureDescription[a][0].getText(),u[0])}return[i,r,o,s]},e.prototype.computeInterface=function(t){for(var e={},n=0;n<this.structureDescription.length;++n)e[this.structureDescription[n][0].getText()]=this.structureDescription[n][1].computeInterface(t);return new p.DynamicInterface({},{},e)},e.prototype.simplify=function(){for(var t=[],n=0;n<this.structureDescription.length;++n)t.push([this.structureDescription[n][0],this.structureDescription[n][1].simplify()]);return new e(this.position,t)},e}(A);e.StructureSpecification=N;var q=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=[],o=0;o<this.expression.length;++o){var s=this.expression[o].elaborate(t,e,n);i=i.extend(s[0]),r=r.concat(s[1]),e=s[2],n=s[3]}return[i,r,e,n]},e.prototype.computeInterface=function(t){for(var e=new p.DynamicInterface({},{},{}),n=0;n<this.expression.length;++n)e=e.extend(this.expression[n].computeInterface(t));return e},e.prototype.simplify=function(){for(var t=[],n=0;n<this.expression.length;++n)t.push(this.expression[n].simplify());return new e(this.position,t)},e}(A);e.IncludeSpecification=q;var U=function(t){function e(e){var n=t.call(this)||this;return n.position=e,n}return r(e,t),e.prototype.elaborate=function(t,e,n){return[new p.StaticBasis({},{},{},{},{}),[],e,n]},e.prototype.computeInterface=function(t){return new p.DynamicInterface({},{},{})},e}(A);e.EmptySpecification=U;var P=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.specifications=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){for(var i=new p.StaticBasis({},{},{},{},{}),r=[],o=t,s=0;s<this.specifications.length;++s){var a=this.specifications[s].elaborate(o,e,n);i=i.extend(a[0]),r=r.concat(a[1]),e=a[2],n=a[3],(o=o.getNestedState(o.id)).staticBasis=a[0]}return[i,r,e,n]},e.prototype.computeInterface=function(t){for(var e=new p.DynamicInterface({},{},{}),n=0;n<this.specifications.length;++n)e=e.extend(this.specifications[n].computeInterface(t));return e},e.prototype.simplify=function(){for(var t=[],n=0;n<this.specifications.length;++n)t.push(this.specifications[n].simplify());return new e(this.position,t)},e}(A);e.SequentialSpecification=P;var D=function(t){function e(e,n,i){var r=t.call(this)||this;return r.position=e,r.specification=n,r.typeNames=i,r}return r(e,t),e.prototype.elaborate=function(t,e,n){var i=this.specification.elaborate(t,e,n),r=t.getNestedState(0);r.staticBasis=i[0];for(var o=[],s=[],p=[],h=!1,f=0;f<this.typeNames.length;++f){var l=void 0,d=i[0],y=this.typeNames[f].getText();if(this.typeNames[f]instanceof a.LongIdentifierToken?void 0!==(d=r.getAndResolveStaticStructure(this.typeNames[f]))&&(l=d.getType(this.typeNames[f].id.getText()),y=this.typeNames[f].id.getText()):l=r.getStaticType(this.typeNames[f].getText()),void 0===l||void 0===d)throw new c.ElaborationError(this.position,'Undefined type "'+this.typeNames[f].getText()+'".');h=h||l.allowsEquality,o.push(l),s.push(d),p.push(y)}for(f=1;f<this.typeNames.length;++f)s[f].setType(p[f],new u.FunctionType(o[f].type,o[0].type),[],0,h);return i},e.prototype.computeInterface=function(t){return this.specification.computeInterface(t)},e}(A);e.SharingSpecification=D;var F=function(t){function e(e,n){var i=t.call(this)||this;return i.position=e,i.alias=n,i}return r(e,t),e.prototype.elaborate=function(t,e,n){throw new c.InternalInterpreterError(this.position,"And you don't seem to understand…")},e.prototype.computeInterface=function(t){throw new c.InternalInterpreterError(this.position,"Being an interpreter is suffering.")},e.prototype.simplify=function(){for(var t=[],e=0;e<this.alias.length;++e)t.push([this.alias[e][0],this.alias[e][1]]);var n=new g(-1,new B(-1,t));for(e=0;e<this.alias.length;++e)n=new E(-1,n,this.alias[e][0],this.alias[e][1],this.alias[e][2]);return new q(-1,[n]).simplify()},e}(A);e.TypeAliasSpecification=F},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=n(5),r=n(0);e.evaluate=function(t,e){var n=t.getNestedState(),o=[];o.push({next:e,params:{state:t,modifiable:n,recResult:void 0}});for(var s=void 0;o.length>0;){var a=o.pop();if(void 0===a)throw new r.InternalInterpreterError(-1,"How is this undefined?");var u=a.next,p=a.params;p.recResult=s,s=u instanceof i.Declaration?u.evaluate(p,o):u.compute(p,o)}if(void 0!==s){var c=s.newState;if(void 0!==c){c.setWarnings(n.getWarnings());for(var h=0,f=n.getMemoryChanges(t.id);h<f.length;h++){var l=f[h];c.setCell(l[0],l[1])}var d=n.getIdChanges(t.id);for(var y in d)d.hasOwnProperty(y)&&c.setValueIdentifierId(y,d[y]);c.exceptionEvalId=n.exceptionEvalId}}return s}}]);