/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = "./src/worker.ts");
/******/ })
/************************************************************************/
/******/ ({

/***/ "./node_modules/@sosml/interpreter/build/interpreter.min.js":
/*!******************************************************************!*\
  !*** ./node_modules/@sosml/interpreter/build/interpreter.min.js ***!
  \******************************************************************/
/*! no static exports found */
/***/ (function(module, exports) {

eval("module.exports=function(t){function __webpack_require__(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,__webpack_require__),i.l=!0,i.exports}var e={};return __webpack_require__.m=t,__webpack_require__.c=e,__webpack_require__.i=function(t){return t},__webpack_require__.d=function(exports,t,e){__webpack_require__.o(exports,t)||Object.defineProperty(exports,t,{configurable:!1,enumerable:!0,get:e})},__webpack_require__.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return __webpack_require__.d(e,\"a\",e),e},__webpack_require__.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},__webpack_require__.p=\"\",__webpack_require__(__webpack_require__.s=10)}([function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=function(t){function InterpreterError(e,n,i){var r=t.call(this,n)||this;return r.position=e,r.message=n,r.name=i,Object.setPrototypeOf(r,InterpreterError.prototype),r}return n(InterpreterError,t),InterpreterError.prototype.toString=function(){return this.name+\": \"+this.message},InterpreterError}(Error);exports.InterpreterError=i;var r=function(t){function InternalInterpreterError(e,n){void 0===n&&(n=\"internal compiler error\");var i=t.call(this,e,n,\"You triggered Third Impact\")||this;return Object.setPrototypeOf(i,InternalInterpreterError.prototype),i}return n(InternalInterpreterError,t),InternalInterpreterError}(i);exports.InternalInterpreterError=r;var o=function(t){function FeatureNotImplementedError(e,n){var i=t.call(this,e,n,\"Feature Not Implemented\")||this;return Object.setPrototypeOf(i,FeatureNotImplementedError.prototype),i}return n(FeatureNotImplementedError,t),FeatureNotImplementedError}(i);exports.FeatureNotImplementedError=o;var a=function(t){function FeatureDisabledError(e,n){var i=t.call(this,e,n,\"Have you ever tried doing something you were not supposed to? Basically that\")||this;return Object.setPrototypeOf(i,FeatureDisabledError.prototype),i}return n(FeatureDisabledError,t),FeatureDisabledError}(i);exports.FeatureDisabledError=a;var s=function(t){function IncompleteError(e,n){void 0===n&&(n=\"unexpected end of input\");var i=t.call(this,e,n,\"Input Incomplete\")||this;return Object.setPrototypeOf(i,IncompleteError.prototype),i}return n(IncompleteError,t),IncompleteError}(i);exports.IncompleteError=s;var u=function(t){function LexerError(e,n){var i=t.call(this,e,n,\"Lexing failed\")||this;return Object.setPrototypeOf(i,LexerError.prototype),i}return n(LexerError,t),LexerError}(i);exports.LexerError=u;var p=function(t){function ParserError(e,n){var i=t.call(this,n,e,\"Parsing failed\")||this;return Object.setPrototypeOf(i,ParserError.prototype),i}return n(ParserError,t),ParserError}(i);exports.ParserError=p;var c=function(t){function ElaborationError(e,n){var i=t.call(this,e,n,\"Elaboration failed\")||this;return Object.setPrototypeOf(i,ElaborationError.prototype),i}return n(ElaborationError,t),ElaborationError.getUnguarded=function(t,e){var n=\"\";e.length>1&&(n+=\"s\"),n+=\" \";for(var i=0;i<e.length;++i)i>0&&(n+=\", \"),n+='\"'+e[i]+'\"';return new ElaborationError(t,\"Unguarded type variable\"+n+\".\")},ElaborationError}(i);exports.ElaborationError=c;var h=function(t){function EvaluationError(e,n){var i=t.call(this,e,n,\"Evaluation failed\")||this;return Object.setPrototypeOf(i,EvaluationError.prototype),i}return n(EvaluationError,t),EvaluationError}(i);exports.EvaluationError=h;var l=function(t){function Warning(e,n){var i=t.call(this,e,n,\"Warning\")||this;return Object.setPrototypeOf(i,Warning.prototype),i}return n(Warning,t),Warning}(i);exports.Warning=l},function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=function(){function KeywordToken(t,e){this.text=t,this.position=e}return KeywordToken.prototype.getText=function(){return this.text},KeywordToken.prototype.isValidRecordLabel=function(){return!1},KeywordToken.prototype.isVid=function(){return!1},KeywordToken}();exports.KeywordToken=i;var r=function(){function ConstantToken(){}return ConstantToken.prototype.isVid=function(){return!1},ConstantToken}();exports.ConstantToken=r;var o=function(t){function IntegerConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(IntegerConstantToken,t),IntegerConstantToken.prototype.getText=function(){return\"\"+this.value},IntegerConstantToken.prototype.isValidRecordLabel=function(){return!1},IntegerConstantToken}(r);exports.IntegerConstantToken=o;var a=function(t){function RealConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(RealConstantToken,t),RealConstantToken.prototype.getText=function(){return this.text},RealConstantToken.prototype.isValidRecordLabel=function(){return!1},RealConstantToken}(r);exports.RealConstantToken=a;var s=function(t){function WordConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(WordConstantToken,t),WordConstantToken.prototype.getText=function(){return\"\"+this.value},WordConstantToken.prototype.isValidRecordLabel=function(){return!1},WordConstantToken}(r);exports.WordConstantToken=s;var u=function(t){function CharacterConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(CharacterConstantToken,t),CharacterConstantToken.prototype.getText=function(){return\"\"+this.text},CharacterConstantToken.prototype.isValidRecordLabel=function(){return!1},CharacterConstantToken}(r);exports.CharacterConstantToken=u;var p=function(t){function StringConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(StringConstantToken,t),StringConstantToken.prototype.getText=function(){return\"\"+this.text},StringConstantToken.prototype.isValidRecordLabel=function(){return!1},StringConstantToken}(r);exports.StringConstantToken=p;var c=function(){function IdentifierToken(t,e){this.text=t,this.position=e,this.opPrefixed=!1}return IdentifierToken.prototype.getText=function(){return this.text},IdentifierToken.prototype.isValidRecordLabel=function(){return!0},IdentifierToken.prototype.isVid=function(){return!0},IdentifierToken}();exports.IdentifierToken=c;var h=function(t){function AlphanumericIdentifierToken(e,n){return t.call(this,e,n)||this}return n(AlphanumericIdentifierToken,t),AlphanumericIdentifierToken.prototype.getText=function(){return this.text},AlphanumericIdentifierToken.prototype.isValidRecordLabel=function(){return!0},AlphanumericIdentifierToken}(c);exports.AlphanumericIdentifierToken=h;var l=function(){function TypeVariableToken(t,e){this.text=t,this.position=e}return TypeVariableToken.prototype.getText=function(){return this.text},TypeVariableToken.prototype.isValidRecordLabel=function(){return!1},TypeVariableToken.prototype.isVid=function(){return!1},TypeVariableToken}();exports.TypeVariableToken=l;var f=function(t){function EqualityTypeVariableToken(e,n){return t.call(this,e,n)||this}return n(EqualityTypeVariableToken,t),EqualityTypeVariableToken.prototype.getText=function(){return this.text},EqualityTypeVariableToken.prototype.isValidRecordLabel=function(){return!1},EqualityTypeVariableToken.prototype.isVid=function(){return!1},EqualityTypeVariableToken}(l);exports.EqualityTypeVariableToken=f;var d=function(t){function StarToken(e){var n=t.call(this,\"*\",e)||this;return n.position=e,n.opPrefixed=!1,n}return n(StarToken,t),StarToken.prototype.getText=function(){return this.text},StarToken.prototype.isValidRecordLabel=function(){return!0},StarToken.prototype.isVid=function(){return!0},StarToken}(i);exports.StarToken=d;var y=function(t){function EqualsToken(e){var n=t.call(this,\"=\",e)||this;return n.position=e,n}return n(EqualsToken,t),EqualsToken.prototype.getText=function(){return this.text},EqualsToken.prototype.isValidRecordLabel=function(){return!1},EqualsToken.prototype.isVid=function(){return!0},EqualsToken}(i);exports.EqualsToken=y;var v=function(t){function NumericToken(e,n,i){return t.call(this,e,n,i)||this}return n(NumericToken,t),NumericToken.prototype.getText=function(){return this.text},NumericToken.prototype.isValidRecordLabel=function(){return!0},NumericToken.prototype.isVid=function(){return!1},NumericToken}(o);exports.NumericToken=v;var m=function(){function LongIdentifierToken(t,e,n,i){this.text=t,this.position=e,this.qualifiers=n,this.id=i,this.opPrefixed=!1}return LongIdentifierToken.prototype.getText=function(){for(var t=\"\",e=0;e<this.qualifiers.length;++e)e>0&&(t+=\".\"),t+=this.qualifiers[e].getText();return t+\".\"+this.id.getText()},LongIdentifierToken.prototype.isValidRecordLabel=function(){return!1},LongIdentifierToken.prototype.isVid=function(){return!1},LongIdentifierToken}();exports.LongIdentifierToken=m},function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=e(3),r=e(0),o=e(1);exports.MAXINT=1073741823,exports.MININT=-1073741824;var a=function(){function PrintCounter(t){this.charactersLeft=t}return PrintCounter}();exports.PrintCounter=a;var s=function(){function Value(){}return Value.prototype.toString=function(t,e){return void 0===e&&(e=120),this.pcToString(t,new a(e))},Value.prototype.equals=function(t){throw new r.InternalInterpreterError(-1,\"Tried comparing incomparable things.\")},Value}();exports.Value=s;var u=function(t){function ReferenceValue(e){var n=t.call(this)||this;return n.address=e,n}return n(ReferenceValue,t),ReferenceValue.prototype.equals=function(t){return this.address===t.address},ReferenceValue.prototype.pcToString=function(t,e){if(void 0===t){var n=\"$\"+this.address;return e.charactersLeft-=n.length,n}if(void 0!==t.getCell(this.address))return e.charactersLeft-=4,\"ref \"+t.getCell(this.address).pcToString(t,e);throw new r.EvaluationError(-1,'Ouch, you may not de-reference \"$'+this.address+'\".')},ReferenceValue}(s);exports.ReferenceValue=u;var p=function(t){function VectorValue(e){void 0===e&&(e=[]);var n=t.call(this)||this;return n.entries=e,n}return n(VectorValue,t),VectorValue.prototype.equals=function(t){if(this.entries.length!==t.entries.length)return!1;for(var e=0;e<this.entries.length;++e)if(!this.entries[e].equals(t.entries[e]))return!1;return!0},VectorValue.prototype.pcToString=function(t,e){var n=\"#[\";e.charactersLeft-=3;for(var i=0;i<this.entries.length;++i){if(i>0&&(n+=\", \",e.charactersLeft-=2),!(e.charactersLeft>0)){n+=\"…\";break}var r=0;i<this.entries.length&&(r=Math.floor(e.charactersLeft/2)),e.charactersLeft-=r,n+=this.entries[i].pcToString(t,e),e.charactersLeft+=r}return n+=\"]\"},VectorValue}(s);exports.VectorValue=p;var c=function(t){function ArrayValue(e,n){var i=t.call(this)||this;return i.address=e,i.length=n,i}return n(ArrayValue,t),ArrayValue.prototype.equals=function(t){return this.address===t.address},ArrayValue.prototype.pcToString=function(t,e){if(void 0===t){var n=\"[|$\"+this.address+\"...$\"+(this.address+this.length-1)+\"|]\";return e.charactersLeft-=n.length,n}var i=\"[|\";e.charactersLeft-=4;for(var o=0;o<this.length;++o){if(o>0&&(i+=\", \",e.charactersLeft-=2),!(e.charactersLeft>0)){i+=\"…\";break}if(void 0===t.getCell(this.address+o))throw new r.EvaluationError(-1,'Ouch, you may not de-reference \"$'+(this.address+o)+'\".');var a=0;o<this.length&&(a=Math.floor(e.charactersLeft/2)),e.charactersLeft-=a,i+=t.getCell(this.address+o).pcToString(t,e),e.charactersLeft+=a}return i+=\"|]\"},ArrayValue}(s);exports.ArrayValue=c;var h=function(t){function BoolValue(e){var n=t.call(this)||this;return n.value=e,n}return n(BoolValue,t),BoolValue.prototype.equals=function(t){return this.value===t.value},BoolValue.prototype.pcToString=function(t,e){return this.value?(e.charactersLeft-=4,\"true\"):(e.charactersLeft-=5,\"false\")},BoolValue}(s);exports.BoolValue=h;var l=function(t){function CharValue(e){var n=t.call(this)||this;return n.value=e,n}return n(CharValue,t),CharValue.prototype.pcToString=function(t,e){return e.charactersLeft-=1,\"#\"+new f(this.value).pcToString(t,e)},CharValue.prototype.compareTo=function(t){return this.value<t.value?-1:this.value>t.value?1:0},CharValue.prototype.equals=function(t){return this.value===t.value},CharValue}(s);exports.CharValue=l;var f=function(t){function StringValue(e){var n=t.call(this)||this;return n.value=e,n}return n(StringValue,t),StringValue.implode=function(t){for(var e=\"\";\"nil\"!==t.constructorName;){if(\"::\"!==t.constructorName)throw new r.InternalInterpreterError(-1,\"Is this a char list? I can't implode \\\"\"+t.constructorName+'\".');var n=t.argument;if(!(n instanceof m))throw new r.InternalInterpreterError(-1,\"Is this a char list? I can't implode \\\"\"+t.constructorName+'\".');var i=n.getValue(\"1\"),o=n.getValue(\"2\");if(!(i instanceof l&&o instanceof w))throw new r.InternalInterpreterError(-1,\"Is this a char list? I can't implode \\\"\"+t.constructorName+'\".');e+=i.value,t=o}return new StringValue(e)},StringValue.prototype.pcToString=function(t,e){var n=\"\";e.charactersLeft-=2;for(var i=0,r=this.value;i<r.length;i++){var o=r[i];if(e.charactersLeft<0){n+=\"…\";break}switch(e.charactersLeft-=1,o){case\"\\n\":n+=\"\\\\n\";break;case\"\\t\":n+=\"\\\\t\";break;case\"\\r\":n+=\"\\\\r\";break;case\"\u0007\":n+=\"\\\\a\";break;case\"\\b\":n+=\"\\\\b\";break;case\"\\v\":n+=\"\\\\v\";break;case\"\\f\":n+=\"\\\\f\";break;case\"\":n+=\"\\\\127\";break;case\"ÿ\":n+=\"\\\\255\";break;default:if(o.charCodeAt(0)<32){var a=\"\\\\^\"+String.fromCharCode(o.charCodeAt(0)+64);n+=a,e.charactersLeft-=a.length-1}else n+=o}}return'\"'+n+'\"'},StringValue.prototype.equals=function(t){return this.value===t.value},StringValue.prototype.compareTo=function(t){return this.value<t.value?-1:this.value>t.value?1:0},StringValue.prototype.concat=function(t){return new StringValue(this.value+t.value)},StringValue.prototype.explode=function(){for(var t=new w(\"nil\"),e=this.value.length-1;e>=0;--e)t=new w(\"::\",new m(new Map([[\"1\",new l(this.value[e])],[\"2\",t]])));return t},StringValue}(s);exports.StringValue=f;var d=function(t){function Word(e){var n=t.call(this)||this;return n.value=e,n}return n(Word,t),Word.prototype.pcToString=function(t,e){var n=\"\"+this.value;return e.charactersLeft-=n.length,n},Word.prototype.compareTo=function(t){if(t instanceof Word){var e=t.value;return this.value<e?-1:this.value>e?1:0}return 2},Word.prototype.negate=function(){return new Word(-this.value)},Word.prototype.equals=function(t){return 0===this.compareTo(t)},Word.prototype.add=function(t){return new Word(this.value+t.value)},Word.prototype.multiply=function(t){return new Word(this.value*t.value)},Word.prototype.divide=function(t){return new Word(Math.floor(this.value/t.value))},Word.prototype.modulo=function(t){return new Word(this.value%t.value)},Word.prototype.toReal=function(){return new v(this.value)},Word.prototype.hasOverflow=function(){return this.value>exports.MAXINT||this.value<exports.MININT},Word}(s);exports.Word=d;var y=function(t){function Integer(e){var n=t.call(this)||this;return n.value=e,n}return n(Integer,t),Integer.prototype.pcToString=function(t,e){var n=\"\"+this.value;return e.charactersLeft-=n.length,n.replace(/-/,\"~\")},Integer.prototype.compareTo=function(t){if(t instanceof Integer){var e=t.value;return this.value<e?-1:this.value>e?1:0}return!1},Integer.prototype.equals=function(t){return 0===this.compareTo(t)},Integer.prototype.negate=function(){return new Integer(-this.value)},Integer.prototype.add=function(t){return new Integer(this.value+t.value)},Integer.prototype.multiply=function(t){return new Integer(this.value*t.value)},Integer.prototype.divide=function(t){return new Integer(Math.floor(this.value/t.value))},Integer.prototype.modulo=function(t){return new Integer(this.value-Math.floor(this.value/t.value)*t.value)},Integer.prototype.toReal=function(){return new v(this.value)},Integer.prototype.hasOverflow=function(){return this.value>exports.MAXINT||this.value<exports.MININT},Integer}(s);exports.Integer=y;var v=function(t){function Real(e){var n=t.call(this)||this;return n.value=e,n}return n(Real,t),Real.prototype.pcToString=function(t,e){var n=\"\"+this.value;return-1===n.search(/\\./)&&(n+=\".0\"),e.charactersLeft-=n.length,n.replace(/-/,\"~\")},Real.prototype.compareTo=function(t){if(t instanceof Real){var e=t.value;return this.value<e?-1:this.value>e?1:0}return!1},Real.prototype.equals=function(t){return 0===this.compareTo(t)},Real.prototype.negate=function(){return new Real(-this.value)},Real.prototype.add=function(t){return new Real(this.value+t.value)},Real.prototype.multiply=function(t){return new Real(this.value*t.value)},Real.prototype.divide=function(t){return new Real(this.value/t.value)},Real.prototype.toInteger=function(){return new y(Math.floor(this.value))},Real.prototype.hasOverflow=function(){return!1},Real}(s);exports.Real=v;var m=function(t){function RecordValue(e){void 0===e&&(e=new Map);var n=t.call(this)||this;return n.entries=e,n}return n(RecordValue,t),RecordValue.prototype.pcToString=function(t,e){for(var n=this,i=1!==this.entries.size,o=1;o<=this.entries.size;++o)this.entries.has(\"\"+o)||(i=!1);if(i){var a=\"(\";e.charactersLeft-=2;for(var o=1;o<=this.entries.size;++o){o>1&&(a+=\", \",e.charactersLeft-=2);var s=this.entries.get(\"\"+o);if(void 0===s)throw new r.InternalInterpreterError(-1,\"How did we loose this value? It was there before. I promise…\");if(!(e.charactersLeft>0)){a+=\"…\";break}var u=0;o<this.entries.size&&(u=Math.floor(e.charactersLeft/2)),e.charactersLeft-=u,a+=s.pcToString(t,e),e.charactersLeft+=u}return a+\")\"}var p=\"{\";e.charactersLeft-=2;var c=!0,h=!1,l=0;return this.entries.forEach(function(i,r){if(!h){if(c?c=!1:(p+=\", \",e.charactersLeft-=2),e.charactersLeft>0){var o=0;l<n.entries.size&&(o=Math.floor(e.charactersLeft/2)),e.charactersLeft-=o,p+=r+\" = \"+i.pcToString(t,e),e.charactersLeft+=o}else p+=\"…\",h=!0;++l}}),p+\"}\"},RecordValue.prototype.getValue=function(t){if(!this.entries.has(t))throw new r.EvaluationError(0,\"Tried accessing non-existing record part.\");return this.entries.get(t)},RecordValue.prototype.hasValue=function(t){return this.entries.has(t)},RecordValue.prototype.equals=function(t){var e=this;if(!(t instanceof RecordValue))return!1;var n=!1;return this.entries.forEach(function(e,i){t.entries.has(i)||(n=!0),e.equals(t.entries.get(i))||(n=!0)}),!n&&(t.entries.forEach(function(i,r){e.entries.has(r)||(n=!0),i.equals(t.entries.get(r))||(n=!0)}),!n)},RecordValue}(s);exports.RecordValue=m;var g=function(t){function FunctionValue(e,n,i){var r=t.call(this)||this;return r.state=e,r.recursives=n,r.body=i,r}return n(FunctionValue,t),FunctionValue.prototype.pcToString=function(t,e){return e.charactersLeft-=2,\"fn\"},FunctionValue.prototype.compute=function(t,e,n){for(var r=this.state.getNestedState(this.state.id),o=0;o<this.recursives.length;++o)this.recursives[o][1]instanceof FunctionValue?r.setDynamicValue(this.recursives[o][0],new FunctionValue(this.state,this.recursives,this.recursives[o][1].body),i.IdentifierStatus.VALUE_VARIABLE):r.setDynamicValue(this.recursives[o][0],this.recursives[o][1],i.IdentifierStatus.VALUE_VARIABLE);t.push({next:this.body,params:{state:r,recResult:void 0,modifiable:n,value:e}})},FunctionValue.prototype.equals=function(t){throw new r.InternalInterpreterError(-1,'You simply cannot compare \"'+this.pcToString(void 0,new a(20))+'\" and \"'+t.pcToString(void 0,new a(20))+'\".')},FunctionValue}(s);exports.FunctionValue=g;var w=function(t){function ConstructedValue(e,n,i){void 0===n&&(n=void 0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.argument=n,r.id=i,r}return n(ConstructedValue,t),ConstructedValue.prototype.pcToString=function(t,e){if(\"::\"===this.constructorName){var n=\"[\";e.charactersLeft-=2;for(var i=this;\"nil\"!==i.constructorName;){if(\"::\"!==i.constructorName)throw new r.InternalInterpreterError(-1,'Is this even a list? 1 \"'+i.constructorName+'\".');var a=i.argument;if(!(a instanceof m&&2===a.entries.size))throw new r.InternalInterpreterError(-1,'Is this even a list? 3 \"'+i.constructorName+'\".');var u=a.getValue(\"1\"),p=a.getValue(\"2\");if(!(u instanceof s&&p instanceof ConstructedValue))throw new r.InternalInterpreterError(-1,'Is this even a list? 2 \"'+i.constructorName+'\".');if(i!==this&&(n+=\", \",e.charactersLeft-=2),!(e.charactersLeft>0)){n+=\"…\";break}var c=0;\"nil\"!==p.constructorName&&(c=Math.floor(e.charactersLeft/2)),e.charactersLeft-=c,n+=u.pcToString(t,e),e.charactersLeft+=c,i=p}return n+\"]\"}if(\"nil\"===this.constructorName)return e.charactersLeft-=2,\"[]\";if(void 0!==t){var h=t.getInfixStatus(new o.IdentifierToken(this.constructorName,-1));if(void 0!==h&&h.infix&&this.argument instanceof m&&2===this.argument.entries.size){var l=this.argument.getValue(\"1\"),f=this.argument.getValue(\"2\");if(l instanceof s&&f instanceof s){e.charactersLeft-=4+this.constructorName.length;var c=Math.floor(e.charactersLeft/2);e.charactersLeft-=c;var n=\"(\";if(e.charactersLeft>0?n+=l.pcToString(t,e):n+=\"…\",e.charactersLeft+=c,n+=\" \"+this.constructorName,this.id>0){var d=\"/\"+this.id;n+=d,e.charactersLeft-=d.length}return e.charactersLeft>0?n+=\" \"+f.pcToString(t,e):n+=\" …\",n+\")\"}}}var y=\"\";if(y+=this.constructorName,e.charactersLeft-=this.constructorName.length+1,this.id>0){var d=\"/\"+this.id;y+=d,e.charactersLeft-=d.length}return this.argument&&(e.charactersLeft>0?(y+=\" \",this.argument instanceof ConstructedValue&&this.argument.argument?y+=\"(\":this.argument instanceof T&&this.argument.argument&&(y+=\"(\"),y+=this.argument.pcToString(t,e),this.argument instanceof ConstructedValue&&this.argument.argument?y+=\")\":this.argument instanceof T&&this.argument.argument&&(y+=\")\")):y+=\" …\"),y},ConstructedValue.prototype.equals=function(t){return t instanceof S&&(t=t.construct()),t instanceof ConstructedValue&&(this.constructorName===t.constructorName&&this.id===t.id&&(void 0!==this.argument?void 0===t.argument||this.argument.equals(t.argument):void 0===t.argument))},ConstructedValue}(s);exports.ConstructedValue=w;var T=function(t){function ExceptionValue(e,n,i,r){void 0===n&&(n=void 0),void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.constructorName=e,o.argument=n,o.id=i,o.evalId=r,o}return n(ExceptionValue,t),ExceptionValue.prototype.pcToString=function(t,e){var n=this.constructorName;if(e.charactersLeft-=this.constructorName.length+1,this.id>0){var i=\"/\"+this.id;n+=i,e.charactersLeft-=i.length}return this.argument&&(e.charactersLeft>0?n+=\" \"+this.argument.pcToString(t,e):n+=\" …\"),n},ExceptionValue.prototype.equals=function(t){return t instanceof x&&(t=t.construct()),t instanceof ExceptionValue&&(this.constructorName===t.constructorName&&this.id===t.id&&this.evalId===t.evalId&&(void 0!==this.argument?void 0===t.argument||this.argument.equals(t.argument):void 0===t.argument))},ExceptionValue}(s);exports.ExceptionValue=T;var E=function(t){function PredefinedFunction(e,n){var i=t.call(this)||this;return i.name=e,i.apply=n,i}return n(PredefinedFunction,t),PredefinedFunction.prototype.pcToString=function(t,e){return e.charactersLeft-=2,\"fn\"},PredefinedFunction.prototype.equals=function(t){return t instanceof PredefinedFunction&&this.name===t.name},PredefinedFunction}(s);exports.PredefinedFunction=E;var S=function(t){function ValueConstructor(e,n,i){void 0===n&&(n=0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.numArgs=n,r.id=i,r}return n(ValueConstructor,t),ValueConstructor.prototype.equals=function(t){return t instanceof ValueConstructor&&(this.constructorName===t.constructorName&&this.id===t.id)},ValueConstructor.prototype.construct=function(t){return void 0===t&&(t=void 0),new w(this.constructorName,t,this.id)},ValueConstructor.prototype.pcToString=function(t,e){var n=this.constructorName;if(e.charactersLeft-=this.constructorName.length,this.id>0){var i=\"/\"+this.id;n+=i,e.charactersLeft-=i.length}return n},ValueConstructor}(s);exports.ValueConstructor=S;var x=function(t){function ExceptionConstructor(e,n,i,r){void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.exceptionName=e,o.numArgs=n,o.id=i,o.evalId=r,o}return n(ExceptionConstructor,t),ExceptionConstructor.prototype.equals=function(t){return t instanceof ExceptionConstructor&&(this.exceptionName===t.exceptionName&&this.id===t.id&&this.evalId===t.evalId)},ExceptionConstructor.prototype.construct=function(t){return void 0===t&&(t=void 0),new T(this.exceptionName,t,this.id,this.evalId)},ExceptionConstructor.prototype.pcToString=function(t,e){var n=this.exceptionName;if(e.charactersLeft-=this.exceptionName.length,this.id>0){var i=\"/\"+this.id;n+=i,e.charactersLeft-=i.length}return n},ExceptionConstructor}(s);exports.ExceptionConstructor=x},function(t,exports,e){\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(2),i=e(1),r=e(0);!function(t){t[t.VALUE_VARIABLE=0]=\"VALUE_VARIABLE\",t[t.VALUE_CONSTRUCTOR=1]=\"VALUE_CONSTRUCTOR\",t[t.EXCEPTION_CONSTRUCTOR=2]=\"EXCEPTION_CONSTRUCTOR\"}(exports.IdentifierStatus||(exports.IdentifierStatus={}));var o=function(){function TypeInformation(t,e,n,i){void 0===i&&(i=!0),this.type=t,this.constructors=e,this.arity=n,this.allowsEquality=i}return TypeInformation.prototype.toString=function(){return\"TypeInformation(\"+this.type+\", [\"+this.constructors+\"], arity = \"+this.arity+\", allowsEquality = \"+this.allowsEquality+\")\"},TypeInformation}();exports.TypeInformation=o;var a=function(){function DynamicFunctorInformation(t,e,n,i){this.paramName=t,this.param=e,this.body=n,this.state=i}return DynamicFunctorInformation}();exports.DynamicFunctorInformation=a;var s=function(){function DynamicInterface(t,e,n){this.typeInterface=t,this.valueInterface=e,this.structureInterface=n}return DynamicInterface.prototype.extend=function(t){for(var e in t.typeInterface)t.typeInterface.hasOwnProperty(e)&&(this.typeInterface[e]=t.typeInterface[e]);for(var e in t.valueInterface)t.valueInterface.hasOwnProperty(e)&&(this.valueInterface[e]=t.valueInterface[e]);for(var e in t.structureInterface)t.structureInterface.hasOwnProperty(e)&&(this.structureInterface[e]=t.structureInterface[e]);return this},DynamicInterface}();exports.DynamicInterface=s;var u=function(){function InfixStatus(t,e,n){void 0===e&&(e=0),void 0===n&&(n=!1),this.infix=t,this.precedence=e,this.rightAssociative=n}return InfixStatus}();exports.InfixStatus=u;var p=function(){function DynamicBasis(t,e,n,i,r){this.typeEnvironment=t,this.valueEnvironment=e,this.structureEnvironment=n,this.signatureEnvironment=i,this.functorEnvironment=r}return DynamicBasis.prototype.getValue=function(t){if(this.valueEnvironment.hasOwnProperty(t))return this.valueEnvironment[t]},DynamicBasis.prototype.getType=function(t){if(this.typeEnvironment.hasOwnProperty(t))return this.typeEnvironment[t]},DynamicBasis.prototype.getStructure=function(t){if(this.structureEnvironment.hasOwnProperty(t))return this.structureEnvironment[t]},DynamicBasis.prototype.getSignature=function(t){if(this.signatureEnvironment.hasOwnProperty(t))return this.signatureEnvironment[t]},DynamicBasis.prototype.getFunctor=function(t){if(this.functorEnvironment.hasOwnProperty(t))return this.functorEnvironment[t]},DynamicBasis.prototype.setValue=function(t,e,n){this.valueEnvironment[t]=[e,n]},DynamicBasis.prototype.setType=function(t,e){this.typeEnvironment[t]=e},DynamicBasis.prototype.setStructure=function(t,e){this.structureEnvironment[t]=e},DynamicBasis.prototype.setSignature=function(t,e){this.signatureEnvironment[t]=e},DynamicBasis.prototype.setFunctor=function(t,e){this.functorEnvironment[t]=e},DynamicBasis.prototype.extend=function(t){for(var e in t.typeEnvironment)t.typeEnvironment.hasOwnProperty(e)&&(this.typeEnvironment[e]=t.typeEnvironment[e]);for(var e in t.valueEnvironment)t.valueEnvironment.hasOwnProperty(e)&&(this.valueEnvironment[e]=t.valueEnvironment[e]);for(var e in t.structureEnvironment)t.structureEnvironment.hasOwnProperty(e)&&(this.structureEnvironment[e]=t.structureEnvironment[e]);for(var e in t.signatureEnvironment)t.signatureEnvironment.hasOwnProperty(e)&&(this.signatureEnvironment[e]=t.signatureEnvironment[e]);for(var e in t.functorEnvironment)t.functorEnvironment.hasOwnProperty(e)&&(this.functorEnvironment[e]=t.functorEnvironment[e]);return this},DynamicBasis.prototype.restrict=function(t){var e=new DynamicBasis({},{},{},this.signatureEnvironment,this.functorEnvironment);for(var n in t.typeInterface)if(t.typeInterface.hasOwnProperty(n)&&this.typeEnvironment.hasOwnProperty(n)){for(var i=new Set,r=[],o=0;o<this.typeEnvironment[n].length;++o)i=i.add(this.typeEnvironment[n][o]);for(var o=0;o<t.typeInterface[n].length;++o)i.has(t.typeInterface[n][o])&&r.push(t.typeInterface[n][o]);e.typeEnvironment[n]=r}for(var n in t.valueInterface)t.valueInterface.hasOwnProperty(n)&&this.valueEnvironment.hasOwnProperty(n)&&(e.valueEnvironment[n]=[this.valueEnvironment[n][0],t.valueInterface[n]]);for(var n in t.structureInterface)t.structureInterface.hasOwnProperty(n)&&this.structureEnvironment.hasOwnProperty(n)&&(e.structureEnvironment[n]=this.structureEnvironment[n].restrict(t.structureInterface[n]));return e},DynamicBasis}();exports.DynamicBasis=p;var c=function(){function StaticBasis(t,e,n,i,r){this.typeEnvironment=t,this.valueEnvironment=e,this.structureEnvironment=n,this.signatureEnvironment=i,this.functorEnvironment=r}return StaticBasis.prototype.getValue=function(t){if(this.valueEnvironment.hasOwnProperty(t))return this.valueEnvironment[t]},StaticBasis.prototype.getType=function(t){if(this.typeEnvironment.hasOwnProperty(t))return this.typeEnvironment[t]},StaticBasis.prototype.getStructure=function(t){if(this.structureEnvironment.hasOwnProperty(t))return this.structureEnvironment[t]},StaticBasis.prototype.getSignature=function(t){if(this.signatureEnvironment.hasOwnProperty(t))return this.signatureEnvironment[t]},StaticBasis.prototype.getFunctor=function(t){if(this.functorEnvironment.hasOwnProperty(t))return this.functorEnvironment[t]},StaticBasis.prototype.setValue=function(t,e,n){this.valueEnvironment[t]=[e,n]},StaticBasis.prototype.deleteValue=function(t){this.valueEnvironment[t]=void 0},StaticBasis.prototype.setType=function(t,e,n,i,r){this.typeEnvironment[t]=new o(e,n,i,r)},StaticBasis.prototype.setStructure=function(t,e){this.structureEnvironment[t]=e},StaticBasis.prototype.setSignature=function(t,e){this.signatureEnvironment[t]=e},StaticBasis.prototype.setFunctor=function(t,e){this.functorEnvironment[t]=e},StaticBasis.prototype.extend=function(t){for(var e in t.typeEnvironment)t.typeEnvironment.hasOwnProperty(e)&&(this.typeEnvironment[e]=t.typeEnvironment[e]);for(var e in t.valueEnvironment)t.valueEnvironment.hasOwnProperty(e)&&(this.valueEnvironment[e]=t.valueEnvironment[e]);for(var e in t.structureEnvironment)t.structureEnvironment.hasOwnProperty(e)&&(this.structureEnvironment[e]=t.structureEnvironment[e]);for(var e in t.signatureEnvironment)t.signatureEnvironment.hasOwnProperty(e)&&(this.signatureEnvironment[e]=t.signatureEnvironment[e]);for(var e in t.functorEnvironment)t.functorEnvironment.hasOwnProperty(e)&&(this.functorEnvironment[e]=t.functorEnvironment[e]);return this},StaticBasis}();exports.StaticBasis=c;var h=function(){function State(t,e,n,i,r,o,a,s,u,p,c,h,l){void 0===a&&(a=[0,new Map]),void 0===s&&(s={}),void 0===u&&(u={}),void 0===p&&(p=[]),void 0===c&&(c=!1),void 0===h&&(h=!1),void 0===l&&(l=[]),this.id=t,this.parent=e,this.staticBasis=n,this.dynamicBasis=i,this.memory=r,this.exceptionEvalId=o,this.freeTypeVariables=a,this.infixEnvironment=s,this.valueIdentifierId=u,this.warns=p,this.insideLocalDeclBody=c,this.localDeclStart=h,this.loadedModules=l}return State.allowsRebind=function(t){return void 0==={true:!1,false:!1,nil:!1,\"::\":!1,\"=\":!1,ref:!1,\":=\":!1,\"!\":!1}[t]},State.prototype.getNestedState=function(t){void 0===t&&(t=void 0),void 0===t&&(t=this.id+1);var e=new State(t,this,new c({},{},{},{},{}),new p({},{},{},{},{}),[this.memory[0],{}],this.exceptionEvalId,[this.freeTypeVariables[0],new Map]);e.insideLocalDeclBody=this.insideLocalDeclBody;for(var n=0,i=this.loadedModules;n<i.length;n++){var r=i[n];e.loadedModules.push(r)}return e},State.prototype.hasModule=function(t){for(var e=0,n=this.loadedModules;e<n.length;e++){if(n[e]===t)return!0}return!1},State.prototype.registerModule=function(t){this.loadedModules.push(t)},State.prototype.getIdChanges=function(t){if(this.id<=t)return{};var e={};void 0!==this.parent&&(e=this.parent.getIdChanges(t));for(var n in this.valueIdentifierId)this.valueIdentifierId.hasOwnProperty(n)&&(e[n]=this.valueIdentifierId[n]);return e},State.prototype.getMemoryChanges=function(t){if(this.id<=t)return[];var e=[];void 0!==this.parent&&(e=this.parent.getMemoryChanges(t));for(var n in this.memory[1])this.memory[1].hasOwnProperty(n)&&e.push([+n,this.memory[1][n]]);return e},State.prototype.getDynamicChanges=function(t){if(this.id<=t)return new p({},{},{},{},{});var e=new p({},{},{},{},{});return void 0!==this.parent&&(e=this.parent.getDynamicChanges(t)),e=e.extend(this.dynamicBasis)},State.prototype.getDynamicLocalDeclChanges=function(t){if(this.id<=t||this.localDeclStart)return new p({},{},{},{},{});var e=new p({},{},{},{},{});return void 0!==this.parent&&(e=this.parent.getDynamicLocalDeclChanges(t)),e=e.extend(this.dynamicBasis)},State.prototype.getStaticChanges=function(t){if(this.id<=t)return new c({},{},{},{},{});var e=new c({},{},{},{},{});return void 0!==this.parent&&(e=this.parent.getStaticChanges(t)),e=e.extend(this.staticBasis)},State.prototype.getCell=function(t){return void 0!==this.memory[1][t]?this.memory[1][t]:void 0===this.parent?void 0:this.parent.getCell(t)},State.prototype.getTypeVariableBinds=function(t){void 0===t&&(t=0);var e=this.freeTypeVariables;if(void 0===this.parent||this.parent.id<t){var n=new Map;return e[1].forEach(function(t,e){n.set(e,t)}),[e[0],n]}var i=this.parent.getTypeVariableBinds(t);return e[1].forEach(function(t,e){i[1].set(e,t)}),[Math.max(e[0],i[0]),i[1]]},State.prototype.getStaticValue=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getValue(t);return void 0!==n||void 0===this.parent||this.parent.id<e?void 0!==n?[n[0],n[1]]:n:this.parent.getStaticValue(t,e)},State.prototype.getStaticType=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getType(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticType(t,e)},State.prototype.getStaticStructure=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getStructure(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticStructure(t,e)},State.prototype.getAndResolveStaticStructure=function(t,e){void 0===e&&(e=0);var n=void 0;if(0===t.qualifiers.length)throw new r.EvaluationError(t.position,\"Unqualified LongIdentifierToken are too unqualified to be useful here.\");n=this.getStaticStructure(t.qualifiers[0].getText(),e);for(var i=1;i<t.qualifiers.length;++i){if(void 0===n)return n;n=n.getStructure(t.qualifiers[i].getText())}return n},State.prototype.getStaticSignature=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getSignature(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticSignature(t,e)},State.prototype.getStaticFunctor=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getFunctor(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticFunctor(t,e)},State.prototype.getDynamicValue=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getValue(t);return void 0!==n||void 0===this.parent||this.parent.id<e?void 0!==n?[n[0],n[1]]:n:this.parent.getDynamicValue(t,e)},State.prototype.getDynamicType=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getType(t);return void 0!==n||void 0===this.parent||this.parent.id<e?void 0!==n?[n[0],n[1]]:n:this.parent.getDynamicType(t,e)},State.prototype.getDynamicStructure=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getStructure(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicStructure(t,e)},State.prototype.getAndResolveDynamicStructure=function(t,e){void 0===e&&(e=0);var n=void 0;if(0===t.qualifiers.length)throw new r.EvaluationError(t.position,\"Unqualified LongIdentifierToken are too unqualified to be useful here.\");n=this.getDynamicStructure(t.qualifiers[0].getText(),e);for(var i=1;i<t.qualifiers.length;++i){if(void 0===n)return n;n=n.getStructure(t.qualifiers[i].getText())}return n},State.prototype.getDynamicSignature=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getSignature(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicSignature(t,e)},State.prototype.getDynamicFunctor=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getFunctor(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicFunctor(t,e)},State.prototype.getInfixStatus=function(t,e){if(void 0===e&&(e=0),t.isVid()||t instanceof i.LongIdentifierToken)return this.infixEnvironment.hasOwnProperty(t.getText())||!this.parent||this.parent.id<e?this.infixEnvironment[t.getText()]:this.parent.getInfixStatus(t,e);throw new r.InternalInterpreterError(t.position,'You gave me some \"'+t.getText()+'\" ('+t.constructor.name+\") but I only want (Long)IdentifierToken.\")},State.prototype.getValueIdentifierId=function(t,e){return void 0===e&&(e=0),this.valueIdentifierId.hasOwnProperty(t)?this.valueIdentifierId[t]:!this.parent||this.parent.id<e?0:this.parent.getValueIdentifierId(t,e)},State.prototype.getWarnings=function(){return this.warns},State.prototype.incrementValueIdentifierId=function(t,e){if(void 0===e&&(e=void 0),void 0===e||this.id===e)this.valueIdentifierId[t]=this.getValueIdentifierId(t,e)+1;else{if(e>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+e+'\" does not exist.');this.parent.incrementValueIdentifierId(t,e)}},State.prototype.setCell=function(t,e){t>=this.memory[0]&&(this.memory[0]=t+1),this.memory[1][t]=e},State.prototype.setNewCell=function(t){return this.memory[1][this.memory[0]]=t,new n.ReferenceValue(this.memory[0]++)},State.prototype.getNextExceptionEvalId=function(){return this.exceptionEvalId++},State.prototype.deleteStaticValue=function(t){this.staticBasis.deleteValue(t),void 0!==this.parent&&this.parent.deleteStaticValue(t)},State.prototype.setStaticValue=function(t,e,n,i){if(void 0===i&&(i=void 0),void 0===i||i===this.id)this.staticBasis.setValue(t,e,n);else{if(i>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+i+'\" does not exist.');this.parent.setStaticValue(t,e,n,i)}},State.prototype.setStaticType=function(t,e,n,i,o,a){if(void 0===a&&(a=void 0),void 0===a||a===this.id)this.staticBasis.setType(t,e,n,i,o);else{if(a>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+a+'\" does not exist.');this.parent.setStaticType(t,e,n,i,o,a)}},State.prototype.setStaticStructure=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.staticBasis.setStructure(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setStaticStructure(t,e,n)}},State.prototype.setStaticSignature=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.staticBasis.setSignature(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setStaticSignature(t,e,n)}},State.prototype.setStaticFunctor=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.staticBasis.setFunctor(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setStaticFunctor(t,e,n)}},State.prototype.setDynamicValue=function(t,e,n,i){if(void 0===i&&(i=void 0),void 0===i||i===this.id)this.dynamicBasis.setValue(t,e,n);else{if(i>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+i+'\" does not exist.');this.parent.setDynamicValue(t,e,n,i)}},State.prototype.setDynamicType=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setType(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setDynamicType(t,e,n)}},State.prototype.setDynamicStructure=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setStructure(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setDynamicStructure(t,e,n)}},State.prototype.setDynamicSignature=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setSignature(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setDynamicSignature(t,e,n)}},State.prototype.setDynamicFunctor=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setFunctor(t,e);else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setDynamicFunctor(t,e,n)}},State.prototype.setInfixStatus=function(t,e,n,o,a){if(void 0===a&&(a=void 0),void 0===a||a===this.id)(t.isVid()||t instanceof i.LongIdentifierToken)&&(this.infixEnvironment[t.getText()]=new u(o,e,n));else{if(a>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+a+'\" does not exist.');this.parent.setInfixStatus(t,e,n,o,a)}},State.prototype.setValueIdentifierId=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.valueIdentifierId[t]=e;else{if(n>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+n+'\" does not exist.');this.parent.setValueIdentifierId(t,e,n)}},State.prototype.addWarning=function(t,e){if(void 0===e&&(e=void 0),void 0===e||e===this.id)this.warns.push(t);else{if(e>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+e+'\" does not exist.');this.parent.addWarning(t,e)}},State.prototype.setWarnings=function(t,e){if(void 0===e&&(e=void 0),void 0===e||e===this.id)this.warns=t;else{if(e>this.id||void 0===this.parent)throw new r.InternalInterpreterError(-1,'State with id \"'+e+'\" does not exist.');this.parent.setWarnings(t,e)}},State}();exports.State=h},function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=e(0),r=function(){function Type(){}return Type.prototype.instantiate=function(t,e,n){throw void 0===n&&(n=new Set),new i.ElaborationError(-1,\"I mustn't run away. I mustn't run away. I mustn't run away.\")},Type.prototype.merge=function(t,e,n){throw new i.ElaborationError(-1,\"I don't know anything. But you know everything.\")},Type.prototype.makeEqType=function(t,e){throw new i.ElaborationError(-1,\"I don't know everything. I just know what I know.\")},Type.prototype.getTypeVariables=function(t){throw void 0===t&&(t=!1),new i.ElaborationError(-1,\"This is wrong.\\nI said with a posed look.\")},Type.prototype.getOrderedTypeVariables=function(){throw new i.ElaborationError(-1,\"You seem well today.\\nDid something nice happen?\")},Type.prototype.replaceTypeVariables=function(t,e){throw void 0===e&&(e=new Set),new i.ElaborationError(-1,\"あんたバカ?\")},Type.prototype.qualify=function(t,e){return this},Type.prototype.propagate=function(t){return void 0===t&&(t=new Map),this},Type.prototype.makeFree=function(){return this},Type.prototype.simplify=function(){return this},Type.prototype.isOpaque=function(){return!1},Type.prototype.getOpaqueName=function(){return\"undefined\"},Type.prototype.isResolved=function(){return!1},Type.prototype.admitsEquality=function(t){return!1},Type.prototype.flatten=function(t){return void 0===t&&(t=new Map),this},Type.prototype.replace=function(t,e){return t.equals(this)?e:this},Type.prototype.normalize=function(t,e){void 0===t&&(t=0),void 0===e&&(e={});for(var n=this.getOrderedTypeVariables(),i=this.getTypeVariables(!0),r=new Map,o=0,a=0,s=n;a<s.length;a++){var u=s[a];if(!r.has(u)){var p=\"\",c=++o;if(i.has(u)&&(c=++t),c<=26)p=String.fromCharCode(\"a\".charCodeAt(0)+c-1);else for(;c>0;){var h=--c%26;p=String.fromCharCode(\"a\".charCodeAt(0)+h)+p,c=Math.floor(c/26)}var l=\"'\";u.length>2&&\"'\"===u.charAt(1)&&(l+=\"'\"),i.has(u)&&(l+=\"~\"),l+=p,i.has(u)&&(l=l.toUpperCase()),r.set(u,l)}}var f=this.replaceTypeVariables(r);return!1!==e.strictMode&&(f=f.flatten(new Map)),[f,t]},Type}();exports.Type=r;var o=function(t){function AnyType(){return t.call(this)||this}return n(AnyType,t),AnyType.prototype.isResolved=function(){return!0},AnyType.prototype.toString=function(){return\"any\"},AnyType.prototype.equals=function(t){return!0},AnyType.prototype.instantiate=function(t,e,n){return void 0===n&&(n=new Set),this},AnyType.prototype.merge=function(t,e,n){return[n,e]},AnyType.prototype.makeEqType=function(t,e){return[this,e]},AnyType.prototype.getTypeVariables=function(t){return void 0===t&&(t=!1),new Map},AnyType.prototype.getOrderedTypeVariables=function(){return[]},AnyType.prototype.replaceTypeVariables=function(t,e){return void 0===e&&(e=new Set),this},AnyType}(r);exports.AnyType=o;var a=function(t){function TypeVariableBind(e,n,i){void 0===i&&(i=[]);var r=t.call(this)||this;return r.name=e,r.type=n,r.domain=i,r.isFree=!1,r}return n(TypeVariableBind,t),TypeVariableBind.prototype.isResolved=function(){return this.type.isResolved()},TypeVariableBind.prototype.simplify=function(){var t=new TypeVariableBind(this.name,this.type.simplify(),this.domain);return t.isFree=this.isFree,t},TypeVariableBind.prototype.makeFree=function(){var t=new TypeVariableBind(this.name,this.type.makeFree(),this.domain);return t.isFree=!0,t},TypeVariableBind.prototype.flatten=function(t){if(this.domain.length>0)return t=t.set(this.name,this.domain[0]),this.type.flatten(t);var e=new TypeVariableBind(this.name,this.type.flatten(t),this.domain);return e.isFree=this.isFree,e},TypeVariableBind.prototype.qualify=function(t,e){var n=new TypeVariableBind(this.name,this.type.qualify(t,e),this.domain);return n.isFree=this.isFree,n},TypeVariableBind.prototype.propagate=function(t){void 0===t&&(t=new Map),this.domain.length>0&&(t=t.set(this.name,this.domain));var e=new TypeVariableBind(this.name,this.type.propagate(t),this.domain);return e.isFree=this.isFree,e},TypeVariableBind.prototype.isOpaque=function(){return this.type.isOpaque()},TypeVariableBind.prototype.getOpaqueName=function(){return this.type.getOpaqueName()},TypeVariableBind.prototype.instantiate=function(t,e){var n=new TypeVariableBind(this.name,this.type.instantiate(t,e),this.domain);return n.isFree=this.isFree,n},TypeVariableBind.prototype.toString=function(){for(var t=new Set,e=new Set,n=this;n instanceof TypeVariableBind;)n.isFree?t=t.add([n.name,n.domain]):e=e.add([n.name,n.domain]),n=n.type;var i=\"\";return e.size>0&&(i+=\"∀\",e.forEach(function(t){if(i+=\" \"+t[0],t[1].length>0){i+=\" ∈ {\";for(var e=0;e<t[1].length;++e)e>0&&(i+=\", \"),i+=t[1][e];i+=\"}\"}}),i+=\" . \"),i+=n,t.size>0&&(i+=\",\",t.forEach(function(t){if(i+=\" \"+t[0],t[1].length>0){i+=\" ∈ {\";for(var e=0;e<t[1].length;++e)e>0&&(i+=\", \"),i+=t[1][e];i+=\"}\"}}),i+=\" free\"),i},TypeVariableBind.prototype.getTypeVariables=function(t){var e=this;void 0===t&&(t=!1);var n=this.type.getTypeVariables(t),i=new Map;return n.forEach(function(n,r){r===e.name&&t!==e.isFree||(i=i.has(r)?i.set(r,s.mergeDomain(n,i.get(r))):i.set(r,n))}),t&&this.isFree&&!i.has(this.name)&&(i=i.set(this.name,this.domain)),i},TypeVariableBind.prototype.getOrderedTypeVariables=function(){return[this.name].concat(this.type.getOrderedTypeVariables())},TypeVariableBind.prototype.replaceTypeVariables=function(t,e){if(void 0===e&&(e=new Set),t.has(this.name)){var n=new TypeVariableBind(t.get(this.name),this.type.replaceTypeVariables(t,e),this.domain);return e.has(this.name)?n.isFree=!0:n.isFree=this.isFree,n}var n=new TypeVariableBind(this.name,this.type.replaceTypeVariables(t,e),this.domain);return n.isFree=this.isFree,n},TypeVariableBind.prototype.equals=function(t){return t instanceof TypeVariableBind&&t.name===this.name&&t.type.equals(this.type)},TypeVariableBind}(r);exports.TypeVariableBind=a;var s=function(t){function TypeVariable(e,n,i){void 0===n&&(n=0),void 0===i&&(i=[]);var r=t.call(this)||this;return r.name=e,r.position=n,r.domain=i,r.isFree=!1,r}return n(TypeVariable,t),TypeVariable.mergeDomain=function(t,e){if(0===t.length)return e;if(0===e.length)return t;for(var n=[],i=0,r=t;i<r.length;i++)for(var o=r[i],a=0,s=e;a<s.length;a++){var u=s[a];o.equals(u)&&n.push(o)}return n},TypeVariable.prototype.isResolved=function(){return!0},TypeVariable.prototype.makeFree=function(){var t=new TypeVariable(this.name,this.position,this.domain);return t.isFree=!0,t},TypeVariable.prototype.flatten=function(t){return this.domain.length>0?(t=t.set(this.name,this.domain[0]),this.domain[0]):t.has(this.name)?t.get(this.name):this},TypeVariable.prototype.propagate=function(t){void 0===t&&(t=new Map);var e=[];t.has(this.name)&&(e=t.get(this.name));var n=new TypeVariable(this.name,this.position,e);return n.isFree=this.isFree,n},TypeVariable.prototype.toString=function(){return this.name},TypeVariable.prototype.instantiate=function(t,e,n){if(void 0===n&&(n=new Set),!e.has(this.name))return this;if(n.has(this.name))throw new i.ElaborationError(-1,'Type clash. An expression of type \"'+this.normalize()[0]+'\" cannot have type \"'+e.get(this.name)[0].normalize()[0]+'\" because of circularity.');var r=new Set;return n.forEach(function(t){r.add(t)}),r.add(this.name),e.get(this.name)[0].instantiate(t,e,r)},TypeVariable.prototype.merge=function(t,e,n){if(n instanceof o)return[this,e];var r=this.instantiate(t,e);if(r instanceof TypeVariable){var a=n.instantiate(t,e);if(a instanceof TypeVariable){if(r.name===a.name){var s=TypeVariable.mergeDomain(r.domain,a.domain);if(0===s.length&&r.domain.length+a.domain.length>0)throw['Cannot merge domains of \"'+r.normalize(0,{strictMode:!1})[0]+'\" and \"'+n.normalize(0,{strictMode:!1})[0]+'\" ({'+r.domain+\"} and {\"+a.domain+\"})\"];var u=new TypeVariable(r.name,r.position,s);return u.isFree=r.isFree&&a.isFree,[u,e]}var p=new Map,c=r;if(r.name<a.name?(r.domain=TypeVariable.mergeDomain(r.domain,a.domain),p.set(a.name,r.name)):(a.domain=TypeVariable.mergeDomain(r.domain,a.domain),p.set(r.name,a.name),c=a),0===c.domain.length&&r.domain.length+a.domain.length>0)throw['Cannot merge domains of \"'+this.normalize(0,{strictMode:!1})[0]+'\" and \"'+n.normalize(0,{strictMode:!1})[0]+'\". ({'+r.domain+\"} and {\"+a.domain+\"})\"];var h=new Map;e.forEach(function(t,e){h=h.set(e,[t[0].replaceTypeVariables(p),t[1]])}),c.isFree=r.isFree&&a.isFree,r.name<a.name?h.set(a.name,[r,c.isFree]):h.set(r.name,[a,c.isFree]);var l=c.domain;return h.has(\"$\"+r.name)&&(l=TypeVariable.mergeDomain(l,h.get(\"$\"+r.name)[0].domain)),h.has(\"$\"+a.name)&&(l=TypeVariable.mergeDomain(l,h.get(\"$\"+a.name)[0].domain)),h.set(\"$\"+r.name,[new TypeVariable(r.name,-1,l),c.isFree]),h.set(\"$\"+a.name,[new TypeVariable(a.name,-1,l),c.isFree]),[c,h]}if(a.getTypeVariables().has(r.name))throw new i.ElaborationError(-1,'Type clash. An expression of type \"'+r.normalize()[0]+'\" cannot have type \"'+a.normalize()[0]+'\" because of circularity.');if(r.isFree&&(a=a.makeFree()),r.admitsEquality(t)&&!a.admitsEquality(t)){var f=a.makeEqType(t,e);if(!f[0].admitsEquality(t))throw['Type \"'+a.normalize()[0]+'\" does not admit equality.',r,a];a=f[0],e=f[1]}if(r.domain.length>0&&0===TypeVariable.mergeDomain(r.domain,[a]).length)throw['Type \"'+a.normalize(0,{strictMode:!1})[0]+'\" is not part of the domain of \"'+r.normalize(0,{strictMode:!1})[0]+'\" ({'+r.domain+\"}).\"];return[a,e.set(r.name,[a,r.isFree])]}return r.merge(t,e,n)},TypeVariable.prototype.makeEqType=function(t,e){if(this.admitsEquality(t))return[this,e];if(e.has(this.name)){var n=e.get(this.name)[0].makeEqType(t,e);e=n[1];var i=new TypeVariable(\"'\"+this.name,this.position,this.domain);i.isFree=this.isFree,e=e.set(i.name,[n[0],i.isFree])}var r=new TypeVariable(\"'\"+this.name,this.position,this.domain);return[r,e.set(this.name,[r,this.isFree])]},TypeVariable.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;return t&&!this.isFree||(e=e.set(this.name,this.domain)),e},TypeVariable.prototype.getOrderedTypeVariables=function(){return[this.name]},TypeVariable.prototype.replaceTypeVariables=function(t,e){if(void 0===e&&(e=new Set),t.has(this.name)){var n=new TypeVariable(t.get(this.name),0,this.domain);return e.has(this.name)?n.isFree=!0:n.isFree=this.isFree,n}return this},TypeVariable.prototype.admitsEquality=function(t){return\"'\"===this.name[1]},TypeVariable.prototype.equals=function(t){return t instanceof o||t instanceof TypeVariable&&this.name===t.name},TypeVariable}(r);exports.TypeVariable=s;var u=function(t){function RecordType(e,n,i){void 0===n&&(n=!0),void 0===i&&(i=0);var r=t.call(this)||this;return r.elements=e,r.complete=n,r.position=i,r}return n(RecordType,t),RecordType.prototype.isResolved=function(){if(!this.complete)return!1;var t=!0;return this.elements.forEach(function(e,n){t=t&&e.isResolved()}),t},RecordType.prototype.makeFree=function(){var t=new Map;return this.elements.forEach(function(e,n){t.set(n,e.makeFree())}),new RecordType(t,this.complete,this.position)},RecordType.prototype.replace=function(t,e){if(t.equals(this))return e;var n=new Map;return this.elements.forEach(function(i,r){n.set(r,i.replace(t,e))}),new RecordType(n,this.complete,this.position)},RecordType.prototype.flatten=function(t){var e=new Map;return this.elements.forEach(function(n,i){e.set(i,n.flatten(t))}),new RecordType(e,this.complete,this.position)},RecordType.prototype.instantiate=function(t,e,n){void 0===n&&(n=new Set);var i=new Map;return this.elements.forEach(function(r,o){i.set(o,r.instantiate(t,e,n))}),new RecordType(i,this.complete,this.position)},RecordType.prototype.qualify=function(t,e){var n=new Map;return this.elements.forEach(function(i,r){n.set(r,i.qualify(t,e))}),new RecordType(n,this.complete,this.position)},RecordType.prototype.propagate=function(t){void 0===t&&(t=new Map);var e=new Map;return this.elements.forEach(function(n,i){e.set(i,n.propagate(t))}),new RecordType(e,this.complete,this.position)},RecordType.prototype.merge=function(t,e,n){var i=this;if(n instanceof s||n instanceof o)return n.merge(t,e,this);if((n=n.instantiate(t,e))instanceof RecordType){if(!this.complete&&n.complete)return n.merge(t,e,this);var r=new Map,a=e;return n.elements.forEach(function(e,o){if(i.complete&&!i.elements.has(o))throw[\"Records don't agree on members (\\\"\"+o+'\" occurs only once.)',i.instantiate(t,a),n.instantiate(t,a)];if(i.elements.has(o)){var s=e.merge(t,a,i.elements.get(o));r=r.set(o,s[0]),a=s[1]}else r=r.set(o,e.instantiate(t,a))}),n.complete?this.elements.forEach(function(e,r){if(!n.elements.has(r))throw[\"Records don't agree on members (\\\"\"+r+'\" occurs only once.)',i.instantiate(t,a),n.instantiate(t,a)]}):this.elements.forEach(function(e,n){r=r.set(n,e.instantiate(t,a))}),[new RecordType(r,this.complete||n.complete,this.position),a]}throw['Cannot merge \"'+this.instantiate(t,e).normalize()[0]+'\" and \"'+n.instantiate(t,e).normalize()[0]+'\".',this.constructor.name,n.constructor.name]},RecordType.prototype.makeEqType=function(t,e){var n=new Map;return this.elements.forEach(function(i,r){var o=i.makeEqType(t,e);n.set(r,o[0]),e=o[1]}),[new RecordType(n,this.complete,this.position),e]},RecordType.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;return this.elements.forEach(function(n){n.getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,s.mergeDomain(t,e.get(n))):e.set(n,t)})}),e},RecordType.prototype.getOrderedTypeVariables=function(){var t=[];return this.elements.forEach(function(e){t=t.concat(e.getOrderedTypeVariables())}),t},RecordType.prototype.replaceTypeVariables=function(t,e){void 0===e&&(e=new Set);var n=new Map;return this.elements.forEach(function(i,r){n=n.set(r,i.replaceTypeVariables(t,e))}),new RecordType(n,this.complete,0)},RecordType.prototype.getType=function(t){if(!this.elements.has(t))throw new i.ElaborationError(0,\"Tried accessing non-existing record part.\");return this.elements.get(t)},RecordType.prototype.hasType=function(t){return this.elements.has(t)},RecordType.prototype.admitsEquality=function(t){var e=!0;return this.elements.forEach(function(n,i){n.admitsEquality(t)||(e=!1)}),e},RecordType.prototype.toString=function(){for(var t=1!==this.elements.size,e=1;e<=this.elements.size;++e)this.elements.has(\"\"+e)||(t=!1);if(t){if(0===this.elements.size)return\"unit\";for(var n=\"\",e=1;e<=this.elements.size;++e){e>1&&(n+=\" * \");var i=this.elements.get(\"\"+e);i instanceof p||i instanceof RecordType&&0!==i.elements.size?n+=\"(\"+i+\")\":n+=i}return n+\"\"}var r=\"{\",o=!0;return this.elements.forEach(function(t,e){o?o=!1:r+=\", \",r+=e+\": \"+t}),this.complete||(o||(r+=\", \"),r+=\"...\"),r+\"}\"},RecordType.prototype.simplify=function(){var t=new Map;return this.elements.forEach(function(e,n){t.set(n,e.simplify())}),new RecordType(t,this.complete,this.position)},RecordType.prototype.equals=function(t){var e=this;if(t instanceof o)return!0;if(!(t instanceof RecordType)||this.complete!==t.complete)return!1;var n=!0;return this.elements.forEach(function(e,i){e.equals(t.elements.get(i))||(n=!1)}),t.elements.forEach(function(t,i){t.equals(e.elements.get(i))||(n=!1)}),n},RecordType}(r);exports.RecordType=u;var p=function(t){function FunctionType(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.parameterType=e,r.returnType=n,r.position=i,r}return n(FunctionType,t),FunctionType.prototype.isResolved=function(){return this.parameterType.isResolved()&&this.returnType.isResolved()},FunctionType.prototype.makeFree=function(){return new FunctionType(this.parameterType.makeFree(),this.returnType.makeFree(),this.position)},FunctionType.prototype.flatten=function(t){return new FunctionType(this.parameterType.flatten(t),this.returnType.flatten(t),this.position)},FunctionType.prototype.replace=function(t,e){return this.equals(t)?e:new FunctionType(this.parameterType.replace(t,e),this.returnType.replace(t,e),this.position)},FunctionType.prototype.instantiate=function(t,e,n){return void 0===n&&(n=new Set),new FunctionType(this.parameterType.instantiate(t,e,n),this.returnType.instantiate(t,e,n),this.position)},FunctionType.prototype.qualify=function(t,e){return new FunctionType(this.parameterType.qualify(t,e),this.returnType.qualify(t,e),this.position)},FunctionType.prototype.propagate=function(t){return void 0===t&&(t=new Map),new FunctionType(this.parameterType.propagate(t),this.returnType.propagate(t),this.position)},FunctionType.prototype.merge=function(t,e,n){if(n instanceof s||n instanceof o)return n.merge(t,e,this);var i=n.instantiate(t,e);if(i instanceof FunctionType){var r=this.parameterType.merge(t,e,i.parameterType),a=this.returnType.merge(t,r[1],i.returnType);return[new FunctionType(r[0],a[0],this.position),a[1]]}throw['Cannot merge \"'+this.instantiate(t,e).normalize()[0]+'\" and \"'+n.instantiate(t,e).normalize()[0]+'\".',this.constructor.name,n.constructor.name]},FunctionType.prototype.makeEqType=function(t,e){return[this,e]},FunctionType.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;return this.parameterType.getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,s.mergeDomain(t,e.get(n))):e.set(n,t)}),this.returnType.getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,s.mergeDomain(t,e.get(n))):e.set(n,t)}),e},FunctionType.prototype.getOrderedTypeVariables=function(){var t=[];return t=t.concat(this.parameterType.getOrderedTypeVariables()),t=t.concat(this.returnType.getOrderedTypeVariables())},FunctionType.prototype.replaceTypeVariables=function(t,e){return void 0===e&&(e=new Set),new FunctionType(this.parameterType.replaceTypeVariables(t,e),this.returnType.replaceTypeVariables(t,e),0)},FunctionType.prototype.admitsEquality=function(t){return!1},FunctionType.prototype.toString=function(){return this.parameterType instanceof FunctionType?\"(\"+this.parameterType+\") → \"+this.returnType:this.parameterType+\" → \"+this.returnType},FunctionType.prototype.simplify=function(){return new FunctionType(this.parameterType.simplify(),this.returnType.simplify(),this.position)},FunctionType.prototype.equals=function(t){return t instanceof o||t instanceof FunctionType&&this.parameterType.equals(t.parameterType)&&this.returnType.equals(t.returnType)},FunctionType}(r);exports.FunctionType=p;var c=function(t){function CustomType(e,n,i,r,o,a){void 0===n&&(n=[]),void 0===i&&(i=0),void 0===r&&(r=void 0),void 0===o&&(o=!1),void 0===a&&(a=0);var s=t.call(this)||this;return s.name=e,s.typeArguments=n,s.position=i,s.qualifiedName=r,s.opaque=o,s.id=a,s}return n(CustomType,t),CustomType.prototype.isResolved=function(){for(var t=0;t<this.typeArguments.length;++t)if(!this.typeArguments[t].isResolved())return!1;return!0},CustomType.prototype.isOpaque=function(){return this.opaque},CustomType.prototype.getOpaqueName=function(){return this.isOpaque?this.name:\"undefined\"},CustomType.prototype.makeFree=function(){for(var t=[],e=0;e<this.typeArguments.length;++e)t.push(this.typeArguments[e].makeFree());return new CustomType(this.name,t,this.position,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.replace=function(t,e){if(this.equals(t))return e;for(var n=[],i=0;i<this.typeArguments.length;++i)n.push(this.typeArguments[i].replace(t,e));return new CustomType(this.name,n,this.position,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.flatten=function(t){for(var e=[],n=0;n<this.typeArguments.length;++n)e.push(this.typeArguments[n].flatten(t));return new CustomType(this.name,e,this.position,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.qualify=function(t,e){for(var n=[],i=0;i<this.typeArguments.length;++i)n.push(this.typeArguments[i].qualify(t,e));var r=new CustomType(this.name,n,this.position,this.qualifiedName,this.opaque,this.id);return void 0!==t.getStaticType(this.name)&&(r.qualifiedName=e),r},CustomType.prototype.propagate=function(t){void 0===t&&(t=new Map);for(var e=[],n=0;n<this.typeArguments.length;++n)e.push(this.typeArguments[n].propagate(t));return new CustomType(this.name,e,this.position,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.instantiate=function(t,e,n){void 0===n&&(n=new Set);var r=t.getStaticType(this.name);if(void 0!==this.qualifiedName){var o=t.getAndResolveStaticStructure(this.qualifiedName);r=void 0!==o?o.getType(this.name):void 0}if(void 0!==r&&r.type instanceof p)try{var a=r.type.getTypeVariables(),s=1,u=new Map;a.forEach(function(t,e){u=u.set(e,\"'*q\"+s),++s});var c=r.type.replaceTypeVariables(u),h=this.merge(t,e,c.parameterType,!0),l=t.getNestedState(t.id);return l.setStaticType(this.name,c.returnType,[],-1,r.allowsEquality),c.returnType.instantiate(l,h[1])}catch(t){if(!(t instanceof Array))throw t;throw new i.ElaborationError(-1,'Instantiating \"'+this.normalize()[0]+'\" failed: '+t[0])}else{if(void 0===r){if(this.id>0)throw new i.ElaborationError(-1,'Unbound type \"'+this.name+\"/\"+this.id+'\".');throw new i.ElaborationError(-1,'Unbound type \"'+this.name+'\".')}if(void 0!==r&&r.type.isOpaque())this.opaque=!0;else{if(!(void 0===r||r.type instanceof CustomType&&this.typeArguments.length===r.type.typeArguments.length))throw new i.ElaborationError(this.position,\"Arity mismatch: \"+this.normalize()[0]+\" vs \"+r.type.normalize()[0]+\".\");if(void 0!==r&&(!(r.type instanceof CustomType)||this.id>r.type.id)){if(this.id>0)throw new i.ElaborationError(-1,'Unbound type \"'+this.name+\"/\"+this.id+'\".');throw new i.ElaborationError(-1,'Unbound type \"'+this.name+'\".')}}}for(var f=[],d=0;d<this.typeArguments.length;++d)f.push(this.typeArguments[d].instantiate(t,e,n));return new CustomType(this.name,f,this.position,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.merge=function(t,e,n,i){if(void 0===i&&(i=!1),n instanceof s||n instanceof o)return n.merge(t,e,this);var r=this,a=n;if(!i){if(!((r=this.instantiate(t,e))instanceof CustomType))return r.merge(t,e,n);a=n.instantiate(t,e)}var u=r;if(a instanceof CustomType&&u.name===a.name&&u.id===a.id){for(var p=[],c=e,h=0;h<r.typeArguments.length;++h){var l=r.typeArguments[h].merge(t,c,a.typeArguments[h]);p.push(l[0]),c=l[1]}return[new CustomType(u.name,p,u.position,u.qualifiedName,u.opaque,u.id),c]}throw['Cannot merge \"'+this.instantiate(t,e).normalize()[0]+'\" and \"'+n.instantiate(t,e).normalize()[0]+'\".',this.constructor.name,n.constructor.name]},CustomType.prototype.makeEqType=function(t,e){var n=t.getStaticType(this.name);if(void 0!==this.qualifiedName){var i=t.getAndResolveStaticStructure(this.qualifiedName);n=void 0!==i?i.getType(this.name):void 0}if(void 0!==n&&!n.allowsEquality)return[this,e];for(var r=[],o=0;o<this.typeArguments.length;++o){var a=this.typeArguments[o].makeEqType(t,e);r.push(a[0]),e=a[1]}return[new CustomType(this.name,r,this.position,this.qualifiedName,this.opaque,this.id),e]},CustomType.prototype.getTypeVariables=function(t){void 0===t&&(t=!1);var e=new Map;if(this.typeArguments.length>0)for(var n=0;n<this.typeArguments.length;++n)this.typeArguments[n].getTypeVariables(t).forEach(function(t,n){e=e.has(n)?e.set(n,s.mergeDomain(t,e.get(n))):e.set(n,t)});return e},CustomType.prototype.getOrderedTypeVariables=function(){for(var t=[],e=0;e<this.typeArguments.length;++e)t=t.concat(this.typeArguments[e].getOrderedTypeVariables());return t},CustomType.prototype.replaceTypeVariables=function(t,e){for(var n=[],i=0;i<this.typeArguments.length;++i)n.push(this.typeArguments[i].replaceTypeVariables(t,e));return new CustomType(this.name,n,0,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.admitsEquality=function(t){var e=t.getStaticType(this.name);if(void 0!==this.qualifiedName){var n=t.getAndResolveStaticStructure(this.qualifiedName);e=void 0!==n?n.getType(this.name):void 0}if(void 0===e)return!0;var i=t.getNestedState(t.id);i.setStaticType(this.name,this,[],this.typeArguments.length,!0);for(var r=0;r<this.typeArguments.length;++r)if(!this.typeArguments[r].admitsEquality(i))return!1;for(var r=0;r<e.constructors.length;++r){var o=function(n){var r=t.getStaticValue(e.constructors[n]);if(void 0===r)return\"continue\";for(var o=r[0];o instanceof a;)o=o.type;if(o instanceof CustomType)return\"continue\";var s=o.parameterType,u=s.getTypeVariables(),p=new Map;return u.forEach(function(t,e){e.startsWith(\"''\")||(p=p.set(e,\"'\"+e))}),s=s.replaceTypeVariables(p),s.admitsEquality(i)?void 0:{value:!1}}(r);if(\"object\"==typeof o)return o.value}return e.allowsEquality},CustomType.prototype.toString=function(){var t=\"\";(this.typeArguments.length>1||1===this.typeArguments.length&&(this.typeArguments[0]instanceof p||this.typeArguments[0]instanceof u&&\"unit\"!==this.typeArguments[0].toString()))&&(t+=\"(\");for(var e=0;e<this.typeArguments.length;++e)e>0&&(t+=\", \"),t+=this.typeArguments[e];if((this.typeArguments.length>1||1===this.typeArguments.length&&(this.typeArguments[0]instanceof p||this.typeArguments[0]instanceof u&&\"unit\"!==this.typeArguments[0].toString()))&&(t+=\")\"),this.typeArguments.length>0&&(t+=\" \"),void 0!==this.qualifiedName)for(var e=0;e<this.qualifiedName.qualifiers.length;++e)t+=this.qualifiedName.qualifiers[e].getText()+\".\";return t+=this.name,this.id>0&&(t+=\"/\"+this.id),t},CustomType.prototype.simplify=function(){for(var t=[],e=0;e<this.typeArguments.length;++e)t.push(this.typeArguments[e].simplify());return new CustomType(this.name,t,this.position,this.qualifiedName,this.opaque,this.id)},CustomType.prototype.equals=function(t){if(t instanceof o)return!0;if(!(t instanceof CustomType)||this.name!==t.name||this.id!==t.id)return!1;for(var e=0;e<this.typeArguments.length;++e)if(!this.typeArguments[e].equals(t.typeArguments[e]))return!1;return!0},CustomType}(r);exports.CustomType=c;var h=function(t){function TupleType(e,n){void 0===n&&(n=0);var i=t.call(this)||this;return i.elements=e,i.position=n,i}return n(TupleType,t),TupleType.prototype.toString=function(){for(var t=\"(\",e=0;e<this.elements.length;++e)e>0&&(t+=\" * \"),t+=this.elements[e];return t+\")\"},TupleType.prototype.simplify=function(){for(var t=new Map,e=0;e<this.elements.length;++e)t.set(\"\"+(e+1),this.elements[e].simplify());return new u(t,!0,this.position)},TupleType.prototype.equals=function(t){return this.simplify().equals(t)},TupleType}(r);exports.TupleType=h},function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=e(6),r=e(1),o=e(4),a=e(3),s=e(0),u=e(2),p=function(){function Declaration(){}return Declaration.prototype.elaborate=function(t,e,n,i,r){throw void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=!1),void 0===r&&(r={}),new s.InternalInterpreterError(-1,\"Not yet implemented.\")},Declaration.prototype.evaluate=function(t,e){throw new s.InternalInterpreterError(-1,\"Not yet implemented.\")},Declaration.prototype.toString=function(){throw new s.InternalInterpreterError(-1,\"Not yet implemented.\")},Declaration.prototype.simplify=function(){throw new s.InternalInterpreterError(-1,\"Not yet implemented.\")},Declaration.prototype.assertUniqueBinding=function(t,e){return new Set},Declaration}();exports.Declaration=p;var c=function(t){function ValueDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.typeVariableSequence=n,o.valueBinding=i,o.id=r,o}return n(ValueDeclaration,t),ValueDeclaration.prototype.assertUniqueBinding=function(t,e){for(var n=0;n<this.valueBinding.length;++n)this.valueBinding[n].pattern.assertUniqueBinding(t,e),this.valueBinding[n].expression.assertUniqueBinding(t,e);return new Set},ValueDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.valueBinding.length;++e)t.push(new V(this.valueBinding[e].position,this.valueBinding[e].isRecursive,this.valueBinding[e].pattern.simplify(),this.valueBinding[e].expression.simplify()));return new ValueDeclaration(this.position,this.typeVariableSequence,t,this.id)},ValueDeclaration.prototype.elaborate=function(t,e,n,r,u){for(var p=[],c=[],h=[],l=e,f=0;f<this.valueBinding.length;++f){if(this.valueBinding[f].isRecursive){for(var d=f;d<this.valueBinding.length;++d){for(var y=this.valueBinding[d].pattern;y instanceof i.TypedExpression;)y=y.expression;var v=y.name.getText();p.push([v,new o.TypeVariableBind(\"'a\",new o.TypeVariableBind(\"'b\",new o.FunctionType(new o.TypeVariable(\"'a\"),new o.TypeVariable(\"'b\"))))])}break}var m=this.valueBinding[f].getType(this.typeVariableSequence,t,l,n,r);h=h.concat(m[1]),l=m[2],n=m[3],t.valueIdentifierId=m[4];for(var d=0;d<m[0].length;++d)c.push(m[0][d])}for(var g=t.getNestedState(t.id),d=0;d<p.length;++d){if(!(u&&!0===u.allowSuccessorML||p[d][1].isResolved()))throw new s.ElaborationError(this.position,\"Unresolved record type. (Is that a goblin?)\");g.setStaticValue(p[d][0],p[d][1],a.IdentifierStatus.VALUE_VARIABLE)}var w=h,T=new Map;l.forEach(function(t,e){T=T.set(e,t)});for(var E=n,S=g.valueIdentifierId,x=this.valueBinding.length-f+1,I=0;I<x*x+1;++I){h=w,l=new Map,T.forEach(function(t,e){l=l.set(e,t)}),n=E,g.valueIdentifierId=S;for(var V=!1,d=f;d<this.valueBinding.length;++d){var m=this.valueBinding[d].getType(this.typeVariableSequence,g,l,n,r);h=h.concat(m[1]),l=m[2],n=m[3],g.valueIdentifierId=m[4];for(var k=0;k<m[0].length;++k){var b=g.getStaticValue(m[0][k][0]);if(void 0!==b&&b[0].normalize()[0].equals(m[0][k][1].normalize()[0])||(V=!0),!(u&&!0===u.allowSuccessorML||m[0][k][1].isResolved()))throw new s.ElaborationError(this.position,\"Unresolved record type. (Is that a goblin?)\");g.setStaticValue(m[0][k][0],m[0][k][1],a.IdentifierStatus.VALUE_VARIABLE)}}if(!V)break;if(I===x*x)throw new s.ElaborationError(this.position,\"My brain trembles; too much circularity.\")}for(var d=0;d<c.length;++d){if(!(u&&!0===u.allowSuccessorML||c[d][1].isResolved()))throw new s.ElaborationError(this.position,\"Unresolved record type. (Is that a goblin?)\");g.setStaticValue(c[d][0],c[d][1],a.IdentifierStatus.VALUE_VARIABLE)}return[g,h,l,n]},ValueDeclaration.prototype.evaluate=function(t,e){var n=t.state;void 0===t.step&&(t.result=[],t.recursives=[],t.isRec=!1,t.step=-1);var i=t.result,r=t.recursives,o=t.isRec,p=t.step;if(p>=0){var c=t.recResult;if(void 0===c)throw new s.InternalInterpreterError(-1,\"How is this undefined? \"+JSON.stringify(c));if(this.valueBinding[p].isRecursive&&(o=!0),c.hasThrown)return{newState:n,value:c.value,hasThrown:!0};var h=this.valueBinding[p].pattern.matches(n,c.value);if(void 0===h)return{newState:n,value:new u.ExceptionValue(\"Bind\",void 0,0,1),hasThrown:!0};for(var l=0;l<h.length;++l)o?r.push(h[l]):i.push(h[l])}if(++p<this.valueBinding.length)return t.step=p,t.isRec=o,e.push({next:this,params:t}),void e.push({next:this.valueBinding[p].expression,params:{state:n,modifiable:t.modifiable,recResult:void 0}});for(var f=n.getNestedState(n.id),l=0;l<r.length;++l)r[l][1]instanceof u.FunctionValue?f.setDynamicValue(r[l][0],new u.FunctionValue(r[l][1].state,r,r[l][1].body),a.IdentifierStatus.VALUE_VARIABLE):f.setDynamicValue(r[l][0],r[l][1],a.IdentifierStatus.VALUE_VARIABLE);for(var l=0;l<i.length;++l)f.setDynamicValue(i[l][0],i[l][1],a.IdentifierStatus.VALUE_VARIABLE);return{newState:f,value:void 0,hasThrown:!1}},ValueDeclaration.prototype.toString=function(){for(var t=\"val <stuff>\",e=0;e<this.valueBinding.length;++e)e>0&&(t+=\" and\"),t+=\" \"+this.valueBinding[e];return t+=\";\"},ValueDeclaration}(p);exports.ValueDeclaration=c;var h=function(t){function TypeDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.typeBinding=n,r.id=i,r}return n(TypeDeclaration,t),TypeDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.typeBinding.length;++e)t.push(new b(this.typeBinding[e].position,this.typeBinding[e].typeVariableSequence,this.typeBinding[e].name,this.typeBinding[e].type.simplify()));return new TypeDeclaration(this.position,t,this.id)},TypeDeclaration.prototype.elaborate=function(t,e,n,i,r){for(var a=0;a<this.typeBinding.length;++a){var u=t.getStaticType(this.typeBinding[a].name.getText());if(void 0!==u&&u.type instanceof o.CustomType)throw new s.ElaborationError(this.position,\"Nnaaa~ Redefining types as aliases is not yet implemented.\");t.setStaticType(this.typeBinding[a].name.getText(),new o.FunctionType(new o.CustomType(this.typeBinding[a].name.getText(),this.typeBinding[a].typeVariableSequence),this.typeBinding[a].type.instantiate(t,e)),[],this.typeBinding[a].typeVariableSequence.length,!0)}return[t,[],e,n]},TypeDeclaration.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.typeBinding.length;++i)n.setDynamicType(this.typeBinding[i].name.getText(),[]);return{newState:n,value:void 0,hasThrown:!1}},TypeDeclaration.prototype.toString=function(){for(var t=\"type\",e=0;e<this.typeBinding.length;++e)e>0&&(t+=\" and\"),t+=\" <stuff> \"+this.typeBinding[e].name.getText(),t+=\" = \"+this.typeBinding[e].type;return t+\";\"},TypeDeclaration}(p);exports.TypeDeclaration=h;var l=function(t){function DatatypeDeclaration(e,n,i,r,o){void 0===r&&(r=0),void 0===o&&(o={});var a=t.call(this)||this;if(a.position=e,a.datatypeBinding=n,a.typeBinding=i,a.id=r,a.givenIds=o,void 0!==a.typeBinding)throw new s.FeatureDisabledError(a.position,'Who is \"withtype\"?');return a}return n(DatatypeDeclaration,t),DatatypeDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.datatypeBinding.length;++e){for(var n=[],i=0;i<this.datatypeBinding[e].type.length;++i)void 0!==this.datatypeBinding[e].type[i][1]?n.push([this.datatypeBinding[e].type[i][0],this.datatypeBinding[e].type[i][1].simplify()]):n.push(this.datatypeBinding[e].type[i]);t.push(new A(this.datatypeBinding[e].position,this.datatypeBinding[e].typeVariableSequence,this.datatypeBinding[e].name,n))}return new DatatypeDeclaration(this.position,t,void 0,this.id)},DatatypeDeclaration.prototype.elaborate=function(t,e,n,i,r){for(var o=[],u=0;u<this.datatypeBinding.length;++u){for(var p=this.datatypeBinding[u].getType(t,i),c=0;c<p[0].length;++c){if(!a.State.allowsRebind(p[0][c][0]))throw new s.ElaborationError(this.position,'You simply cannot rebind \"'+p[0][c][0]+'\".');t.setStaticValue(p[0][c][0],p[0][c][1],a.IdentifierStatus.VALUE_CONSTRUCTOR),o.push(p[0][c][1])}t.setStaticType(p[2][0],p[1],p[2][1],this.datatypeBinding[u].typeVariableSequence.length,!0),t.incrementValueIdentifierId(p[2][0])}for(var u=0;u<o.length;++u)o[u].instantiate(t,new Map);return[t,[],e,n]},DatatypeDeclaration.prototype.evaluate=function(t,e){for(var n=t.state,i=t.modifiable,r=0;r<this.datatypeBinding.length;++r){for(var o=this.datatypeBinding[r].compute(n,i),u=0;u<o[0].length;++u){if(!a.State.allowsRebind(o[0][u][0]))throw new s.EvaluationError(this.position,'You simply cannot rebind \"'+o[0][u][0]+'\".');n.setDynamicValue(o[0][u][0],o[0][u][1],a.IdentifierStatus.VALUE_CONSTRUCTOR)}n.setDynamicType(o[1][0],o[1][1]),void 0===this.givenIds[o[1][0]]&&(i.incrementValueIdentifierId(o[1][0]),this.givenIds[o[1][0]]=n.getValueIdentifierId(o[1][0]))}return{newState:n,value:void 0,hasThrown:!1}},DatatypeDeclaration.prototype.toString=function(){for(var t=\"datatype\",e=0;e<this.datatypeBinding.length;++e){e>0&&(t+=\" and\"),t+=\" \"+this.datatypeBinding[e].name.getText()+\" =\";for(var n=0;n<this.datatypeBinding[e].type.length;++n)n>0&&(t+=\" |\"),t+=\" \"+this.datatypeBinding[e].type[n][0].getText(),void 0!==this.datatypeBinding[e].type[n][1]&&(t+=\" of \"+this.datatypeBinding[e].type[n][1])}return t+\";\"},DatatypeDeclaration}(p);exports.DatatypeDeclaration=l;var f=function(t){function DatatypeReplication(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.name=n,o.oldname=i,o.id=r,o}return n(DatatypeReplication,t),DatatypeReplication.prototype.simplify=function(){return this},DatatypeReplication.prototype.elaborate=function(t,e,n,i,a){var u=void 0;if(this.oldname instanceof r.LongIdentifierToken){var p=t.getAndResolveStaticStructure(this.oldname);void 0!==p&&(u=p.getType(this.oldname.id.getText()))}else u=t.getStaticType(this.oldname.getText());if(void 0===u)throw new s.ElaborationError(this.position,'The datatype \"'+this.oldname.getText()+\"\\\" doesn't exist.\");var c=u.type.instantiate(t,e);return t.setStaticType(this.name.getText(),new o.FunctionType(new o.CustomType(this.name.getText(),c.typeArguments,0,this.oldname instanceof r.LongIdentifierToken?this.oldname:void 0),c),[],u.arity,u.allowsEquality),[t,[],e,n]},DatatypeReplication.prototype.evaluate=function(t,e){var n=t.state,i=[];if(this.oldname instanceof r.LongIdentifierToken){var o=n.getAndResolveDynamicStructure(this.oldname);void 0!==o&&(i=o.getType(this.oldname.id.getText()))}else i=n.getDynamicType(this.oldname.getText());if(void 0===i)throw new s.EvaluationError(this.position,'The datatype \"'+this.oldname.getText()+'\" does not exist.');return n.setDynamicType(this.name.getText(),i),{newState:n,value:void 0,hasThrown:!1}},DatatypeReplication.prototype.toString=function(){return\"datatype \"+this.name.getText()+\" = datatype \"+this.oldname.getText()+\";\"},DatatypeReplication}(p);exports.DatatypeReplication=f;var d=function(t){function ExceptionDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.bindings=n,r.id=i,r}return n(ExceptionDeclaration,t),ExceptionDeclaration.prototype.simplify=function(){return this},ExceptionDeclaration.prototype.toString=function(){return\"exception <stuff>;\"},ExceptionDeclaration.prototype.elaborate=function(t,e,n,i,r){var o=new Set;e.forEach(function(t,e){e.includes(\"!\")&&(o=o.add(e.substring(1)))});for(var a=0;a<this.bindings.length;++a)t=this.bindings[a].elaborate(t,i,o,r);return[t,[],e,n]},ExceptionDeclaration.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.bindings.length;++i)this.bindings[i].evaluate(n,t.modifiable);return{newState:n,value:void 0,hasThrown:!1}},ExceptionDeclaration}(p);exports.ExceptionDeclaration=d;var y=function(t){function LocalDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.declaration=n,o.body=i,o.id=r,o}return n(LocalDeclaration,t),LocalDeclaration.prototype.assertUniqueBinding=function(t,e){return this.declaration.assertUniqueBinding(t,e),this.body.assertUniqueBinding(t,e),new Set},LocalDeclaration.prototype.simplify=function(){return new LocalDeclaration(this.position,this.declaration.simplify(),this.body.simplify(),this.id)},LocalDeclaration.prototype.elaborate=function(t,e,n,i,r){var o=[t.getNestedState(0).getNestedState(t.id),[],e,n],a=this.declaration.elaborate(o[0],e,n,!1,r);t.valueIdentifierId=a[0].getIdChanges(0);var s=a[0].getNestedState(t.id);return o=this.body.elaborate(s,a[2],a[3],i,r),s.parent=t,[o[0],a[1].concat(o[1]),o[2],o[3]]},LocalDeclaration.prototype.evaluate=function(t,e){var n=t.state,i=t.modifiable;void 0===t.step&&(t.step=-1);var r=t.step;if(-1===r){var o=n.getNestedState(0),a=o.getNestedState(n.id);return o.insideLocalDeclBody||(o.localDeclStart=!0),t.nstate=a,t.step=r+1,e.push({next:this,params:t}),void e.push({next:this.declaration,params:{state:a,modifiable:i,recResult:void 0}})}if(0===r){var u=t.recResult;if(void 0===u||void 0===u.newState)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");var p=u.newState;if(u.hasThrown)return{newState:n,value:u.value,hasThrown:!0};var a=p.getNestedState(n.id);return a.insideLocalDeclBody=!0,t.nstate=a,t.res=u,t.step=r+1,e.push({next:this,params:t}),void e.push({next:this.body,params:{state:a,modifiable:i,recResult:void 0}})}var c=t.recResult,a=t.nstate,u=t.res;if(void 0===c||void 0===u)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");return a.parent=n,void 0!==c.newState&&(c.newState.insideLocalDeclBody=n.insideLocalDeclBody),c},LocalDeclaration.prototype.toString=function(){var t=\"local \"+this.declaration;return t+=\" in \"+this.body,t+=\" end;\"},LocalDeclaration}(p);exports.LocalDeclaration=y;var v=function(t){function OpenDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.names=n,r.id=i,r}return n(OpenDeclaration,t),OpenDeclaration.prototype.simplify=function(){return this},OpenDeclaration.prototype.elaborate=function(t,e,n,i,o){for(var a=0;a<this.names.length;++a){var u=void 0;if(this.names[a]instanceof r.LongIdentifierToken?void 0!==(u=t.getAndResolveStaticStructure(this.names[a]))&&(u=u.getStructure(this.names[a].id.getText())):u=t.getStaticStructure(this.names[a].getText()),void 0===u)throw new s.EvaluationError(this.position,'Undefined module \"'+this.names[a].getText()+'\".');t.staticBasis.extend(u)}return[t,[],e,n]},OpenDeclaration.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.names.length;++i){var o=void 0;if(this.names[i]instanceof r.LongIdentifierToken?void 0!==(o=n.getAndResolveDynamicStructure(this.names[i]))&&(o=o.getStructure(this.names[i].id.getText())):o=n.getDynamicStructure(this.names[i].getText()),void 0===o)throw new s.EvaluationError(this.position,'Undefined module \"'+this.names[i].getText()+'\".');n.dynamicBasis.extend(o)}return{newState:n,value:void 0,hasThrown:!1}},OpenDeclaration.prototype.toString=function(){for(var t=\"open\",e=0;e<this.names.length;++e)t+=\" \"+this.names[e].getText();return t+\";\"},OpenDeclaration}(p);exports.OpenDeclaration=v;var m=function(t){function EmptyDeclaration(e){void 0===e&&(e=0);var n=t.call(this)||this;return n.id=e,n}return n(EmptyDeclaration,t),EmptyDeclaration.prototype.simplify=function(){return this},EmptyDeclaration.prototype.elaborate=function(t,e,n,i,r){return[t,[],e,n]},EmptyDeclaration.prototype.evaluate=function(t,e){return{newState:t.state,value:void 0,hasThrown:!1}},EmptyDeclaration.prototype.toString=function(){return\" ;\"},EmptyDeclaration}(p);exports.EmptyDeclaration=m;var g=function(t){function SequentialDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.declarations=n,r.id=i,r}return n(SequentialDeclaration,t),SequentialDeclaration.prototype.assertUniqueBinding=function(t,e){for(var n=0;n<this.declarations.length;++n)this.declarations[n].assertUniqueBinding(t,e);return new Set},SequentialDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.declarations.length;++e)t.push(this.declarations[e].simplify());return new SequentialDeclaration(this.position,t,this.id)},SequentialDeclaration.prototype.elaborate=function(t,e,n,i,r){for(var o=this,a=[],u=e,p=n,c=this,h=0;h<this.declarations.length;++h)!function(n){i&&(u=new Map,t.getTypeVariableBinds()[1].forEach(function(t,e){u=u.set(e,t)}));var h=c.declarations[n].elaborate(t.getNestedState(c.declarations[n].id),u,p,i,r);t=h[0],a=a.concat(h[1]),u=h[2];var l=new Map;if(i&&(l=e),h[2].forEach(function(e,n){if(e[1]&&\"~\"===n[1]){var u=e[0].instantiate(t,h[2]).normalize(t.freeTypeVariables[0],r);t.parent.getTypeVariableBinds()[1].has(n)||a.push(new s.Warning(o.position,'The free type variable \"'+n+'\" has been instantiated to \"'+u[0]+'\".\\n')),l=l.set(n,[u[0],!0])}else i||(l=l.set(n,[e[0].instantiate(t,h[2]),!1]))}),u=l,i){t.freeTypeVariables[1]=l;for(var f in t.staticBasis.valueEnvironment)if(t.staticBasis.valueEnvironment.hasOwnProperty(f)){var d=t.staticBasis.valueEnvironment[f],y=d[0].normalize(t.freeTypeVariables[0],r);t.freeTypeVariables[0]=y[1],t.setStaticValue(f,y[0],d[1])}}p=h[3]}(h);return[t,a,u,p]},SequentialDeclaration.prototype.evaluate=function(t,e){var n=t.state;void 0===t.step&&(t.step=-1);var i=t.step;if(i>=0){var r=t.recResult;if(void 0===r||void 0===r.newState)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");if(r.hasThrown)return{newState:r.newState,value:r.value,hasThrown:!0};n=r.newState}if(++i<this.declarations.length){var o=n.getNestedState(this.declarations[i].id);return t.step=i,t.state=n,e.push({next:this,params:t}),void e.push({next:this.declarations[i],params:{state:o,modifiable:t.modifiable,recResult:void 0}})}return{newState:n,value:void 0,hasThrown:!1}},SequentialDeclaration.prototype.toString=function(){for(var t=\"\",e=0;e<this.declarations.length;++e)e>0&&(t+=\" \"),t+=this.declarations[e];return t},SequentialDeclaration}(p);exports.SequentialDeclaration=g;var w=function(t){function FunctionDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.typeVariableSequence=n,o.functionValueBinding=i,o.id=r,o}return n(FunctionDeclaration,t),FunctionDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.functionValueBinding.length;++e)t.push(this.functionValueBinding[e].simplify());return new c(this.position,this.typeVariableSequence,t,this.id)},FunctionDeclaration}(p);exports.FunctionDeclaration=w;var T=function(t){function Evaluation(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return n(Evaluation,t),Evaluation.prototype.simplify=function(){return new c(this.position,[],[new V(this.position,!1,new i.Tuple(-1,[]),this.expression)]).simplify()},Evaluation}(p);exports.Evaluation=T;var E=function(t){function AbstypeDeclaration(e,n,i,r,o){void 0===o&&(o=0);var a=t.call(this)||this;if(a.position=e,a.datatypeBinding=n,a.typeBinding=i,a.declaration=r,a.id=o,void 0!==a.typeBinding)throw new s.FeatureDisabledError(a.position,'Who is \"withtype\"?');return a}return n(AbstypeDeclaration,t),AbstypeDeclaration.prototype.simplify=function(){for(var t=new l(this.position,this.datatypeBinding,void 0,this.id),e=[],n=0;n<this.datatypeBinding.length;++n)e.push(new b(this.datatypeBinding[n].position,this.datatypeBinding[n].typeVariableSequence,this.datatypeBinding[n].name,new o.CustomType(this.datatypeBinding[n].name.getText(),this.datatypeBinding[n].typeVariableSequence)));var i=new h(this.position,e,this.id);return new y(this.position,t,new g(this.position,[i,this.declaration],this.id),this.id).simplify()},AbstypeDeclaration}(p);exports.AbstypeDeclaration=E;var S=function(t){function InfixDeclaration(e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.operators=n,o.precedence=i,o.id=r,o}return n(InfixDeclaration,t),InfixDeclaration.prototype.simplify=function(){return this},InfixDeclaration.prototype.elaborate=function(t,e,n){return[t,[],e,n]},InfixDeclaration.prototype.setInfixStatus=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],this.precedence,!1,!0)},InfixDeclaration.prototype.evaluate=function(t,e){var n=t.state;return this.setInfixStatus(n),{newState:n,value:void 0,hasThrown:!1}},InfixDeclaration.prototype.toString=function(){var t=\"infix\";t+=\" \"+this.precedence;for(var e=0;e<this.operators.length;++e)t+=\" \"+this.operators[e].getText();return t+\";\"},InfixDeclaration}(p);exports.InfixDeclaration=S;var x=function(t){function InfixRDeclaration(e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.operators=n,o.precedence=i,o.id=r,o}return n(InfixRDeclaration,t),InfixRDeclaration.prototype.simplify=function(){return this},InfixRDeclaration.prototype.elaborate=function(t,e,n){return[t,[],e,n]},InfixRDeclaration.prototype.setInfixStatus=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],this.precedence,!0,!0)},InfixRDeclaration.prototype.evaluate=function(t,e){var n=t.state;return this.setInfixStatus(n),{newState:n,value:void 0,hasThrown:!1}},InfixRDeclaration.prototype.toString=function(){var t=\"infixr\";t+=\" \"+this.precedence;for(var e=0;e<this.operators.length;++e)t+=\" \"+this.operators[e].getText();return t+\";\"},InfixRDeclaration}(p);exports.InfixRDeclaration=x;var I=function(t){function NonfixDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.operators=n,r.id=i,r}return n(NonfixDeclaration,t),NonfixDeclaration.prototype.simplify=function(){return this},NonfixDeclaration.prototype.elaborate=function(t,e,n){return[t,[],e,n]},NonfixDeclaration.prototype.setInfixStatus=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],0,!1,!1)},NonfixDeclaration.prototype.evaluate=function(t,e){var n=t.state;return this.setInfixStatus(n),{newState:n,value:void 0,hasThrown:!1}},NonfixDeclaration.prototype.toString=function(){for(var t=\"nonfix\",e=0;e<this.operators.length;++e)t+=\" \"+this.operators[e].getText();return t+\";\"},NonfixDeclaration}(p);exports.NonfixDeclaration=I;var V=function(){function ValueBinding(t,e,n,i){this.position=t,this.isRecursive=e,this.pattern=n,this.expression=i}return ValueBinding.prototype.toString=function(){var t=\"\";return this.isRecursive&&(t+=\"rec \"),t+=this.pattern,(t+=\" = \")+this.expression},ValueBinding.prototype.getType=function(t,e,n,i,r){var a=this,u=e.getNestedState(e.id),p=new Map;n.forEach(function(t,e){p=p.set(e,t)});var c=this.expression.getType(u,p,i),h=this.pattern.matchType(u,c[4],c[0]),l=new Set;if(void 0===h)throw new s.ElaborationError(this.position,'Type clash. An expression of type \"'+c[0]+'\" cannot be assigned to \"'+h[1]+'\".');for(var f=[],d=new Set,y=0;y<t.length;++y){if(d.has(t[y].name))throw new s.ElaborationError(t[y].position,'I will not let a duplicate type variable name \"'+t[y].name+'\" disturb my Happy Sugar Life.');d=d.add(t[y].name);var v=t[y].instantiate(e,h[2]);if(!(v instanceof o.TypeVariable)||v.domain.length>0||t[y].admitsEquality(e)!==v.admitsEquality(e))throw new s.ElaborationError(this.position,'Type clash. An expression of explicit type \"'+t[y]+'\" cannot have type \"'+v.normalize()[0]+'\".');f.push(v)}this.expression.getExplicitTypeVariables().forEach(function(t){var n=t.instantiate(e,h[2]);if(!(n instanceof o.TypeVariable)||n.domain.length>0||t.admitsEquality(e)!==n.admitsEquality(e))throw new s.ElaborationError(a.position,'Type clash. An expression of explicit type \"'+t+'\" cannot have type \"'+n.normalize()[0]+'\".')});for(var m=!this.isRecursive&&!this.expression.isSafe(e),g=!1,y=0;y<h[0].length;++y)!function(t){h[0][t][1]=h[0][t][1].instantiate(e,h[2]),r||(h[2]=h[2].set(\"'**\"+h[0][t][0],[h[0][t][1],!1]));for(var n=h[0][t][1].getTypeVariables(),i=h[0][t][1].getTypeVariables(!0),a=new Set,s=f.length-1;s>=0;--s)if(n.has(f[s].name)){var u=n.get(f[s].name);h[2].has(\"$\"+f[s].name)&&(u=o.TypeVariable.mergeDomain(u,h[2].get(\"$\"+f[s].name)[0].domain)),h[0][t][1]=new o.TypeVariableBind(f[s].name,h[0][t][1],u),h[0][t][1].isFree=0===h[0][t][1].domain.length&&(m||i.has(f[s].name)),g=g||h[0][t][1].isFree,a.add(f[s].name)}f=[],h[0][t][1].getTypeVariables().forEach(function(t,e){if((r||!l.has(e))&&!a.has(e)){var n=t;h[2].has(\"$\"+e)&&(n=o.TypeVariable.mergeDomain(n,h[2].get(\"$\"+e)[0].domain)),f.push(new o.TypeVariable(e,0,n))}});for(var s=f.length-1;s>=0;--s)h[0][t][1]=new o.TypeVariableBind(f[s].name,h[0][t][1],f[s].domain),h[0][t][1].isFree=0===h[0][t][1].domain.length&&(m||i.has(f[s].name)),g=g||h[0][t][1].isFree}(y);return g&&r&&c[1].push(new s.Warning(this.position,\"Free type variables at top level.\\n\")),[h[0],c[1],h[2],c[2],c[5]]},ValueBinding}();exports.ValueBinding=V;var k=function(){function FunctionValueBinding(t,e,n){this.position=t,this.parameters=e,this.name=n}return FunctionValueBinding.prototype.simplify=function(){if(void 0===this.name)throw new s.InternalInterpreterError(this.position,\"This function isn't ready to be simplified yet.\");for(var t=[],e=[],n=0;n<this.parameters[0][0].length;++n)t.push(new i.ValueIdentifier(-1,new r.IdentifierToken(\"__arg\"+n,-1)));for(var n=0;n<this.parameters.length;++n){var o=void 0;o=1===this.parameters[n][0].length?this.parameters[n][0][0]:new i.Tuple(-1,this.parameters[n][0]),void 0===this.parameters[n][1]?e.push([o,this.parameters[n][2]]):e.push([o,new i.TypedExpression(-1,this.parameters[n][2],this.parameters[n][1])])}var a;a=1!==t.length?new i.Tuple(-1,t).simplify():t[0];var u,p=new i.Match(-1,e);u=new i.CaseAnalysis(-1,a,p);for(var n=this.parameters[0][0].length-1;n>=0;--n)u=new i.Lambda(-1,new i.Match(-1,[[new i.ValueIdentifier(-1,new r.IdentifierToken(\"__arg\"+n,-1)),u]]));return new V(this.position,!0,this.name,u.simplify())},FunctionValueBinding.prototype.toString=function(){for(var t=\"\",e=0;e<this.parameters.length;++e){e>0&&(t+=\" | \"),t+=this.name.name.getText();for(var n=0;n<this.parameters[e][0].length;++n)t+=\" \"+this.parameters[e][0][n];void 0!==this.parameters[e][1]&&(t+=\": \"+this.parameters[e][1]),t+=\" = \"+this.parameters[e][2]}return t},FunctionValueBinding}();exports.FunctionValueBinding=k;var b=function(){function TypeBinding(t,e,n,i){this.position=t,this.typeVariableSequence=e,this.name=n,this.type=i}return TypeBinding}();exports.TypeBinding=b;var A=function(){function DatatypeBinding(t,e,n,i,r){void 0===r&&(r={}),this.position=t,this.typeVariableSequence=e,this.name=n,this.type=i,this.givenIds=r}return DatatypeBinding.prototype.getType=function(t,e){var n=[],i=[],r=t.getNestedState(t.id),a=t.getValueIdentifierId(this.name.getText());r.incrementValueIdentifierId(this.name.getText());var u=new o.CustomType(this.name.getText(),this.typeVariableSequence,-1,void 0,!1,0),p=new o.CustomType(this.name.getText(),this.typeVariableSequence,-1,void 0,!1,a);r.setStaticType(this.name.getText(),p,[],this.typeVariableSequence.length,!0);for(var c=this,h=0;h<this.type.length;++h)!function(t){var e=p;if(void 0!==c.type[t][1]){var r=c.type[t][1].replace(u,p);e=new o.FunctionType(r,e)}for(var a=new Set,h=0;h<c.typeVariableSequence.length;++h){if(a.has(c.typeVariableSequence[h].name))throw new s.ElaborationError(c.typeVariableSequence[h].position,\"I'm not interested in duplicate type variable names such as \\\"\"+c.typeVariableSequence[h]+'\".');a=a.add(c.typeVariableSequence[h].name)}var l=[];if(e.getTypeVariables().forEach(function(t,n){a.has(n)?e=new o.TypeVariableBind(n,e,t):l.push(n)}),l.length>0)throw s.ElaborationError.getUnguarded(c.position,l);i.push([c.type[t][0].getText(),e]),n.push(c.type[t][0].getText())}(h);return[i,p,[this.name.getText(),n]]},DatatypeBinding.prototype.compute=function(t,e){for(var n=[],i=[],r=0;r<this.type.length;++r){var o=0;void 0!==this.type[r][1]&&(o=1);var a=-1;void 0===this.givenIds[this.type[r][0].getText()]?(a=e.getValueIdentifierId(this.type[r][0].getText()),e.incrementValueIdentifierId(this.type[r][0].getText()),this.givenIds[this.type[r][0].getText()]=a):a=this.givenIds[this.type[r][0].getText()],i.push([this.type[r][0].getText(),new u.ValueConstructor(this.type[r][0].getText(),o,a)]),n.push(this.type[r][0].getText())}return[i,[this.name.getText(),n]]},DatatypeBinding}();exports.DatatypeBinding=A;var L=function(){function DirectExceptionBinding(t,e,n){this.position=t,this.name=e,this.type=n}return DirectExceptionBinding.prototype.elaborate=function(t,e,n,i){if(void 0!==this.type){var r=this.type.simplify().instantiate(t,new Map),u=[];if(r.getTypeVariables().forEach(function(t,e){u.push(e)}),e&&u.length>0)throw s.ElaborationError.getUnguarded(this.position,u);t.setStaticValue(this.name.getText(),new o.FunctionType(r.makeFree(),new o.CustomType(\"exn\")),a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)}else t.setStaticValue(this.name.getText(),new o.CustomType(\"exn\"),a.IdentifierStatus.EXCEPTION_CONSTRUCTOR);return t},DirectExceptionBinding.prototype.evaluate=function(t,e){var n=0;void 0!==this.type&&(n=1);var i=t.getValueIdentifierId(this.name.getText());t.incrementValueIdentifierId(this.name.getText());var r=e.getNextExceptionEvalId();if(!a.State.allowsRebind(this.name.getText()))throw new s.EvaluationError(this.position,'You simply cannot rebind \"'+this.name.getText()+'\".');t.setDynamicValue(this.name.getText(),new u.ExceptionConstructor(this.name.getText(),n,i,r),a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)},DirectExceptionBinding}();exports.DirectExceptionBinding=L;var R=function(){function ExceptionAlias(t,e,n){this.position=t,this.name=e,this.oldname=n}return ExceptionAlias.prototype.elaborate=function(t,e,n){var i=void 0;if(this.oldname instanceof r.LongIdentifierToken){var o=t.getAndResolveStaticStructure(this.oldname);void 0!==o&&(i=o.getValue(this.oldname.id.getText()))}else i=t.getStaticValue(this.oldname.getText());if(void 0===i)throw new s.ElaborationError(this.position,'Unbound value identifier \"'+this.oldname.getText()+'\".');if(i[1]!==a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)throw new s.ElaborationError(this.position,'You cannot transform \"'+i[0]+'\" into an exception.');return t.setStaticValue(this.name.getText(),i[0].normalize()[0],a.IdentifierStatus.EXCEPTION_CONSTRUCTOR),t},ExceptionAlias.prototype.evaluate=function(t,e){var n=void 0;if(this.oldname instanceof r.LongIdentifierToken){var i=t.getAndResolveDynamicStructure(this.oldname);void 0!==i&&(n=i.getValue(this.oldname.id.getText()))}else n=t.getDynamicValue(this.oldname.getText());if(void 0===n)throw new s.EvaluationError(this.position,'Unbound value identifier \"'+this.oldname.getText()+'\".');if(n[1]!==a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)throw new s.EvaluationError(this.position,'You cannot transform \"'+n[0].toString(t,40)+'\" into an exception.');t.setDynamicValue(this.name.getText(),n[0],a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)},ExceptionAlias}();exports.ExceptionAlias=R},function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=e(4),r=e(5),o=e(1),a=e(3),s=e(0),u=e(2),p=function(){function Expression(){}return Expression.prototype.getType=function(t,e,n,i,r){throw void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1),new s.InternalInterpreterError(this.position,'Called \"getType\" on a derived form.')},Expression.prototype.compute=function(t,e){throw new s.InternalInterpreterError(this.position,'Called \"getValue\" on a derived form.')},Expression.prototype.isSafe=function(t){return!0},Expression.prototype.getExplicitTypeVariables=function(){return new Set},Expression.prototype.toString=function(){throw new s.InternalInterpreterError(this.position,\"You humans can't seem to write bug-free code. What an inferior species.\")},Expression.prototype.assertUniqueBinding=function(t,e){return new Set},Expression}();exports.Expression=p;var c=function(t){function Constant(e,n){var i=t.call(this)||this;return i.position=e,i.token=n,i}return n(Constant,t),Constant.prototype.matchType=function(t,e,n){return[[],this.getType(t,e)[0],e]},Constant.prototype.matches=function(t,e){var n=this.compute({state:t,modifiable:t,recResult:void 0},[]);if(void 0===n||void 0===n.value)throw new s.InternalInterpreterError(this.token.position,\"How is this undefined?\");return n.value.equals(e)?[]:void 0},Constant.prototype.getType=function(t,e,n,r,a){if(void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===a&&(a=!1),this.token instanceof o.IntegerConstantToken||this.token instanceof o.NumericToken)return[new i.CustomType(\"int\"),[],n,r,e,t.valueIdentifierId];if(this.token instanceof o.RealConstantToken)return[new i.CustomType(\"real\"),[],n,r,e,t.valueIdentifierId];if(this.token instanceof o.WordConstantToken)return[new i.CustomType(\"word\"),[],n,r,e,t.valueIdentifierId];if(this.token instanceof o.CharacterConstantToken)return[new i.CustomType(\"char\"),[],n,r,e,t.valueIdentifierId];if(this.token instanceof o.StringConstantToken)return[new i.CustomType(\"string\"),[],n,r,e,t.valueIdentifierId];throw new s.InternalInterpreterError(this.token.position,'\"'+this+'\" does not seem to be a valid constant.')},Constant.prototype.simplify=function(){return this},Constant.prototype.toString=function(){return this.token.getText()},Constant.prototype.compute=function(t,e){var n=void 0;if(this.token instanceof o.IntegerConstantToken||this.token instanceof o.NumericToken?n=new u.Integer(this.token.value):this.token instanceof o.RealConstantToken?n=new u.Real(this.token.value):this.token instanceof o.WordConstantToken?n=new u.Word(this.token.value):this.token instanceof o.CharacterConstantToken?n=new u.CharValue(this.token.value):this.token instanceof o.StringConstantToken&&(n=new u.StringValue(this.token.value)),void 0===n)throw new s.EvaluationError(this.token.position,\"You sure that this is a constant?\");return{newState:void 0,value:n,hasThrown:!1}},Constant}(p);exports.Constant=c;var h=function(t){function ValueIdentifier(e,n){var i=t.call(this)||this;return i.position=e,i.name=n,i}return n(ValueIdentifier,t),ValueIdentifier.prototype.getType=function(t,e,n,r,u){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===u&&(u=!1);var p=void 0;if(this.name instanceof o.LongIdentifierToken){var c=t.getAndResolveStaticStructure(this.name);if(void 0!==c&&void 0!==(p=c.getValue(this.name.id.getText()))){var h=new a.State(0,void 0,c,t.dynamicBasis,[0,{}],4);p=[p[0].qualify(h,this.name),p[1]]}}else p=t.getStaticValue(this.name.getText());var l=e,f=!1;if(void 0===p||p[1]===a.IdentifierStatus.VALUE_VARIABLE){var d=new i.TypeVariable(\"'**\"+this.name.getText());if(u)p=[new i.TypeVariableBind(\"'**\"+this.name.getText(),d),0],f=!0;else{if(e.has(d.name)){return[e.get(d.name)[0].instantiate(t,l),[],n,r,l,t.valueIdentifierId]}if(void 0===p)throw new s.ElaborationError(this.position,'Unbound value identifier \"'+this.name.getText()+'\".')}}for(var y=new Set,v=new Set,m=new Map;p[0]instanceof i.TypeVariableBind;)p[0].isFree?(v=v.add(p[0].name),m=m.set(p[0].name,p[0].name)):y=y.add(p[0].name),p[0]=p[0].type;y=y.add(\"*\");var g=[];y.forEach(function(i){for(var o=+n.substring(3)+1,a=\"\";;++o)if(n=\"'\"+n[1]+n[2]+o,!y.has(n)&&!r.has(n)&&!e.has(n)&&void 0===t.getStaticValue(n)){a=\"'\"===i[1]?\"'\"+n:n,g.push(a),m=m.set(i,a);break}});for(var w=0;w<g.length;++w)r=r.add(g[w]);var T=p[0].replaceTypeVariables(m,v).instantiate(t,l);return f&&(l=l.set(\"'**\"+this.name.getText(),[T,!1])),[T,[],n,r,l,t.valueIdentifierId]},ValueIdentifier.prototype.matchType=function(t,e,n){if(this.name instanceof o.LongIdentifierToken)throw new s.ElaborationError(this.position,\"Variable names in patterns cannot be qualified.\");var r=t.getStaticValue(this.name.getText());if(void 0===r||r[1]===a.IdentifierStatus.VALUE_VARIABLE)return[[[this.name.getText(),n.instantiate(t,e)]],n.instantiate(t,e),e];var u=this.getType(t,e,\"'*g0\");u[3].forEach(function(t){var e=\"'*p\"+t.substring(3);\"'\"===t[1]&&(e=\"''*p\"+t.substring(4)),u[4]=u[4].set(t,[new i.TypeVariable(e),!1])}),r[0]=u[0],e=u[4];try{var p=n.merge(t,e,r[0]);return[[],p[0],p[1]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,'Type clash: \"'+n.normalize()[0]+'\" vs. \"'+r[0].normalize()[0]+'\": '+t[0])}},ValueIdentifier.prototype.matches=function(t,e){if(this.name instanceof o.LongIdentifierToken)throw new s.EvaluationError(this.position,\"Variable names in patterns cannot be qualified.\");var n=t.getDynamicValue(this.name.getText());if(void 0===n||n[1]===a.IdentifierStatus.VALUE_VARIABLE)return[[this.name.getText(),e]];try{if(e.equals(n[0]))return[]}catch(t){return[[this.name.getText(),e]]}},ValueIdentifier.prototype.simplify=function(){return this},ValueIdentifier.prototype.toString=function(){return this.name.getText()},ValueIdentifier.prototype.compute=function(t,e){var n=t.state,i=void 0;if(this.name instanceof o.LongIdentifierToken){var r=n.getAndResolveDynamicStructure(this.name);void 0!==r&&(i=r.getValue(this.name.id.getText()))}else i=n.getDynamicValue(this.name.getText());if(void 0===i)throw new s.EvaluationError(this.position,'Unbound value identifier \"'+this.name.getText()+'\".');return i[1]===a.IdentifierStatus.VALUE_CONSTRUCTOR&&0===i[0].numArgs?{newState:void 0,value:i[0].construct(),hasThrown:!1}:i[1]===a.IdentifierStatus.EXCEPTION_CONSTRUCTOR&&0===i[0].numArgs?{newState:void 0,value:i[0].construct(),hasThrown:!1}:{newState:void 0,value:i[0],hasThrown:!1}},ValueIdentifier.prototype.assertUniqueBinding=function(t,e){if(e.has(this.name.getText()))return new Set;var n=t.getStaticValue(this.name.getText());if(void 0!==n&&n[1]!==a.IdentifierStatus.VALUE_VARIABLE)return new Set;var i=t.getDynamicValue(this.name.getText());return void 0!==i&&i[1]!==a.IdentifierStatus.VALUE_VARIABLE?new Set:(new Set).add(this.name.getText())},ValueIdentifier}(p);exports.ValueIdentifier=h;var l=function(t){function Record(e,n,i){var r=t.call(this)||this;r.position=e,r.complete=n,r.entries=i,r.entries.sort();for(var o=1;o<r.entries.length;++o)if(r.entries[o][0]===r.entries[o-1][0])throw new s.ElaborationError(r.position,'Label \"'+r.entries[o][0]+'\" occurs more than once in the same record.');return r}return n(Record,t),Record.prototype.getExplicitTypeVariables=function(){for(var t=new Set,e=0;e<this.entries.length;++e)this.entries[e][1].getExplicitTypeVariables().forEach(function(e){t=t.add(e)});return t},Record.prototype.getEntry=function(t){for(var e=0;e<this.entries.length;++e)if(this.entries[e][0]===t)return this.entries[e][1];throw new s.InternalInterpreterError(this.position,'Yeah, \"'+t+'\" would be nice to have.')},Record.prototype.isSafe=function(t){for(var e=0;e<this.entries.length;++e)if(!this.entries[e][1].isSafe(t))return!1;return!0},Record.prototype.matchType=function(t,e,n){if(n instanceof i.RecordType||(n=n.instantiate(t,e)),n instanceof i.TypeVariable){for(var r=new Map,o=0;o<this.entries.length;++o){var a=new i.TypeVariable(n.name+\"*\"+o);a.isFree=n.isFree,r=r.set(this.entries[o][0],a)}var u=new i.RecordType(r,this.complete);e=e.set(n.name,[u,n.isFree]),n=u}if(!(n instanceof i.RecordType))throw new s.ElaborationError(this.position,'Expected pattern of a record type, got \"'+n.constructor.name+'\".');if(this.complete&&this.entries.length!==n.elements.size)throw new s.ElaborationError(this.position,\"Expected a record type with \"+this.entries.length+\" entries, but the given one has \"+n.elements.size+\".\");for(var p=[],c=new Map,h=e,o=0;o<this.entries.length;++o){if(!n.hasType(this.entries[o][0]))throw new s.ElaborationError(this.position,\"I am mad scientist. Sunovabitch!\");var l=this.entries[o][1].matchType(t,h,n.getType(this.entries[o][0]));p=p.concat(l[0]),c=c.set(this.entries[o][0],l[1]),h=l[2]}return[p,new i.RecordType(c),h]},Record.prototype.matches=function(t,e){if(e instanceof u.RecordValue&&(!this.complete||this.entries.length===e.entries.size)){for(var n=[],i=0;i<this.entries.length;++i){if(!e.hasValue(this.entries[i][0]))return;var r=this.entries[i][1].matches(t,e.getValue(this.entries[i][0]));if(void 0===r)return r;for(var o=0;o<r.length;++o)n.push(r[o])}return n}},Record.prototype.getType=function(t,e,n,r,o){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===o&&(o=!1);for(var u=new Map,p=[],c=e,l=0;l<this.entries.length;++l){var f=this.entries[l][0],d=this.entries[l][1];if(u.has(f))throw new s.ElaborationError(this.position,'Label \"'+f+'\" occurs more than once in the same record.');if(d instanceof h&&o){var y=t.getStaticValue(d.name.getText());if(void 0!==y&&y[1]!==a.IdentifierStatus.VALUE_VARIABLE&&y[0]instanceof i.FunctionType)throw new s.ElaborationError(d.position,\"Unary constructor in the pattern needs an argument.\")}var v=d.getType(t,c,n,r,o);p=p.concat(v[1]),n=v[2],r=v[3],v[4].forEach(function(t,e){c=c.set(e,t)}),t.valueIdentifierId=v[5],u=u.set(f,v[0])}return[new i.RecordType(u,this.complete),p,n,r,c,t.valueIdentifierId]},Record.prototype.simplify=function(){for(var t=[],e=0;e<this.entries.length;++e){var n=this.entries[e];t.push([n[0],n[1].simplify()])}return new Record(this.position,this.complete,t)},Record.prototype.toString=function(){for(var t=\"{\",e=!0,n=0;n<this.entries.length;++n)e||(t+=\", \"),e=!1,t+=this.entries[n][0]+\" = \"+this.entries[n][1];return this.complete||(e||(t+=\", \"),t+=\"...\"),t+\"}\"},Record.prototype.compute=function(t,e){var n=t.state;void 0===t.step&&(t.step=-1,t.nentr=new Map);var i=t.nentr,r=t.step;if(r>=0){var o=t.recResult;if(void 0===o)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");if(o.hasThrown)return{newState:void 0,value:o.value,hasThrown:!0};i=i.set(this.entries[r][0],o.value)}return++r,r<this.entries.length?(t.step=r,t.nentr=i,e.push({next:this,params:t}),void e.push({next:this.entries[r][1],params:{state:n,modifiable:t.modifiable,recResult:void 0}})):{newState:void 0,value:new u.RecordValue(i),hasThrown:!1}},Record.prototype.assertUniqueBinding=function(t,e){for(var n=this,i=new Set,r=0;r<this.entries.length;++r){this.entries[r][1].assertUniqueBinding(t,e).forEach(function(t){if(i.has(t))throw new s.ParserError(\"Don't try to rebind \\\"\"+t+'\" \"'+t+'\" in the same pattern... Sorry, I stuttered.',n.position);i=i.add(t)})}return i},Record}(p);exports.Record=l;var f=function(t){function LocalDeclarationExpression(e,n,i){var r=t.call(this)||this;return r.position=e,r.declaration=n,r.expression=i,r}return n(LocalDeclarationExpression,t),LocalDeclarationExpression.prototype.simplify=function(){return new LocalDeclarationExpression(this.position,this.declaration.simplify(),this.expression.simplify())},LocalDeclarationExpression.prototype.toString=function(){var t=\"let \"+this.declaration;return t+=\" in \"+this.expression+\" end\"},LocalDeclarationExpression.prototype.isSafe=function(t){return!1},LocalDeclarationExpression.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=t.getNestedState(t.id),s=new Map;e.forEach(function(n,i){if(\"*\"===i[1]&&\"*\"===i[2]){var r=i.substring(3),u=n[0].instantiate(t,e);o.setStaticValue(r,u,a.IdentifierStatus.VALUE_VARIABLE)}s=s.set(i,n)});var u=this.declaration.elaborate(o,s,n),p=new Map;u[2].forEach(function(t,e){p=p.set(e,t)});var c=this.expression.getType(u[0],p,u[3],i,r);return[c[0],u[1].concat(c[1]),c[2],c[3],c[4],c[5]]},LocalDeclarationExpression.prototype.compute=function(t,e){var n=t.state;void 0===t.step&&(t.step=-1);var i=t.step;if(-1===i){var r=n.getNestedState(0).getNestedState(n.id);return t.step=i+1,t.state=n,e.push({next:this,params:t}),void e.push({next:this.declaration,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}if(0===i){var o=t.recResult;if(void 0===o||void 0===o.newState)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");var r=o.newState;return o.hasThrown?{newState:void 0,value:o.value,hasThrown:!0}:void e.push({next:this.expression,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}var a=t.recResult;if(void 0===a)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");return{newState:void 0,value:a.value,hasThrown:a.hasThrown}},LocalDeclarationExpression.prototype.assertUniqueBinding=function(t,e){return this.declaration.assertUniqueBinding(t,e),this.expression.assertUniqueBinding(t,e),new Set},LocalDeclarationExpression}(p);exports.LocalDeclarationExpression=f;var d=function(t){function TypedExpression(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.typeAnnotation=i,r}return n(TypedExpression,t),TypedExpression.prototype.getExplicitTypeVariables=function(){var t=new Set;return this.typeAnnotation.getTypeVariables().forEach(function(e,n){t=t.add(new i.TypeVariable(n,0,e))}),t},TypedExpression.prototype.isSafe=function(t){return this.expression.isSafe(t)},TypedExpression.prototype.matchType=function(t,e,n){var i=this.expression.matchType(t,e,n);try{for(var r=i[1].merge(t,i[2],this.typeAnnotation.instantiate(t,i[2])),o=0;o<i[0].length;++o)i[0][o][1]=i[0][o][1].instantiate(t,r[1]);return[i[0],r[0],r[1]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,'The annotated type \"'+this.typeAnnotation+'\" does not match the expression\\'s type \"'+i[1].normalize()[0]+'\": '+t[0])}},TypedExpression.prototype.matches=function(t,e){return this.expression.matches(t,e)},TypedExpression.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=this.expression.getType(t,e,n,i,r);try{var a=this.typeAnnotation.instantiate(t,o[4]),u=o[0].merge(t,o[4],a);return[u[0],o[1],o[2],o[3],u[1],o[5]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,'The specified type \"'+this.typeAnnotation+'\" does not match the annotated expression\\'s type \"'+o[0].normalize()[0]+'\": '+t[0])}},TypedExpression.prototype.simplify=function(){return new TypedExpression(this.position,this.expression.simplify(),this.typeAnnotation.simplify())},TypedExpression.prototype.toString=function(){var t=\"( \"+this.expression;return(t+=\": \"+this.typeAnnotation)+\" )\"},TypedExpression.prototype.compute=function(t,e){return this.expression.compute(t,e)},TypedExpression.prototype.assertUniqueBinding=function(t,e){return this.expression.assertUniqueBinding(t,e)},TypedExpression}(p);exports.TypedExpression=d;var y=function(t){function FunctionApplication(e,n,i){var r=t.call(this)||this;return r.position=e,r.func=n,r.argument=i,r}return n(FunctionApplication,t),FunctionApplication.prototype.getExplicitTypeVariables=function(){var t=new Set;return this.func.getExplicitTypeVariables().forEach(function(e){t=t.add(e)}),this.argument.getExplicitTypeVariables().forEach(function(e){t=t.add(e)}),t},FunctionApplication.prototype.isSafe=function(t){if(!(this.func instanceof h))return!1;var e=t.getStaticValue(this.func.name.getText());return void 0!==e&&\"ref\"!==this.func.name.getText()&&e[1]!==a.IdentifierStatus.VALUE_VARIABLE},FunctionApplication.prototype.matchType=function(t,e,n){if(!(this.func instanceof h))throw new s.ElaborationError(this.position,\"Non-identifier applied to a pattern.\");var r=t.getStaticValue(this.func.name.getText());if(void 0===r||r[1]===a.IdentifierStatus.VALUE_VARIABLE)throw new s.ElaborationError(this.position,'Expected a constructor, \"'+this.func.name.getText()+\"\\\" isn't.\");var o=this.func.getType(t,e,\"'g0\");if(o[3].forEach(function(t){var e=\"'p\"+t.substring(2);\"'\"===t[1]&&(e=\"''p\"+t.substring(3)),o[4]=o[4].set(t,[new i.TypeVariable(e),!1])}),r[0]=o[0],e=o[4],!(r[0]instanceof i.FunctionType))throw new s.ElaborationError(this.position,\"This is truly more...slothful.\");try{var u=r[0],p=u.returnType.merge(t,e,n),c=this.argument.matchType(t,p[1],u.parameterType.instantiate(t,p[1]));return[c[0],p[0],c[2]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Merge failed: \"+t[0])}},FunctionApplication.prototype.matches=function(t,e){if(e instanceof u.FunctionValue)throw new s.EvaluationError(this.position,\"You simply cannot match function values.\");if(e instanceof u.ConstructedValue){if(this.func instanceof h&&this.func.name.getText()===e.constructorName&&\"ref\"!==this.func.name.getText())return void 0!==e.argument?this.argument.matches(t,e.argument):[]}else if(e instanceof u.ExceptionValue){var n=t.getDynamicValue(this.func.name.getText());if(void 0===n)throw new s.InternalInterpreterError(this.position,\"How did you match something that does not exist?\");var i=n[0];if(this.func instanceof h&&i instanceof u.ExceptionConstructor&&this.func.name.getText()===e.constructorName&&i.id===e.id&&i.evalId===e.evalId)return void 0!==e.argument?this.argument.matches(t,e.argument):[]}else{if(e instanceof u.PredefinedFunction)throw new s.EvaluationError(this.position,\"You simply cannot match predefined functions.\");if(!(e instanceof u.ReferenceValue))throw new s.EvaluationError(this.position,\"Help me, I'm broken. (\"+e.constructor.name+\").\");if(this.func instanceof h&&\"ref\"===this.func.name.getText())return this.argument.matches(t,t.getCell(e.address))}},FunctionApplication.prototype.getType=function(t,e,n,r,u){if(void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===u&&(u=!1),u&&this.func instanceof h)if(this.func.name instanceof o.LongIdentifierToken){var p=t.getAndResolveStaticStructure(this.func.name);if(void 0===p||void 0===p.getValue(this.func.name.id.getText()))throw new s.ElaborationError(this.position,'\"'+this.func.name.getText()+'\" is not a constructor.')}else{var c=t.getStaticValue(this.func.name.getText());if(void 0===c||c[1]===a.IdentifierStatus.VALUE_VARIABLE)throw new s.ElaborationError(this.position,'\"'+this.func.name.getText()+'\" is not a constructor.')}var l=this.func.getType(t,e,n,r,u);t.valueIdentifierId=l[5];var f=new Map;l[4].forEach(function(t,e){f=f.set(e,t)});var d=this.argument.getType(t,f,l[2],l[3],u);if(d[4].forEach(function(t,e){l[4]=l[4].set(e,t)}),l[0]=l[0].instantiate(t,l[4]),l[0]instanceof i.TypeVariable){var y=new i.TypeVariable(l[0].name+\"*a\"),v=new i.TypeVariable(l[0].name+\"*b\");y.isFree=l[0].isFree,v.isFree=l[0].isFree;var m=new i.FunctionType(y,v);l[4]=l[4].set(l[0].name,[m,l[0].isFree]),l[0]=m}if(l[0]instanceof i.AnyType&&(l[0]=new i.FunctionType(new i.AnyType,new i.AnyType)),!(l[0]instanceof i.FunctionType))throw new s.ElaborationError(this.func.position,'\"'+this.func+'\" of type \"'+l[0].normalize()[0]+'\" is not a function.');try{var g=l[0].parameterType.merge(t,l[4],d[0]),w=l[0].returnType;return l[0].parameterType instanceof i.RecordType&&!l[0].parameterType.complete&&(w=w.replace(l[0].parameterType,g[0])),[w.instantiate(t,g[1]),l[1].concat(d[1]),d[2],d[3],g[1],d[5]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,'Type clash. Functions of type \"'+l[0].normalize()[0]+'\" cannot take an argument of type \"'+d[0].normalize()[0]+'\": '+t[0])}},FunctionApplication.prototype.simplify=function(){return new FunctionApplication(this.position,this.func.simplify(),this.argument.simplify())},FunctionApplication.prototype.toString=function(){var t=\"( \"+this.func;return(t+=\" \"+this.argument)+\" )\"},FunctionApplication.prototype.compute=function(t,e){var n=t.state,i=t.modifiable;void 0===t.step&&(t.step=-1);var r=t.step;if(-1===r)return t.step=r+1,t.state=n,e.push({next:this,params:t}),void e.push({next:this.func,params:{state:n,modifiable:i,recResult:void 0}});if(0===r){var o=t.recResult;if(void 0===o)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");return o.hasThrown?o:(t.step=r+1,t.state=n,t.funcVal=o,e.push({next:this,params:t}),void e.push({next:this.argument,params:{state:n,modifiable:i,recResult:void 0}}))}if(1===r){var o=t.funcVal,a=t.recResult;if(void 0===o||void 0===o.value)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");if(void 0===a||void 0===a.value)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");if(a.hasThrown)return{newState:void 0,value:a.value,hasThrown:!0};if(o.value instanceof u.FunctionValue)return void o.value.compute(e,a.value,i);if(o.value instanceof u.ValueConstructor)return{newState:void 0,value:o.value.construct(a.value),hasThrown:!1};if(o.value instanceof u.ExceptionConstructor)return{newState:void 0,value:o.value.construct(a.value),hasThrown:!1};if(o.value instanceof u.PredefinedFunction){for(var p=o.value.apply(a.value,t),c=0,h=p[2];c<h.length;c++){var l=h[c];i.addWarning(l)}return{newState:void 0,value:p[0],hasThrown:p[1]}}throw new s.EvaluationError(this.position,'Cannot evaluate the function \"'+this.func+'\" ('+o[0].constructor.name+\").\")}var p=t.recResult;if(void 0===p)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");return{newState:void 0,value:p.value,hasThrown:p.hasThrown}},FunctionApplication.prototype.assertUniqueBinding=function(t,e){var n=this.func.assertUniqueBinding(t,e),i=this.argument.assertUniqueBinding(t,e);return this.func instanceof h&&0===n.size?i:new Set},FunctionApplication}(p);exports.FunctionApplication=y;var v=function(t){function HandleException(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.match=i,r}return n(HandleException,t),HandleException.prototype.getExplicitTypeVariables=function(){return this.expression.getExplicitTypeVariables()},HandleException.prototype.isSafe=function(t){return this.expression.isSafe(t)},HandleException.prototype.simplify=function(){return new HandleException(this.position,this.expression.simplify(),this.match.simplify())},HandleException.prototype.toString=function(){var t=\"( \"+this.expression+\" )\";return t+=\" handle \"+this.match},HandleException.prototype.getType=function(t,e,n,r,o){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===o&&(o=!1);var a=this.match.getType(t,e,n,r,o,!1);if(!(a[0]instanceof i.FunctionType))throw new s.ElaborationError(this.match.position,'You can only handle things of type \"exn\" and not \"'+a[0].parameterType.normalize()[0]+'\".');try{a[0].parameterType.merge(t,a[4],new i.CustomType(\"exn\"))}catch(t){throw new s.ElaborationError(this.match.position,'You can only handle things of type \"exn\" and not \"'+a[0].parameterType.normalize()[0]+'\".')}var u=a[0].returnType;t.valueIdentifierId=a[5];var p=this.expression.getType(t,a[4],a[2],a[3],o);try{var c=u.merge(t,p[4],p[0]);return[c[0],a[1].concat(p[1]),p[2],p[3],c[1],p[5]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.expression.position,'The \"handle\" cannot change the type of the expression from \"'+p[0].normalize()[0]+'\" to \"'+u.normalize()[0]+'\": '+t[0])}},HandleException.prototype.compute=function(t,e){var n=t.state;if(void 0===t.recResult)return e.push({next:this,params:t}),void e.push({next:this.expression,params:{state:n,modifiable:t.modifiable,recResult:void 0}});var i=t.recResult;if(void 0===i||void 0===i.value)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");if(void 0===t.exprResult)return i.hasThrown?(t.exprResult=i,e.push({next:this,params:t}),void e.push({next:this.match,params:{state:n,modifiable:t.modifiable,recResult:void 0,value:i.value}})):i;i=t.exprResult;var r=t.recResult;if(void 0===i||void 0===i.value||void 0===r||void 0===r.value)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");return r.hasThrown&&r.value.equals(new u.ExceptionValue(\"Match\",void 0,0,0))?{newState:void 0,value:i.value,hasThrown:i.hasThrown}:{newState:void 0,value:r.value,hasThrown:r.hasThrown}},HandleException.prototype.assertUniqueBinding=function(t,e){return this.expression.assertUniqueBinding(t,e),this.match.assertUniqueBinding(t,e),new Set},HandleException}(p);exports.HandleException=v;var m=function(t){function RaiseException(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return n(RaiseException,t),RaiseException.prototype.getExplicitTypeVariables=function(){return this.expression.getExplicitTypeVariables()},RaiseException.prototype.simplify=function(){return new RaiseException(this.position,this.expression.simplify())},RaiseException.prototype.isSafe=function(t){return!1},RaiseException.prototype.toString=function(){return\"raise \"+this.expression},RaiseException.prototype.getType=function(t,e,n,r,o){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===o&&(o=!1);var a=this.expression.getType(t,e,n,r,o);try{var u=a[0].merge(t,e,new i.CustomType(\"exn\"));return[new i.TypeVariable(a[2]),a[1],a[2]+\"0\",a[3],u[1],a[5]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.expression.position,\"Raising anything but exceptions will only raise exceptions: \"+t[0])}},RaiseException.prototype.compute=function(t,e){var n=t.state;if(void 0===t.recResult)return e.push({next:this,params:t}),void e.push({next:this.expression,params:{state:n,modifiable:t.modifiable,recResult:void 0}});var i=t.recResult;if(void 0===i||void 0===i.value)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");if(!(i.value instanceof u.ExceptionValue))throw new s.EvaluationError(this.position,'Cannot \"raise\" value of type \"'+i.value.constructor.name+'\" (type must be \"exn\").');return{newState:n,value:i.value,hasThrown:!0}},RaiseException.prototype.assertUniqueBinding=function(t,e){return this.expression.assertUniqueBinding(t,e),new Set},RaiseException}(p);exports.RaiseException=m;var g=function(t){function Lambda(e,n){var i=t.call(this)||this;return i.position=e,i.match=n,i}return n(Lambda,t),Lambda.prototype.getExplicitTypeVariables=function(){return this.match.getExplicitTypeVariables()},Lambda.prototype.simplify=function(){return new Lambda(this.position,this.match.simplify())},Lambda.prototype.toString=function(){return\"( fn \"+this.match+\" )\"},Lambda.prototype.getType=function(t,e,n,i,r){return void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1),this.match.getType(t,e,n,i,r)},Lambda.prototype.compute=function(t,e){var n=t.state,i=n.getNestedState(n.id);return i.insideLocalDeclBody&&(i.dynamicBasis=n.getDynamicLocalDeclChanges(-1),i.insideLocalDeclBody=!1),{newState:void 0,value:new u.FunctionValue(i,[],this.match),hasThrown:!1}},Lambda.prototype.assertUniqueBinding=function(t,e){return this.match.assertUniqueBinding(t,e),new Set},Lambda}(p);exports.Lambda=g;var w=function(){function Match(t,e){this.position=t,this.matches=e}return Match.prototype.getExplicitTypeVariables=function(){for(var t=new Set,e=0;e<this.matches.length;++e)this.matches[e][0].getExplicitTypeVariables().forEach(function(e){t=t.add(e)}),this.matches[e][1].getExplicitTypeVariables().forEach(function(e){t=t.add(e)});return t},Match.prototype.toString=function(){for(var t=\"\",e=0;e<this.matches.length;++e)e>0&&(t+=\" | \"),t+=this.matches[e][0],t+=\" => \"+this.matches[e][1];return t},Match.prototype.compute=function(t,e){var n=t.state,i=t.value;if(void 0===i)throw new s.InternalInterpreterError(-1,\"How is this undefined?\");for(var r=0;r<this.matches.length;++r){var o=n.getNestedState(n.id),p=this.matches[r][0].matches(o,i);if(void 0!==p){for(var c=0;c<p.length;++c)o.setDynamicValue(p[c][0],p[c][1],a.IdentifierStatus.VALUE_VARIABLE);return void e.push({next:this.matches[r][1],params:{state:o,modifiable:t.modifiable,recResult:void 0}})}}return{newState:void 0,value:new u.ExceptionValue(\"Match\",void 0,0,0),hasThrown:!0}},Match.prototype.getType=function(t,e,n,r,o,u){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===o&&(o=!1),void 0===u&&(u=!1);for(var p=new i.FunctionType(new i.AnyType,new i.AnyType),c=[],l=e,f=new Map,d=this,y=0;y<this.matches.length;++y)!function(e){var u;if(d.matches[e][0]instanceof h){var y=t.getStaticValue(d.matches[e][0].name.getText());if(void 0!==y&&y[1]!==a.IdentifierStatus.VALUE_VARIABLE&&y[0]instanceof i.FunctionType)throw new s.ElaborationError(d.matches[e][0].position,\"Unary constructor in the pattern needs an argument.\")}var v=new Map;l.forEach(function(t,e){v=v.set(e,t)});var m=d.matches[e][0].getType(t,l,n,r,!0);t.valueIdentifierId=m[5],c=c.concat(m[1]);var g=d.matches[e][1].getType(t,m[4],m[2],m[3],o);c=c.concat(g[1]),t.valueIdentifierId=g[5],n=g[2],r=g[3];var w=new i.FunctionType(m[0],g[0]);try{u=p.merge(t,g[4],w),p=u[0],l=u[1],p=p.instantiate(t,l)}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(d.position,\"Match rules disagree on type: \"+t[0])}p=p.instantiate(t,l),l.forEach(function(t,e){\"*\"!==e[1]||\"*\"!==e[2]?v=v.set(e,t):f=f.set(e,t)}),l=v}(y);var v=new Map;return l.forEach(function(t,e){v=v.set(e,t)}),f.forEach(function(t,e){v=v.set(e,t)}),u&&c.push(new s.Warning(this.position,\"How should I know whether this pattern matching is exhaustive? Do I look like friggin' WIKIP***A to you?!\\n\")),[p,c,n,r,l,t.valueIdentifierId]},Match.prototype.simplify=function(){for(var t=[],e=0;e<this.matches.length;++e){var n=this.matches[e];t.push([n[0].simplify(),n[1].simplify()])}return new Match(this.position,t)},Match.prototype.assertUniqueBinding=function(t,e){for(var n=0;n<this.matches.length;++n)this.matches[n][0].assertUniqueBinding(t,e),this.matches[n][1].assertUniqueBinding(t,e);return new Set},Match}();exports.Match=w;var T=function(t){function Wildcard(e){var n=t.call(this)||this;return n.position=e,n}return n(Wildcard,t),Wildcard.prototype.getType=function(t,e,n,r,o){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===o&&(o=!1);for(var a=+n.substring(3)+1,s=\"\";;++a)if(n=\"'\"+n[1]+n[2]+a,!r.has(n)&&!e.has(n)&&void 0===t.getStaticValue(n))return s=n,[new i.TypeVariable(s),[],s,r.add(s),e,t.valueIdentifierId]},Wildcard.prototype.compute=function(t,e){throw new s.InternalInterpreterError(this.position,\"Wildcards are far too wild to have a value.\")},Wildcard.prototype.matchType=function(t,e,n){return[[],n,e]},Wildcard.prototype.matches=function(t,e){return[]},Wildcard.prototype.simplify=function(){return this},Wildcard.prototype.toString=function(){return\"_\"},Wildcard.prototype.assertUniqueBinding=function(t,e){return new Set},Wildcard}(p);exports.Wildcard=T;var E=function(t){function LayeredPattern(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.identifier=n,o.typeAnnotation=i,o.pattern=r,o}return n(LayeredPattern,t),LayeredPattern.prototype.getType=function(t,e,n,i,r){if(void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1),!r)throw new s.InternalInterpreterError(this.position,\"Layered patterns are far too layered to have a type.\");var o=new h(-1,this.identifier),a=o.getType(t,e,n,i,!0),u=a[0];if(void 0!==this.typeAnnotation)try{var p=u.merge(t,a[4],this.typeAnnotation);e=p[1],u=p[0]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Wrong type annotation: \"+t[0])}var c=this.pattern.getType(t,e,a[2],a[3],!0);try{var p=u.merge(t,c[4],c[0]);e=p[1],u=p[0]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Wrong type annotation: \"+t[0])}return[u,a[1].concat(c[1]),c[2],c[3],e,t.valueIdentifierId]},LayeredPattern.prototype.compute=function(t,e){throw new s.InternalInterpreterError(this.position,\"Layered patterns are far too layered to have a value.\")},LayeredPattern.prototype.matchType=function(t,e,n){var i=n;if(void 0!==this.typeAnnotation)try{var r=n.merge(t,e,this.typeAnnotation);e=r[1],i=r[0]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Wrong type annotation: \"+t[0])}var o=this.pattern.matchType(t,e,i);return[[[this.identifier.getText(),i]].concat(o[0]),n,o[2]]},LayeredPattern.prototype.matches=function(t,e){var n=this.pattern.matches(t,e);return void 0===n?n:[[this.identifier.getText(),e]].concat(n)},LayeredPattern.prototype.simplify=function(){return this.typeAnnotation?new LayeredPattern(this.position,this.identifier,this.typeAnnotation.simplify(),this.pattern.simplify()):new LayeredPattern(this.position,this.identifier,void 0,this.pattern.simplify())},LayeredPattern.prototype.toString=function(){return this.identifier.getText()+\" as \"+this.pattern},LayeredPattern.prototype.assertUniqueBinding=function(t,e){var n=this.pattern.assertUniqueBinding(t,e),i=t.getStaticValue(this.identifier.getText());if(void 0!==i&&i[1]!==a.IdentifierStatus.VALUE_VARIABLE)return n;var r=t.getDynamicValue(this.identifier.getText());if(void 0!==r&&r[1]!==a.IdentifierStatus.VALUE_VARIABLE)return n;if(n.has(this.identifier.getText()))throw new s.ParserError('No matter from which end you start eating this pattern,rebinding \"'+this.identifier.getText()+'\" is still a bad idea.',this.position);return n.add(this.identifier.getText())},LayeredPattern}(p);exports.LayeredPattern=E;var S=function(t){function Vector(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(Vector,t),Vector.prototype.getType=function(t,e,n,r,o){if(void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===r&&(r=new Set),void 0===o&&(o=!1),0===this.expressions.length)return[new i.CustomType(\"vector\",[new i.AnyType],this.position),[],n,r,e,t.valueIdentifierId];for(var a=this.expressions[0].getType(t,e,n,r,o),u=a[0],p=0;p<this.expressions.length;++p){a=this.expressions[p].getType(t,a[4],a[2],a[3],o);try{var c=u.merge(t,a[4],a[0]);a[4]=c[1],u=c[0]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Type clash in vector entries: \"+t[0])}}return[new i.CustomType(\"vector\",[u],this.position),a[1],a[2],a[3],a[4],a[5]]},Vector.prototype.compute=function(t,e){for(var n=[],i=0;i<this.expressions.length;++i){var r=this.expressions[i].compute(t,e);if(void 0===r||void 0===r.value)throw new s.InternalInterpreterError(this.position,\"NG\");n.push(r.value)}return{newState:void 0,value:new u.VectorValue(n),hasThrown:!1}},Vector.prototype.getExplicitTypeVariables=function(){return new Set},Vector.prototype.matchType=function(t,e,n){if(!(n instanceof i.CustomType)||\"vector\"!==n.name)throw new s.ElaborationError(this.position,'Vectors like only vectors, not \"'+n+'\". Stay cool.');for(var r=n.typeArguments[0],o=[],a=0;a<this.expressions.length;++a){var u=this.expressions[a].matchType(t,e,r);r=u[1],o=o.concat(u[0]),e=u[2]}return[o,new i.CustomType(\"vector\",[r],this.position),e]},Vector.prototype.matches=function(t,e){if(!(e instanceof u.VectorValue))throw new s.ElaborationError(this.position,'Vectors like only vectors, not \"'+e+'\". Stay cool.');for(var n=[],i=0;i<this.expressions.length;++i){var r=this.expressions[i].matches(t,e.entries[i]);void 0!==r&&(n=n.concat(r))}return n},Vector.prototype.simplify=function(){for(var t=[],e=0;e<this.expressions.length;++e)t.push(this.expressions[e].simplify());return new Vector(this.position,t)},Vector.prototype.toString=function(){for(var t=\"#[ \",e=0;e<this.expressions.length;++e)e>0&&(t+=\", \"),t+=this.expressions[e];return t+\" ]\"},Vector}(p);exports.Vector=S;var x=function(t){function ConjunctivePattern(e,n,i){var r=t.call(this)||this;return r.position=e,r.left=n,r.right=i,r}return n(ConjunctivePattern,t),ConjunctivePattern.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=this.left.getType(t,e,n,i,r),a=this.right.getType(t,o[4],o[2],o[3],r);try{var u=o[0].merge(t,a[4],a[0]);return[u[0],o[1].concat(a[1]),a[2],a[3],u[1],a[5]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Both patterns of a conjunctive pattern must have the same type.\")}},ConjunctivePattern.prototype.simplify=function(){return new ConjunctivePattern(this.position,this.left.simplify(),this.right.simplify())},ConjunctivePattern.prototype.matchType=function(t,e,n){throw new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},ConjunctivePattern.prototype.matches=function(t,e){var n=this.left.matches(t,e);if(void 0!==n){for(var i=t.getNestedState(t.id),r=0,o=n;r<o.length;r++){var s=o[r];i.setDynamicValue(s[0],s[1],a.IdentifierStatus.VALUE_VARIABLE)}var u=this.right.matches(i,e);if(void 0!==u)return n.concat(u)}},ConjunctivePattern.prototype.assertUniqueBinding=function(t,e){return new Set},ConjunctivePattern}(p);exports.ConjunctivePattern=x;var I=function(t){function DisjunctivePattern(e,n,i){var r=t.call(this)||this;return r.position=e,r.left=n,r.right=i,r}return n(DisjunctivePattern,t),DisjunctivePattern.prototype.getType=function(t,e,n,i,r){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1);var o=this.left.getType(t,e,n,i,r),a=this.right.getType(t,o[4],o[2],o[3],r);try{var u=o[0].merge(t,a[4],a[0]);return[u[0],o[1].concat(a[1]),a[2],a[3],u[1],a[5]]}catch(t){if(!(t instanceof Array))throw t;throw new s.ElaborationError(this.position,\"Both patterns of a disjunctive pattern must have the same type.\")}},DisjunctivePattern.prototype.simplify=function(){return new DisjunctivePattern(this.position,this.left.simplify(),this.right.simplify())},DisjunctivePattern.prototype.matchType=function(t,e,n){throw new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},DisjunctivePattern.prototype.matches=function(t,e){var n=this.left.matches(t,e);return void 0!==n?n:this.right.matches(t,e)},DisjunctivePattern.prototype.assertUniqueBinding=function(t,e){return new Set},DisjunctivePattern}(p);exports.DisjunctivePattern=I;var V=function(t){function NestedMatch(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.pattern=n,o.nested=i,o.expression=r,o}return n(NestedMatch,t),NestedMatch.prototype.getType=function(t,e,n,i,r){throw void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\"),void 0===i&&(i=new Set),void 0===r&&(r=!1),new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},NestedMatch.prototype.simplify=function(){return new NestedMatch(this.position,this.pattern.simplify(),this.nested.simplify(),this.expression.simplify())},NestedMatch.prototype.matchType=function(t,e,n){throw new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},NestedMatch.prototype.matches=function(t,e){if(void 0!==this.pattern.matches(t,e))throw new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},NestedMatch.prototype.assertUniqueBinding=function(t,e){return new Set},NestedMatch}(p);exports.NestedMatch=V;var k=function(t){function InfixExpression(e,n){var i=t.call(this)||this;return i.expressions=e,i.operators=n,i}return n(InfixExpression,t),InfixExpression.prototype.matchType=function(t,e,n){return this.reParse(t).matchType(t,e,n)},InfixExpression.prototype.matches=function(t,e){return this.reParse(t).matches(t,e)},InfixExpression.prototype.simplify=function(){throw new s.InternalInterpreterError(this.position,\"Ouch, I'm not fully parsed.\")},InfixExpression.prototype.reParse=function(t){for(var e=this.operators,n=this.expressions,i=[],r=0;r<n.length;++r)i.push([r]);e.sort(function(e,n){var i=e[0],r=e[1],o=n[0],a=n[1],s=t.getInfixStatus(i),u=t.getInfixStatus(o);if(s.precedence>u.precedence)return-1;if(s.precedence<u.precedence)return 1;if(s.rightAssociative){if(r>a)return-1;if(r<a)return 1}else{if(r>a)return 1;if(r<a)return-1}return 0});for(var r=0;r<e.length;++r){if(r>0){var o=t.getInfixStatus(e[r][0]),a=t.getInfixStatus(e[r-1][0]);if(o.precedence===a.precedence&&o.rightAssociative!==a.rightAssociative&&(i[e[r-1][1]+1]===i[e[r][1]]||i[e[r-1][1]]===i[e[r][1]+1]))throw new s.ParserError(\"Could you ever imagine left associatives and right associatives living together in peace?\",e[r][0].position)}for(var u=n[e[r][1]],p=n[e[r][1]+1],c=new y(e[r][0].position,new h(e[r][0].position,e[r][0]),new D(e[r][0].position,[u,p])),l=i[e[r][1]],f=0,d=i[e[r][1]+1];f<d.length;f++){var v=d[f];l.push(v)}for(var m=0,g=l;m<g.length;m++){var v=g[m];i[v]=l,n[v]=c}}return n[0]},InfixExpression}(p);exports.InfixExpression=k;var b=new h(0,new o.IdentifierToken(\"false\",0)),A=new h(0,new o.IdentifierToken(\"true\",0)),L=new h(0,new o.IdentifierToken(\"nil\",0)),R=new h(0,new o.IdentifierToken(\"::\",0)),B=function(t){function Conjunction(e,n,i){var r=t.call(this)||this;return r.position=e,r.leftOperand=n,r.rightOperand=i,r}return n(Conjunction,t),Conjunction.prototype.simplify=function(){return new F(this.position,this.leftOperand,this.rightOperand,b).simplify()},Conjunction.prototype.toString=function(){return\"( \"+this.leftOperand+\" andalso \"+this.rightOperand+\" )\"},Conjunction}(p);exports.Conjunction=B;var C=function(t){function Disjunction(e,n,i){var r=t.call(this)||this;return r.position=e,r.leftOperand=n,r.rightOperand=i,r}return n(Disjunction,t),Disjunction.prototype.simplify=function(){return new F(this.position,this.leftOperand,A,this.rightOperand).simplify()},Disjunction.prototype.toString=function(){return\"( \"+this.leftOperand+\" orelse \"+this.rightOperand+\" )\"},Disjunction}(p);exports.Disjunction=C;var D=function(t){function Tuple(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(Tuple,t),Tuple.prototype.matchType=function(t,e,n){return this.simplify().matchType(t,e,n)},Tuple.prototype.matches=function(t,e){return this.simplify().matches(t,e)},Tuple.prototype.simplify=function(){for(var t=[],e=0;e<this.expressions.length;++e)t.push([\"\"+(e+1),this.expressions[e].simplify()]);return new l(this.position,!0,t)},Tuple.prototype.toString=function(){for(var t=\"( \",e=0;e<this.expressions.length;++e)e>0&&(t+=\", \"),t+=this.expressions[e];return t+\" )\"},Tuple}(p);exports.Tuple=D;var _=function(t){function List(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(List,t),List.prototype.matchType=function(t,e,n){return this.simplify().matchType(t,e,n)},List.prototype.matches=function(t,e){return this.simplify().matches(t,e)},List.prototype.simplify=function(){for(var t=L,e=this.expressions.length-1;e>=0;--e){var n=new D(-1,[this.expressions[e],t]).simplify();t=new y(-1,R,n)}return t},List.prototype.toString=function(){for(var t=\"[ \",e=0;e<this.expressions.length;++e)e>0&&(t+=\", \"),t+=this.expressions[e];return t+\" ]\"},List}(p);exports.List=_;var O=function(t){function Sequence(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(Sequence,t),Sequence.prototype.simplify=function(){for(var t=this.expressions.length-1,e=new w(-1,[[new T(0),this.expressions[t]]]),n=new q(-1,this.expressions[t-1],e),i=t-2;i>=0;--i)e=new w(-1,[[new T(0),n]]),n=new q(-1,this.expressions[i],e);return n.simplify()},Sequence.prototype.toString=function(){for(var t=\"( \",e=0;e<this.expressions.length;++e)e>0&&(t+=\"; \"),t+=this.expressions[e];return t+\" )\"},Sequence}(p);exports.Sequence=O;var P=function(t){function RecordSelector(e,n){var i=t.call(this)||this;return i.position=e,i.label=n,i}return n(RecordSelector,t),RecordSelector.prototype.simplify=function(){return new g(this.position,new w(-1,[[new l(-1,!1,[[this.label.text,new h(-1,new o.IdentifierToken(\"__rs\",-1))]]),new h(-1,new o.IdentifierToken(\"__rs\",-1))]]))},RecordSelector.prototype.toString=function(){return\"#\"+this.label.getText()},RecordSelector}(p);exports.RecordSelector=P;var q=function(t){function CaseAnalysis(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.match=i,r}return n(CaseAnalysis,t),CaseAnalysis.prototype.simplify=function(){return new y(this.position,new g(this.position,this.match.simplify()),this.expression.simplify())},CaseAnalysis.prototype.toString=function(){return\"case \"+this.expression+\" of \"+this.match},CaseAnalysis}(p);exports.CaseAnalysis=q;var F=function(t){function Conditional(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.condition=n,o.consequence=i,o.alternative=r,o}return n(Conditional,t),Conditional.prototype.simplify=function(){var t=new w(this.position,[[A,this.consequence],[b,this.alternative]]);return new q(this.position,this.condition,t).simplify()},Conditional.prototype.toString=function(){return\"if \"+this.condition+\" then \"+this.consequence+\" else \"+this.alternative},Conditional}(p);exports.Conditional=F;var N=function(t){function While(e,n,i){var r=t.call(this)||this;return r.position=e,r.condition=n,r.body=i,r}return n(While,t),While.prototype.simplify=function(){var t=new h(this.position,new o.IdentifierToken(\"__whl\",this.position)),e=new y(this.position,t,new D(this.position,[])),n=new F(this.position,this.condition,new O(this.position,[this.body,e]),new D(this.position,[])),i=new r.ValueBinding(this.position,!0,t,new g(this.position,new w(this.position,[[new D(this.position,[]),n]]))),a=new r.ValueDeclaration(this.position,[],[i]);return new f(this.position,a,e).simplify()},While.prototype.toString=function(){return\"( while \"+this.condition+\" do \"+this.body+\" )\"},While}(p);exports.While=N;var U=function(t){function PatternGuard(e,n,i){var r=t.call(this)||this;return r.position=e,r.pattern=n,r.condition=i,r}return n(PatternGuard,t),PatternGuard.prototype.simplify=function(){return new V(this.position,this.pattern.simplify(),A,this.condition.simplify())},PatternGuard.prototype.matchType=function(t,e,n){throw new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},PatternGuard.prototype.matches=function(t,e){throw new s.InternalInterpreterError(this.position,\"「ニャ－、ニャ－」\")},PatternGuard}(p);exports.PatternGuard=U},function(t,exports,e){\"use strict\";function functionType(t){return new i.FunctionType(new i.TupleType([t,t]),t).simplify()}function bfunctionType(t){return new i.FunctionType(new i.TupleType([t,t]),s).simplify()}function intWordBind(t){return new i.TypeVariableBind(\"'iw\",t,[new i.CustomType(\"int\"),new i.CustomType(\"word\")]).propagate()}function intRealBind(t){return new i.TypeVariableBind(\"'ir\",t,[new i.CustomType(\"int\"),a]).propagate()}function intWordRealBind(t){return new i.TypeVariableBind(\"'iwr\",t,[new i.CustomType(\"int\"),new i.CustomType(\"word\"),a]).propagate()}function anyBind(t){return new i.TypeVariableBind(\"'any\",t,[new i.CustomType(\"int\"),new i.CustomType(\"word\"),a,new i.CustomType(\"string\"),new i.CustomType(\"char\")]).propagate()}function getInitialState(){return T.getNestedState()}Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(3),i=e(4),r=e(2),o=e(0),a=new i.CustomType(\"real\"),s=new i.CustomType(\"bool\"),u=new i.CustomType(\"string\"),p=new i.CustomType(\"char\"),c=new i.TypeVariable(\"'a\"),h=new i.TypeVariable(\"''b\"),l=new i.TypeVariable(\"'iw\"),f=new i.TypeVariable(\"'ir\"),d=new i.TypeVariable(\"'iwr\"),y=new i.TypeVariable(\"'any\"),v=new r.ExceptionConstructor(\"Match\",0,0,0),m=new r.ExceptionConstructor(\"Bind\",0,0,1),g=new r.ExceptionConstructor(\"Div\",0,0,2),w=new r.ExceptionConstructor(\"Overflow\",0,0,3),T=new n.State(0,void 0,new n.StaticBasis({unit:new n.TypeInformation(new i.FunctionType(new i.CustomType(\"unit\"),new i.TupleType([])).simplify(),[],0,!0),bool:new n.TypeInformation(new i.CustomType(\"bool\"),[\"true\",\"false\"],0,!0),int:new n.TypeInformation(new i.CustomType(\"int\"),[],0,!0),word:new n.TypeInformation(new i.CustomType(\"word\"),[],0,!0),real:new n.TypeInformation(a,[],0,!1),string:new n.TypeInformation(new i.CustomType(\"string\"),[],0,!0),char:new n.TypeInformation(new i.CustomType(\"char\"),[],0,!0),list:new n.TypeInformation(new i.CustomType(\"list\",[c]),[\"nil\",\"::\"],1,!0),array:new n.TypeInformation(new i.CustomType(\"array\",[c]),[],1,!0),vector:new n.TypeInformation(new i.CustomType(\"vector\",[c]),[],1,!0),ref:new n.TypeInformation(new i.CustomType(\"ref\",[c]),[\"ref\"],1,!0),exn:new n.TypeInformation(new i.CustomType(\"exn\"),[],0,!1)},{div:[intWordBind(functionType(l)),n.IdentifierStatus.VALUE_VARIABLE],mod:[intWordBind(functionType(l)),n.IdentifierStatus.VALUE_VARIABLE],\"*\":[intWordRealBind(functionType(d)),n.IdentifierStatus.VALUE_VARIABLE],\"/\":[functionType(a),n.IdentifierStatus.VALUE_VARIABLE],\"+\":[intWordRealBind(functionType(d)),n.IdentifierStatus.VALUE_VARIABLE],\"-\":[intWordRealBind(functionType(d)),n.IdentifierStatus.VALUE_VARIABLE],\"<\":[anyBind(bfunctionType(y)),n.IdentifierStatus.VALUE_VARIABLE],\"<=\":[anyBind(bfunctionType(y)),n.IdentifierStatus.VALUE_VARIABLE],\">\":[anyBind(bfunctionType(y)),n.IdentifierStatus.VALUE_VARIABLE],\">=\":[anyBind(bfunctionType(y)),n.IdentifierStatus.VALUE_VARIABLE],\"=\":[new i.TypeVariableBind(\"''b\",new i.FunctionType(new i.TupleType([h,h]),s)).simplify(),n.IdentifierStatus.VALUE_VARIABLE],\"<>\":[new i.TypeVariableBind(\"''b\",new i.FunctionType(new i.TupleType([h,h]),s)).simplify(),n.IdentifierStatus.VALUE_VARIABLE],true:[new i.CustomType(\"bool\"),n.IdentifierStatus.VALUE_CONSTRUCTOR],false:[new i.CustomType(\"bool\"),n.IdentifierStatus.VALUE_CONSTRUCTOR],nil:[new i.TypeVariableBind(\"'a\",new i.CustomType(\"list\",[c])),n.IdentifierStatus.VALUE_CONSTRUCTOR],\"::\":[new i.TypeVariableBind(\"'a\",new i.FunctionType(new i.TupleType([c,new i.CustomType(\"list\",[c])]),new i.CustomType(\"list\",[c]))).simplify(),n.IdentifierStatus.VALUE_CONSTRUCTOR],Match:[new i.CustomType(\"exn\"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Bind:[new i.CustomType(\"exn\"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Div:[new i.CustomType(\"exn\"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Overflow:[new i.CustomType(\"exn\"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],\"^\":[functionType(u),n.IdentifierStatus.VALUE_VARIABLE],explode:[new i.FunctionType(u,new i.CustomType(\"list\",[p])).simplify(),n.IdentifierStatus.VALUE_VARIABLE],implode:[new i.FunctionType(new i.CustomType(\"list\",[p]),u).simplify(),n.IdentifierStatus.VALUE_VARIABLE],\"~\":[intRealBind(new i.FunctionType(f,f)),n.IdentifierStatus.VALUE_VARIABLE],abs:[intRealBind(new i.FunctionType(f,f)),n.IdentifierStatus.VALUE_VARIABLE],print:[new i.TypeVariableBind(\"'a\",new i.FunctionType(c,new i.TupleType([]))).simplify(),n.IdentifierStatus.VALUE_VARIABLE],printLn:[new i.TypeVariableBind(\"'a\",new i.FunctionType(c,new i.TupleType([]))).simplify(),n.IdentifierStatus.VALUE_VARIABLE],\":=\":[new i.TypeVariableBind(\"'a\",new i.FunctionType(new i.TupleType([new i.CustomType(\"ref\",[c]),c]),new i.TupleType([]))).simplify(),n.IdentifierStatus.VALUE_VARIABLE],ref:[new i.TypeVariableBind(\"'a\",new i.FunctionType(c,new i.CustomType(\"ref\",[c]))),n.IdentifierStatus.VALUE_CONSTRUCTOR],\"!\":[new i.TypeVariableBind(\"'a\",new i.FunctionType(new i.CustomType(\"ref\",[c]),c)),n.IdentifierStatus.VALUE_VARIABLE]},{},{},{}),new n.DynamicBasis({unit:[],bool:[\"true\",\"false\"],int:[],word:[],real:[],string:[],char:[],list:[\"nil\",\"::\"],array:[],vector:[],ref:[\"ref\"],exn:[]},{div:[new r.PredefinedFunction(\"div\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer)return 0===i.value?[g.construct(),!0,[]]:[n.divide(i),!1,[]];if(n instanceof r.Word&&i instanceof r.Word)return 0===i.value?[g.construct(),!0,[]]:[n.divide(i),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"div\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],mod:[new r.PredefinedFunction(\"mod\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer)return 0===i.value?[g.construct(),!0,[]]:[n.modulo(i),!1,[]];if(n instanceof r.Word&&i instanceof r.Word)return 0===i.value?[g.construct(),!0,[]]:[n.modulo(i),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"mod\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"*\":[new r.PredefinedFunction(\"*\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer){var a=n.multiply(i);return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}if(n instanceof r.Word&&i instanceof r.Word){var a=n.multiply(i);return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}if(n instanceof r.Real&&i instanceof r.Real){var a=n.multiply(i);return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}}throw new o.InternalInterpreterError(-1,'Called \"*\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"/\":[new r.PredefinedFunction(\"/\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Real&&i instanceof r.Real)return 0===i.value?[g.construct(),!0,[]]:[n.divide(i),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"/\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"+\":[new r.PredefinedFunction(\"+\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer){var a=n.add(i);return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}if(n instanceof r.Word&&i instanceof r.Word){var a=n.add(i);return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}if(n instanceof r.Real&&i instanceof r.Real){var a=n.add(i);return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}}throw new o.InternalInterpreterError(-1,'Called \"+\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"-\":[new r.PredefinedFunction(\"-\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer){var a=n.add(i.negate());return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}if(n instanceof r.Word&&i instanceof r.Word){var a=n.add(i.negate());return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}if(n instanceof r.Real&&i instanceof r.Real){var a=n.add(i.negate());return a.hasOverflow()?[w.construct(),!0,[]]:[a,!1,[]]}}throw new o.InternalInterpreterError(-1,'Called \"-\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"<\":[new r.PredefinedFunction(\"<\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer)return[new r.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof r.Word&&i instanceof r.Word)return[new r.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof r.Real&&i instanceof r.Real)return[new r.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof r.StringValue&&i instanceof r.StringValue)return[new r.BoolValue(n.compareTo(i)<0),!1,[]];if(n instanceof r.CharValue&&i instanceof r.CharValue)return[new r.BoolValue(n.compareTo(i)<0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"<\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\">\":[new r.PredefinedFunction(\"<\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer)return[new r.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof r.Word&&i instanceof r.Word)return[new r.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof r.Real&&i instanceof r.Real)return[new r.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof r.StringValue&&i instanceof r.StringValue)return[new r.BoolValue(n.compareTo(i)>0),!1,[]];if(n instanceof r.CharValue&&i instanceof r.CharValue)return[new r.BoolValue(n.compareTo(i)>0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \">\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"<=\":[new r.PredefinedFunction(\"<\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer)return[new r.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof r.Word&&i instanceof r.Word)return[new r.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof r.Real&&i instanceof r.Real)return[new r.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof r.StringValue&&i instanceof r.StringValue)return[new r.BoolValue(n.compareTo(i)<=0),!1,[]];if(n instanceof r.CharValue&&i instanceof r.CharValue)return[new r.BoolValue(n.compareTo(i)<=0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"<=\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\">=\":[new r.PredefinedFunction(\"<\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer&&i instanceof r.Integer)return[new r.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof r.Word&&i instanceof r.Word)return[new r.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof r.Real&&i instanceof r.Real)return[new r.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof r.StringValue&&i instanceof r.StringValue)return[new r.BoolValue(n.compareTo(i)>=0),!1,[]];if(n instanceof r.CharValue&&i instanceof r.CharValue)return[new r.BoolValue(n.compareTo(i)>=0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \">=\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"=\":[new r.PredefinedFunction(\"=\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");return[new r.BoolValue(n.equals(i)),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"=\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"<>\":[new r.PredefinedFunction(\"=\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");return[new r.BoolValue(!n.equals(i)),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"<>\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],true:[new r.BoolValue(!0),n.IdentifierStatus.VALUE_CONSTRUCTOR],false:[new r.BoolValue(!1),n.IdentifierStatus.VALUE_CONSTRUCTOR],nil:[new r.ValueConstructor(\"nil\"),n.IdentifierStatus.VALUE_CONSTRUCTOR],\"::\":[new r.ValueConstructor(\"::\",1),n.IdentifierStatus.VALUE_CONSTRUCTOR],Match:[v,n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Bind:[m,n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Div:[g,n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Overflow:[w,n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],\"^\":[new r.PredefinedFunction(\"^\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.StringValue&&i instanceof r.StringValue)return[n.concat(i),!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"^\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],explode:[new r.PredefinedFunction(\"explode\",function(t,e){if(t instanceof r.StringValue)return[t.explode(),!1,[]];throw new o.InternalInterpreterError(-1,'Called \"explode\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],implode:[new r.PredefinedFunction(\"implode\",function(t,e){if(t instanceof r.ConstructedValue)return[r.StringValue.implode(t),!1,[]];throw new o.InternalInterpreterError(-1,'Called \"implode\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],\"~\":[new r.PredefinedFunction(\"~\",function(t,e){if(t instanceof r.Integer){var n=t.negate();return n.hasOverflow()?[w.construct(),!0,[]]:[n,!1,[]]}if(t instanceof r.Real){var n=t.negate();return n.hasOverflow()?[w.construct(),!0,[]]:[n,!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"~\" on something weird.')}),n.IdentifierStatus.VALUE_VARIABLE],abs:[new r.PredefinedFunction(\"~\",function(t,e){if(t instanceof r.Integer){if(t.value>=0)return[t,!1,[]];var n=t.negate();return n.hasOverflow()?[w.construct(),!0,[]]:[n,!1,[]]}if(t instanceof r.Real){if(t.value>=0)return[t,!1,[]];var n=t.negate();return n.hasOverflow()?[w.construct(),!0,[]]:[n,!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"~\" on something weird.')}),n.IdentifierStatus.VALUE_VARIABLE],print:[new r.PredefinedFunction(\"print\",function(t,e){var n=[];return t instanceof r.StringValue?n.push(new o.Warning(-2,t.value)):n.push(new o.Warning(-2,t.toString(void 0,1e18))),[new r.RecordValue,!1,n]}),n.IdentifierStatus.VALUE_VARIABLE],printLn:[new r.PredefinedFunction(\"printLn\",function(t,e){var n=[];return t instanceof r.StringValue?n.push(new o.Warning(-2,t.value+\"\\n\")):n.push(new o.Warning(-2,t.toString(void 0,1e18)+\"\\n\")),[new r.RecordValue,!1,n]}),n.IdentifierStatus.VALUE_VARIABLE],\":=\":[new r.PredefinedFunction(\":=\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.ReferenceValue)return e.modifiable.setCell(n.address,i),[new r.RecordValue,!1,[]]}throw new o.InternalInterpreterError(-1,'Called \":=\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE],ref:[new r.PredefinedFunction(\"ref\",function(t,e){return[e.modifiable.setNewCell(t),!1,[]]}),n.IdentifierStatus.VALUE_VARIABLE],\"!\":[new r.PredefinedFunction(\"!\",function(t,e){if(t instanceof r.ReferenceValue){var n=e.modifiable.getCell(t.address);if(void 0===n)throw new o.InternalInterpreterError(-1,\"Neko-sempai, I think that I crashed. What shall I do now?\");return[n,!1,[]]}throw new o.InternalInterpreterError(-1,'Called \"!\" on value of the wrong type ('+t.constructor.name+\").\")}),n.IdentifierStatus.VALUE_VARIABLE]},{},{},{}),[0,{}],4,[0,new Map],{div:new n.InfixStatus(!0,7,!1),mod:new n.InfixStatus(!0,7,!1),\"*\":new n.InfixStatus(!0,7,!1),\"/\":new n.InfixStatus(!0,7,!1),\"+\":new n.InfixStatus(!0,6,!1),\"-\":new n.InfixStatus(!0,6,!1),\"<\":new n.InfixStatus(!0,4,!1),\">\":new n.InfixStatus(!0,4,!1),\"<=\":new n.InfixStatus(!0,4,!1),\">=\":new n.InfixStatus(!0,4,!1),\"::\":new n.InfixStatus(!0,5,!0),\"=\":new n.InfixStatus(!0,4,!1),\"<>\":new n.InfixStatus(!0,4,!1),\":=\":new n.InfixStatus(!0,3,!1),\"^\":new n.InfixStatus(!0,6,!1)},{Match:1,Bind:1,Div:1,Overflow:1,int:1,real:1,string:1,char:1,unit:1,word:1,list:1,bool:1});exports.getInitialState=getInitialState},function(t,exports,e){\"use strict\";function lex(t,e){for(var n=new s(t,e),i=[];!n.finished();)i.push(n.nextToken());return i}Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(0),i=e(1),r=e(2),o=new Set([\"abstype\",\"and\",\"andalso\",\"as\",\"case\",\"datatype\",\"do\",\"else\",\"end\",\"exception\",\"fn\",\"fun\",\"handle\",\"if\",\"in\",\"infix\",\"infixr\",\"let\",\"local\",\"nonfix\",\"of\",\"op\",\"open\",\"orelse\",\"raise\",\"rec\",\"then\",\"type\",\"val\",\"with\",\"withtype\",\"while\",\"(\",\")\",\"[\",\"]\",\"{\",\"}\",\",\",\":\",\";\",\"...\",\"_\",\"|\",\"=\",\"=>\",\"->\",\"#\",\"eqtype\",\"functor\",\"signature\",\"struct\",\"include\",\"sharing\",\"structure\",\"where\",\"sig\",\":>\"]),a=new Set([\"!\",\"%\",\"&\",\"$\",\"#\",\"+\",\"-\",\"/\",\":\",\"<\",\"=\",\">\",\"?\",\"@\",\"\\\\\",\"~\",\"`\",\"^\",\"|\",\"*\"]),s=function(){function Lexer(t,e){this.input=t,this.options=e,this.position=0,this.skipWhitespaceAndComments()}return Lexer.isAlphanumeric=function(t){return t>=\"a\"&&t<=\"z\"||t>=\"A\"&&t<=\"Z\"||t>=\"0\"&&t<=\"9\"||\"'\"===t||\"_\"===t},Lexer.isSymbolic=function(t){return a.has(t)},Lexer.isWhitespace=function(t){return\" \"===t||\"\\t\"===t||\"\\n\"===t||\"\\f\"===t},Lexer.isNumber=function(t,e){return t>=\"0\"&&t<=\"9\"||e&&(t>=\"a\"&&t<=\"f\"||t>=\"A\"&&t<=\"F\")},Lexer.prototype.consumeChar=function(t,e){if(void 0===t&&(t=\"\"),void 0===e&&(e=this.input.length-1),this.position>=this.input.length)throw\"\"===t?new n.IncompleteError(e):new n.IncompleteError(e,t);return++this.position,this.input.charAt(this.position-1)},Lexer.prototype.getChar=function(t){return void 0===t&&(t=0),this.position+t>=this.input.length?\"\u0004\":this.input.charAt(this.position+t)},Lexer.prototype.skipWhitespace=function(){for(;Lexer.isWhitespace(this.getChar());)++this.position},Lexer.prototype.skipWhitespaceAndComments=function(){var t;do{for(t=this.position,this.skipWhitespace();this.position+1<this.input.length&&\"(*\"===this.input.substr(this.position,2);){var e=this.position;this.position+=2;for(var i=1;i>0;){if(this.position>this.input.length-2)throw new n.IncompleteError(e,\"unclosed comment\");var r=this.input.substr(this.position,2);\"(*\"===r?(++i,++this.position):\"*)\"===r&&(--i,++this.position),++this.position}}}while(this.position!==t);this.tokenStart=this.position},Lexer.prototype.readNumeric=function(t,e){void 0===e&&(e=-1);for(var n=\"\";Lexer.isNumber(this.getChar(),t)&&n.length!==e;)n+=this.consumeChar();return n},Lexer.prototype.makeNumberToken=function(t,e,o,a){if(void 0===e&&(e=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),e&&o)throw new n.InternalInterpreterError(this.position);var s=this.input.substring(this.tokenStart,this.position);if(e)return new i.RealConstantToken(s,this.tokenStart,parseFloat(t));var u=parseInt(t,a?16:10);if(u>r.MAXINT)throw new n.LexerError(this.position,'\"'+u+'\", whoa, it\\'s over \"'+r.MAXINT+'\".');if(u<r.MININT)throw new n.LexerError(this.position,'\"'+u+'\", whoa, it\\'s ounder \"'+r.MININT+'\".');if(o)return new i.WordConstantToken(s,this.tokenStart,u);var p=s.charAt(0);return Lexer.isNumber(p,!1)&&\"0\"!==p?new i.NumericToken(s,this.tokenStart,u):new i.IntegerConstantToken(s,this.tokenStart,u)},Lexer.prototype.lexNumber=function(){var t=\"\",e=!1,n=!1,i=!1,r=!1;if(\"~\"===this.getChar()&&(++this.position,r=!0,t+=\"-\"),\"0\"===this.getChar()&&(\"w\"===this.getChar(1)||\"x\"===this.getChar(1))){++this.position,\"w\"===this.getChar()&&(n=!0),\"x\"===this.getChar(n?1:0)&&(e=!0);var o=n&&e?2:1;if(r&&n||!Lexer.isNumber(this.getChar(o),e))return t+=\"0\",this.makeNumberToken(t,!1,!1,!1);this.position+=o}if(t+=this.readNumeric(e),e||n)return this.makeNumberToken(t,!1,n,e);if(\".\"===this.getChar()){if(!Lexer.isNumber(this.getChar(1),!1))return this.makeNumberToken(t);t+=this.consumeChar(),t+=this.readNumeric(!1),i=!0}if(\"e\"===this.getChar()||\"E\"===this.getChar()){if(Lexer.isNumber(this.getChar(1),!1))t+=\"e\",++this.position,t+=this.readNumeric(!1);else{if(\"~\"!==this.getChar(1)||!Lexer.isNumber(this.getChar(2),!1))return this.makeNumberToken(t,i);t+=\"e-\",this.position+=2,t+=this.readNumeric(!1)}i=!0}return this.makeNumberToken(t,i)},Lexer.prototype.lexString=function(){var t=this.position;if('\"'!==this.consumeChar())throw new n.InternalInterpreterError(this.position);for(var e=\"\";'\"'!==this.getChar();)if(\"\\\\\"===this.getChar())if(++this.position,Lexer.isWhitespace(this.getChar())){if(this.skipWhitespace(),\"\\\\\"!==this.consumeChar(\"unterminated whitespace escape sequence\"))throw new n.LexerError(this.position-1,\"Found non-whitespace character in whitespace escape sequence.\")}else{var r=this.consumeChar();switch(r){case\"a\":e+=\"\u0007\";break;case\"b\":e+=\"\\b\";break;case\"t\":e+=\"\\t\";break;case\"n\":e+=\"\\n\";break;case\"v\":e+=\"\\v\";break;case\"f\":e+=\"\\f\";break;case\"r\":e+=\"\\r\";break;case'\"':e+='\"';break;case\"\\\\\":e+=\"\\\\\";break;case\"^\":var o=this.consumeChar().charCodeAt(0);if(o<64||o>95)throw new n.LexerError(this.position-1,'\"'+String.fromCharCode(o)+'\" does not represent a valid control character.');e+=String.fromCharCode(o-64);break;case\"u\":var a=this.readNumeric(!0,4);if(4!==a.length)throw new n.LexerError(this.position-a.length-1,\"A Unicode escape sequence must consist of four digits.\");var s=parseInt(a,16);if(s>=256&&!this.options.allowUnicodeInStrings)throw new n.LexerError(this.position-a.length-1,'The character code \"'+a+'\" is too large, only values between 00 and ff are allowed.');e+=String.fromCharCode(s);break;default:if(!Lexer.isNumber(r,!1))throw new n.LexerError(this.position-1,\"Invalid escape sequence.\");--this.position;var a=this.readNumeric(!1,3);if(3!==a.length)throw new n.LexerError(this.position-a.length-1,\"A numeric escape sequence must consist of three digits.\");var s=parseInt(a,10);if(s>=256&&!this.options.allowUnicodeInStrings)throw new n.LexerError(this.position-a.length-1,'The character code \"'+a+'\" is too large, only values between 000 and 255 are allowed.');e+=String.fromCharCode(s)}}else{var r=this.consumeChar(\"unterminated string\",this.tokenStart).charCodeAt(0);if((r<33||r>126)&&32!==r&&r<128){var u=\"\";throw 9===r&&(u=\" (tab)\"),10===r&&(u=\" (newline)\"),13===r&&(u=\" (carriage return)\"),new n.LexerError(this.position-1,\"A string may not contain the character <\"+r+\">\"+u+\".\")}e+=String.fromCharCode(r)}if('\"'!==this.consumeChar())throw new n.InternalInterpreterError(this.position);return new i.StringConstantToken(this.input.substring(t,this.position),this.tokenStart,e)},Lexer.prototype.lexCharacter=function(){if(\"#\"!==this.consumeChar())throw new n.InternalInterpreterError(this.position);var t=this.lexString();if(1!==t.value.length)throw new n.LexerError(this.tokenStart,\"A character constant must have length 1, not \"+t.value.length+\".\");return new i.CharacterConstantToken(\"#\"+t.text,this.tokenStart,t.value)},Lexer.prototype.lexIdentifierOrKeyword=function(){var t,e=\"\",r=this.getChar();if(Lexer.isSymbolic(r))t=Lexer.isSymbolic;else{if(!Lexer.isAlphanumeric(r)||Lexer.isNumber(r,!1)||\"_\"===r){if(o.has(r))return new i.KeywordToken(this.consumeChar(),this.tokenStart);if(\".\"===r&&\".\"===this.getChar(1)&&\".\"===this.getChar(2))return this.position+=3,new i.KeywordToken(\"...\",this.tokenStart);throw r.charCodeAt(0)<32?new n.LexerError(this.position,\"Invalid character <\"+r.charCodeAt(0)+\">.\"):new n.LexerError(this.position,'Invalid token \"'+r+'\".')}t=Lexer.isAlphanumeric}do{e+=this.consumeChar()}while(t(this.getChar()));return\"*\"===e?new i.StarToken(this.tokenStart):\"=\"===e?new i.EqualsToken(this.tokenStart):o.has(e)?new i.KeywordToken(e,this.tokenStart):\"'\"===r?\"'\"===e.charAt(1)?new i.EqualityTypeVariableToken(e,this.tokenStart):new i.TypeVariableToken(e,this.tokenStart):Lexer.isAlphanumeric(r)?new i.AlphanumericIdentifierToken(e,this.tokenStart):new i.IdentifierToken(e,this.tokenStart)},Lexer.prototype.lexLongIdentifierOrKeyword=function(){var t=this.tokenStart,e=this.lexIdentifierOrKeyword();if(\".\"!==this.getChar())return e;var r=[];do{if(this.consumeChar(),!(e instanceof i.AlphanumericIdentifierToken))throw new n.LexerError(e.position,'Expected structure name before \".\".');r.push(e),this.tokenStart=this.position,e=this.lexIdentifierOrKeyword()}while(\".\"===this.getChar());if(!(e instanceof i.IdentifierToken||e instanceof i.StarToken)||e instanceof i.TypeVariableToken)throw new n.LexerError(e.position,'\"'+e.text+'\" is not allowed in a long identifier.');return new i.LongIdentifierToken(this.input.substring(t,this.position),t,r,e)},Lexer.prototype.nextToken=function(){var t;return this.tokenStart=this.position,t=Lexer.isNumber(this.getChar(),!1)||\"~\"===this.getChar()&&Lexer.isNumber(this.getChar(1),!1)?this.lexNumber():'\"'===this.getChar()?this.lexString():\"#\"===this.getChar()&&'\"'===this.getChar(1)?this.lexCharacter():this.lexLongIdentifierOrKeyword(),this.skipWhitespaceAndComments(),t},Lexer.prototype.finished=function(){return this.position>=this.input.length},Lexer}();exports.lex=lex},function(t,exports,e){\"use strict\";function parse(t,e,n){void 0===n&&(n={});var i=new u(t,e,e.id,n),r=i.parseDeclaration(!0,!0);return i.assertFinished(),r}Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(6),i=e(4),r=e(0),o=e(1),a=e(5),s=e(13),u=function(){function Parser(t,e,n,i){if(this.tokens=t,this.state=e,this.currentId=n,this.options=i,this.position=0,this.newcons=new Set,void 0===this.state)throw new r.InternalInterpreterError(-1,\"What are you, stupid? Hurry up and give me a state already!\")}return Parser.prototype.assertFinished=function(){if(this.position<=this.tokens.length-1)throw new r.ParserError('Junk after declaration: \"'+this.currentToken().getText()+'\".',this.position)},Parser.prototype.assertKeywordToken=function(t,e){if(void 0===e&&(e=void 0),!(t instanceof o.KeywordToken))throw new r.ParserError('Expected a reserved word, got \"'+t.getText()+'\" ('+t.constructor.name+\").\",t.position);if(void 0!==e&&t.text!==e)throw new r.ParserError('Expected \"'+e+'\" but got \"'+t.text+'\".',t.position)},Parser.prototype.assertVidToken=function(t){if(!t.isVid())throw new r.ParserError('Expected an identifier, got \"'+t.getText()+'\" ('+t.constructor.name+\").\",t.position)},Parser.prototype.assertIdentifierToken=function(t){if(!(t instanceof o.IdentifierToken))throw new r.ParserError('Expected an identifier, got \"'+t.getText()+'\" ('+t.constructor.name+\").\",t.position)},Parser.prototype.assertVidOrLongToken=function(t){if(!(t.isVid()||t instanceof o.LongIdentifierToken))throw new r.ParserError('Expected an identifier, got \"'+t.getText()+'\" ('+t.constructor.name+\").\",t.position)},Parser.prototype.assertIdentifierOrLongToken=function(t){if(!(t instanceof o.IdentifierToken||t instanceof o.LongIdentifierToken))throw new r.ParserError('Expected an identifier, got \"'+t.getText()+'\" ('+t.constructor.name+\").\",t.position)},Parser.prototype.assertRecordLabelToken=function(t){if(!t.isValidRecordLabel())throw new r.ParserError('Expected a record label \"'+t.getText()+'\" ('+t.constructor.name+\").\",t.position)},Parser.prototype.checkVidOrLongToken=function(t){return t.isVid()||t instanceof o.LongIdentifierToken},Parser.prototype.checkIdentifierOrLongToken=function(t){return t instanceof o.IdentifierToken||t instanceof o.LongIdentifierToken},Parser.prototype.checkKeywordToken=function(t,e){return void 0===e&&(e=void 0),t instanceof o.KeywordToken&&(void 0===e||t.text===e)},Parser.prototype.parseOpIdentifierToken=function(t){void 0===t&&(t=!1);var e=this.currentToken(),n=this.checkKeywordToken(e,\"op\");n&&++this.position,t?this.assertIdentifierOrLongToken(this.currentToken()):this.assertIdentifierToken(this.currentToken());var i=this.currentToken();return i.opPrefixed=n,++this.position,i},Parser.prototype.parseAtomicExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,\"op\")){++this.position;var e=this.currentToken();return this.assertVidOrLongToken(e),e.opPrefixed=!0,++this.position,new n.ValueIdentifier(t.position,e)}if(this.checkKeywordToken(t,\"{\"))return++this.position,this.parseExpressionRow();if(this.checkKeywordToken(t,\"(\")){if(++this.position,this.checkKeywordToken(this.currentToken(),\")\"))return++this.position,new n.Tuple(t.position,[]);for(var i=[this.parseExpression()],a=!1,s=!1;;){var e=this.currentToken();if(!this.checkKeywordToken(e,\",\")||a){if(this.checkKeywordToken(e,\";\")&&!s){if(++this.position,a=!0,!this.options.allowSuccessorML||!this.checkKeywordToken(this.currentToken(),\")\")){i.push(this.parseExpression());continue}e=this.currentToken()}if(!this.checkKeywordToken(e,\")\"))throw new r.ParserError('Expected \",\", \";\" or \")\" but got \"'+e.getText()+'\".',e.position);if(++this.position,1===i.length)return i[0];if(s)return new n.Tuple(t.position,i);if(a)return new n.Sequence(t.position,i);i.push(this.parseExpression())}else++this.position,s=!0,i.push(this.parseExpression())}}if(this.checkKeywordToken(t,\"[\")){if(++this.position,this.checkKeywordToken(this.currentToken(),\"]\"))return++this.position,new n.List(t.position,[]);for(var i=[this.parseExpression()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,\",\")){if(this.checkKeywordToken(e,\"]\"))return++this.position,new n.List(t.position,i);throw new r.ParserError('Expected \",\" or \"]\" but found \"'+e.getText()+'\".',e.position)}++this.position,i.push(this.parseExpression())}}if(this.checkKeywordToken(t,\"#\")){++this.position;var u=this.currentToken();if(this.options.allowVector&&this.checkKeywordToken(u,\"[\")){if(++this.position,this.checkKeywordToken(this.currentToken(),\"]\"))return++this.position,new n.Vector(t.position,[]);for(var i=[this.parseExpression()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,\",\")){if(this.checkKeywordToken(e,\"]\"))return++this.position,new n.Vector(t.position,i);throw new r.ParserError('Expected \",\" or \"]\" but found \"'+e.getText()+'\".',e.position)}++this.position,i.push(this.parseExpression())}}return this.assertRecordLabelToken(u),++this.position,new n.RecordSelector(t.position,u)}if(this.checkKeywordToken(t,\"let\")){++this.position;var p=this.state;this.state=this.state.getNestedState(this.state.id);var c=new Set;this.newcons.forEach(function(t){c=c.add(t)});var h=this.parseDeclaration();this.assertKeywordToken(this.currentToken(),\"in\"),++this.position;for(var l=[this.parseExpression()],f=this.currentToken(),d=f.position;this.checkKeywordToken(f,\";\");){if(++this.position,this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),\"end\")){f=this.currentToken();break}l.push(this.parseExpression()),f=this.currentToken()}return this.assertKeywordToken(f,\"end\"),++this.position,this.state=p,this.newcons=c,l.length>=2?new n.LocalDeclarationExpression(t.position,h,new n.Sequence(d,l)):new n.LocalDeclarationExpression(t.position,h,l[0])}if(t instanceof o.ConstantToken)return++this.position,new n.Constant(t.position,t);if(t.isVid()||t instanceof o.LongIdentifierToken){if(++this.position,void 0!==this.state.getInfixStatus(t)&&this.state.getInfixStatus(t).infix)throw new r.ParserError('Infix operator \"'+t.getText()+'\" appeared in non-infix context without \"op\".',t.position);return new n.ValueIdentifier(t.position,t)}throw new r.ParserError('Expected atomic expression, \"'+t.getText()+'\" found.',t.position)},Parser.prototype.parseExpressionRow=function(){for(var t=this.currentToken(),e=[],i=!0;;){var o=this.currentToken();if(this.checkKeywordToken(o,\"}\"))return++this.position,new n.Record(t.position,!0,e);if(i||!this.checkKeywordToken(o,\",\")){if(i=!1,!o.isValidRecordLabel())throw new r.ParserError('Expected \"}\", or identifier, got \"'+o.getText()+'\".',o.position);++this.position;var a=this.currentToken();this.assertKeywordToken(a,\"=\"),++this.position,e.push([o.getText(),this.parseExpression()])}else++this.position}},Parser.prototype.parseApplicationExpression=function(){for(var t=this.currentToken(),e=this.parseAtomicExpression();;){var i=this.position,o=this.currentToken();if(this.checkVidOrLongToken(o)&&void 0!==this.state.getInfixStatus(o)&&this.state.getInfixStatus(o).infix)break;try{var a=this.parseAtomicExpression();e=new n.FunctionApplication(t.position,e,a)}catch(t){if(t instanceof r.IncompleteError)throw t;this.position=i;break}}return e},Parser.prototype.parseInfixExpression=function(){for(var t=[],e=[],i=0;;){t.push(this.parseApplicationExpression());var r=this.currentToken();if(!this.checkVidOrLongToken(r)||void 0===this.state.getInfixStatus(r)||!this.state.getInfixStatus(r).infix)break;++this.position,e.push([r,i++])}return 0===i?t[0]:new n.InfixExpression(t,e).reParse(this.state)},Parser.prototype.parseAppendedExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,\"raise\"))return++this.position,new n.RaiseException(t.position,this.parseExpression());if(this.checkKeywordToken(t,\"if\")){++this.position;var e=this.parseExpression();this.assertKeywordToken(this.currentToken(),\"then\"),++this.position;var i=this.parseExpression();return this.options.allowSuccessorML&&!this.checkKeywordToken(this.currentToken(),\"else\")?new n.Conditional(t.position,e,i,new n.Tuple(-1,[])):(this.assertKeywordToken(this.currentToken(),\"else\"),++this.position,new n.Conditional(t.position,e,i,this.parseExpression()))}if(this.checkKeywordToken(t,\"case\")){++this.position;var e=this.parseExpression();return this.assertKeywordToken(this.currentToken(),\"of\"),++this.position,new n.CaseAnalysis(t.position,e,this.parseMatch())}if(this.checkKeywordToken(t,\"while\")){++this.position;var e=this.parseExpression();return this.assertKeywordToken(this.currentToken(),\"do\"),++this.position,new n.While(t.position,e,this.parseExpression())}if(this.checkKeywordToken(t,\"fn\"))return++this.position,new n.Lambda(t.position,this.parseMatch());for(var r=this.parseInfixExpression(),o=this.currentToken();this.checkKeywordToken(o,\":\");)++this.position,r=new n.TypedExpression(t.position,r,this.parseType()),o=this.currentToken();return r},Parser.prototype.parseExpression=function(){var t=this.parseAppendedExpression(),e=this.currentToken(),i=e;if(this.checkKeywordToken(e,\"andalso\")||this.checkKeywordToken(e,\"orelse\")){for(var r=[[t,[0]]],o=[],a=0;;){if(this.checkKeywordToken(e,\"orelse\"))o.push([1,a++]),++this.position;else{if(!this.checkKeywordToken(e,\"andalso\"))break;o.push([0,a++]),++this.position}r.push([this.parseAppendedExpression(),[a]]),e=this.currentToken()}o.sort();for(var s=0;s<o.length;++s){var u=r[o[s][1]][0],p=r[o[s][1]+1][0],c=void 0;c=0===o[s][0]?new n.Conjunction(u.position,u,p):new n.Disjunction(u.position,u,p);for(var h=r[o[s][1]][1],l=0,f=r[o[s][1]+1][1];l<f.length;l++){var d=f[l];h.push(d)}for(var y=0,v=h;y<v.length;y++){var d=v[y];r[d]=[c,h]}}t=r[0][0]}for(e=this.currentToken();this.checkKeywordToken(e,\"handle\");)++this.position,t=new n.HandleException(i.position,t,this.parseMatch()),e=this.currentToken();return t},Parser.prototype.parseSimpleStructureExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,\"struct\")){++this.position;var e=this.parseDeclaration(!1,!0);return this.assertKeywordToken(this.currentToken(),\"end\"),++this.position,new s.StructureExpression(t.position,e)}if(this.checkKeywordToken(t,\"let\")){++this.position;var e=this.parseDeclaration(!1,!0);this.assertKeywordToken(this.currentToken(),\"in\"),++this.position;var n=this.parseStructureExpression();return this.assertKeywordToken(this.currentToken(),\"end\"),++this.position,new s.LocalDeclarationStructureExpression(t.position,e,n)}if(t instanceof o.IdentifierToken)if(++this.position,this.checkKeywordToken(this.currentToken(),\"(\")){++this.position;var i=this.position;try{var n=this.parseStructureExpression();return this.assertKeywordToken(this.currentToken(),\")\"),++this.position,new s.FunctorApplication(t.position,t,n)}catch(n){this.position=i;var e=this.parseDeclaration(!1,!0);return this.assertKeywordToken(this.currentToken(),\")\"),++this.position,new s.FunctorApplication(t.position,t,new s.StructureExpression(t.position,e))}}else--this.position;if(this.checkIdentifierOrLongToken(t))return++this.position,new s.StructureIdentifier(t.position,t);throw new r.ParserError(\"Expected a simple structure expression.\",t.position)},Parser.prototype.parseStructureExpression=function(){for(var t=this.currentToken(),e=this.parseSimpleStructureExpression();;)if(this.checkKeywordToken(this.currentToken(),\":\"))++this.position,e=new s.TransparentConstraint(t.position,e,this.parseSignatureExpression());else{if(!this.checkKeywordToken(this.currentToken(),\":>\"))break;++this.position,e=new s.OpaqueConstraint(t.position,e,this.parseSignatureExpression())}return e},Parser.prototype.parseSimpleSignatureExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,\"sig\")){++this.position;var e=this.parseSpecification();return this.assertKeywordToken(this.currentToken(),\"end\"),++this.position,new s.SignatureExpression(t.position,e)}if(t instanceof o.IdentifierToken)return++this.position,new s.SignatureIdentifier(t.position,t);throw new r.ParserError(\"Expected a simple signature expression.\",t.position)},Parser.prototype.parseSignatureExpression=function(){for(var t=this.currentToken(),e=this.parseSimpleSignatureExpression(),n=!0;this.checkKeywordToken(this.currentToken(),\"where\")||!n&&this.checkKeywordToken(this.currentToken(),\"and\");){n=!1,++this.position,this.assertKeywordToken(this.currentToken(),\"type\"),++this.position;var i=this.parseTypeVarSequence();this.assertIdentifierOrLongToken(this.currentToken());var r=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,e=new s.TypeRealisation(t.position,e,i,r,this.parseType())}return e},Parser.prototype.parseSimpleSpecification=function(){var t=this.currentToken();if(this.checkKeywordToken(t,\"val\")){++this.position;for(var e=[];;){this.assertIdentifierOrLongToken(this.currentToken());var n=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),\":\"),++this.position,e.push([n,this.parseType()]),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.ValueSpecification(t.position,e)}if(this.checkKeywordToken(t,\"type\")){++this.position;for(var e=[],i=this.position;;){var r=this.parseTypeVarSequence();if(this.assertIdentifierToken(this.currentToken()),e.push([r,this.currentToken()]),++this.position,this.checkKeywordToken(this.currentToken(),\"=\")){var o=[];for(this.position=i;;){r=this.parseTypeVarSequence(),this.assertIdentifierToken(this.currentToken());var n=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,o.push([r,n,this.parseType()]),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.TypeAliasSpecification(t.position,o)}if(!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.TypeSpecification(t.position,e)}if(this.checkKeywordToken(t,\"eqtype\")){++this.position;for(var e=[];;){var r=this.parseTypeVarSequence();if(this.assertIdentifierToken(this.currentToken()),e.push([r,this.currentToken()]),++this.position,!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.EqualityTypeSpecification(t.position,e)}if(this.checkKeywordToken(t,\"datatype\")){if(++this.position+2<this.tokens.length&&this.checkKeywordToken(this.tokens[this.position+2],\"datatype\")){this.assertIdentifierToken(this.currentToken());var a=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,this.assertKeywordToken(this.currentToken(),\"datatype\"),++this.position,this.assertIdentifierOrLongToken(this.currentToken());var u=this.currentToken();return++this.position,new s.DatatypeReplicationSpecification(t.position,a,u)}for(var e=[];;){var r=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var a=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,!0===this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),\"|\")&&++this.position;for(var p=[];;){this.assertIdentifierToken(this.currentToken());var c=this.currentToken();++this.position;var h=void 0;if(this.checkKeywordToken(this.currentToken(),\"of\")&&(++this.position,h=this.parseType()),p.push([c,h]),!this.checkKeywordToken(this.currentToken(),\"|\"))break;++this.position}if(e.push([r,a,p]),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.DatatypeSpecification(t.position,e)}if(this.checkKeywordToken(t,\"exception\")){++this.position;for(var e=[];;){this.assertIdentifierToken(this.currentToken());var a=this.currentToken();++this.position;var h=void 0;if(this.checkKeywordToken(this.currentToken(),\"of\")&&(++this.position,h=this.parseType()),e.push([a,h]),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.ExceptionSpecification(t.position,e)}if(this.checkKeywordToken(t,\"structure\")){++this.position;for(var e=[];;){this.assertIdentifierToken(this.currentToken());var a=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),\":\"),++this.position,e.push([a,this.parseSignatureExpression()]),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new s.StructureSpecification(t.position,e)}if(this.checkKeywordToken(t,\"include\")){++this.position;var l=[],f=this.position;try{for(;;)l.push(this.parseSignatureExpression()),f=this.position}catch(t){this.position=f}return new s.IncludeSpecification(t.position,l)}return new s.EmptySpecification(t.position)},Parser.prototype.parseSequentialSpecification=function(){for(var t=this.currentToken(),e=[];;){var n=this.parseSimpleSpecification();if(n instanceof s.EmptySpecification)break;e.push(n),this.checkKeywordToken(this.currentToken(),\";\")&&++this.position}return new s.SequentialSpecification(t.position,e)},Parser.prototype.parseSpecification=function(){for(var t=this.currentToken(),e=this.parseSequentialSpecification();this.checkKeywordToken(this.currentToken(),\"sharing\");){++this.position,this.assertKeywordToken(this.currentToken(),\"type\"),++this.position,this.assertIdentifierOrLongToken(this.currentToken());var n=[this.currentToken()];for(++this.position;this.checkKeywordToken(this.currentToken(),\"=\");)++this.position,this.assertIdentifierOrLongToken(this.currentToken()),n.push(this.currentToken()),++this.position;if(n.length<2)throw new r.ParserError('A \"sharing\" expression requires at least 2 type names.',t.position);e=new s.SharingSpecification(t.position,e,n)}return e},Parser.prototype.parseMatch=function(){var t=this.currentToken();this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),\"|\")&&++this.position;for(var e=[];;){var i=this.parsePattern();i.simplify().assertUniqueBinding(this.state,this.newcons),this.assertKeywordToken(this.currentToken(),\"=>\"),++this.position;var r=this.parseExpression();if(e.push([i,r]),!this.checkKeywordToken(this.currentToken(),\"|\"))break;++this.position}return new n.Match(t.position,e)},Parser.prototype.parsePatternRow=function(){for(var t=this.currentToken(),e=[],i=!0,a=!0;;){var s=this.currentToken();if(this.checkKeywordToken(s,\"}\"))return++this.position,new n.Record(t.position,a,e);if(!a)throw new r.ParserError(\"Record wildcard must appear as last element of the record.\",s.position);if(i||!this.checkKeywordToken(s,\",\"))if(i=!1,this.checkKeywordToken(s,\"...\"))a=!1,++this.position;else{if(!s.isValidRecordLabel())throw new r.ParserError('Expected \"}\", \"...\", or identifier.',s.position);++this.position;var u=this.currentToken();if(!(u instanceof o.KeywordToken))throw new r.ParserError('Expected \":\", \"as\", \",\", or \"=\", got '+u.getText()+'\".',u.position);if(\"=\"===u.text){++this.position,e.push([s.getText(),this.parsePattern()]);continue}var p=void 0;if(s instanceof o.NumericToken)throw new r.ParserError('You cannot assign to \"'+s.getText()+'\".',s.position);var c=new n.ValueIdentifier(s.position,s);\":\"===u.text&&(++this.position,p=this.parseType(),u=this.currentToken()),\"as\"!==u.text||this.options.allowSuccessorML?void 0!==p&&(c=new n.TypedExpression(c.position,c,p)):(++this.position,c=new n.LayeredPattern(c.position,c.name,p,this.parsePattern()),u=this.currentToken()),e.push([s.getText(),c])}else++this.position}},Parser.prototype.parseAtomicPattern=function(){if(this.position>=this.tokens.length)throw new r.ParserError(\"Unexpected end of token stream\",-1);var t=this.currentToken();if(this.checkKeywordToken(t,\"op\")){++this.position;var e=this.currentToken();this.assertVidOrLongToken(e),e.opPrefixed=!0,++this.position;var i=this.position;try{if(!(e instanceof o.LongIdentifierToken)){var a=this.currentToken(),s=void 0;return this.checkKeywordToken(a,\":\")&&(++this.position,s=this.parseType(),a=this.currentToken()),this.assertKeywordToken(a,\"as\"),++this.position,new n.LayeredPattern(t.position,e,s,this.parsePattern())}}catch(t){this.position=i}return new n.ValueIdentifier(t.position,e)}if(this.checkKeywordToken(t,\"_\"))return++this.position,new n.Wildcard(t.position);if(this.checkKeywordToken(t,\"{\")){++this.position;return this.parsePatternRow()}if(this.checkKeywordToken(t,\"(\")){if(++this.position,this.checkKeywordToken(this.currentToken(),\")\"))return++this.position,new n.Tuple(t.position,[]);for(var u=[this.parsePattern()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,\",\")){if(this.checkKeywordToken(e,\")\"))return++this.position,1===u.length?u[0]:new n.Tuple(t.position,u);throw new r.ParserError('Expected \",\" or \")\", but got \"'+e.getText()+'\".',e.position)}++this.position,u.push(this.parsePattern())}}if(this.options.allowVector&&this.checkKeywordToken(t,\"#\")&&this.checkKeywordToken(this.nextToken(),\"[\")){if(++this.position,++this.position,this.checkKeywordToken(this.currentToken(),\"]\"))return++this.position,new n.Vector(t.position,[]);for(var u=[this.parsePattern()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,\",\")){if(this.checkKeywordToken(e,\"]\"))return++this.position,new n.Vector(t.position,u);throw new r.ParserError('Expected \",\" or \"]\" but found \"'+e.getText()+'\".',e.position)}++this.position,u.push(this.parsePattern())}}if(this.checkKeywordToken(t,\"[\")){if(++this.position,this.checkKeywordToken(this.currentToken(),\"]\"))return++this.position,new n.List(t.position,[]);for(var u=[this.parsePattern()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,\",\")){if(this.checkKeywordToken(e,\"]\"))return++this.position,new n.List(t.position,u);throw new r.ParserError('Expected \",\" or \"]\" but found \"'+e.getText()+'\".',e.position)}++this.position,u.push(this.parsePattern())}}else{if(t instanceof o.ConstantToken){if(t instanceof o.RealConstantToken)throw new r.ParserError('I am not interested in real constants such as \"'+t.getText()+'\" appearing in patterns.',t.position);return++this.position,new n.Constant(t.position,t)}if(t.isVid()&&\"=\"!==t.getText()||t instanceof o.LongIdentifierToken){++this.position;var i=this.position;try{if(!(t instanceof o.LongIdentifierToken)){var a=this.currentToken(),s=void 0;return this.checkKeywordToken(a,\":\")&&(++this.position,s=this.parseType(),a=this.currentToken()),this.assertKeywordToken(a,\"as\"),++this.position,t instanceof o.KeywordToken&&(t=new o.IdentifierToken(t.getText(),t.position)),new n.LayeredPattern(t.position,t,s,this.parsePattern())}}catch(t){this.position=i}return new n.ValueIdentifier(t.position,t)}}throw new r.ParserError('Expected atomic pattern but got \"'+t.getText()+'\".',t.position)},Parser.prototype.parseApplicationPattern=function(){var t=this.position,e=this.currentToken(),i=this.parseAtomicPattern();if(i instanceof n.ValueIdentifier&&void 0!==this.state.getInfixStatus(i.name)&&this.state.getInfixStatus(i.name).infix){if(!(t>0&&this.checkKeywordToken(this.tokens[t-1],\"op\")||this.checkKeywordToken(e,\"op\")))throw new r.ParserError('Infix operator \"'+i+'\" appeared in non-infix context without \"op\".',e.position)}for(;;){var o=this.position,a=this.currentToken();if(this.checkVidOrLongToken(a)&&void 0!==this.state.getInfixStatus(a)&&this.state.getInfixStatus(a).infix)break;var s=!1;try{var u=this.parseAtomicPattern();if(i instanceof n.Wildcard)throw s=!0,new r.ParserError(\"You cannot apply a pattern to a wildcard.\",e.position);i=new n.FunctionApplication(e.position,i,u)}catch(t){if(s)throw t;this.position=o;break}}return i},Parser.prototype.parseInfixPattern=function(){for(var t=[],e=[],i=0;;){t.push(this.parseApplicationPattern());var r=this.currentToken();if(!this.checkIdentifierOrLongToken(r)||void 0===this.state.getInfixStatus(r)||!this.state.getInfixStatus(r).infix)break;++this.position,e.push([r,i++])}return 0===i?t[0]:new n.InfixExpression(t,e).reParse(this.state)},Parser.prototype.parsePattern=function(){for(var t=this.currentToken(),e=this.parseInfixPattern();;){if(!this.checkKeywordToken(this.currentToken(),\":\")){if(!0===this.options.allowSuccessorML){if(this.checkKeywordToken(this.currentToken(),\"as\")){++this.position,e=new n.ConjunctivePattern(t.position,e,this.parsePattern());continue}if(this.checkKeywordToken(this.currentToken(),\"|\")){++this.position,e=new n.DisjunctivePattern(t.position,e,this.parseInfixPattern());continue}if(this.checkKeywordToken(this.currentToken(),\"with\")){++this.position;var i=this.parsePattern();this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,e=new n.NestedMatch(t.position,e,i,this.parseExpression());continue}if(this.checkKeywordToken(this.currentToken(),\"if\")){++this.position,e=new n.PatternGuard(t.position,e,this.parseExpression());continue}}break}++this.position,e=new n.TypedExpression(t.position,e,this.parseType())}return e},Parser.prototype.parseTypeRow=function(){for(var t=this.currentToken(),e=new Map,n=!0;;){var a=this.currentToken();if(this.checkKeywordToken(a,\"}\"))return++this.position,new i.RecordType(e,!0,t.position);{if(n||!this.checkKeywordToken(a,\",\")){if(n=!1,a.isValidRecordLabel()){++this.position;var s=this.currentToken();if(!(s instanceof o.KeywordToken))throw new r.ParserError('Expected \":\".',s.position);if(\":\"===s.text){if(++this.position,e.has(a.getText()))throw new r.ParserError('Duplicate record label \"'+a.getText()+'\".',a.position);e.set(a.getText(),this.parseType());continue}throw new r.ParserError('Expected \":\".',s.position)}throw new r.ParserError('Expected \"}\", or an identifier, got \"'+a.getText()+'\".',a.position)}++this.position}}},Parser.prototype.parseSimpleType=function(){var t=this.currentToken();if(t instanceof o.TypeVariableToken)return++this.position,new i.TypeVariable(t.getText(),t.position);if(this.checkIdentifierOrLongToken(t))return++this.position,t instanceof o.LongIdentifierToken?new i.CustomType(t.id.getText(),[],t.position,t):new i.CustomType(t.getText(),[],t.position);if(this.checkKeywordToken(t,\"{\"))return++this.position,this.parseTypeRow();if(this.checkKeywordToken(t,\"(\")){if(++this.position,this.checkKeywordToken(this.currentToken(),\")\"))throw new r.ParserError('Use \"{}\" or \"unit\" to denote the unit type.',this.currentToken().position);for(var e=[this.parseType()];;){var n=this.currentToken();{if(!this.checkKeywordToken(n,\",\")){if(this.checkKeywordToken(n,\")\")){if(++this.position,1===e.length)return e[0];this.assertIdentifierOrLongToken(this.currentToken());var a=this.currentToken();return++this.position,new i.CustomType(a.getText(),e,t.position)}throw new r.ParserError('Expected \",\" or \")\", got \"'+n.getText()+'\".',n.position)}++this.position,e.push(this.parseType())}}}throw new r.ParserError('Expected either \"(\" or \"{\" got \"'+t.getText()+'\".',t.position)},Parser.prototype.parseType=function(){var t=this.parseTupleType(),e=this.currentToken();if(!this.checkKeywordToken(e,\"->\"))return t;++this.position;var n=this.parseType();return new i.FunctionType(t,n,e.position)},Parser.prototype.parseTupleType=function(){for(var t=[this.parseCustomType()],e=this.currentToken(),n=e.position;this.checkKeywordToken(this.currentToken(),\"*\");)++this.position,t.push(this.parseCustomType());return 1===t.length?t[0]:new i.TupleType(t,n)},Parser.prototype.parseCustomType=function(){for(var t=this.currentToken(),e=this.parseSimpleType();this.position<this.tokens.length;){var n=this.currentToken();if(!this.checkIdentifierOrLongToken(n))return e;++this.position,e=n instanceof o.LongIdentifierToken?new i.CustomType(n.id.getText(),[e],t.position,n):new i.CustomType(n.getText(),[e],t.position)}return e},Parser.prototype.parseValueBinding=function(){var t=this.currentToken();if(this.checkKeywordToken(t,\"rec\")){++this.position;var e=this.parseValueBinding();return e.position=t.position,e.isRecursive=!0,e}var n=this.parsePattern();return n.simplify().assertUniqueBinding(this.state,this.newcons),this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new a.ValueBinding(t.position,!1,n,this.parseExpression())},Parser.prototype.parseFunctionValueBinding=function(){var t=this.currentToken(),e=[],i=-1,o=void 0;for(!0===this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),\"|\")&&++this.position;;){var s=[],u=void 0,p=void 0;if(this.checkKeywordToken(this.currentToken(),\"(\")){var c=this.position;try{var h=this.parsePattern(),l=!1,f=[];for(h instanceof n.FunctionApplication||(l=!0);!l&&h instanceof n.FunctionApplication;)f.push(h.argument),h=h.func;if(h instanceof n.ValueIdentifier||(l=!0),l)throw new r.ParserError(\"Nyaboron is sad. Did you forget a function name?\",h.position);p=h;for(var d=f.length-1;d>=0;--d)s.push(f[d])}catch(t){var y=!1;try{this.position=c,++this.position;var v=this.parseAtomicPattern();if(this.assertVidOrLongToken(this.currentToken()),p=new n.ValueIdentifier(this.currentToken().position,this.currentToken()),void 0===this.state.getInfixStatus(this.currentToken())||!this.state.getInfixStatus(this.currentToken()).infix)throw new r.ParserError('\"'+this.currentToken().getText()+'\" does not have infix status.',this.currentToken().position);if(!0!==this.options.allowSuccessorML&&\"=\"===this.currentToken().getText())throw y=!0,new r.FeatureDisabledError(this.currentToken().position,'Why would you try to rebind \"=\"?');++this.position;var m=this.parseAtomicPattern();for(this.assertKeywordToken(this.currentToken(),\")\"),++this.position,s.push(new n.Tuple(-1,[v,m]));;){if(this.checkKeywordToken(this.currentToken(),\"=\")||this.checkKeywordToken(this.currentToken(),\":\"))break;var h=this.parseAtomicPattern();if(h instanceof n.ValueIdentifier&&void 0!==this.state.getInfixStatus(h.name)&&this.state.getInfixStatus(h.name).infix)throw new r.ParserError('Cute little infix identifiers such as \"'+h+'\" sure should play somewhere else.',h.position);s.push(h)}}catch(e){if(!y)throw t;throw e}}}else{var g=this.position,w=!1,T=!1;try{var E=this.parseOpIdentifierToken();if(p=new n.ValueIdentifier(E.position,E),void 0!==this.state.getInfixStatus(p.name)&&this.state.getInfixStatus(p.name).infix&&!p.name.opPrefixed)throw w=!0,new r.ParserError('Missing \"op\".',p.name.position);for(;;){if(this.checkKeywordToken(this.currentToken(),\"=\")||this.checkKeywordToken(this.currentToken(),\":\"))break;var h=this.parseAtomicPattern();if(h instanceof n.ValueIdentifier&&void 0!==this.state.getInfixStatus(h.name)&&this.state.getInfixStatus(h.name).infix)throw T=!0,new r.ParserError('Cute little infix identifiers such as \"'+h+'\" sure should play somewhere else.',h.position);s.push(h)}}catch(t){if(w)throw t;w=!1;try{this.position=g;var v=this.parseAtomicPattern();if(this.assertVidOrLongToken(this.currentToken()),p=new n.ValueIdentifier(this.currentToken().position,this.currentToken()),void 0===this.state.getInfixStatus(this.currentToken())||!this.state.getInfixStatus(this.currentToken()).infix){if(T)throw w=!0,t;throw new r.ParserError('\"'+this.currentToken().getText()+'\" does not have infix status.',this.currentToken().position)}++this.position;var m=this.parseAtomicPattern();s.push(new n.Tuple(-1,[v,m]))}catch(e){throw console.log(e),t}}}if(this.checkKeywordToken(this.currentToken(),\":\")&&(++this.position,u=this.parseType()),this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,-1===i)i=s.length;else if(2!==i&&3!==i&&i!==s.length)throw new r.ParserError(\"Different number of arguments.\",t.position);if(0===i)throw new r.ParserError('Functions need arguments to survive. Rely on \"val\" instead.',t.position);if(void 0===o)o=p;else if(p.name.getText()!==o.name.getText())throw new r.ParserError('Different function names in different cases (\"'+p.name.getText()+'\" vs. \"'+o.name.getText()+'\")',t.position);if(new n.Tuple(-1,s).simplify().assertUniqueBinding(this.state,this.newcons),e.push([s,u,this.parseExpression()]),!this.checkKeywordToken(this.currentToken(),\"|\"))break;++this.position}return new a.FunctionValueBinding(t.position,e,o)},Parser.prototype.parseTypeBinding=function(){var t=this.currentToken(),e=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var n=this.currentToken();return++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new a.TypeBinding(t.position,e,n,this.parseType())},Parser.prototype.parseTypeBindingSeq=function(){for(var t=[];;){if(t.push(this.parseTypeBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return t},Parser.prototype.parseExceptionBinding=function(){var t=this.currentToken(),e=this.parseOpIdentifierToken();if(this.checkKeywordToken(this.currentToken(),\"of\")){++this.position;var n=this.parseType();return new a.DirectExceptionBinding(t.position,e,n)}if(this.checkKeywordToken(this.currentToken(),\"=\")){++this.position;var i=this.parseOpIdentifierToken(!0);return new a.ExceptionAlias(t.position,e,i)}return new a.DirectExceptionBinding(t.position,e,void 0)},Parser.prototype.parseDatatypeBinding=function(){var t=this.currentToken(),e=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var n=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position;var i=[];for(!0===this.options.allowSuccessorML&&this.checkKeywordToken(this.currentToken(),\"|\")&&++this.position;;){var r=this.parseOpIdentifierToken();if(this.newcons=this.newcons.add(r.getText()),this.checkKeywordToken(this.currentToken(),\"of\")){++this.position;var o=this.parseType();i.push([r,o])}else i.push([r,void 0]);if(!this.checkKeywordToken(this.currentToken(),\"|\"))break;++this.position}return new a.DatatypeBinding(t.position,e,n,i)},Parser.prototype.parseDatatypeBindingSeq=function(){for(var t=[];;){if(t.push(this.parseDatatypeBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return t},Parser.prototype.parseStructureBinding=function(){var t=this.currentToken();this.assertIdentifierToken(this.currentToken());var e=this.currentToken();if(++this.position,this.checkKeywordToken(this.currentToken(),\":\")){++this.position;var n=this.parseSignatureExpression();this.assertKeywordToken(this.currentToken(),\"=\"),++this.position;var i=this.parseStructureExpression();return new s.StructureBinding(t.position,e,new s.TransparentConstraint(t.position,i,n))}if(this.checkKeywordToken(this.currentToken(),\":>\")){++this.position;var n=this.parseSignatureExpression();this.assertKeywordToken(this.currentToken(),\"=\"),++this.position;var i=this.parseStructureExpression();return new s.StructureBinding(t.position,e,new s.OpaqueConstraint(t.position,i,n))}return this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new s.StructureBinding(t.position,e,this.parseStructureExpression())},Parser.prototype.parseStructureBindingSeq=function(){for(var t=[];;){if(t.push(this.parseStructureBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return t},Parser.prototype.parseSignatureBinding=function(){var t=this.currentToken();this.assertIdentifierToken(this.currentToken());var e=this.currentToken();return++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new s.SignatureBinding(t.position,e,this.parseSignatureExpression())},Parser.prototype.parseSignatureBindingSeq=function(){for(var t=[];;){if(t.push(this.parseSignatureBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return t},Parser.prototype.parseFunctorBinding=function(){var t=this.currentToken();this.assertIdentifierToken(this.currentToken());var e=this.currentToken();if(++this.position,this.assertKeywordToken(this.currentToken(),\"(\"),++this.position,this.currentToken()instanceof o.IdentifierToken){var n=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),\":\"),++this.position;var i=this.parseSignatureExpression();if(this.assertKeywordToken(this.currentToken(),\")\"),++this.position,this.checkKeywordToken(this.currentToken(),\":\")){++this.position;var r=this.parseSignatureExpression();return this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new s.FunctorBinding(t.position,e,n,i,new s.TransparentConstraint(t.position,this.parseStructureExpression(),r))}if(this.checkKeywordToken(this.currentToken(),\":>\")){++this.position;var r=this.parseSignatureExpression();return this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new s.FunctorBinding(t.position,e,n,i,new s.OpaqueConstraint(t.position,this.parseStructureExpression(),r))}return this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,new s.FunctorBinding(t.position,e,n,i,this.parseStructureExpression())}var u=this.parseSpecification(),p=new s.SignatureExpression(-1,u);this.assertKeywordToken(this.currentToken(),\")\"),++this.position;var c=!1,h=void 0;this.checkKeywordToken(this.currentToken(),\":\")?(++this.position,h=this.parseSignatureExpression()):this.checkKeywordToken(this.currentToken(),\":>\")&&(c=!0,++this.position,h=this.parseSignatureExpression()),this.assertKeywordToken(this.currentToken(),\"=\"),++this.position;var l=this.parseStructureExpression(),f=new o.AlphanumericIdentifierToken(\"__farg\",-1);return void 0!==h&&(l=c?new s.OpaqueConstraint(-1,l,h):new s.TransparentConstraint(-1,l,h)),l=new s.LocalDeclarationStructureExpression(-1,new a.OpenDeclaration(-1,[f]),l),new s.FunctorBinding(t.position,e,f,p,l)},Parser.prototype.parseFunctorBindingSeq=function(){for(var t=[];;){if(t.push(this.parseFunctorBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return t},Parser.prototype.parseTypeVarSequence=function(t){void 0===t&&(t=!1);var e=this.currentToken(),n=[];if(e instanceof o.TypeVariableToken)return n.push(new i.TypeVariable(e.text,e.position)),++this.position,n;if(this.checkKeywordToken(e,\"(\"))for(++this.position;;){if(!((e=this.currentToken())instanceof o.TypeVariableToken)){if(t)return;throw new r.ParserError(\"Expected a type varible.\",e.position)}if(n.push(new i.TypeVariable(e.text,e.position)),++this.position,e=this.currentToken(),!this.checkKeywordToken(e,\",\")){if(this.checkKeywordToken(e,\")\")){++this.position;break}throw new r.ParserError('Expected \",\" or \")\" but got \"'+e.getText()+'\".',e.position)}++this.position}return n},Parser.prototype.parseDeclaration=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1);for(var n=[],i=this.currentToken(),r=this.currentId++;this.position<this.tokens.length;){var o=this.parseSimpleDeclaration(t,e);if(o instanceof a.EmptyDeclaration){if(this.position>=this.tokens.length||this.checkKeywordToken(this.currentToken(),\"in\")||this.checkKeywordToken(this.currentToken(),\"end\")||this.checkKeywordToken(this.currentToken(),\")\"))break}else n.push(o),this.checkKeywordToken(this.currentToken(),\";\")&&++this.position}return new a.SequentialDeclaration(i.position,n,r)},Parser.prototype.parseSimpleDeclaration=function(t,e){void 0===t&&(t=!1),void 0===e&&(e=!1);var i=this.currentToken(),u=this.currentId++;if(this.checkKeywordToken(i,\"val\")){++this.position;var p=this.parseTypeVarSequence(!0);void 0===p&&(--this.position,p=[]);for(var c=[],h=!1;;){var l=this.parseValueBinding();if(l.isRecursive){h=!0;for(var f=l.pattern;f instanceof n.TypedExpression;)f=f.expression;if(!(l.expression instanceof n.Lambda))throw new r.ParserError('Using \"rec\" requires binding a lambda.',l.position);if(!(f instanceof n.ValueIdentifier||f instanceof n.Wildcard))throw new r.ParserError('Using \"rec\" requires binding to a single identifier and not \"'+f.toString(0,!0)+'\".',l.position)}if(l.isRecursive=h,c.push(l),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new a.ValueDeclaration(i.position,p,c,u)}if(this.checkKeywordToken(i,\"fun\")){++this.position;var p=this.parseTypeVarSequence(!0);void 0===p&&(--this.position,p=[]);for(var d=[];;){if(d.push(this.parseFunctionValueBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new a.FunctionDeclaration(i.position,p,d,u)}if(this.checkKeywordToken(i,\"type\"))return++this.position,new a.TypeDeclaration(i.position,this.parseTypeBindingSeq(),u);if(this.checkKeywordToken(i,\"datatype\")){if(this.position+3<this.tokens.length&&this.checkKeywordToken(this.tokens[this.position+3],\"datatype\")){++this.position;var y=this.currentToken();this.assertIdentifierToken(y),++this.position,this.assertKeywordToken(this.currentToken(),\"=\"),++this.position,this.assertKeywordToken(this.currentToken(),\"datatype\"),++this.position;var v=this.currentToken();return this.assertIdentifierOrLongToken(v),++this.position,new a.DatatypeReplication(i.position,y,v,u)}++this.position;var m=this.parseDatatypeBindingSeq();if(this.checkKeywordToken(this.currentToken(),\"withtype\")){++this.position;var g=this.parseTypeBindingSeq();return new a.DatatypeDeclaration(i.position,m,g,u)}return new a.DatatypeDeclaration(i.position,m,void 0,u)}if(this.checkKeywordToken(i,\"abstype\")){++this.position;var w=this.state;this.state=this.state.getNestedState(this.state.id);var T=new Set;this.newcons.forEach(function(t){T=T.add(t)});var m=this.parseDatatypeBindingSeq(),E=void 0;this.checkKeywordToken(this.currentToken(),\"withtype\")&&(++this.position,E=this.parseTypeBindingSeq()),this.assertKeywordToken(this.currentToken(),\"with\"),++this.position;var S=this.parseDeclaration();return this.assertKeywordToken(this.currentToken(),\"end\"),++this.position,this.state=w,this.newcons=T,new a.AbstypeDeclaration(i.position,m,E,S,u)}if(this.checkKeywordToken(i,\"exception\")){++this.position;for(var x=[];;){if(x.push(this.parseExceptionBinding()),!this.checkKeywordToken(this.currentToken(),\"and\"))break;++this.position}return new a.ExceptionDeclaration(i.position,x,u)}if(this.checkKeywordToken(i,\"local\")){++this.position;var w=this.state;this.state=this.state.getNestedState(this.state.id);var I=new Set;this.newcons.forEach(function(t){I=I.add(t)});var S=this.parseDeclaration(!1,e);this.assertKeywordToken(this.currentToken(),\"in\"),++this.position;var V=this.parseDeclaration(!1,e);return this.assertKeywordToken(this.currentToken(),\"end\"),++this.position,this.state=w,this.newcons=I,new a.LocalDeclaration(i.position,S,V,u)}if(this.checkKeywordToken(i,\"open\")){++this.position;for(var k=[];this.checkIdentifierOrLongToken(this.currentToken());)k.push(this.currentToken()),++this.position;if(0===k.length)throw new r.ParserError('Empty \"open\" declaration.',this.currentToken().position);return new a.OpenDeclaration(i.position,k,u)}if(this.checkKeywordToken(i,\"infix\")){++this.position;var b=0;if(this.currentToken()instanceof o.IntegerConstantToken){if(1!==this.currentToken().text.length)throw new r.ParserError(\"Precedences may only be single digits.\",this.currentToken().position);b=this.currentToken().value,++this.position}for(var k=[];this.currentToken().isVid();)k.push(this.currentToken()),++this.position;if(0===k.length)throw new r.ParserError('Empty \"infix\" declaration.',this.currentToken().position);var A=new a.InfixDeclaration(i.position,k,b,u);return A.setInfixStatus(this.state),A}if(this.checkKeywordToken(i,\"infixr\")){++this.position;var b=0;if(this.currentToken()instanceof o.IntegerConstantToken){if(1!==this.currentToken().text.length)throw new r.ParserError(\"Precedences may only be single digits.\",this.currentToken().position);b=this.currentToken().value,++this.position}for(var k=[];this.currentToken().isVid();)k.push(this.currentToken()),++this.position;if(0===k.length)throw new r.ParserError('Empty \"infixr\" declaration.',this.currentToken().position);var A=new a.InfixRDeclaration(i.position,k,b,u);return A.setInfixStatus(this.state),A}if(this.checkKeywordToken(i,\"nonfix\")){++this.position;for(var k=[];this.currentToken().isVid();)k.push(this.currentToken()),++this.position;if(0===k.length)throw new r.ParserError('Empty \"nonfix\" declaration.',this.currentToken().position);var A=new a.NonfixDeclaration(i.position,k,u);return A.setInfixStatus(this.state),A}if(this.options.allowSuccessorML&&this.checkKeywordToken(i,\"do\"))return++this.position,new a.Evaluation(i.position,this.parseExpression());if((!0===this.options.allowStructuresAnywhere||e)&&this.checkKeywordToken(i,\"structure\"))return++this.position,new s.StructureDeclaration(i.position,this.parseStructureBindingSeq());if((!0===this.options.allowSignaturesAnywhere||t)&&this.checkKeywordToken(i,\"signature\"))return++this.position,new s.SignatureDeclaration(i.position,this.parseSignatureBindingSeq());if((!0===this.options.allowFunctorsAnywhere||t)&&this.checkKeywordToken(i,\"functor\"))return++this.position,new s.FunctorDeclaration(i.position,this.parseFunctorBindingSeq());if(this.checkKeywordToken(i,\";\"))return++this.position,new a.EmptyDeclaration(u);if(this.checkKeywordToken(i,\"in\")||this.checkKeywordToken(i,\"end\")||this.checkKeywordToken(i,\")\"))return new a.EmptyDeclaration(u);if(t){if(this.position>0&&!this.checkKeywordToken(this.tokens[this.position-1],\";\"))throw new r.ParserError('A single top-level expression must be separated from preceeding declarations by a \";\".',this.position);var L=this.parseExpression(),R=new a.ValueBinding(i.position,!1,new n.ValueIdentifier(-1,new o.AlphanumericIdentifierToken(\"it\",-1)),L);return this.assertKeywordToken(this.currentToken(),\";\"),new a.ValueDeclaration(i.position,[],[R],u)}throw new r.ParserError('Expected a declaration, found \"'+i.getText()+'\".',i.position)},Parser.prototype.currentToken=function(){if(this.position>=this.tokens.length)throw new r.IncompleteError(-1,\"More input, I'm starving. ~nyan.\");return this.tokens[this.position]},Parser.prototype.nextToken=function(){if(this.position+1>=this.tokens.length)throw new r.IncompleteError(-1,\"More input, I'm starving. ~nyan.\");return this.tokens[this.position+1]},Parser}();exports.Parser=u,exports.parse=parse},function(t,exports,e){\"use strict\";function interpret(t,e,i){void 0===e&&(e=n.getInitialState()),void 0===i&&(i={allowUnicodeInStrings:!1,allowSuccessorML:!1,disableElaboration:!1,allowVector:!0,strictMode:!0});var u=e.getNestedState(),p=o.lex(t,i),c=a.parse(p,u,i);if(c=c.simplify(),u=e.getNestedState(),!0===i.disableElaboration){var h=s.evaluate(e.getNestedState(),c);if(void 0===h)throw new r.InternalInterpreterError(-1,\"How is this undefined?\");return{state:h.newState,evaluationErrored:h.hasThrown,error:h.value,warnings:h.newState.getWarnings()}}var l=c.elaborate(u,new Map,\"'*t0\",!0,i);if(u=l[0],!0===i.disableEvaluation)return{state:u,evaluationErrored:!1,error:void 0,warnings:u.getWarnings()};var f=s.evaluate(e.getNestedState(),c);if(void 0===f)throw new r.InternalInterpreterError(-1,\"How is this undefined?\");for(var d=0;d<l[1].length;++d)f.newState.addWarning(l[1][d]);if(f.hasThrown)return{state:f.newState,evaluationErrored:!0,error:f.value,warnings:f.newState.getWarnings()};for(var y=f.newState;y.id>e.id;){if(void 0!==y.dynamicBasis){y.freeTypeVariables=u.getTypeVariableBinds(y.id);for(var d in y.dynamicBasis.valueEnvironment)if(Object.prototype.hasOwnProperty.call(y.dynamicBasis.valueEnvironment,d)){var v=u.getStaticValue(d,y.id);void 0!==v&&y.setStaticValue(d,v[0],v[1])}for(var d in y.dynamicBasis.typeEnvironment)if(Object.prototype.hasOwnProperty.call(y.dynamicBasis.typeEnvironment,d)){var v=u.getStaticType(d,y.id);void 0!==v&&y.setStaticType(d,v.type,v.constructors,v.arity,v.allowsEquality)}for(var d in y.dynamicBasis.structureEnvironment)if(Object.prototype.hasOwnProperty.call(y.dynamicBasis.structureEnvironment,d)){var v=u.getStaticStructure(d,y.id);void 0!==v&&y.setStaticStructure(d,v)}for(var d in y.dynamicBasis.signatureEnvironment)if(Object.prototype.hasOwnProperty.call(y.dynamicBasis.signatureEnvironment,d)){var v=u.getStaticSignature(d,y.id);void 0!==v&&y.setStaticSignature(d,v)}for(var d in y.dynamicBasis.functorEnvironment)if(Object.prototype.hasOwnProperty.call(y.dynamicBasis.functorEnvironment,d)){var v=u.getStaticFunctor(d,y.id);void 0!==v&&y.setStaticFunctor(d,v)}}if(void 0===u.parent)break;for(y=y.parent;u.id>y.id&&void 0!==u.parent;)u=u.parent}return{state:f.newState,evaluationErrored:!1,error:f.value,warnings:f.newState.getWarnings()}}function getAvailableModules(){var t=[];for(var e in i.STDLIB)Object.prototype.hasOwnProperty.call(i.STDLIB,e)&&\"_\"!==e[0]&&t.push(e);return t}function getFirstState(t,e){void 0===t&&(t=getAvailableModules()),void 0===e&&(e={});for(var r=i.loadModule(n.getInitialState(),\"__Base\",e),o=0,a=t;o<a.length;o++){var s=a[o];r=i.loadModule(r,s,e)}return r}Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(7),i=e(12),r=e(0),o=e(8),a=e(9),s=e(11);exports.interpret=interpret,exports.getAvailableModules=getAvailableModules,exports.getFirstState=getFirstState},function(t,exports,e){\"use strict\";function evaluate(t,e){var r=t.getNestedState(),o=[];o.push({next:e,params:{state:t,modifiable:r,recResult:void 0}});for(var a=void 0;o.length>0;){var s=o.pop();if(void 0===s)throw new i.InternalInterpreterError(-1,\"How is this undefined?\");var u=s.next,p=s.params;p.recResult=a,a=u instanceof n.Declaration?u.evaluate(p,o):u.compute(p,o)}if(void 0!==a){var c=a.newState;if(void 0!==c){c.setWarnings(r.getWarnings());for(var h=0,l=r.getMemoryChanges(t.id);h<l.length;h++){var f=l[h];c.setCell(f[0],f[1])}var d=r.getIdChanges(t.id);for(var y in d)d.hasOwnProperty(y)&&c.setValueIdentifierId(y,d[y]);c.exceptionEvalId=r.exceptionEvalId}}return a}Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(5),i=e(0);exports.evaluate=evaluate},function(t,exports,e){\"use strict\";function addArrayLib(t){var e=new n.DynamicBasis({},{},{},{},{}),a=new n.StaticBasis({},{},{},{},{}),s=new i.CustomType(\"array\",[new i.TypeVariable(\"'a\")]),u=new i.CustomType(\"list\",[new i.TypeVariable(\"'a\")]);return a.setType(\"array\",s,[],1,!0),e.setType(\"array\",[]),e.setValue(\"array\",new r.PredefinedFunction(\"array\",function(t,e){if(t instanceof r.RecordValue&&2===t.entries.size){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Integer){var a=n.value;if(a<0)return[g.construct(),!0,[]];var s=new r.ArrayValue(e.modifiable.memory[0]+1,a);e.modifiable.setNewCell(s);for(var u=0;u<a;++u)e.modifiable.setNewCell(i);return[s,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"array\",new i.FunctionType(new i.TupleType([l,new i.TypeVariable(\"'a\")]).simplify(),s),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"fromList\",new r.PredefinedFunction(\"fromList\",function(t,e){var n=new r.ArrayValue(e.modifiable.memory[0]+1,0);if(e.modifiable.setNewCell(n),t instanceof r.ConstructedValue){for(var i=t;\"nil\"!==i.constructorName;){if(\"::\"!==i.constructorName)throw new o.InternalInterpreterError(-1,\"std type mismatch\");var a=i.argument;if(!(a instanceof r.RecordValue&&2===a.entries.size))throw new o.InternalInterpreterError(-1,\"std type mismatch\");var s=a.getValue(\"1\"),u=a.getValue(\"2\");if(!(s instanceof r.Value&&u instanceof r.ConstructedValue))throw new o.InternalInterpreterError(-1,\"std type mismatch\");e.modifiable.setNewCell(s),n.length++,i=u}return[n,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"fromList\",new i.FunctionType(u,s),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"sub\",new r.PredefinedFunction(\"sub\",function(t,e){if(t instanceof r.RecordValue&&2===t.entries.size){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.ArrayValue&&i instanceof r.Integer){var a=i.value;return a<0||a>=n.length?[T.construct(),!0,[]]:[e.modifiable.getCell(n.address+a),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"sub\",new i.FunctionType(new i.TupleType([s,l]).simplify(),new i.TypeVariable(\"'a\")),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"update\",new r.PredefinedFunction(\"update\",function(t,e){if(t instanceof r.RecordValue&&3===t.entries.size){var n=t.getValue(\"1\"),i=t.getValue(\"2\"),a=t.getValue(\"3\");if(n instanceof r.ArrayValue&&i instanceof r.Integer){var s=i.value;return s<0||s>=n.length?[T.construct(),!0,[]]:(e.modifiable.setCell(n.address+s,a),[new r.RecordValue,!1,[]])}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"update\",new i.FunctionType(new i.TupleType([s,l,new i.TypeVariable(\"'a\")]),new i.TupleType([])).simplify(),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"length\",new r.PredefinedFunction(\"length\",function(t,e){if(t instanceof r.ArrayValue){return[new r.Integer(t.length),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"length\",new i.FunctionType(s,l),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure(\"Array\",e),t.setStaticStructure(\"Array\",a),t}function addMathLib(t){var e=new n.DynamicBasis({},{},{},{},{}),a=new n.StaticBasis({},{},{},{},{});return e.setValue(\"sqrt\",new r.PredefinedFunction(\"sqrt\",function(t,e){if(t instanceof r.Real){var n=t.value;return n<0?[m.construct(),!0,[]]:[new r.Real(Math.sqrt(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"sqrt\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"sin\",new r.PredefinedFunction(\"sin\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.sin(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"sin\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"cos\",new r.PredefinedFunction(\"cos\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.cos(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"cos\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"tan\",new r.PredefinedFunction(\"tan\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.tan(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"tan\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"asin\",new r.PredefinedFunction(\"asin\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.asin(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"asin\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"acos\",new r.PredefinedFunction(\"acos\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.acos(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"acos\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"atan\",new r.PredefinedFunction(\"atan\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.atan(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"atan\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"atan2\",new r.PredefinedFunction(\"atan2\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Real&&i instanceof r.Real){var a=n.value,s=i.value;return[new r.Real(Math.atan2(a,s)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"atan2\",new i.FunctionType(new i.TupleType([f,f]),f).simplify(),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"exp\",new r.PredefinedFunction(\"exp\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.exp(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"exp\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"pow\",new r.PredefinedFunction(\"pow\",function(t,e){if(t instanceof r.RecordValue){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.Real&&i instanceof r.Real){var a=n.value,s=i.value;return[new r.Real(Math.pow(a,s)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"pow\",new i.FunctionType(new i.TupleType([f,f]),f).simplify(),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"ln\",new r.PredefinedFunction(\"ln\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.log(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"ln\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"log10\",new r.PredefinedFunction(\"log10\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.log10(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"log10\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"sinh\",new r.PredefinedFunction(\"sinh\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.sinh(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"sinh\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"cosh\",new r.PredefinedFunction(\"cosh\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.cosh(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"cosh\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"tanh\",new r.PredefinedFunction(\"tanh\",function(t,e){if(t instanceof r.Real){var n=t.value;return[new r.Real(Math.tanh(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"tanh\",new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"pi\",new r.Real(3.14159265359),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"pi\",f,n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"e\",new r.Real(2.71828182846),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"e\",f,n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure(\"Math\",e),t.setStaticStructure(\"Math\",a),t}function addCharLib(t){return t.setDynamicValue(\"ord\",new r.PredefinedFunction(\"ord\",function(t,e){if(t instanceof r.CharValue){var n=t.value;return[new r.Integer(n.charCodeAt(0)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue(\"ord\",new i.FunctionType(y,l),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue(\"chr\",new r.PredefinedFunction(\"chr\",function(t,e){if(t instanceof r.Integer){var n=t.value;return n<0||n>255?[w.construct(),!0,[]]:[new r.CharValue(String.fromCharCode(n)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue(\"chr\",new i.FunctionType(l,y),n.IdentifierStatus.VALUE_VARIABLE),t}function addRealLib(t){var e=new n.DynamicBasis({},{},{},{},{}),a=new n.StaticBasis({},{},{},{},{});return e.setValue(\"fromInt\",new r.PredefinedFunction(\"fromInt\",function(t,e){if(t instanceof r.Integer){var n=t.value;return[new r.Real(n),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"fromInt\",new i.FunctionType(l,f),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"round\",new r.PredefinedFunction(\"round\",function(t,e){if(t instanceof r.Real){var n=t.value,i=new r.Integer(Math.round(n));return i.hasOverflow()?[v.construct(),!0,[]]:[i,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"round\",new i.FunctionType(f,l),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"floor\",new r.PredefinedFunction(\"floor\",function(t,e){if(t instanceof r.Real){var n=t.value,i=new r.Integer(Math.floor(n));return i.hasOverflow()?[v.construct(),!0,[]]:[i,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"floor\",new i.FunctionType(f,l),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"ceil\",new r.PredefinedFunction(\"ceil\",function(t,e){if(t instanceof r.Real){var n=t.value,i=new r.Integer(Math.ceil(n));return i.hasOverflow()?[v.construct(),!0,[]]:[i,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"ceil\",new i.FunctionType(f,l),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"toString\",new r.PredefinedFunction(\"toString\",function(t,e){if(t instanceof r.Real){return[new r.StringValue(t.toString(void 0)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"toString\",new i.FunctionType(f,d),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure(\"Real\",e),t.setStaticStructure(\"Real\",a),t}function addIntLib(t){var e=new n.DynamicBasis({},{},{},{},{}),a=new n.StaticBasis({},{},{},{},{});return e.setValue(\"toString\",new r.PredefinedFunction(\"toString\",function(t,e){if(t instanceof r.Integer){return[new r.StringValue(t.toString(void 0)),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"toString\",new i.FunctionType(l,d),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure(\"Int\",e),t.setStaticStructure(\"Int\",a),t}function addListLib(t){var e=new n.DynamicBasis({},{},{},{},{}),o=new n.StaticBasis({},{},{},{},{});return o.setType(\"list\",new i.CustomType(\"list\",[new i.TypeVariable(\"'a\")]),[\"nil\",\"::\"],1,!0),o.setValue(\"nil\",new i.TypeVariableBind(\"'a\",new i.CustomType(\"list\",[new i.TypeVariable(\"'a\")])),n.IdentifierStatus.VALUE_CONSTRUCTOR),o.setValue(\"::\",new i.TypeVariableBind(\"'a\",new i.FunctionType(new i.TupleType([new i.TypeVariable(\"'a\"),new i.CustomType(\"list\",[new i.TypeVariable(\"'a\")])]),new i.CustomType(\"list\",[new i.TypeVariable(\"'a\")]))).simplify(),n.IdentifierStatus.VALUE_CONSTRUCTOR),e.setType(\"list\",[\"nil\",\"::\"]),e.setValue(\"nil\",new r.ValueConstructor(\"nil\"),n.IdentifierStatus.VALUE_CONSTRUCTOR),e.setValue(\"::\",new r.ValueConstructor(\"::\",1),n.IdentifierStatus.VALUE_CONSTRUCTOR),t.setDynamicStructure(\"List\",e),t.setStaticStructure(\"List\",o),t}function addStringLib(t){var e=new n.DynamicBasis({},{},{},{},{}),r=new n.StaticBasis({},{},{},{},{});return r.setType(\"string\",new i.CustomType(\"string\",[]),[],0,!0),e.setType(\"string\",[]),r.setType(\"char\",new i.CustomType(\"char\",[]),[],0,!0),e.setType(\"char\",[]),t.setDynamicStructure(\"String\",e),t.setStaticStructure(\"String\",r),t}function addVectorLib(t){var e=new n.DynamicBasis({},{},{},{},{}),a=new n.StaticBasis({},{},{},{},{}),s=new i.CustomType(\"vector\",[new i.TypeVariable(\"'a\")]),u=new i.CustomType(\"list\",[new i.TypeVariable(\"'a\")]);return a.setType(\"vector\",s,[],1,!0),e.setType(\"vector\",[]),e.setValue(\"fromList\",new r.PredefinedFunction(\"fromList\",function(t,e){var n=new r.VectorValue([]);if(t instanceof r.ConstructedValue){for(var i=t;\"nil\"!==i.constructorName;){if(\"::\"!==i.constructorName)throw new o.InternalInterpreterError(-1,\"std type mismatch\");var a=i.argument;if(!(a instanceof r.RecordValue&&2===a.entries.size))throw new o.InternalInterpreterError(-1,\"std type mismatch\");var s=a.getValue(\"1\"),u=a.getValue(\"2\");if(!(s instanceof r.Value&&u instanceof r.ConstructedValue))throw new o.InternalInterpreterError(-1,\"std type mismatch\");n.entries.push(s),i=u}return[n,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"fromList\",new i.FunctionType(u,s),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"sub\",new r.PredefinedFunction(\"sub\",function(t,e){if(t instanceof r.RecordValue&&2===t.entries.size){var n=t.getValue(\"1\"),i=t.getValue(\"2\");if(n instanceof r.VectorValue&&i instanceof r.Integer){var a=i.value;return a<0||a>=n.entries.length?[T.construct(),!0,[]]:[n.entries[a],!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"sub\",new i.FunctionType(new i.TupleType([s,l]).simplify(),new i.TypeVariable(\"'a\")),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"update\",new r.PredefinedFunction(\"update\",function(t,e){if(t instanceof r.RecordValue&&3===t.entries.size){var n=t.getValue(\"1\"),i=t.getValue(\"2\"),a=t.getValue(\"3\");if(n instanceof r.VectorValue&&i instanceof r.Integer){var s=i.value;if(s<0||s>=n.entries.length)return[T.construct(),!0,[]];var u=new r.VectorValue(n.entries.slice());return u.entries[s]=a,[u,!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"update\",new i.FunctionType(new i.TupleType([s,l,new i.TypeVariable(\"'a\")]).simplify(),s),n.IdentifierStatus.VALUE_VARIABLE),e.setValue(\"length\",new r.PredefinedFunction(\"length\",function(t,e){if(t instanceof r.VectorValue){return[new r.Integer(t.entries.length),!1,[]]}throw new o.InternalInterpreterError(-1,\"std type mismatch\")}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"length\",new i.FunctionType(s,l),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure(\"Vector\",e),t.setStaticStructure(\"Vector\",a),t}function addEvalLib(t){var e=new n.DynamicBasis({},{},{},{},{}),a=new n.StaticBasis({},{},{},{},{});return e.setValue(\"evalExp\",new r.PredefinedFunction(\"symbolic_eval\",function(t,e){if(!(t instanceof r.StringValue))throw new o.InternalInterpreterError(-1,\"This std type mismatch reigns supreme!\");var n=t.value;try{var i=u.lex(n+\";\",{}),a=new p.Parser(i,e.state,e.state.id,{}),s=a.parseExpression();s=s.simplify();var l=[];l.push({next:s,params:{state:e.state.getNestedState(),modifiable:e.state.getNestedState(),recResult:void 0}});for(var f=void 0,d=\"\",y=new Map;l.length>0;)!function(){var t=l.pop();if(void 0===t)throw new o.InternalInterpreterError(-1,\"バトル、バトルしたい！\");var e=t.next,n=t.params;n.recResult=f,f=e instanceof c.Declaration?e.evaluate(n,l):e.compute(n,l);var i=t.next.toString();if(1===n.step&&!i.includes(\"__arg\"))if(f&&f.value)d+=i+\" → \"+f.value.toString(n.state)+\"\\n\";else{var r=new Map;y.forEach(function(t,e){i.includes(e)?i=i.replace(e,t):r.set(e,t)}),y=r,d+=i+\"\\n\"}f&&f.value&&\"fn\"!==f.value.toString(n.state)&&(t.next instanceof h.ValueIdentifier||t.next instanceof h.Record||y.set(t.next.toString(),f.value.toString(n.state)))}();return void 0!==f&&void 0!==f.value&&(d+=f.value.toString(void 0)+\"\\n\"),[new r.RecordValue,!1,[new o.Warning(-2,d)]]}catch(t){return[new r.RecordValue,!1,[new o.Warning(t.position,t.message)]]}}),n.IdentifierStatus.VALUE_VARIABLE),a.setValue(\"evalExp\",new i.FunctionType(d,new i.TupleType([])).simplify(),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicStructure(\"Eval\",e),t.setStaticStructure(\"Eval\",a),t}function loadModule(t,e,n){if(!exports.STDLIB.hasOwnProperty(e))throw new o.InternalInterpreterError(-1,'The module \"'+e+'\" does not exist. Auuuu~');if(t.hasModule(e))return t;var i=exports.STDLIB[e];if(void 0!==i.requires)for(var r=0,s=i.requires;r<s.length;r++){var u=s[r];t.hasModule(u)||(t=loadModule(t,u,n))}return void 0!==i.native&&(t=i.native(t)),void 0!==i.code&&(t=a.interpret(i.code,t,n).state),t.registerModule(e),t}Object.defineProperty(exports,\"__esModule\",{value:!0});var n=e(3),i=e(4),r=e(2),o=e(0),a=e(10),s=e(14),u=e(8),p=e(9),c=e(5),h=e(6),l=new i.CustomType(\"int\"),f=new i.CustomType(\"real\"),d=new i.CustomType(\"string\"),y=new i.CustomType(\"char\"),v=new r.ExceptionConstructor(\"Overflow\",0,0,3),m=new r.ExceptionConstructor(\"Domain\",0,0,4),g=new r.ExceptionConstructor(\"Size\",0,0,5),w=new r.ExceptionConstructor(\"Chr\",0,0,6),T=new r.ExceptionConstructor(\"Subscript\",0,0,7);exports.STDLIB={__Base:{native:void 0,code:\"fun o (f,g) x = f (g x);\\n            infix 3 o;\\n            datatype order = LESS | EQUAL | GREATER;\\n\\n            exception Domain;\\n            exception Size;\\n            exception Chr;\\n            exception Subscript;\\n\\n            fun not true = false | not false = true;\\n\\n            (* fun ! (a : 'A ref): 'A = ! a;\\n            fun op := ((a, b) : ('A ref * 'A)): unit = a := b;\\n            fun ref (a : 'A): 'A ref = ref a; *)\",requires:void 0},Array:{native:addArrayLib,code:\"structure Array :> sig\\n            (* eqtype 'a array = 'a array *)\\n            (* type 'a vector = 'a Vector.vector *)\\n            (* val maxLen : int *)\\n            val array : int * 'a -> 'a array\\n            val fromList : 'a list -> 'a array\\n            val tabulate : int * (int -> 'a) -> 'a array\\n            val length : 'a array -> int\\n            val sub : 'a array * int -> 'a\\n            val update : 'a array * int * 'a -> unit\\n            val vector : 'a array -> 'a vector\\n            (* val copy    : {src : 'a array, dst : 'a array, di : int} -> unit *)\\n            (* val copyVec : {src : 'a vector, dst : 'a array, di : int} -> unit *)\\n            (* val appi : (int * 'a -> unit) -> 'a array -> unit *)\\n            (* val app  : ('a -> unit) -> 'a array -> unit *)\\n            (* val modifyi : (int * 'a -> 'a) -> 'a array -> unit *)\\n            (* val modify  : ('a -> 'a) -> 'a array -> unit *)\\n            val foldli : (int * 'a * 'b -> 'b) -> 'b -> 'a array -> 'b\\n            val foldri : (int * 'a * 'b -> 'b) -> 'b -> 'a array -> 'b\\n            val foldl  : ('a * 'b -> 'b) -> 'b -> 'a array -> 'b\\n            val foldr  : ('a * 'b -> 'b) -> 'b -> 'a array -> 'b\\n            (* val findi : (int * 'a -> bool) -> 'a array -> (int * 'a) option *)\\n            (* val find  : ('a -> bool) -> 'a array -> 'a option *)\\n            (* val exists : ('a -> bool) -> 'a array -> bool *)\\n            (* val all : ('a -> bool) -> 'a array -> bool *)\\n            (* val collate : ('a * 'a -> order) -> 'a array * 'a array -> order *)\\n        end = struct\\n            open Array;\\n            fun tabulate (n, f) = fromList (List.tabulate (n, f));\\n\\n            fun vector arr = Vector.tabulate (length arr, fn i => sub (arr, i));\\n\\n            fun foldli f init arr = let\\n                val len = length arr\\n                fun loop (i, b) =\\n                    if i = len then b\\n                    else loop (i + 1, f (i, sub (arr, i), b))\\n                in\\n                    loop (0, init)\\n                end;\\n            fun foldri f init arr = let\\n                val len = length arr\\n                fun loop (i, b) =\\n                    if i = ~1 then b\\n                    else loop (i - 1, f (i, sub (arr, i), b))\\n                in\\n                    loop (len - 1, init)\\n                end;\\n            fun foldl f init arr = foldli (fn (_, a, x) => f(a, x)) init arr;\\n            fun foldr f init arr = foldri (fn (_, a, x) => f(a, x)) init arr;\\n\\n        end;\",requires:[\"Option\",\"List\",\"Vector\"]},Char:{native:addCharLib,code:'structure Char = struct\\n                fun isLower c  = #\"a\" <= c andalso c <= #\"z\"\\n                fun isUpper c  = #\"A\" <= c andalso c <= #\"Z\"\\n                fun isDigit c  = #\"0\" <= c andalso c <= #\"9\"\\n                fun isAlpha c  = isLower c orelse isUpper c\\n                fun isHexDigit c = #\"0\" <= c andalso c <= #\"9\"\\n                               orelse #\"a\" <= c andalso c <= #\"f\"\\n                               orelse #\"A\" <= c andalso c <= #\"F\"\\n                fun isAlphaNum c = isAlpha c orelse isDigit c\\n                fun isPrint c  = c >= #\" \" andalso c < #\"\\\\127\"\\n                fun isSpace c  = c = #\" \" orelse #\"\\\\009\" <= c andalso c <= #\"\\\\013\"\\n                fun isGraph c  = isPrint c andalso not (isSpace c)\\n                fun isPunct c  = isGraph c andalso not (isAlphaNum c)\\n                fun isAscii c  = c <= #\"\\\\127\"\\n                fun isCntrl c  = c < #\" \" orelse c >= #\"\\\\127\"\\n\\n                fun toLower c =\\n                    if #\"A\" <= c andalso c <= #\"Z\" then chr (ord c + 32)\\n                    else c;\\n                fun toUpper c =\\n                    if #\"a\" <= c andalso c <= #\"z\" then chr (ord c - 32)\\n                    else c;\\n\\n                fun compare (a, b) = Int.compare(ord a, ord b);\\n                fun op< (a, b) = Int.compare(ord a, ord b) = LESS;\\n                fun op> (a, b) = Int.compare(ord a, ord b) = GREATER;\\n                fun op<= (a, b) = Int.compare(ord a, ord b) <> GREATER;\\n                fun op>= (a, b) = Int.compare(ord a, ord b) <> LESS;\\n\\n                val ord = ord;\\n                val chr = chr;\\n            end;',requires:[\"Int\"]},Eval:{native:addEvalLib,code:void 0,requires:void 0},Int:{native:addIntLib,code:\"structure Int = struct\\n                open Int;\\n                fun compare (x, y: int) = if x < y then LESS else if x > y then GREATER else EQUAL;\\n\\n                val minInt = SOME ~\"+-r.MININT+\";\\n                val maxInt = SOME \"+r.MAXINT+\";\\n                fun max (x, y) = if x < y then y else x : int;\\n                fun min (x, y) = if x > y then y else x : int;\\n            end;\",requires:[\"Option\"]},List:{native:addListLib,code:\"structure List : sig\\n                datatype 'a list = nil | :: of 'a * 'a list;\\n                val rev: 'a list -> 'a list;\\n            end  = struct\\n                open List;\\n                fun rev' nil ys     = ys\\n                  | rev' (x::xs) ys = rev' xs (x::ys)\\n                fun rev xs = rev' xs nil;\\n            end;\\n\\n            structure List = struct\\n                exception Empty;\\n                open List;\\n\\n                fun hd nil = raise Empty\\n                  | hd (x::xr) = x;\\n\\n                fun tl nil = raise Empty\\n                  | tl (x::xr) = xr;\\n\\n                fun null nil = true\\n                  | null (x::xr) = false;\\n\\n                fun map f nil = nil\\n                  | map f (x::xr) = (f x) :: (map f xr);\\n\\n                infixr 5 @;\\n                fun [] @ ys = ys\\n                  | (x::xr) @ ys = x :: (xr @ ys);\\n\\n                fun length nil = 0\\n                  | length (x::xr) = 1 + length xr;\\n\\n                fun foldr f e []      = e\\n                  | foldr f e (x::xr) = f(x, foldr f e xr);\\n\\n                fun foldl f e []      = e\\n                  | foldl f e (x::xr) = foldl f (f(x, e)) xr;\\n            end;\\n            open List;\\n            infixr 5 @;\\n\\n            structure List = struct\\n                open List;\\n\\n                fun concat nil = nil\\n                  | concat (x::xr) = x @ concat xr;\\n\\n                fun tabulate (n, f) = let\\n                    fun h i = if i < n then f i :: h (i + 1) else []\\n                in\\n                    if n < 0 then raise Size else h 0\\n                end;\\n\\n                fun exists p []      = false\\n                  | exists p (x::xr) = p x orelse exists p xr;\\n\\n                fun all p []      = true\\n                  | all p (x::xr) = p x andalso all p xr;\\n\\n                fun filter p []      = []\\n                  | filter p (x::xr) = if p x then x :: filter p xr else filter p xr;\\n\\n                fun collate (compare : 'a * 'a -> order) p = case p of\\n                    (nil, _::_)     => LESS\\n                  | (nil, nil)      => EQUAL\\n                  | (_::_, nil)     => GREATER\\n                  | (x::xr, y::yr)  => case compare (x, y) of\\n                         EQUAL  => collate compare (xr, yr)\\n                       | s      => s;\\n\\n                fun nth ([], _)    = raise Subscript\\n                  | nth (x::xs, 0) = x\\n                  | nth (x::xs, n) = nth (xs, n - 1);\\n\\n                fun last [x] = x\\n                  | last (x::xs) = last xs\\n                  | last [] = raise Empty;\\n\\n                fun getItem [] = NONE\\n                  | getItem x = SOME (hd x, tl x);\\n\\n                fun take (x, 0) = []\\n                  | take ([], _) = raise Subscript\\n                  | take (x::xs, n) = x :: take (xs, n - 1);\\n\\n                fun drop (x, 0) = x\\n                  | drop ([], _) = raise Subscript\\n                  | drop (x::xs, n) = drop (xs, n - 1);\\n\\n                fun revAppend (l1, l2) = (rev l1) @ l2;\\n\\n                fun app f [] = ()\\n                  | app f (x::xs) = (f x; app f xs);\\n\\n                fun mapPartial f l\\n                    = ((map valOf) o (filter isSome) o (map f)) l;\\n\\n                fun find f [] = NONE\\n                  | find f (x::xs) = if f x then SOME x else find f xs;\\n\\n                fun partition f [] = ([], [])\\n                  | partition f (x::xs) = let\\n                    val tmp = partition f xs\\n                in\\n                    if f x then (x :: #1 tmp, #2 tmp)\\n                    else (#1 tmp, x :: #2 tmp)\\n                end;\\n            end;\",requires:[\"Option\"]},Listsort:{native:void 0,code:\"structure Listsort : sig\\n                val sort: ('a * 'a -> order) -> 'a list -> 'a list;\\n                val sorted: ('a * 'a -> order) -> 'a list -> bool;\\n                val mergeUniq: ('a * 'a -> order) -> 'a list * 'a list -> 'a list;\\n                val merge: ('a * 'a -> order) -> 'a list * 'a list -> 'a list;\\n                val eqclasses: ('a * 'a -> order) -> 'a list -> 'a list list;\\n            end = struct\\n              fun take ordr x1 xr []       = x1 :: xr\\n                | take ordr x1 xr (y1::yr) = (case ordr(x1, y1) of\\n                    LESS    => x1 :: take ordr y1 yr xr\\n                  | _       => y1 :: take ordr x1 xr yr);\\n\\n              fun takeUniq ordr x1 xr []       = x1 :: xr\\n                | takeUniq ordr x1 xr (y1::yr) = (case ordr(x1, y1) of\\n                    LESS    => x1 :: takeUniq ordr y1 yr xr\\n                  | GREATER => y1 :: takeUniq ordr x1 xr yr\\n                  | EQUAL   => takeUniq ordr x1 xr yr);\\n\\n              fun merge ordr ([],     ys) = ys\\n                | merge ordr (x1::xr, ys) = take ordr x1 xr ys;\\n\\n              fun mergeUniq ordr ([],     ys) = ys\\n                | mergeUniq ordr (x1::xr, ys) = takeUniq ordr x1 xr ys;\\n\\n              fun mergepairs ordr l1  [] k              = [l1]\\n                | mergepairs ordr l1 (ls as (l2::lr)) k =\\n                  if k mod 2 = 1 then l1::ls\\n                  else mergepairs ordr (merge ordr (l1, l2)) lr (k div 2);\\n\\n              fun nextrun ordr run []      = (run, [])\\n                | nextrun ordr run (xs as (x::xr)) =\\n                  if ordr(x, List.hd run) = LESS then (run, xs)\\n                  else nextrun ordr (x::run) xr;\\n\\n              fun sorting ordr []      ls r = List.hd(mergepairs ordr [] ls 0)\\n                | sorting ordr (x::xs) ls r = let\\n                    val (revrun, tail) = nextrun ordr [x] xs\\n                  in\\n                    sorting ordr tail (mergepairs ordr (List.rev revrun) ls (r+1)) (r+1)\\n                  end;\\n\\n              fun group ordr last rest cs1 css = case rest of\\n                  []     => cs1 :: css\\n                | r1::rr => if ordr(r1, last) = EQUAL then group ordr r1 rr (r1 :: cs1) css\\n                            else group ordr r1 rr [r1] (cs1 :: css);\\n\\n              fun sort ordr []               = []\\n                | sort ordr (xs as [_])      = xs\\n                | sort ordr (xs as [x1, x2]) = (case ordr(x1, x2) of\\n                    GREATER => [x2, x1]\\n                  | _       => xs)\\n                | sort ordr xs = sorting ordr xs [] 0;\\n\\n              fun sorted ordr []           = true\\n                | sorted ordr [x]          = true\\n                | sorted ordr (x1::x2::xr) =\\n                  ordr(x1, x2) <> GREATER andalso sorted ordr (x2::xr);\\n\\n\\n              fun eqclasses ordr xs = let\\n                  val xs = List.rev (sort ordr xs)\\n                in\\n                  case xs of\\n                      []     => []\\n                    | x1::xr => group ordr x1 xr [x1] []\\n                  end;\\n            end;\\n            structure List = struct\\n                open List;\\n                open Listsort;\\n            end;\",requires:[\"List\"]},Math:{native:addMathLib,code:void 0,requires:void 0},Option:{native:void 0,code:\"structure Option = struct\\n                exception Option;\\n\\n                datatype 'a option = NONE | SOME of 'a;\\n\\n                fun getOpt (NONE, a) = a\\n                  | getOpt (SOME x, a) = x;\\n\\n                fun isSome NONE = false\\n                  | isSome (SOME _) = true;\\n\\n                fun valOf (SOME x) = x\\n                  | valOf NONE = raise Option;\\n\\n                fun filter f x = if f x then SOME x else NONE;\\n\\n                fun join NONE = NONE\\n                  | join (SOME (SOME x)) = SOME x;\\n\\n                fun app f (SOME v) = f v\\n                  | app f NONE = ();\\n\\n                fun map f NONE = NONE\\n                  | map f (SOME v) = SOME(f v);\\n\\n                fun mapPartial f NONE = NONE\\n                  | mapPartial f (SOME v) = f v;\\n\\n                fun compose (f, g) a = case g a of\\n                      NONE => NONE\\n                    | SOME v => SOME (f v);\\n\\n                fun compose (f, g) a = case g a of\\n                      NONE => NONE\\n                    | SOME v => (f v);\\n            end;\\n            open Option;\",requires:void 0},Real:{native:addRealLib,code:\"structure Real = struct\\n                open Real;\\n                fun compare (x, y: real) = if x < y then LESS else if x > y then GREATER else EQUAL;\\n            end;\",requires:void 0},String:{native:addStringLib,code:'structure String : sig\\n                eqtype string\\n                eqtype char\\n                val size : string -> int\\n                val sub : string * int -> char\\n                val extract   : string * int * int option -> string\\n                val substring : string * int * int -> string\\n                val ^ : string * string -> string\\n                val concat : string list -> string\\n                val concatWith : string -> string list -> string\\n                val str : char -> string\\n                val implode : char list -> string\\n                val explode : string -> char list\\n                val map : (char -> char) -> string -> string\\n                val translate : (char -> string) -> string -> string\\n                val tokens : (char -> bool) -> string -> string list\\n                val fields : (char -> bool) -> string -> string list\\n                val isPrefix    : string -> string -> bool\\n                val isSubstring : string -> string -> bool\\n                val isSuffix    : string -> string -> bool\\n                val compare : string * string -> order\\n                val collate : (char * char -> order)\\n                                -> string * string -> order\\n                val <  : string * string -> bool\\n                val <= : string * string -> bool\\n                val >  : string * string -> bool\\n                val >= : string * string -> bool\\n            end = struct\\n                open String;\\n\\n                fun size s = List.length (explode s);\\n                fun sub (s,i) = List.nth (explode s, i);\\n                fun extract (s, i, NONE) = implode (List.drop (explode s, i))\\n                  | extract (s, i, SOME j) = implode (List.take (List.drop (explode s, i), j));\\n                fun substring (s, i, j) = extract (s, i, SOME j);\\n                val op^ = op^;\\n\\n                fun cc2 b ([], y) = y\\n                  | cc2 b (x::xs, y) = cc2 b (xs, y^b^x);\\n                fun concat a = cc2 \"\" (a, \"\");\\n                fun concatWith b [] = \"\"\\n                  | concatWith b (a::c) = a ^ (cc2 b (c, \"\"));\\n\\n                fun str c = implode [c];\\n                val implode = implode;\\n                val explode = explode;\\n                fun map f s = implode(List.map f (explode s));\\n                fun translate f s = concat(List.map f (explode s));\\n\\n\\n                fun cmp f ([], []) = EQUAL\\n                  | cmp f ([], _) = LESS\\n                  | cmp f (_, []) = GREATER\\n                  | cmp f (x::xs, y::ys) = let\\n                        val tmp = f (x, y);\\n                    in\\n                        if tmp <> EQUAL then tmp else cmp f (xs, ys)\\n                    end;\\n\\n                fun matchPrefix ([], _) = true\\n                  | matchPrefix (_, []) = false\\n                  | matchPrefix (x::xs, y::ys) = if x <> y then false else matchPrefix (xs, ys);\\n\\n                fun matchSubstring ([], _) = true\\n                  | matchSubstring (_, []) = false\\n                  | matchSubstring (x, y as _::ys) = if matchPrefix (x, y) then true\\n                    else matchSubstring (x, ys);\\n\\n                fun getFields (f, [], tmp, x) = (implode tmp) :: x\\n                  | getFields (f, (r::rs), tmp, x) = if f r then\\n                        getFields (f, rs, [], (implode tmp)::x)\\n                    else\\n                        getFields (f, rs, r::tmp, x);\\n\\n                fun tokens f s = List.filter (fn t => t <> \"\") (getFields (f, rev (explode s), [], []));\\n                fun fields f s = getFields (f, rev (explode s), [], []);\\n\\n                fun isPrefix a b = matchPrefix (explode a, explode b);\\n                fun isSubstring a b = matchSubstring (explode a, explode b);\\n                fun isSuffix a b = matchPrefix (rev (explode a), rev (explode b));\\n\\n                fun compare (a, b) = cmp Char.compare (explode a, explode b);\\n                fun collate f (a, b) = cmp f (explode a, explode b);\\n\\n                fun op< (a, b) = compare (a, b) = LESS;\\n                fun op> (a, b) = compare (a, b) = GREATER;\\n                fun op<= (a, b) = compare (a, b) <> GREATER;\\n                fun op>= (a, b) = compare (a, b) <> LESS;\\n            end;',requires:[\"Char\",\"List\"]},Vector:{native:addVectorLib,code:\"structure Vector :> sig\\n            (* eqtype 'a vector = 'a vector *)\\n            (* val maxLen : int *)\\n            val fromList : 'a list -> 'a vector\\n            val tabulate : int * (int -> 'a) -> 'a vector\\n            val length : 'a vector -> int\\n            val sub : 'a vector * int -> 'a\\n            val update : 'a vector * int * 'a -> 'a vector\\n            val concat : 'a vector list -> 'a vector\\n            val appi : (int * 'a -> unit) -> 'a vector -> unit\\n            val app  : ('a -> unit) -> 'a vector -> unit\\n            val mapi : (int * 'a -> 'b) -> 'a vector -> 'b vector\\n            val map  : ('a -> 'b) -> 'a vector -> 'b vector\\n            val foldli : (int * 'a * 'b -> 'b) -> 'b -> 'a vector -> 'b\\n            val foldri : (int * 'a * 'b -> 'b) -> 'b -> 'a vector -> 'b\\n            val foldl  : ('a * 'b -> 'b) -> 'b -> 'a vector -> 'b\\n            val foldr  : ('a * 'b -> 'b) -> 'b -> 'a vector -> 'b\\n            (* val findi : (int * 'a -> bool) -> 'a vector -> (int * 'a) option *)\\n            (* val find  : ('a -> bool) -> 'a vector -> 'a option *)\\n            (* val exists : ('a -> bool) -> 'a vector -> bool *)\\n            (* val all : ('a -> bool) -> 'a vector -> bool *)\\n            (* val collate : ('a * 'a -> order) -> 'a vector * 'a vector -> order *)\\n        end = struct\\n            open Vector;\\n            fun tabulate (n, f) = fromList (List.tabulate (n, f));\\n\\n            fun foldli f init vec = let\\n                val len = length vec\\n                fun loop (i, b) =\\n                    if i = len then b\\n                    else loop (i + 1, f (i, sub (vec, i), b))\\n                in\\n                    loop (0, init)\\n                end;\\n            fun foldri f init vec = let\\n                val len = length vec\\n                fun loop (i, b) =\\n                    if i = ~1 then b\\n                    else loop (i - 1, f (i, sub (vec, i), b))\\n                in\\n                    loop (len - 1, init)\\n                end;\\n            fun foldl f init vec = foldli (fn (_, a, x) => f(a, x)) init vec;\\n            fun foldr f init vec = foldri (fn (_, a, x) => f(a, x)) init vec;\\n\\n            fun concat l = fromList (List.concat (List.map (foldr (fn (a, b) => (a::b)) []) l));\\n\\n            fun appi f vec = List.app f (foldri (fn (i,a,l) => (i,a)::l) [] vec);\\n            fun app  f vec = List.app f (foldr (fn (a,l) => a::l) [] vec);\\n            fun mapi f vec = fromList (List.map f (foldri (fn (i,a,l) => (i,a)::l) [] vec));\\n            fun map  f vec = fromList (List.map f (foldr (fn (a,l) => a::l) [] vec));\\n\\n        end; \",requires:[\"Option\",\"List\"]},Version:{native:void 0,code:'structure Version = struct\\n            val version     = \"'+s.VERSION+'\";\\n            val branch      = \"'+s.BRANCH_NAME+'\";\\n            val commit      = \"'+s.COMMIT_HASH+'\";\\n            val buildDate   = \"'+s.BUILD_DATE+'\";\\n            val message     = \"'+s.COMMIT_MESSAGE+'\";\\n        end;',requires:void 0}},exports.loadModule=loadModule},function(t,exports,e){\"use strict\";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,\"__esModule\",{value:!0});var i=e(6),r=e(5),o=e(1),a=e(4),s=e(3),u=e(0),p=e(2),c=e(7),h=function(t){function StructureExpression(e,n){var i=t.call(this)||this;return i.position=e,i.structureDeclaration=n,i}return n(StructureExpression,t),StructureExpression.prototype.simplify=function(){return new StructureExpression(this.position,this.structureDeclaration.simplify())},StructureExpression.prototype.elaborate=function(t,e,n){var i=t.getNestedState(0).getNestedState(t.id),r=this.structureDeclaration.elaborate(i,e,n,!0);return t.valueIdentifierId=r[0].valueIdentifierId,[r[0].getStaticChanges(0),r[1],r[2],r[3]]},StructureExpression.prototype.computeStructure=function(t,e,n){if(void 0===t.recResult){var i=t.state,r=i.getNestedState(0).getNestedState(i.id);return e.push({next:n,params:t}),void e.push({next:this.structureDeclaration,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}var o=t.recResult;if(void 0===o||void 0===o.newState)throw new u.InternalInterpreterError(-1,\"RAINBOW!\");var r=o.newState;return o.hasThrown?o.value:r.getDynamicChanges(0)},StructureExpression.prototype.toString=function(){return\"struct \"+this.structureDeclaration+\" end\"},StructureExpression}(i.Expression);exports.StructureExpression=h;var l=function(t){function StructureIdentifier(e,n){var i=t.call(this)||this;return i.position=e,i.identifier=n,i}return n(StructureIdentifier,t),StructureIdentifier.prototype.simplify=function(){return this},StructureIdentifier.prototype.elaborate=function(t,e,n){var i=void 0;if(this.identifier instanceof o.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.identifier);void 0!==r&&(i=r.getStructure(this.identifier.id.getText()))}else i=t.getStaticStructure(this.identifier.getText());if(void 0===i)throw new u.ElaborationError(this.position,'Undefined module \"'+this.identifier.getText()+'\".');return[i,[],e,n]},StructureIdentifier.prototype.computeStructure=function(t,e,n){var i=t.state,r=void 0;if(this.identifier instanceof o.LongIdentifierToken){var a=i.getAndResolveDynamicStructure(this.identifier);void 0!==a&&(r=a.getStructure(this.identifier.id.getText()))}else r=i.getDynamicStructure(this.identifier.getText());if(void 0===r)throw new u.EvaluationError(this.position,'Undefined module \"'+this.identifier.getText()+'\".');return r},StructureIdentifier.prototype.toString=function(){return this.identifier.getText()},StructureIdentifier}(i.Expression);exports.StructureIdentifier=l;var f=function(t){function TransparentConstraint(e,n,i){var r=t.call(this)||this;return r.position=e,r.structureExpression=n,r.signatureExpression=i,r}return n(TransparentConstraint,t),TransparentConstraint.restrict=function(t,e,n,i,r,o){var p=new s.StaticBasis({},{},{},{},{}),c=n.getNestedState(n.id);c.staticBasis=e;var h=n.getNestedState(n.id);h.staticBasis=t;for(var l in t.typeEnvironment)if(t.typeEnvironment.hasOwnProperty(l)){if(!e.typeEnvironment.hasOwnProperty(l))throw new u.ElaborationError(o,'Signature mismatch: Unimplemented type \"'+l+'\".');var f=t.typeEnvironment[l],d=e.typeEnvironment[l];if(f.arity!==d.arity)throw new u.ElaborationError(o,'Signature mismatch: Implementation of type \"'+l+'\" has the wrong arity.');try{var y=f.type,v=d.type;!(f.type instanceof a.FunctionType)&&d.type instanceof a.FunctionType&&(v=d.type.parameterType);var m=y.merge(c,i,v);p.setType(l,d.type.instantiate(h,m[1]),f.constructors,f.arity,f.allowsEquality),i=m[1]}catch(t){if(!(t instanceof Array))throw t;throw new u.ElaborationError(o,'Signature mismatch: Wrong implementation of type \"'+l+'\": '+t[0])}}for(var l in t.valueEnvironment)if(t.valueEnvironment.hasOwnProperty(l)){if(!e.valueEnvironment.hasOwnProperty(l))throw new u.ElaborationError(o,'Signature mismatch: Unimplemented value \"'+l+'\".');for(var f=t.valueEnvironment[l],d=e.valueEnvironment[l],g=new Map,w=f[0].getTypeVariables(),T=d[0].getTypeVariables();d[0]instanceof a.TypeVariableBind;){for(;;){var E=+r.substring(3),S=\"'\"+r[1]+r[2]+(E+1);if(r=S,!i.has(S)&&!w.has(S)&&!T.has(S)){\"'\"===d[0].name[1]&&(S=\"'\"+S),g=g.set(d[0].name,S);break}}d[0]=d[0].type}d[0]=d[0].replaceTypeVariables(g);for(var x=f[0];x instanceof a.TypeVariableBind;){for(;;){var E=+r.substring(3),S=\"'\"+r[1]+r[2]+(E+1);if(r=S,!i.has(S)&&!w.has(S)&&!T.has(S)){\"'\"===x.name[1]&&(S=\"'\"+S),g=g.set(x.name,S);break}}x=x.type}x=x.replaceTypeVariables(g);try{var I=x.merge(c,i,d[0]);p.setValue(l,f[0].instantiate(c,I[1]),f[1])}catch(t){if(!(t instanceof Array))throw t;throw new u.ElaborationError(o,'Signature mismatch: Wrong implementation of type \"'+l+'\": '+t[0])}}for(var l in t.structureEnvironment)if(t.structureEnvironment.hasOwnProperty(l)){if(!e.structureEnvironment.hasOwnProperty(l))throw new u.ElaborationError(o,'Unimplemented structure \"'+l+'\".');try{var V=TransparentConstraint.restrict(t.getStructure(l),e.getStructure(l),c,i,r,o);p.setStructure(l,V[0]),i=V[2],r=V[3]}catch(t){throw new u.ElaborationError(o,'Signature Mismatch: Wrong implementation of structure \"'+l+'\": '+t.message)}}return[p,[],i,r]},TransparentConstraint.prototype.simplify=function(){return new TransparentConstraint(this.position,this.structureExpression.simplify(),this.signatureExpression.simplify())},TransparentConstraint.prototype.elaborate=function(t,e,n){var i=this.structureExpression.elaborate(t,e,n),r=this.signatureExpression.elaborate(t,i[2],i[3]);return TransparentConstraint.restrict(r[0],i[0],t,r[2],r[3],this.position)},TransparentConstraint.prototype.computeStructure=function(t,e,n){var i=this.structureExpression.computeStructure(t,e,n);if(void 0!==i){if(i instanceof p.Value)return i;var r=this.signatureExpression.computeInterface(t.state);return i.restrict(r)}},TransparentConstraint.prototype.toString=function(){return this.structureExpression+\" : \"+this.signatureExpression},TransparentConstraint}(i.Expression);exports.TransparentConstraint=f;var d=function(t){function OpaqueConstraint(e,n,i){var r=t.call(this)||this;return r.position=e,r.structureExpression=n,r.signatureExpression=i,r}return n(OpaqueConstraint,t),OpaqueConstraint.restrict=function(t,e,n,i,r,o){var p=new s.StaticBasis({},{},{},{},{}),c=n.getNestedState(n.id);c.staticBasis=e;var h=n.getNestedState(n.id);h.staticBasis=t,h=h.getNestedState(n.id);for(var l in t.typeEnvironment)if(t.typeEnvironment.hasOwnProperty(l)){if(!e.typeEnvironment.hasOwnProperty(l))throw new u.ElaborationError(o,'Signature mismatch: Unimplemented type \"'+l+'\".');var f=t.typeEnvironment[l],d=e.typeEnvironment[l];if(f.arity!==d.arity)throw new u.ElaborationError(o,'Signature mismatch: Implementation of type \"'+l+'\" has the wrong arity.');try{var y=f.type,v=d.type;!(f.type instanceof a.FunctionType)&&d.type instanceof a.FunctionType&&(v=d.type.parameterType);var m=y.merge(c,i,v);y=new a.CustomType(y.name,y.typeArguments,y.position,y.qualifiedName,!0),p.setType(l,y,[],f.arity,f.allowsEquality),h.staticBasis.setType(l,y,f.constructors,f.arity,f.allowsEquality),i=m[1]}catch(t){if(!(t instanceof Array))throw t;throw new u.ElaborationError(o,'Signature mismatch: Wrong implementation of type \"'+l+'\": '+t[0])}}for(var l in t.valueEnvironment)if(t.valueEnvironment.hasOwnProperty(l)){if(!e.valueEnvironment.hasOwnProperty(l))throw new u.ElaborationError(o,'Signature mismatch: Unimplemented value \"'+l+'\".');for(var f=t.valueEnvironment[l],d=e.valueEnvironment[l],g=new Map,w=f[0].getTypeVariables(),T=d[0].getTypeVariables(),E=d[0];E instanceof a.TypeVariableBind;){for(;;){var S=+r.substring(3),x=\"'\"+r[1]+r[2]+(S+1);if(r=x,!i.has(x)&&!w.has(x)&&!T.has(x)){\"'\"===E.name[1]&&(x=\"'\"+x),g=g.set(E.name,x);break}}E=E.type}E=E.replaceTypeVariables(g);for(var I=f[0];I instanceof a.TypeVariableBind;){for(;;){var S=+r.substring(3),x=\"'\"+r[1]+r[2]+(S+1);if(r=x,!i.has(x)&&!w.has(x)&&!T.has(x)){\"'\"===I.name[1]&&(x=\"'\"+x),g=g.set(I.name,x);break}}I=I.type}I=I.replaceTypeVariables(g);try{I.merge(c,i,E),p.setValue(l,f[0].instantiate(h,i),f[1])}catch(t){if(!(t instanceof Array))throw t;throw new u.ElaborationError(o,'Signature mismatch: Wrong implementation of type \"'+l+'\": '+t[0])}}for(var l in t.structureEnvironment)if(t.structureEnvironment.hasOwnProperty(l)){if(!e.structureEnvironment.hasOwnProperty(l))throw new u.ElaborationError(o,'Unimplemented structure \"'+l+'\".');try{var V=OpaqueConstraint.restrict(t.getStructure(l),e.getStructure(l),c,i,r,o);p.setStructure(l,V[0]),i=V[2],r=V[3]}catch(t){throw new u.ElaborationError(o,'Signature Mismatch: Wrong implementation of structure \"'+l+'\": '+t.message)}}return[p,[],i,r]},OpaqueConstraint.prototype.simplify=function(){return new OpaqueConstraint(this.position,this.structureExpression.simplify(),this.signatureExpression.simplify())},OpaqueConstraint.prototype.elaborate=function(t,e,n){var i=this.structureExpression.elaborate(t,e,n),r=this.signatureExpression.elaborate(t,i[2],i[3]);return OpaqueConstraint.restrict(r[0],i[0],t,r[2],r[3],this.position)},OpaqueConstraint.prototype.computeStructure=function(t,e,n){var i=this.structureExpression.computeStructure(t,e,n);if(void 0!==i){if(i instanceof p.Value)return i;var r=this.signatureExpression.computeInterface(t.state);return i.restrict(r)}},OpaqueConstraint.prototype.toString=function(){return this.structureExpression+\" :> \"+this.signatureExpression},OpaqueConstraint}(i.Expression);exports.OpaqueConstraint=d;var y=function(t){function FunctorApplication(e,n,i){var r=t.call(this)||this;return r.position=e,r.functorId=n,r.structureExpression=i,r}return n(FunctorApplication,t),FunctorApplication.prototype.simplify=function(){return new FunctorApplication(this.position,this.functorId,this.structureExpression.simplify())},FunctorApplication.prototype.elaborate=function(t,e,n){var i=this.structureExpression.elaborate(t,e,n),r=t.getStaticFunctor(this.functorId.getText());if(void 0===r)throw new u.EvaluationError(this.position,'Undefined functor \"'+this.functorId.getText()+'\".');var o=new s.StaticBasis({},{},{},{},{});o.extend(r[1]);var a=o.extend(f.restrict(r[0],i[0],t,e,n,this.position)[0]);for(var p in a.valueEnvironment)if(a.valueEnvironment.hasOwnProperty(p)){var c=a.valueEnvironment[p];if(void 0!==c&&void 0!==c[0]){var h=t.getNestedState(t.id);h.staticBasis=a,a.valueEnvironment[p]=[c[0].instantiate(h,i[2]),c[1]]}}return[a,i[1],i[2],i[3]]},FunctorApplication.prototype.computeStructure=function(t,e,n){var i=t.state,r=i.getDynamicFunctor(this.functorId.getText());if(void 0===r)throw new u.EvaluationError(this.position,'Undefined functor \"'+this.functorId.getText()+'\".');if(void 0===t.funappres){var o=this.structureExpression.computeStructure(t,e,n);if(void 0===o)return;if(o instanceof p.Value)return o;t.funappres=o}var o=t.funappres;if(void 0===t.nstate){var a=r.state.getNestedState(r.state.id);a.setDynamicStructure(r.paramName.getText(),o.restrict(r.param)),t.nstate=a}t.state=t.nstate;var s=r.body.computeStructure(t,e,n);return t.state=i,s},FunctorApplication.prototype.toString=function(){return this.functorId.getText()+\"( \"+this.structureExpression+\" )\"},FunctorApplication}(i.Expression);exports.FunctorApplication=y;var v=function(t){function LocalDeclarationStructureExpression(e,n,i){var r=t.call(this)||this;return r.position=e,r.declaration=n,r.expression=i,r}return n(LocalDeclarationStructureExpression,t),LocalDeclarationStructureExpression.prototype.simplify=function(){return new LocalDeclarationStructureExpression(this.position,this.declaration.simplify(),this.expression.simplify())},LocalDeclarationStructureExpression.prototype.elaborate=function(t,e,n){var i=t.getNestedState(t.id);e.forEach(function(n,r){\"*\"===r[1]&&\"*\"===r[2]&&i.setStaticValue(r.substring(3),n[0].instantiate(t,e),s.IdentifierStatus.VALUE_VARIABLE)});var r=this.declaration.elaborate(i,e,n);n=r[3];var o=new Map;e.forEach(function(t,e){o=o.set(e,[t[0].instantiate(r[0],r[2]),t[1]])});var a=this.expression.elaborate(r[0],r[2],n);return[a[0],r[1].concat(a[1]),a[2],a[3]]},LocalDeclarationStructureExpression.prototype.toString=function(){return\"let \"+this.declaration+\" in \"+this.expression+\" end\"},LocalDeclarationStructureExpression.prototype.computeStructure=function(t,e,n){var i=t.state;if(void 0===t.ldseRes){if(void 0===t.recResult){var r=i.getNestedState(0).getNestedState(i.id);return e.push({next:n,params:t}),void e.push({next:this.declaration,params:{state:r,modifiable:t.modifiable,recResult:void 0}})}t.ldseRes=t.recResult,t.recResult=void 0}var o=t.ldseRes;if(void 0===o||void 0===o.newState)throw new u.InternalInterpreterError(-1,\"Anpan.\");var r=o.newState;if(o.hasThrown)return o.value;t.state=r;var a=this.expression.computeStructure(t,e,n);return t.state=i,a},LocalDeclarationStructureExpression}(i.Expression);exports.LocalDeclarationStructureExpression=v;var m=function(t){function SignatureExpression(e,n){var i=t.call(this)||this;return i.position=e,i.specification=n,i}return n(SignatureExpression,t),SignatureExpression.prototype.simplify=function(){return new SignatureExpression(this.position,this.specification.simplify())},SignatureExpression.prototype.elaborate=function(t,e,n){return this.specification.elaborate(t,e,n)},SignatureExpression.prototype.computeInterface=function(t){return this.specification.computeInterface(t)},SignatureExpression.prototype.toString=function(){return\"sig \"+this.specification+\" end\"},SignatureExpression}(i.Expression);exports.SignatureExpression=m;var g=function(t){function SignatureIdentifier(e,n){var i=t.call(this)||this;return i.position=e,i.identifier=n,i}return n(SignatureIdentifier,t),SignatureIdentifier.prototype.simplify=function(){return this},SignatureIdentifier.prototype.elaborate=function(t,e,n){var i=void 0;if(this.identifier instanceof o.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.identifier);void 0!==r&&(i=r.getSignature(this.identifier.id.getText()))}else i=t.getStaticSignature(this.identifier.getText());if(void 0===i)throw new u.EvaluationError(this.position,'Undefined signature \"'+this.identifier.getText()+'\".');return[i,[],e,n]},SignatureIdentifier.prototype.computeInterface=function(t){var e=void 0;if(this.identifier instanceof o.LongIdentifierToken){var n=t.getAndResolveDynamicStructure(this.identifier);void 0!==n&&(e=n.getSignature(this.identifier.id.getText()))}else e=t.getDynamicSignature(this.identifier.getText());if(void 0===e)throw new u.EvaluationError(this.position,'Undefined signature \"'+this.identifier.getText()+'\".');return e},SignatureIdentifier.prototype.toString=function(){return this.identifier.getText()},SignatureIdentifier}(i.Expression);exports.SignatureIdentifier=g;var w=function(t){function TypeRealisation(e,n,i,r,o){var a=t.call(this)||this;return a.position=e,a.signatureExpression=n,a.tyvarseq=i,a.name=r,a.type=o,a}return n(TypeRealisation,t),TypeRealisation.prototype.simplify=function(){return new TypeRealisation(this.position,this.signatureExpression.simplify(),this.tyvarseq,this.name,this.type.simplify())},TypeRealisation.prototype.elaborate=function(t,e,n){var i=this.signatureExpression.elaborate(t,e,n),r=t.getNestedState(0);r.staticBasis=i[0];var s=void 0,p=i[0],c=this.name.getText();if(this.name instanceof o.LongIdentifierToken?void 0!==(p=r.getAndResolveStaticStructure(this.name))&&(s=p.getType(this.name.id.getText()),c=this.name.id.getText()):s=r.getStaticType(this.name.getText()),void 0===s||void 0===p)throw new u.ElaborationError(this.position,'Undefined type \"'+this.name.getText()+'\".');return p.setType(c,new a.FunctionType(s.type,this.type),[],this.tyvarseq.length,s.allowsEquality),i},TypeRealisation.prototype.computeInterface=function(t){return this.signatureExpression.computeInterface(t)},TypeRealisation.prototype.toString=function(){return this.signatureExpression+\" where type <stuff> \"+this.name.getText()+\" = \"+this.type},TypeRealisation}(i.Expression);exports.TypeRealisation=w;var T=function(t){function StructureDeclaration(e,n){var i=t.call(this)||this;return i.position=e,i.structureBinding=n,i}return n(StructureDeclaration,t),StructureDeclaration.prototype.elaborate=function(t,e,n,i){for(var r=[],o=0;o<this.structureBinding.length;++o){var a=this.structureBinding[o].elaborate(t,e,n);t=a[0],r=r.concat(a[1]),e=a[2],n=a[3]}return[t,r,e,n]},StructureDeclaration.prototype.evaluate=function(t,e){void 0===t.whichBind&&(t.whichBind=0);var n=t.whichBind,i=this.structureBinding[n].evaluate(t,e,this);if(void 0!==i){if(i.hasThrown)return i;if(t.state=i.newState,t.whichBind=t.whichBind+1,t.recResult=void 0,t.whichBind===this.structureBinding.length)return{newState:t.state,value:void 0,hasThrown:!1};e.push({next:this,params:t})}},StructureDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.structureBinding.length;++e)t.push(this.structureBinding[e].simplify());return new StructureDeclaration(this.position,t)},StructureDeclaration.prototype.toString=function(){for(var t=\"structure\",e=0;e<this.structureBinding.length;++e)t+=\" \"+this.structureBinding[e];return t+\";\"},StructureDeclaration}(r.Declaration);exports.StructureDeclaration=T;var E=function(t){function SignatureDeclaration(e,n){var i=t.call(this)||this;return i.position=e,i.signatureBinding=n,i}return n(SignatureDeclaration,t),SignatureDeclaration.prototype.elaborate=function(t,e,n){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\");for(var i=[],r=0;r<this.signatureBinding.length;++r){var o=this.signatureBinding[r].elaborate(t,e,n);t=o[0],i=i.concat(o[1]),e=o[2],n=o[3]}return[t,i,e,n]},SignatureDeclaration.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.signatureBinding.length;++i)n=this.signatureBinding[i].evaluate(n);return{newState:n,value:void 0,hasThrown:!1}},SignatureDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.signatureBinding.length;++e)t.push(this.signatureBinding[e].simplify());return new SignatureDeclaration(this.position,t)},SignatureDeclaration.prototype.toString=function(){for(var t=\"structure\",e=0;e<this.signatureBinding.length;++e)t+=\" \"+this.signatureBinding[e];return t+\";\"},SignatureDeclaration}(r.Declaration);exports.SignatureDeclaration=E;var S=function(t){function FunctorDeclaration(e,n){var i=t.call(this)||this;return i.position=e,i.functorBinding=n,i}return n(FunctorDeclaration,t),FunctorDeclaration.prototype.elaborate=function(t,e,n){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\");for(var i,r=[],o=0;o<this.functorBinding.length;++o){var a=[];i=this.functorBinding[o].elaborate(t,e,n),t=i[0],a=i[1],e=i[2],n=i[3],r=r.concat(a)}return[t,r,e,n]},FunctorDeclaration.prototype.evaluate=function(t,e){for(var n=t.state,i=0;i<this.functorBinding.length;++i)n=this.functorBinding[i].evaluate(n);return{newState:n,value:void 0,hasThrown:!1}},FunctorDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.functorBinding.length;++e)t.push(this.functorBinding[e].simplify());return new FunctorDeclaration(this.position,t)},FunctorDeclaration.prototype.toString=function(){for(var t=\"functor\",e=0;e<this.functorBinding.length;++e)t+=\" \"+this.functorBinding[e];return t+\";\"},FunctorDeclaration}(r.Declaration);exports.FunctorDeclaration=S;var x=function(){function StructureBinding(t,e,n){this.position=t,this.name=e,this.binding=n}return StructureBinding.prototype.simplify=function(){return new StructureBinding(this.position,this.name,this.binding.simplify())},StructureBinding.prototype.elaborate=function(t,e,n){var i=this.binding.elaborate(t,e,n);return t.setStaticStructure(this.name.getText(),i[0]),[t,i[1],i[2],i[3]]},StructureBinding.prototype.evaluate=function(t,e,n){var i=this.binding.computeStructure(t,e,n);if(void 0!==i){var r=t.state;return i instanceof p.Value?{newState:r,value:i,hasThrown:!0}:(r.setDynamicStructure(this.name.getText(),i),{newState:r,value:void 0,hasThrown:!1})}},StructureBinding.prototype.toString=function(){return this.name.getText()+\" = \"+this.binding},StructureBinding}();exports.StructureBinding=x;var I=function(){function SignatureBinding(t,e,n){this.position=t,this.name=e,this.binding=n}return SignatureBinding.prototype.simplify=function(){return new SignatureBinding(this.position,this.name,this.binding.simplify())},SignatureBinding.prototype.elaborate=function(t,e,n){var i=this.binding.elaborate(t,e,n);return t.setStaticSignature(this.name.getText(),i[0]),[t,i[1],i[2],i[3]]},SignatureBinding.prototype.evaluate=function(t){return t.setDynamicSignature(this.name.getText(),this.binding.computeInterface(t)),t},SignatureBinding.prototype.toString=function(){return this.name.getText()+\" = \"+this.binding},SignatureBinding}();exports.SignatureBinding=I;var V=function(){function FunctorBinding(t,e,n,i,r){this.position=t,this.name=e,this.signatureName=n,this.signatureBinding=i,this.binding=r}return FunctorBinding.prototype.simplify=function(){return new FunctorBinding(this.position,this.name,this.signatureName,this.signatureBinding.simplify(),this.binding.simplify())},FunctorBinding.prototype.elaborate=function(t,e,n){void 0===e&&(e=new Map),void 0===n&&(n=\"'*t0\");var i=this.signatureBinding.elaborate(t,e,n),r=t.getNestedState(t.id);r.setStaticStructure(this.signatureName.getText(),i[0]);var o=this.binding.elaborate(r,i[2],i[3]);return t.setStaticFunctor(this.name.getText(),[i[0],o[0]]),[t,i[1].concat(o[1]),o[2],o[3]]},FunctorBinding.prototype.evaluate=function(t){var e=this.signatureBinding.computeInterface(t),n=c.getInitialState().getNestedState(t.id);return n.dynamicBasis=t.getDynamicChanges(-1),t.setDynamicFunctor(this.name.getText(),new s.DynamicFunctorInformation(this.signatureName,e,this.binding,n)),t},FunctorBinding.prototype.toString=function(){return this.name.getText()+\"( \"+this.signatureName+\" : \"+this.signatureBinding+\" ) = \"+this.binding},FunctorBinding}();exports.FunctorBinding=V;var k=function(){function Specification(){}return Specification.prototype.simplify=function(){return this},Specification}();exports.Specification=k;var b=function(t){function ValueSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.valueDescription=n,i}return n(ValueSpecification,t),ValueSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=this,o=0;o<this.valueDescription.length;++o)!function(n){var o=r.valueDescription[n][1].simplify().instantiate(t,e);o.getTypeVariables().forEach(function(t,e){o=new a.TypeVariableBind(e,o,t)}),i.setValue(r.valueDescription[n][0].getText(),o,s.IdentifierStatus.VALUE_VARIABLE)}(o);return[i,[],e,n]},ValueSpecification.prototype.computeInterface=function(t){for(var e={},n=0;n<this.valueDescription.length;++n)e[this.valueDescription[n][0].getText()]=s.IdentifierStatus.VALUE_VARIABLE;return new s.DynamicInterface({},e,{})},ValueSpecification}(k);exports.ValueSpecification=b;var A=function(t){function TypeSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.typeDescription=n,i}return n(TypeSpecification,t),TypeSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=0;r<this.typeDescription.length;++r)i.setType(this.typeDescription[r][1].getText(),new a.CustomType(this.typeDescription[r][1].getText(),this.typeDescription[r][0]),[],this.typeDescription[r][0].length,!1);return[i,[],e,n]},TypeSpecification.prototype.computeInterface=function(t){for(var e={},n=0;n<this.typeDescription.length;++n)e[this.typeDescription[n][1].getText()]=[];return new s.DynamicInterface(e,{},{})},TypeSpecification}(k);exports.TypeSpecification=A;var L=function(t){function EqualityTypeSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.typeDescription=n,i}return n(EqualityTypeSpecification,t),EqualityTypeSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=0;r<this.typeDescription.length;++r)i.setType(this.typeDescription[r][1].getText(),new a.CustomType(this.typeDescription[r][1].getText(),this.typeDescription[r][0]),[],this.typeDescription[r][0].length,!0);return[i,[],e,n]},EqualityTypeSpecification.prototype.computeInterface=function(t){for(var e={},n=0;n<this.typeDescription.length;++n)e[this.typeDescription[n][1].getText()]=[];return new s.DynamicInterface(e,{},{})},EqualityTypeSpecification}(k);exports.EqualityTypeSpecification=L;var R=function(t){function DatatypeSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.datatypeDescription=n,i}return n(DatatypeSpecification,t),DatatypeSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=0;r<this.datatypeDescription.length;++r){for(var o=[],u=new a.CustomType(this.datatypeDescription[r][1].getText(),this.datatypeDescription[r][0]),p=this,c=0;c<this.datatypeDescription[r][2].length;++c)!function(t){if(o.push(p.datatypeDescription[r][2][t][0].getText()),void 0===p.datatypeDescription[r][2][t][1]){var e=u;e.getTypeVariables().forEach(function(t,n){e=new a.TypeVariableBind(n,e,t)}),i.setValue(p.datatypeDescription[r][2][t][0].getText(),e,s.IdentifierStatus.VALUE_CONSTRUCTOR)}else{var n=new a.FunctionType(p.datatypeDescription[r][2][t][1],u);n.getTypeVariables().forEach(function(t,e){n=new a.TypeVariableBind(e,n,t)}),i.setValue(p.datatypeDescription[r][2][t][0].getText(),n,s.IdentifierStatus.VALUE_CONSTRUCTOR)}}(c);i.setType(this.datatypeDescription[r][1].getText(),u,o,this.datatypeDescription[r][0].length,!0)}return[i,[],e,n]},DatatypeSpecification.prototype.computeInterface=function(t){for(var e={},n={},i=0;i<this.datatypeDescription.length;++i){for(var r=[],o=0;o<this.datatypeDescription[i][2].length;++o)e[this.datatypeDescription[i][2][o][0].getText()]=s.IdentifierStatus.VALUE_CONSTRUCTOR,r.push(this.datatypeDescription[i][2][o][0].getText());n[this.datatypeDescription[i][1].getText()]=r}return new s.DynamicInterface(n,e,{})},DatatypeSpecification.prototype.simplify=function(){for(var t=[],e=0;e<this.datatypeDescription.length;++e){for(var n=[],i=0;i<this.datatypeDescription[e][2].length;++i)void 0===this.datatypeDescription[e][2][i][1]?n.push(this.datatypeDescription[e][2][i]):n.push([this.datatypeDescription[e][2][i][0],this.datatypeDescription[e][2][i][1].simplify()]);t.push([this.datatypeDescription[e][0],this.datatypeDescription[e][1],n])}return new DatatypeSpecification(this.position,t)},DatatypeSpecification}(k);exports.DatatypeSpecification=R;var B=function(t){function DatatypeReplicationSpecification(e,n,i){var r=t.call(this)||this;return r.position=e,r.name=n,r.oldname=i,r}return n(DatatypeReplicationSpecification,t),DatatypeReplicationSpecification.prototype.elaborate=function(t,e,n){var i=void 0;if(this.oldname instanceof o.LongIdentifierToken){var r=t.getAndResolveStaticStructure(this.oldname);void 0!==r&&(i=r.getType(this.oldname.id.getText()))}else i=t.getStaticType(this.oldname.getText());if(void 0===i)throw new u.ElaborationError(this.position,'The datatype \"'+this.oldname.getText()+\"\\\" doesn't exist.\");var p=i.type.instantiate(t,e),c=new s.StaticBasis({},{},{},{},{});return c.setType(this.name.getText(),new a.FunctionType(new a.CustomType(this.name.getText(),p.typeArguments,0,this.oldname instanceof o.LongIdentifierToken?this.oldname:void 0),p),[],i.arity,i.allowsEquality),[c,[],e,n]},DatatypeReplicationSpecification.prototype.computeInterface=function(t){var e=void 0;if(this.oldname instanceof o.LongIdentifierToken){var n=t.getAndResolveDynamicStructure(this.oldname);void 0!==n&&(e=n.getType(this.oldname.id.getText()))}else e=t.getDynamicType(this.oldname.getText());if(void 0===e)throw new u.EvaluationError(this.position,'The datatype \"'+this.oldname.getText()+'\" does not exist.');for(var i={},r=0;r<e.length;++r)i[e[r]]=s.IdentifierStatus.VALUE_CONSTRUCTOR;var a={};return a[this.name.getText()]=e,new s.DynamicInterface(a,i,{})},DatatypeReplicationSpecification}(k);exports.DatatypeReplicationSpecification=B;var C=function(t){function ExceptionSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.exceptionDescription=n,i}return n(ExceptionSpecification,t),ExceptionSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=this,o=0;o<this.exceptionDescription.length;++o)!function(e){if(void 0!==r.exceptionDescription[e][1]){var n=r.exceptionDescription[e][1].simplify().instantiate(t,new Map),o=[];if(n.getTypeVariables().forEach(function(t,e){o.push(e)}),o.length>0)throw u.ElaborationError.getUnguarded(r.position,o);i.setValue(r.exceptionDescription[e][0].getText(),new a.FunctionType(n,new a.CustomType(\"exn\")).normalize()[0],s.IdentifierStatus.EXCEPTION_CONSTRUCTOR)}else i.setValue(r.exceptionDescription[e][0].getText(),new a.CustomType(\"exn\").normalize()[0],s.IdentifierStatus.EXCEPTION_CONSTRUCTOR)}(o);return[i,[],e,n]},ExceptionSpecification.prototype.computeInterface=function(t){for(var e={},n=0;n<this.exceptionDescription.length;++n)e[this.exceptionDescription[n][0].getText()]=s.IdentifierStatus.EXCEPTION_CONSTRUCTOR;return new s.DynamicInterface({},e,{})},ExceptionSpecification.prototype.simplify=function(){for(var t=[],e=0;e<this.exceptionDescription.length;++e)void 0===this.exceptionDescription[e][1]?t.push(this.exceptionDescription[e]):t.push([this.exceptionDescription[e][0],this.exceptionDescription[e][1].simplify()]);return new ExceptionSpecification(this.position,t)},ExceptionSpecification}(k);exports.ExceptionSpecification=C;var D=function(t){function StructureSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.structureDescription=n,i}return n(StructureSpecification,t),StructureSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=[],o=e,a=n,u=0;u<this.structureDescription.length;++u){var p=this.structureDescription[u][1].elaborate(t,o,a);r.concat(p[1]),o=p[2],a=p[3],i.setStructure(this.structureDescription[u][0].getText(),p[0])}return[i,r,o,a]},StructureSpecification.prototype.computeInterface=function(t){for(var e={},n=0;n<this.structureDescription.length;++n)e[this.structureDescription[n][0].getText()]=this.structureDescription[n][1].computeInterface(t);return new s.DynamicInterface({},{},e)},StructureSpecification.prototype.simplify=function(){for(var t=[],e=0;e<this.structureDescription.length;++e)t.push([this.structureDescription[e][0],this.structureDescription[e][1].simplify()]);return new StructureSpecification(this.position,t)},StructureSpecification}(k);exports.StructureSpecification=D;var _=function(t){function IncludeSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return n(IncludeSpecification,t),IncludeSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=[],o=0;o<this.expression.length;++o){var a=this.expression[o].elaborate(t,e,n);i=i.extend(a[0]),r=r.concat(a[1]),e=a[2],n=a[3]}return[i,r,e,n]},IncludeSpecification.prototype.computeInterface=function(t){for(var e=new s.DynamicInterface({},{},{}),n=0;n<this.expression.length;++n)e=e.extend(this.expression[n].computeInterface(t));return e},IncludeSpecification.prototype.simplify=function(){for(var t=[],e=0;e<this.expression.length;++e)t.push(this.expression[e].simplify());return new IncludeSpecification(this.position,t)},IncludeSpecification}(k);exports.IncludeSpecification=_;var O=function(t){function EmptySpecification(e){var n=t.call(this)||this;return n.position=e,n}return n(EmptySpecification,t),EmptySpecification.prototype.elaborate=function(t,e,n){return[new s.StaticBasis({},{},{},{},{}),[],e,n]},EmptySpecification.prototype.computeInterface=function(t){return new s.DynamicInterface({},{},{})},EmptySpecification}(k);exports.EmptySpecification=O;var P=function(t){function SequentialSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.specifications=n,i}return n(SequentialSpecification,t),SequentialSpecification.prototype.elaborate=function(t,e,n){for(var i=new s.StaticBasis({},{},{},{},{}),r=[],o=t,a=0;a<this.specifications.length;++a){var u=this.specifications[a].elaborate(o,e,n);i=i.extend(u[0]),r=r.concat(u[1]),e=u[2],n=u[3],o=o.getNestedState(o.id),o.staticBasis=u[0]}return[i,r,e,n]},SequentialSpecification.prototype.computeInterface=function(t){for(var e=new s.DynamicInterface({},{},{}),n=0;n<this.specifications.length;++n)e=e.extend(this.specifications[n].computeInterface(t));return e},SequentialSpecification.prototype.simplify=function(){for(var t=[],e=0;e<this.specifications.length;++e)t.push(this.specifications[e].simplify());return new SequentialSpecification(this.position,t)},SequentialSpecification}(k);exports.SequentialSpecification=P;var q=function(t){function SharingSpecification(e,n,i){var r=t.call(this)||this;return r.position=e,r.specification=n,r.typeNames=i,r}return n(SharingSpecification,t),SharingSpecification.prototype.elaborate=function(t,e,n){var i=this.specification.elaborate(t,e,n),r=t.getNestedState(0);r.staticBasis=i[0];for(var s=[],p=[],c=[],h=!1,l=0;l<this.typeNames.length;++l){var f=void 0,d=i[0],y=this.typeNames[l].getText();if(this.typeNames[l]instanceof o.LongIdentifierToken?void 0!==(d=r.getAndResolveStaticStructure(this.typeNames[l]))&&(f=d.getType(this.typeNames[l].id.getText()),y=this.typeNames[l].id.getText()):f=r.getStaticType(this.typeNames[l].getText()),void 0===f||void 0===d)throw new u.ElaborationError(this.position,'Undefined type \"'+this.typeNames[l].getText()+'\".');h=h||f.allowsEquality,s.push(f),p.push(d),c.push(y)}for(var l=1;l<this.typeNames.length;++l)p[l].setType(c[l],new a.FunctionType(s[l].type,s[0].type),[],0,h);return i},SharingSpecification.prototype.computeInterface=function(t){return this.specification.computeInterface(t)},SharingSpecification}(k);exports.SharingSpecification=q;var F=function(t){function TypeAliasSpecification(e,n){var i=t.call(this)||this;return i.position=e,i.alias=n,i}return n(TypeAliasSpecification,t),TypeAliasSpecification.prototype.elaborate=function(t,e,n){throw new u.InternalInterpreterError(this.position,\"And you don't seem to understand…\")},TypeAliasSpecification.prototype.computeInterface=function(t){throw new u.InternalInterpreterError(this.position,\"Being an interpreter is suffering.\")},TypeAliasSpecification.prototype.simplify=function(){for(var t=[],e=0;e<this.alias.length;++e)t.push([this.alias[e][0],this.alias[e][1]]);for(var n=new m(-1,new A(-1,t)),e=0;e<this.alias.length;++e)n=new w(-1,n,this.alias[e][0],this.alias[e][1],this.alias[e][2]);return new _(-1,[n]).simplify()},TypeAliasSpecification}(k);exports.TypeAliasSpecification=F},function(t,exports,e){\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.VERSION=\"1.1.1\",exports.BRANCH_NAME=\"npm_release\",exports.COMMIT_HASH=\"54d82e6\",exports.BUILD_DATE=\"Tue Feb 19 21:02:11 UTC 2019\",exports.COMMIT_MESSAGE=\"making interpreter runnable in node\"}]);\n\n//# sourceURL=webpack:///./node_modules/@sosml/interpreter/build/interpreter.min.js?");

/***/ }),

/***/ "./node_modules/webpack/buildin/global.js":
/*!***********************************!*\
  !*** (webpack)/buildin/global.js ***!
  \***********************************/
/*! no static exports found */
/***/ (function(module, exports) {

eval("var g;\n\n// This works in non-strict mode\ng = (function() {\n\treturn this;\n})();\n\ntry {\n\t// This works if eval is allowed (see CSP)\n\tg = g || new Function(\"return this\")();\n} catch (e) {\n\t// This works if the window reference is available\n\tif (typeof window === \"object\") g = window;\n}\n\n// g can still be undefined, but nothing to do about it...\n// We return undefined, instead of nothing here, so it's\n// easier to handle this case. if(!global) { ...}\n\nmodule.exports = g;\n\n\n//# sourceURL=webpack:///(webpack)/buildin/global.js?");

/***/ }),

/***/ "./src/worker.ts":
/*!***********************!*\
  !*** ./src/worker.ts ***!
  \***********************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("/* WEBPACK VAR INJECTION */(function(global) {\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst interpreter_1 = __webpack_require__(/*! @sosml/interpreter */ \"./node_modules/@sosml/interpreter/build/interpreter.min.js\");\nlet untypedGlobal = global;\nlet interpreterSettings = {\n    'allowUnicodeInStrings': false,\n    'allowSuccessorML': false,\n    'disableElaboration': false,\n    'disableEvaluation': false,\n    'allowLongFunctionNames': false\n};\nclass Communication {\n    static init() {\n        Communication.handlers = {};\n        Communication.nextId = 1;\n        Communication.freeIds = new Set();\n        untypedGlobal.onmessage = function (e) {\n            let message = e.data;\n            if (message.type) {\n                if (Communication.handlers[message.type]) {\n                    Communication.handlers[message.type](message.data);\n                }\n            }\n        };\n        Communication.registerHandler('settings', (settings) => {\n            if (settings) {\n                interpreterSettings = JSON.parse(settings);\n            }\n        });\n    }\n    static registerHandler(type, func) {\n        Communication.handlers[type] = func;\n    }\n    static clearHandler(type) {\n        delete Communication.handlers[type];\n    }\n    static sendPartialOutput(output) {\n        untypedGlobal.postMessage({\n            type: 'partial',\n            data: output\n        });\n    }\n    static sendOutputFinished() {\n        untypedGlobal.postMessage({\n            type: 'finished',\n            data: ''\n        });\n    }\n    static getCode(pos) {\n        return new Promise((resolve, reject) => {\n            untypedGlobal.postMessage({\n                type: 'getcode',\n                data: pos\n            });\n            let timeout = setTimeout(() => {\n                reject('Timeout');\n                Communication.clearHandler('code');\n            }, 1000);\n            Communication.registerHandler('code', (code) => {\n                Communication.clearHandler('code');\n                clearTimeout(timeout);\n                resolve(code);\n            });\n        });\n    }\n    static markText(from, to, style) {\n        let id;\n        if (Communication.freeIds.size > 0) {\n            let it = Communication.freeIds.values();\n            id = it.next().value;\n            Communication.freeIds.delete(id);\n        }\n        else {\n            id = Communication.nextId++;\n        }\n        untypedGlobal.postMessage({\n            type: 'markText',\n            data: {\n                'from': from,\n                'to': to,\n                'style': style,\n                'id': id\n            }\n        });\n        return id;\n    }\n    static clearMarker(id) {\n        untypedGlobal.postMessage({\n            type: 'clearMarker',\n            data: {\n                'id': id\n            }\n        });\n    }\n    static ping() {\n        untypedGlobal.postMessage({\n            type: 'ping',\n            data: ''\n        });\n    }\n}\nvar ErrorType;\n(function (ErrorType) {\n    ErrorType[ErrorType[\"OK\"] = 0] = \"OK\";\n    ErrorType[ErrorType[\"INCOMPLETE\"] = 1] = \"INCOMPLETE\";\n    ErrorType[ErrorType[\"INTERPRETER\"] = 2] = \"INTERPRETER\";\n    ErrorType[ErrorType[\"SML\"] = 3] = \"SML\"; // SML raised an exception\n})(ErrorType || (ErrorType = {}));\nclass IncrementalInterpretation {\n    constructor() {\n        this.semicoli = [];\n        this.data = [];\n        this.disabled = false;\n        this.debounceCallNecessary = false;\n        this.initialState = interpreter_1.getFirstState();\n    }\n    clear() {\n        this.semicoli.length = 0;\n        for (let i = 0; i < this.data.length; i++) {\n            if (this.data[i].marker !== -1) {\n                Communication.clearMarker(this.data[i].marker);\n            }\n        }\n        this.data.length = 0;\n    }\n    disable() {\n        this.disabled = true;\n        this.clear();\n    }\n    enable() {\n        this.disabled = false;\n    }\n    handleChangeAt(pos, added, removed) {\n        if (this.disabled) {\n            return;\n        }\n        this.doDebounce(pos, added, removed);\n    }\n    go() {\n        Communication.registerHandler('interpret', (data) => {\n            this.handleChangeAt(data.pos, data.added, data.removed);\n        });\n        Communication.registerHandler('clear', (data) => {\n            this.clear();\n        });\n    }\n    doDebounce(pos, added, removed) {\n        clearTimeout(this.debounceTimeout);\n        if (!this.debounceCallNecessary) {\n            if (!this.isHandlingNecessary(pos, added, removed)) {\n                Communication.ping(); // Let the frontend know I'm not dead\n                return;\n            }\n            else {\n                this.debounceCallNecessary = true;\n            }\n        }\n        if (!this.debounceMinimumPosition || this.compare(pos, this.debounceMinimumPosition) === -1) {\n            this.debounceMinimumPosition = pos;\n        }\n        this.debounceTimeout = setTimeout(() => {\n            this.debounceTimeout = null;\n            this.debounceCallNecessary = false;\n            let minPos = this.debounceMinimumPosition;\n            this.debounceMinimumPosition = null;\n            this.debouncedHandleChangeAt(minPos);\n        }, 400);\n    }\n    debouncedHandleChangeAt(pos) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let anchor = this.binarySearch(pos);\n            anchor = this.findNonErrorAnchor(anchor);\n            this.deleteAllAfter(anchor);\n            let baseIndex = this.findBaseIndex(anchor);\n            let basePos;\n            if (baseIndex !== -1) {\n                basePos = this.copyPos(this.semicoli[baseIndex]);\n            }\n            else {\n                basePos = { line: 0, ch: 0 };\n            }\n            let remainingText = yield Communication.getCode(basePos);\n            if (baseIndex !== -1) {\n                remainingText = remainingText.substr(1);\n                basePos.ch = basePos.ch + 1;\n            }\n            this.sendFinishedData(baseIndex);\n            this.reEvaluateFrom(basePos, baseIndex, anchor, remainingText);\n            Communication.sendOutputFinished();\n        });\n    }\n    sendFinishedData(upTo) {\n        let out = '';\n        for (let i = 0; i <= upTo; i++) {\n            out += this.data[i].output;\n        }\n        Communication.sendPartialOutput(out);\n    }\n    copyPos(pos) {\n        return { line: pos.line, ch: pos.ch };\n    }\n    reEvaluateFrom(basePos, baseIndex, anchor, remainingText) {\n        let splitByLine = remainingText.split('\\n');\n        let lastPos = basePos;\n        let partial = '';\n        let errorEncountered = false;\n        let previousState = (baseIndex === -1) ? null : this.data[baseIndex].state;\n        let previousCounter = (baseIndex === -1) ? -1 : this.data[baseIndex].successCounter;\n        for (let i = 0; i < splitByLine.length; i++) {\n            let lineOffset = 0;\n            if (i === 0) {\n                lineOffset = basePos.ch;\n            }\n            let start = -1;\n            let line = splitByLine[i];\n            let sc;\n            if (i !== 0) {\n                partial += '\\n';\n            }\n            while ((sc = line.indexOf(';', start + 1)) !== -1) {\n                partial += line.substring(start + 1, sc);\n                if (baseIndex >= anchor) {\n                    // actually need to handle this\n                    let semiPos = { line: (basePos.line + i), ch: sc + lineOffset };\n                    if (errorEncountered) {\n                        this.addErrorSemicolon(semiPos, '', Communication.markText(lastPos, semiPos, 'eval-fail'));\n                        lastPos = this.copyPos(semiPos);\n                        lastPos.ch++;\n                        previousState = null;\n                        partial = '';\n                    }\n                    else {\n                        let ret = this.evaluate(previousState, partial);\n                        if (ret.result === ErrorType.INCOMPLETE) {\n                            this.addIncompleteSemicolon(semiPos);\n                            partial += ';';\n                        }\n                        else if (ret.result === ErrorType.OK) {\n                            let className = 'eval-success';\n                            if ((previousCounter + 1) % 2 === 1) {\n                                className = 'eval-success-odd';\n                            }\n                            this.addSemicolon(semiPos, ret.state, Communication.markText(lastPos, semiPos, className), ret.warnings, ++previousCounter);\n                            lastPos = this.copyPos(semiPos);\n                            lastPos.ch++;\n                            previousState = ret.state;\n                            partial = '';\n                        }\n                        else if (ret.result === ErrorType.SML) {\n                            // TODO\n                            this.addSMLErrorSemicolon(semiPos, ret.error, Communication.markText(lastPos, semiPos, 'eval-fail'));\n                            lastPos = this.copyPos(semiPos);\n                            lastPos.ch++;\n                            previousState = ret.state;\n                            partial = '';\n                        }\n                        else {\n                            // TODO: mark error position with red color\n                            let errorMessage = this.getErrorMessage(ret.error, partial, lastPos);\n                            this.addErrorSemicolon(semiPos, errorMessage, Communication.markText(lastPos, semiPos, 'eval-fail'));\n                            lastPos = this.copyPos(semiPos);\n                            lastPos.ch++;\n                            previousState = null;\n                            errorEncountered = true;\n                            partial = '';\n                        }\n                        // Send partial\n                        if (this.data.length > 0) {\n                            let output = this.data[this.data.length - 1].output;\n                            Communication.sendPartialOutput(output);\n                        }\n                    }\n                }\n                else { // no need\n                    partial += ';';\n                }\n                baseIndex++;\n                start = sc;\n            }\n            partial += line.substr(start + 1);\n        }\n    }\n    evaluate(oldState, partial) {\n        let ret;\n        try {\n            if (oldState === null) {\n                ret = interpreter_1.interpret(partial + ';', this.initialState, interpreterSettings);\n            }\n            else {\n                ret = interpreter_1.interpret(partial + ';', oldState, interpreterSettings);\n            }\n        }\n        catch (e) {\n            // TODO: switch over e's type\n            if (this.getPrototypeName(e) === 'IncompleteError') {\n                return {\n                    state: null,\n                    result: ErrorType.INCOMPLETE,\n                    error: e,\n                    warnings: []\n                };\n            }\n            else {\n                return {\n                    state: null,\n                    result: ErrorType.INTERPRETER,\n                    error: e,\n                    warnings: []\n                };\n            }\n        }\n        if (ret.evaluationErrored) {\n            return {\n                state: ret.state,\n                result: ErrorType.SML,\n                error: ret.error,\n                warnings: ret.warnings\n            };\n        }\n        else {\n            return {\n                state: ret.state,\n                result: ErrorType.OK,\n                error: null,\n                warnings: ret.warnings\n            };\n        }\n    }\n    getPrototypeName(object) {\n        let proto = Object.getPrototypeOf(object);\n        if (proto.constructor && proto.constructor.name) {\n            return proto.constructor.name;\n        }\n        else {\n            return '';\n        }\n    }\n    getErrorMessage(error, partial, startPos) {\n        // if (error.position !== undefined) {\n        //    let position = this.calculateErrorPos(partial, startPos, error.position);\n        //    return 'Line ' + position[0] + /* ' Spalte ' + position[1] + */ ': \\\\*' +\n        //        this.getPrototypeName(error) + '\\\\*: ' + this.outputEscape(error.message);\n        // } else {\n        return '\\\\*' + this.outputEscape(error.name) + '\\\\*: ' +\n            this.outputEscape(error.message);\n        // }\n    }\n    /*\nprivate calculateErrorPos(partial: string, startPos: any, offset: number): [number, number] {\n    let pos = {line: startPos.line, ch: startPos.ch};\n    for (let i = 0; i < offset; i++) {\n        let char = partial.charAt(i);\n        if (char === '\\n') {\n            pos.line ++;\n            pos.ch = 0;\n        } else {\n            pos.ch++;\n        }\n    }\n    return [pos.line + 1, pos.ch + 1];\n} */\n    addSemicolon(pos, newState, marker, warnings, newCounter) {\n        this.semicoli.push(pos);\n        let baseIndex = this.findBaseIndex(this.data.length - 1);\n        let baseStateId = this.initialState.id + 1;\n        if (baseIndex !== -1) {\n            baseStateId = this.data[baseIndex].state.id + 1;\n        }\n        this.data.push({\n            state: newState,\n            marker: marker,\n            error: false,\n            output: this.computeNewStateOutput(newState, baseStateId, warnings, newCounter),\n            successCounter: newCounter\n        });\n    }\n    addIncompleteSemicolon(pos) {\n        this.semicoli.push(pos);\n        this.data.push({\n            state: null,\n            marker: -1,\n            error: false,\n            output: '',\n            successCounter: 0\n        });\n    }\n    addErrorSemicolon(pos, errorMessage, marker) {\n        this.semicoli.push(pos);\n        this.data.push({\n            state: null,\n            marker: marker,\n            error: true,\n            output: '\\\\3' + errorMessage,\n            successCounter: 0\n        });\n    }\n    addSMLErrorSemicolon(pos, error, marker) {\n        this.semicoli.push(pos);\n        let outputErr = '\\\\*Uncaught SML exception\\\\*: ' + this.outputEscape(error.toString()) + '\\n';\n        this.data.push({\n            state: null,\n            marker: marker,\n            error: true,\n            output: '\\\\3' + outputErr,\n            successCounter: 0\n        });\n    }\n    outputEscape(str) {\n        return str.replace(/\\\\/g, \"\\\\\\\\\");\n    }\n    printBasis(state, dynamicBasis, staticBasis, indent = 0) {\n        let out = '';\n        let fullst = '>';\n        let emptyst = ' ';\n        let cD = new Date();\n        if (cD.getMonth() === 9 && cD.getDate() >= 25) {\n            fullst = \"🎃\";\n        }\n        else if (cD.getMonth() === 11 && cD.getDate() >= 24 && cD.getDate() <= 26) {\n            fullst = \"🎄\";\n        }\n        else if (cD.getMonth() === 11 && cD.getDate() === 31) {\n            fullst = \"🎊\";\n        }\n        else if (cD.getMonth() === 0 && cD.getDate() === 1) {\n            fullst = \"🎆\";\n        }\n        else if (cD.getMonth() === 1 && cD.getDate() === 14) {\n            fullst = \"🍫\";\n        }\n        else if (cD.getMonth() === 2 && cD.getDate() === 14) {\n            fullst = \"🍫\";\n        }\n        else if (cD.getMonth() === 6 && cD.getDate() === 7) {\n            fullst = \"🎋\";\n        }\n        let stsym = indent === 0 ? fullst : emptyst;\n        let istr = '';\n        for (let i = 0; i < indent; ++i) {\n            istr += '  ';\n        }\n        if (dynamicBasis === undefined) {\n            for (let i in staticBasis.valueEnvironment) {\n                if (staticBasis.valueEnvironment.hasOwnProperty(i)) {\n                    out += stsym + ' ' + istr + this.printBinding(state, [i, undefined,\n                        staticBasis.getValue(i)]) + '\\n';\n                }\n            }\n            for (let i in staticBasis.typeEnvironment) {\n                if (staticBasis.typeEnvironment.hasOwnProperty(i)) {\n                    if (staticBasis.typeEnvironment.hasOwnProperty(i)) {\n                        if (this.getPrototypeName(staticBasis.getType(i).type) === \"CustomType\") {\n                            out += stsym + ' ' + istr + 'datatype \\\\*' + staticBasis.getType(i).type\n                                + '\\\\* : {\\n';\n                            for (let j of staticBasis.getType(i).constructors) {\n                                out += emptyst + '   ' + istr + this.printBinding(state, [j, undefined, staticBasis.getValue(j)]) + '\\n';\n                            }\n                            out += emptyst + ' ' + istr + '};\\n';\n                        }\n                    }\n                }\n            }\n            for (let i in staticBasis.typeEnvironment) {\n                if (staticBasis.typeEnvironment.hasOwnProperty(i)) {\n                    if (staticBasis.typeEnvironment.hasOwnProperty(i)) {\n                        if (this.getPrototypeName(staticBasis.getType(i).type) === \"FunctionType\") {\n                            out += stsym + ' ' + istr + 'type \\\\*'\n                                + staticBasis.getType(i).type.parameterType + ' = '\n                                + staticBasis.getType(i).type.returnType + '\\\\*;\\n';\n                        }\n                    }\n                }\n            }\n            for (let i in staticBasis.structureEnvironment) {\n                if (staticBasis.structureEnvironment.hasOwnProperty(i)) {\n                    out += stsym + ' ' + istr + 'structure \\\\*' + i + '\\\\*: sig\\n';\n                    if (staticBasis) {\n                        out += this.printBasis(state, undefined, staticBasis.getStructure(i), indent + 1);\n                    }\n                    else {\n                        out += this.printBasis(state, undefined, undefined, indent + 1);\n                    }\n                    out += emptyst + ' ' + istr + 'end;\\n';\n                }\n            }\n        }\n        else {\n            for (let i in dynamicBasis.valueEnvironment) {\n                if (dynamicBasis.valueEnvironment.hasOwnProperty(i)) {\n                    if (staticBasis) {\n                        out += stsym + ' ' + istr + this.printBinding(state, [i, dynamicBasis.valueEnvironment[i],\n                            staticBasis.getValue(i)], false) + '\\n';\n                    }\n                    else {\n                        out += stsym + ' ' + istr + this.printBinding(state, [i, dynamicBasis.valueEnvironment[i], undefined], false) + '\\n';\n                    }\n                }\n            }\n            for (let i in dynamicBasis.typeEnvironment) {\n                if (dynamicBasis.typeEnvironment.hasOwnProperty(i)) {\n                    if (staticBasis.typeEnvironment.hasOwnProperty(i)) {\n                        if (this.getPrototypeName(staticBasis.getType(i).type) === \"CustomType\") {\n                            out += stsym + ' ' + istr + 'datatype \\\\*' + staticBasis.getType(i).type\n                                + '\\\\* = {\\n';\n                            for (let j of staticBasis.getType(i).constructors) {\n                                out += emptyst + '   ' + istr + this.printBinding(state, [j, dynamicBasis.valueEnvironment[j],\n                                    staticBasis.getValue(j)]) + '\\n';\n                            }\n                            out += emptyst + ' ' + istr + '};\\n';\n                        }\n                    }\n                }\n            }\n            for (let i in dynamicBasis.typeEnvironment) {\n                if (dynamicBasis.typeEnvironment.hasOwnProperty(i)) {\n                    if (staticBasis.typeEnvironment.hasOwnProperty(i)) {\n                        if (this.getPrototypeName(staticBasis.getType(i).type) === \"FunctionType\") {\n                            out += stsym + ' ' + istr + 'type \\\\*'\n                                + staticBasis.getType(i).type.parameterType + ' = '\n                                + staticBasis.getType(i).type.returnType + '\\\\*;\\n';\n                        }\n                    }\n                }\n            }\n            for (let i in dynamicBasis.structureEnvironment) {\n                if (dynamicBasis.structureEnvironment.hasOwnProperty(i)) {\n                    out += stsym + ' ' + istr + 'structure \\\\*' + i + '\\\\* = struct\\n';\n                    if (staticBasis) {\n                        out += this.printBasis(state, dynamicBasis.getStructure(i), staticBasis.getStructure(i), indent + 1);\n                    }\n                    else {\n                        out += this.printBasis(state, dynamicBasis.getStructure(i), undefined, indent + 1);\n                    }\n                    out += emptyst + ' ' + istr + 'end;\\n';\n                }\n            }\n        }\n        return out;\n    }\n    computeNewStateOutput(state, id, warnings, stateCounter) {\n        let startWith = (stateCounter % 2 === 0) ? '\\\\1' : '\\\\2';\n        let res = '';\n        let curst = state;\n        for (let i = state.id; i >= id; --i) {\n            if (curst.id === i) {\n                if (interpreterSettings.disableEvaluation) {\n                    res = this.printBasis(curst, undefined, curst.getStaticChanges(i - 1), 0) + res;\n                }\n                else {\n                    res = this.printBasis(curst, curst.getDynamicChanges(i - 1), curst.getStaticChanges(i - 1), 0) + res;\n                }\n            }\n            while (curst.id >= i) {\n                curst = curst.parent;\n            }\n        }\n        let needNewline = false;\n        for (let val of warnings) {\n            res += this.outputEscape(val.message);\n            needNewline = !val.message.endsWith('\\n');\n        }\n        if (res.trim() === '') {\n            res = '>\\n';\n        }\n        if (needNewline) {\n            res += '\\n';\n        }\n        res = startWith + res;\n        return res;\n    }\n    printBinding(state, bnd, acon = true) {\n        let res = '';\n        let value = bnd[1];\n        if (value) {\n            value = value[0];\n        }\n        let type = bnd[2];\n        if (type) {\n            type = type[0];\n        }\n        let protoName = value ? this.getPrototypeName(value) : this.getPrototypeName(type);\n        if (protoName === 'ValueConstructor' && acon) {\n            res += 'con';\n        }\n        else if (protoName === 'ExceptionConstructor') {\n            res += 'exn';\n        }\n        else {\n            res += 'val';\n        }\n        if (value) {\n            if (type && type.isOpaque()) {\n                res += ' \\\\*' + bnd[0] + ' = <' + this.outputEscape(type.getOpaqueName()) + '>\\\\*';\n            }\n            else {\n                res += ' \\\\*' + bnd[0] + ' = ' + this.outputEscape(value.toString(state)) + '\\\\*';\n            }\n        }\n        else {\n            res += ' \\\\*' + bnd[0] + '\\\\*';\n        }\n        if (type) {\n            return res + ': \\\\_' + this.outputEscape(type.toString(state)) + '\\\\_;';\n        }\n        else {\n            return res + ': undefined;';\n        }\n    }\n    stringArrayContains(arr, search) {\n        for (let i = 0; i < arr.length; i++) {\n            if (arr[i].indexOf(search) !== -1) {\n                return true;\n            }\n        }\n        return false;\n    }\n    isHandlingNecessary(pos, added, removed) {\n        if (this.stringArrayContains(added, ';') || this.stringArrayContains(removed, ';')) {\n            return true;\n        }\n        if (this.semicoli.length === 0) {\n            return false;\n        }\n        let lastSemicolon = this.semicoli[this.semicoli.length - 1];\n        if (this.compare(lastSemicolon, pos) === -1) {\n            return false;\n        }\n        return true;\n    }\n    findBaseIndex(index) {\n        for (let i = index; i >= 0; i--) {\n            if (this.data[i].state !== null) {\n                return i;\n            }\n        }\n        return -1;\n    }\n    findNonErrorAnchor(anchor) {\n        for (let i = anchor; i >= 0; i--) {\n            if (!this.data[i].error) {\n                return i;\n            }\n        }\n        return -1;\n    }\n    deleteAllAfter(index) {\n        this.semicoli.length = index + 1;\n        for (let i = index + 1; i < this.data.length; i++) {\n            if (this.data[i].marker !== -1) {\n                Communication.clearMarker(this.data[i].marker);\n            }\n        }\n        this.data.length = index + 1;\n    }\n    binarySearch(pos) {\n        let left = 0;\n        let right = this.semicoli.length - 1;\n        while (left <= right) {\n            let center = Math.floor((left + right) / 2);\n            let element = this.semicoli[center];\n            let cmp = this.compare(pos, element);\n            if (cmp === -1) {\n                right = center - 1;\n                if (left > right) {\n                    return center - 1; // the element left of center is the next best element\n                }\n            }\n            else if (cmp === 1) {\n                left = center + 1;\n                if (left > right) {\n                    return center; // center is the next best element\n                }\n            }\n            else {\n                return center - 1;\n            }\n        }\n        return -1;\n    }\n    compare(posa, posb) {\n        if (posa.line === posb.line) {\n            return Math.sign(posa.ch - posb.ch);\n        }\n        else {\n            return Math.sign(posa.line - posb.line);\n        }\n    }\n}\nCommunication.init();\nlet ii = new IncrementalInterpretation();\nii.go();\n\n/* WEBPACK VAR INJECTION */}.call(this, __webpack_require__(/*! ./../node_modules/webpack/buildin/global.js */ \"./node_modules/webpack/buildin/global.js\")))\n\n//# sourceURL=webpack:///./src/worker.ts?");

/***/ })

/******/ });